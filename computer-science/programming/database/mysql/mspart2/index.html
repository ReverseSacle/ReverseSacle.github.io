<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#222><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/ico sizes=48x48 href=/images/favicon.ico><link rel=alternate type=application/rss+xml title=逆转天平 href=https://www.reversesacle.com/rss.xml><link rel=alternate type=application/atom+xml title=逆转天平 href=https://www.reversesacle.com/atom.xml><link rel=alternate type=application/json title=逆转天平 href=https://www.reversesacle.com/feed.json><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=/css/app.css><meta name=description content=数据库><link rel=canonical href=https://www.reversesacle.com/computer-science/programming/database/mysql/mspart2/ ><title>MySQL数据库基础-第二部分 - MySQL - 数据库 - 编程 - 计算机科学 | ReverseSacle-Blog</title><meta name=generator content="Hexo 6.3.0"></head><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=dotloader><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">MySQL数据库基础-第二部分</h1><div class=meta><span class=item title="创建时间：2023-08-19 15:45:12"><span class=icon><i class="ic i-calendar"></i></span> <span class=text>发表于</span> <time itemprop="dateCreated datePublished" datetime=2023-08-19T15:45:12+08:00>2023-08-19</time></span><span class=item title=本文字数><span class=icon><i class="ic i-pen"></i></span> <span class=text>本文字数</span> <span>50k</span> <span class=text>字</span></span><span class=item title=阅读时长><span class=icon><i class="ic i-clock"></i></span> <span class=text>阅读时长</span> <span>59 分钟</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div class=lines role=navigation aria-label=切换导航栏><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>ReverseSacle-Blog</a></li></ul><ul class=right><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id=imgs class=pjax><ul><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg3.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg19.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg9.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg18.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg7.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg16.webp></li></ul></div></header><div id=waves><svg class=waves xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink viewBox="0 24 150 28" preserveAspectRatio=none shape-rendering=auto><defs><path id=gentle-wave d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class=parallax><use xlink:href=#gentle-wave x=48 y=0 /><use xlink:href=#gentle-wave x=48 y=3 /><use xlink:href=#gentle-wave x=48 y=5 /><use xlink:href=#gentle-wave x=48 y=7 /></g></svg></div><main><div class=inner><div id=main class=pjax><div class="article wrap"><div class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i> <span><a href=/ >首页</a></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/ itemprop=item rel=index title="分类于 计算机科学"><span itemprop=name>计算机科学</span></a><meta itemprop=position content=1></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/ itemprop=item rel=index title="分类于 编程"><span itemprop=name>编程</span></a><meta itemprop=position content=2></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/database/ itemprop=item rel=index title="分类于 数据库"><span itemprop=name>数据库</span></a><meta itemprop=position content=3></span><i class="ic i-angle-right"></i> <span class=current itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/database/mysql/ itemprop=item rel=index title="分类于 MySQL"><span itemprop=name>MySQL</span></a><meta itemprop=position content=4></span></div><article itemscope itemtype=http://schema.org/Article class="post block" lang=zh-CN><link itemprop=mainEntityOfPage href=https://www.reversesacle.com/computer-science/programming/database/mysql/mspart2/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.webp><meta itemprop=name content=ReverseSacle><meta itemprop=description content="所见即所得，所思即所行, 知识书库 & 学习点滴"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=逆转天平></span><div class="body md" itemprop=articleBody><h2 id=约束><a class=anchor href=#约束>#</a> 约束</h2><h3 id=概述><a class=anchor href=#概述>#</a> 概述</h3><p>数据完整性(Data Integrity)是指数据的精确性(Accuracy)和可靠性(Reliability)。它是放在数据库中存在不符合语义规定的数据和防止因错误信息的输入输出造成无效操作或错误信息而提出的。</p><p>为了保证数据的完整性，SQL规范以约束的方式对表数据进行额外的条件限制</p><ul><li>实体完整性(Entity Integrity)：例如，同一个表中，不能存在两条完全相同无法区分的记录</li><li>域完整性(Domain Integrity)：例如，年龄范围0~120，性别范围“男/女”</li><li>引用完整性(Referential Integrity)：例如，员工所在部门，在部门表中要能找到这个部门</li><li>用户自定义完整性(User-defined Integrity)：例如，用户名唯一，密码不能为空等，本部门经理的工资不得高于本部门职工的平均工资的5倍</li></ul><p>约束是表级的强制规定。</p><p>可以在创建表时规定约束(通过CREATE TABLE语句)，或者在表创建之后通过ALTER TABLE语句规定约束。</p><p>根据约束数据列的限制，约束可分为</p><ul><li>单列约束：每个约束只约束一列</li><li>多列约束：每个约束可约束多列数据</li></ul><p>根据约束的作用范围，约束可分为</p><ul><li>列级约束：只能作用在一个列上，跟在列的定义后面</li><li>表级约束：可以作用在多个列上，不与列一起，而是单独定义</li></ul><table><thead><tr><th></th><th>位置</th><th>支持的约束类型</th><th>是否可以起约束名</th></tr></thead><tbody><tr><td>列级约束</td><td>列的位置</td><td>语法都支持，但外键没有效果</td><td>不可以</td></tr><tr><td>表级约束</td><td>所有列的下面</td><td>默认和非空不支持，其他支持</td><td>可以(主键没有效果)</td></tr></tbody></table><p>根据约束起的作用，约束可分为</p><ul><li><strong>NOT NULL</strong> - 非空约束，规定某个字段不能为空</li><li><strong>UNIQUE</strong> - 唯一约束，规定某个字段在整个表中是唯一的</li><li><strong>PRIMARY KEY</strong> - 主键(非空且唯一)约束</li><li><strong>FOREIGN KEY</strong> - 外键约束</li><li><strong>CHECK</strong> - 检查约束</li><li><strong>DEFAULT</strong> - 默认值约束</li></ul><p>MySQL不支持check约束，但可以使用check约束，而没有任何效果。</p><h3 id=非空约束><a class=anchor href=#非空约束>#</a> 非空约束</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 如何查看表中的约束 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">WHERE</span> table_name <span class="token operator">=</span> <span class="token string">'employees'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">NOT NULL(非空约束)</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">在CREATE TABLE时添加约束</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test1<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=10></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=11></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=12></td><td><pre>    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=13></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test1<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span><span class="token number">3400</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 错误：Column 'last_name' cannot be null */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test1<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'toml@126.com'</span><span class="token punctuation">,</span><span class="token number">3400</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">/* 错误：Column 'id' cannot be null */</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test1<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">,</span><span class="token string">'jerry@126.com'</span><span class="token punctuation">,</span><span class="token number">3400</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test1<span class="token punctuation">(</span>id<span class="token punctuation">,</span>email<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'abc@126.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">UPDATE</span> test1</pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">SET</span> id <span class="token operator">=</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* 在ALTER TABLE时添加约束 */</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">DESC</span> test1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test1</pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">MODIFY</span> email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">/* 在ALTER TABLE时删除约束 */</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test1</pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">MODIFY</span> email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=唯一性约束><a class=anchor href=#唯一性约束>#</a> 唯一性约束</h3><p>用于限制某个字段/某列的值不能重复。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test2<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=2></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span> <span class="token comment">/* 列级约束 */</span></pre></td></tr><tr><td data-num=3></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    email	<span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>	<span class="token keyword">UNIQUE</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre>    salary	<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">/* 表级约束 */</span></pre></td></tr><tr><td data-num=7></td><td><pre>	<span class="token keyword">CONSTRAINT</span> uk_test2_email <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">DESC</span> test2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">/* 在创建唯一约束的时候，如果不给唯一约束命名，就默认和列名相同 */</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test2<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span><span class="token number">4600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">/* 错误：Duplicate entry '1' for key 'test2.id' */</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test2<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom1'</span><span class="token punctuation">,</span><span class="token string">'toml@126.com'</span><span class="token punctuation">,</span><span class="token number">4600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">/* 错误：Duplicate entry 'tom@126.com' for key 'test2.uk_test2_email' */</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test2<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Tom1'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span><span class="token number">4600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment">/* 可以向声明为unique的字段上添加null值 */</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test2<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Tom1'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">4600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test2<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Tom2'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">4600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token comment">/* 可以向声明为unique的字段上添加NULL值，而且可以多次添加NULL */</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token comment">/* 在ALTER TABLE时添加约束 */</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">DESC</span> test2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">UPDATE</span> test2</pre></td></tr><tr><td data-num=39></td><td><pre><span class="token keyword">SET</span> salary <span class="token operator">=</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token comment">/* 方式一 */</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test2</pre></td></tr><tr><td data-num=43></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> uk_test2_sal <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token comment">/* 方式二 */</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test2</pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">MODIFY</span> last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token comment">/* 复合的唯一性约束 */</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">USER</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num=50></td><td><pre>    id	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>	<span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=52></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span>	<span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token comment">/* 表级约束 */</span></pre></td></tr><tr><td data-num=54></td><td><pre>    <span class="token keyword">CONSTRAINT</span> uk_user_name_pwd <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">USER</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token comment">/* 案例：复合的唯一性约束 */</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token comment">/* 学生表 */</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=63></td><td><pre>    sid	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=64></td><td><pre>    sname	<span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=65></td><td><pre>    tel	<span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>	<span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=66></td><td><pre>    cardid	<span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>	<span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token comment">/* 课程表 */</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=71></td><td><pre>    cid <span class="token keyword">INT</span></pre></td></tr><tr><td data-num=72></td><td><pre>    cname	<span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token comment">/* 选课表 */</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student_course<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=77></td><td><pre>    id	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=78></td><td><pre>    sid	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=79></td><td><pre>    cid	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=80></td><td><pre>    score	<span class="token keyword">INT</span></pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span>cid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student	<span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'xxx1'</span><span class="token punctuation">,</span><span class="token string">'1234567890'</span><span class="token punctuation">,</span><span class="token string">'11111111111111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student	<span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'xxx2'</span><span class="token punctuation">,</span><span class="token string">'1234567891'</span><span class="token punctuation">,</span><span class="token string">'21111111111111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> course <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span><span class="token string">'MySQL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre></pre></td></tr><tr><td data-num=87></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> course<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student_course <span class="token keyword">VALUES</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1001</span><span class="token punctuation">,</span><span class="token number">89</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=92></td><td><pre><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1002</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=93></td><td><pre><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1001</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=94></td><td><pre><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1002</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student_course<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token comment">/* 错误：Duplicate entry '2-1002' for key 'student_course.sid' */</span></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student_course <span class="token keyword">VALUES</span></pre></td></tr><tr><td data-num=99></td><td><pre><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1002</span><span class="token punctuation">,</span><span class="token number">67</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre></pre></td></tr><tr><td data-num=101></td><td><pre><span class="token comment">/* 删除唯一性约束 */</span></pre></td></tr><tr><td data-num=102></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=103></td><td><pre><span class="token comment">添加唯一性约束的列上也会自动创建唯一索引</span></pre></td></tr><tr><td data-num=104></td><td><pre><span class="token comment">删除唯一约束只能通过删除唯一索引的方式删除</span></pre></td></tr><tr><td data-num=105></td><td><pre><span class="token comment">删除时需要指定唯一索引名，唯一索引名就和唯一约束名一样</span></pre></td></tr><tr><td data-num=106></td><td><pre><span class="token comment">如果创建唯一约束时未指定名称，如果是单列，就默认和列名相同；如果是组合列，</span></pre></td></tr><tr><td data-num=107></td><td><pre><span class="token comment">那么默认和()中排在第一个的列名相同。也可以自定义唯一性约束名。</span></pre></td></tr><tr><td data-num=108></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=109></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=110></td><td><pre><span class="token keyword">WHERE</span> table_name <span class="token operator">=</span> <span class="token string">'student_course'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=111></td><td><pre></pre></td></tr><tr><td data-num=112></td><td><pre><span class="token keyword">DESC</span> test2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre></pre></td></tr><tr><td data-num=114></td><td><pre><span class="token comment">/* 如何删除唯一性索引 */</span></pre></td></tr><tr><td data-num=115></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test2</pre></td></tr><tr><td data-num=116></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> last_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=117></td><td><pre></pre></td></tr><tr><td data-num=118></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test2</pre></td></tr><tr><td data-num=119></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> uk_test2_sal<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=primary-key约束><a class=anchor href=#primary-key约束>#</a> PRIMARY KEY约束</h3><p>用来唯一标识表中的一行记录。</p><p>主键约束相当于唯一约束+非空约束的组合，主键约束列不允许重复，也不允许出现空值。</p><p>一个表最多只能有一个主键约束，建立主键约束可以在列级别创建，也可以在表级别上创建</p><p>主键约束对应着表中的一列或者多列(复合主键)。</p><p>如果是多列组合的复合主键约束，那么这些列都不允许为空值，并且组合的值不允许重复。</p><p>MySQL的主键名总是PRIMARY，就算自己命名了主键约束名也没用。</p><p>当创建主键约束时，系统默认会在所在列或组合上建立对应的主键索引。如果删除主键约束了，主键约束对应的索引就自动删除了。</p><p>需要注意的一点是，不要修改主键字段的值。因为主键是数据记录的唯一标识，如果修改了主键的值，就有可能会破坏数据的完整性。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* primary key 主键约束 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">在CREATE TABLE时添加约束</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">一个表中最多只能有一个主键约束</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test3<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=7></td><td><pre>    id	<span class="token keyword">INT</span>	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span><span class="token comment">/* 列级约束 */</span></pre></td></tr><tr><td data-num=8></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=9></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=10></td><td><pre>    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">/* MySQL的主键名总是PRIMARY,就算自己命名了主键约束名也没有用 */</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test3<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=15></td><td><pre>    id	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=16></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=17></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=18></td><td><pre>    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">/* 表级约束 */</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">CONSTRAINT</span> pk_test5_id <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">WHERE</span> table_name <span class="token operator">=</span> <span class="token string">'test5'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test4<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token number">4500</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token comment">/* 错误：Duplicate entry '1' for key 'test4.PRIMARY' */</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test4<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token number">4500</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token comment">/* 错误：Column 'id' cannot be null */</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test4<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token number">4500</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">USER</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num=39></td><td><pre>    id	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=40></td><td><pre>    NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=41></td><td><pre>    PASSWORD <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>PASSWORD<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user1</pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token comment">/* 错误：Column 'name' cannot be null */</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user1</pre></td></tr><tr><td data-num=50></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token comment">/* 在ALTER TABLE时添加约束 */</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test6<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=56></td><td><pre>    id	<span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=57></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=58></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=59></td><td><pre>    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">DESC</span> test6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test6</pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token comment">如何删除主键约束</span></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token comment">在实际开发中，不会去删除表中的主键约束</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test6</pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>自增列 - AUTO_INCREMENT</strong></p><p>某个字段的值自增。</p><p><strong>特点和要求</strong></p><ul><li>一个表最多只能有一个自增长列</li><li>当需要产生唯一标识符或顺序值时，可设置自增长</li><li>自增长列约束的类必须是键列(主键列，唯一键列)</li><li>自增约束的列的实际类型必须是整数类型</li><li>如果自增列指定了0和null，会在当前最大值的基础上自增；如果自增列手动指定了具体值，直接赋值为具体值</li></ul><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test7<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=2></td><td><pre>    id	<span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=3></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test7<span class="token punctuation">(</span>last_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test7<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">当向主键(含AUTO_INCREMENT)的字段上添加0或NULL时，</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">实际上会自动地往上添加指定的字段的数值</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test7<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test7<span class="token punctuation">(</span>id<span class="token punctuation">,</span>last_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 在ALTER TABLE时添加 */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test8<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=21></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=22></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">DESC</span> test8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test8</pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">MODIFY</span> id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token comment">/* 在ALTER TABLE时删除 */</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test8</pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">MODIFY</span> id <span class="token keyword">INT</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>自增变量的持久化(MySQL8.0)</strong></p><p>在MySQL8.0之前，自增主键AUTO_INCREMENT的值如果大于max(primary key) + 1，在MySQL重启后，会重置AUTO_INCREMENT = max(primary key) + 1，这种现象在某些情况下会导致业务主键冲突或者其他难以发现的问题。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* MySQL8.0新特性 - 自增变量的持久化 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> dbtest13<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">USE</span> dbtest13<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test9<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=6></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test9</pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> test9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test9</pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 重启服务器后 */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test9</pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在MySQL5.7系统中，对于自增主键的分配规则，是由InnoDB数据字典内部一个计数器来决定的，而该计数器只在内存中维护，并不会持久化到磁盘中。当数据库重启时，该计数器会被初始化。</p><p>MySQL8.0将自增主键的计数器持久化到重做日志中。每次计数器发生改变，都会将其写入重做日志中，如果数据库重启，InnoDB会根据重做日志中的信息来初始化计数器的内存值。</p><h3 id=foreign-key约束><a class=anchor href=#foreign-key约束>#</a> FOREIGN KEY约束</h3><p>限定某个表的某个字段的引用完整性。</p><p>比如，员工表的员工所在部门的选择，必须在部门表能找到对应的部分。</p><p>主表和从表/父表和子表</p><p>主表(父表)：被引用的表，被参考的表</p><p>从表(子表)：引用别人的表，参考别人的表</p><p>例如，员工表的员工所在部门这个字段的值要参考部门表：部门表是主表，员工表是从表。</p><p>例如，学生表，课程表，选课表：选课表的学生和课程要分别参考学生表和课程表，学生表和课程表是主表，选课表是从表。</p><p>从表的外键列，必须引用/参考主表的键主键或唯一约束的列(被依赖/被参考的值必须是唯一的)。</p><p>在创建外键约束时，如果不给外键约束命名，默认名不是列名，而是自动产生一个外键名(student_ibfk_1)，也可以指定外键约束名。</p><p>创建(CREATE)表时就指定外键约束，并且一个表可以建立多个外键约束。</p><p>在从表中指定外键约束，并且一个表可以建立多个外键约束。</p><p>从表的外键列与主表被参照的列名字可以不相同，但是数据类型必须一样，逻辑意义一致。如果类型不一样，创建子表时，就会出现错误<code>ERROR 1005(HY000)：Can't create table' database.tablename'(errno: 150)</code>。</p><p>当创建外键约束时，系统默认会在所在的列上建立对应的普通索引。但是索引名是别名，不是外键的约束名。</p><p>删除外键约束后，必须手动删除对应的索引。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 在ALTER TABLE时添加外键约束 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dept2<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=3></td><td><pre>    dept_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    dept_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp2<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=8></td><td><pre>    emp_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=9></td><td><pre>    emp_nmae <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=10></td><td><pre>    department_id <span class="token keyword">INT</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> em2</pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_emp2_dept_id</pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>department_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> dept2<span class="token punctuation">(</span>dept_id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">WHERE</span> table_name <span class="token operator">=</span> <span class="token string">'emp2'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=约束等级><a class=anchor href=#约束等级>#</a> 约束等级</h3><p><code>Cascade</code>方式：在父表上update/delete记录时，同步update/delete掉子表的匹配记录。</p><p><code>set null</code>方式：在父表上update/delete记录时，将子表上匹配记录的列设为null，但是要注意子表的外键列不能为not null。</p><p><code>No action</code>方式：如果子表中有匹配的记录，则不允许对父表对应候选键进行update/delete操作</p><p><code>Restrict</code>方式：同No action，都是立即检查外键约束</p><p><code>Set default</code>方式：在可视化工具SQLyog中可能显示空白，父表有变更时，子表将外键列设置成一个默认的值，但Innodb不能识别。</p><p>如果没有指定等级，就相当于Restrict方式。</p><p>对于外键约束，最好采用<code>ON UPDATE CASCADE ON DELETE RESTRICT</code>的方式。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 第一步先查看约束名和删除外键约束  */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>table_constraints</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">WHERE</span> table_nmae <span class="token operator">=</span> <span class="token string">'表名称'</span><span class="token punctuation">;</span><span class="token comment">/* 查看某个表的约束名 */</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 从表名 <span class="token keyword">DROP</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> 外键约束名<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/* 第二步查看索引名和删除索引(只能手动删除) */</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> 表名称<span class="token punctuation">;</span><span class="token comment">/* 查看某个表的索引名 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 从表名 <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> 索引名<span class="token punctuation">;</span></pre></td></tr></table></figure><p>如果两个表之间有关系(一对一，一对多)，比如，员工表和部门表(一对多)，它们之间并不是一定要见外键约束。</p><p>建和不建外键约束的区别</p><ul><li>建外键约束，相关操作(创建表，删除表，添加，修改，删除)会受到限制，从语法层面受到限制。例如，在员工表中不可能添加一个员工信息，它的部门的值在部门表中找不到</li><li>不建外键约束，相关操作(创建表，删除表，添加，修改，删除)不受限制，要保证数据的引用完整性，只能依靠程序员的自觉，或者是在Java层序中进行限定。</li></ul><p>建和不建外键约束和查询没有关系。</p><p>在MySQL里，外键约束是有成本的，需要消耗系统资源。对于大并发的SQL操作，有可能会不适合。比如大型网站的中央数据库，可能会因为外键约束的系统开销而变得非常慢。所以，MySQL允许不使用系统自带的外键约束，在应用层面完成检查数据一致性的逻辑。即，即使不用外键约束，也要想办法通过应用层面的附加逻辑，来实现外键约束的功能，确保数据的一致性。</p><p>(规范)不得使用外键与级联，一切外键概念必须在应用层解决。</p><p>(概念解释)学生表中的student_id是主键，那么成绩表中的student_id则为外键。如果更新学生表中student_id，同时触发成绩表中的student_id更新，即为级联更新。外键与级联更新适用于单机低并发，不适合分布式，高并发集群；级联更新是强阻塞，存在数据库的插入速度。</p><h3 id=check约束><a class=anchor href=#check约束>#</a> CHECK约束</h3><p>检查某个字段的值是否复合相关要求，一般值的是值得范围。</p><p>MySQL5.7可以使用CHECK约束，但CHECK约束对数据验证没有任何作用。添加数据时，没有任何错误或警告。</p><p>但MySQL8.0中可以使用CHECK约束了。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test10<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=2></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=3></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">CHECK</span><span class="token punctuation">(</span>salary <span class="token operator">></span> <span class="token number">2000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=default约束><a class=anchor href=#default约束>#</a> DEFAULT约束</h3><p>给某个字段/某列指定默认值，一旦设置默认值，在插入数据时，如果此字段没有显示赋值，则赋值为默认值。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 在CREATE TABLE添加约束 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test11<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=3></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">2000</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">/* 在ALTER TABLE添加约束 */</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test12<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=11></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=12></td><td><pre>    last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=13></td><td><pre>    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">DESC</span> test12<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> test12</pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">MODIFY</span> salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">2500</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>建表时不想让表中出现NULL值，加not null default ''或default 0。</p><p>为什么不想要NULL的值</p><ul><li>不好比较。NULL是一种特殊值，比较时只能用专门的IS NULL和IS NOT NULL来比较。碰到运算符，通常返回NULL</li><li>效率不高。影响提高索引效果。因此，往往在建表时<strong>NOT NULL DEFAULT</strong>或<strong>DEFAULT 0</strong></li></ul><p>带AUTO_INCREMENT约束的字段值是从1开始的吗？</p><p>在MySQL中，默认AUTO_INCREMENT的初始值是1，每新增一条记录，字段值自动加1。设置自增属性(AUTO_INCREMENT)的时候，还可以指定第一条插入记录的自增字段的值，这样新插入的记录的自增字段值从初始值开始递增，如在表中插入第一条记录，同时指定id值为5，则以后插入的记录的id值就会从6开始往上增加。添加主键约束时，往往需要设置字段自动增加属性。</p><p>并不是每个表都可以任意选择存储引擎？</p><p>外键约束(FOREIGN KEY)不能跨引擎使用。</p><p>MySQL支持多种存储引擎，每一个表都可以指定一个不同的存储引擎，需要注意的是：外键约束是用来保证数据的参照完整性的，如果表之间需要关联外键，却指定了不同的存储引擎，那么这些表之间是不能创建外键约束的。即，存储引擎的选择也不完全是随意的。</p><p><strong>约束练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> test04_emp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">USE</span> test04_emp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp2<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=5></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=6></td><td><pre>    emp_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dept2<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=10></td><td><pre>    id <span class="token keyword">INT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=11></td><td><pre>    dept_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">/* 向表emp2的id列中添加PRIMARY KEY 约束 */</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> emp2</pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> pk_emp2_id <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/* 向表dept2的id列中添加PRIMARY KEY 约束 */</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> dept2</pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">向表emp2中添加列dept_id，并在其中定义FOREIGN KEY约束，</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token comment">与之相关联的列是dept2表中的id列</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> emp2</pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">ADD</span> dept_id <span class="token keyword">INT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">DESC</span> emp2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> emp2</pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_emp2_deptid <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>dept_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> dept2<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* ...............*/</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">USE</span> test01_library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">DESC</span> test01_library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token comment">ALTER TABLE books</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">ADD PRIMARY KEY(id);</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token comment"></span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token comment">ALTER TABLE books</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token comment">MODIFY id INT AUTO_INCREMENT;</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">MODIFY</span> id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">MODIFY</span> NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">MODIFY</span> AUTHORS <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">MODIFY</span> price <span class="token keyword">FLOAT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">MODIFY</span> pubdate <span class="token keyword">YEAR</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> books</pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">MODIFY</span> num <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre></pre></td></tr><tr><td data-num=63></td><td><pre></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token comment">/* ......................... */</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token comment">/* 创建数据库test04_company */</span></pre></td></tr><tr><td data-num=66></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> test04_company <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=67></td><td><pre></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> offices<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=69></td><td><pre>    officeCode <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=70></td><td><pre>    city <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=71></td><td><pre>    address <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=72></td><td><pre>    country <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=73></td><td><pre>    postalCode <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token keyword">CONSTRAINT</span> uk_off_poscode <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>postalCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre></pre></td></tr><tr><td data-num=77></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=78></td><td><pre>    employeeNumber <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=79></td><td><pre>    lastName <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=80></td><td><pre>    firstName <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=81></td><td><pre>    mobile <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=82></td><td><pre>    officeCode <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=83></td><td><pre>    jobTitle CARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=84></td><td><pre>    birth <span class="token keyword">DATETIME</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=85></td><td><pre>    note <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=86></td><td><pre>    sex <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token keyword">CONSTRAINT</span> fk_emp_offcode <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>officeCode<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> offices<span class="token punctuation">(</span>officeCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token comment">/* 将表employees的mobile字段修改到officeCode字段后面 */</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=92></td><td><pre><span class="token keyword">MODIFY</span> mobile <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token keyword">AFTER</span> officeCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre></pre></td></tr><tr><td data-num=94></td><td><pre><span class="token comment">/* 将表employees的birth字段改名为employee_birth */</span></pre></td></tr><tr><td data-num=95></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=96></td><td><pre>CHANGE birth employee_birth <span class="token keyword">DATETIME</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token comment">/* 修改sex字段，数据类型为CHAR(1)，非空约束 */</span></pre></td></tr><tr><td data-num=99></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=100></td><td><pre><span class="token keyword">MODIFY</span> sex <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre></pre></td></tr><tr><td data-num=102></td><td><pre><span class="token comment">/* 删除字段note */</span></pre></td></tr><tr><td data-num=103></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=104></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> note<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre></pre></td></tr><tr><td data-num=106></td><td><pre><span class="token comment">/* 增加字段名favoriate_activity,数据类型为VARCHAR(100) */</span></pre></td></tr><tr><td data-num=107></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=108></td><td><pre><span class="token keyword">ADD</span> favoriate_activity <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre></pre></td></tr><tr><td data-num=110></td><td><pre><span class="token comment">/* 将表employees名称修改为employees_info */</span></pre></td></tr><tr><td data-num=111></td><td><pre><span class="token keyword">RENAME</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=112></td><td><pre><span class="token keyword">TO</span> employees_info<span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=视图><a class=anchor href=#视图>#</a> 视图</h2><h3 id=概述-2><a class=anchor href=#概述-2>#</a> 概述</h3><p><strong>常见的数据库对象</strong></p><table><thead><tr><th>对象</th><th>描述</th></tr></thead><tbody><tr><td>表(TABLE)</td><td>表是存储数据的逻辑单元，以行和列的形式存在，列就是字段，行就是记录</td></tr><tr><td>数据字典</td><td>即系统表，存储数据库相关信息的表。系统表的数据通常由数据库系统维护，不应该被修改，只可查看。</td></tr><tr><td>约束(CONSTRAINT)</td><td>执行数据校验的规则，用于保证数据完整性的规则</td></tr><tr><td>视图(VIEW)</td><td>一个或多个数据表里的数据的逻辑显示，视图并不存储数据</td></tr><tr><td>索引(INDEX)</td><td>用于提高查询性能，相当于书的目录</td></tr><tr><td>存储过程(PROCEDURE)</td><td>用于完成一次完整的业务处理，没有返回值，但可通过传出参数将多个值传给调用环境</td></tr><tr><td>存储函数(FUNCTION)</td><td>用于完成一次特定的计算，具有一个返回值</td></tr><tr><td>触发器(TRIGGER)</td><td>相当于一个事件监听器，当数据库发生特定事件后，触发器被触发并完成相应的处理</td></tr></tbody></table><p>视图一方面可使用表的一部分而不是所有表，另一方面也可以针对不同的用户制定不同的查询视图。</p><p>视图是一种虚拟表，本身是不具有数据的，占用很少的内存控件，它是SQL中的一个重要概念。</p><p>视图建立在已有表的基础上，建立视图时依赖的表被称为基表。</p><p>视图的创建和删除只影响视图本身，不影响对应的基表，但是对视图中的数据进行增删改操作时，数据表中的数据会相应地发生变换，反之亦然。</p><p>向视图提供数据内容的语句为SELECT语句，可以将视图理解为存储起来的SELECT语句。</p><ul><li>在数据库中，视图不会保存数据，数据只保存在真实创建的数据表中。当对视图中的数据进行增删改操作时，数据表中的数据会相应地发生变换，反之亦然</li></ul><p>视图，是向用户提供基表数据的另一种表现形式。通常情况下，小型项目的数据库可以不使用视图，但在大型项目中以及数据表比较复杂的情况下，视图的价值就凸显出来了，它可以把查询的结果集放到虚拟表中，提升使用效率。</p><h3 id=创建视图><a class=anchor href=#创建视图>#</a> 创建视图</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 在CREATE VIEW 语句中嵌入子查询 */</span></pre></td></tr><tr><td data-num=2></td><td><pre>CREEATE <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">[</span><span class="token keyword">ALGORITHM</span> <span class="token operator">=</span> &#123;<span class="token keyword">UNDEFINED</span> <span class="token operator">|</span> <span class="token keyword">MERGE</span> <span class="token operator">|</span> <span class="token keyword">TEMPTABLE</span>&#125;<span class="token punctuation">]</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">VIEW</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">(</span>字段列表<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">AS</span> 查询语句</pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADE</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 精简 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">(</span>字段列表<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">AS</span> 查询语句</pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">/* 例子 */</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">USE</span> dbtest14<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emps</pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>departments<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment">/* 针对单表 */</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">/* 情况1：视图中的字段与基表的字段有对应关系 */</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp1</pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">FROM</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">/* 查询语句中字段的别名会作为视图中字段的名称出现 */</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp2</pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">SELECT</span> employee_id emp_id<span class="token punctuation">,</span>last_name lname<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">FROM</span> emp2</pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">WHERE</span> salary <span class="token operator">></span> <span class="token number">8000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* 小括号内字段个数与SELECT中字段个数相同 */</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp3<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>NAME<span class="token punctuation">,</span>monthly_sal<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">FROM</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">/* 情况2：视图中的字段在基表中可能没有对应的字段 */</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp_sal</pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token keyword">SELECT</span> department_id<span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> avg_sal</pre></td></tr><tr><td data-num=44></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">WHERE</span> department_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token comment">/* 针对多表 */</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp_dept</pre></td></tr><tr><td data-num=50></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span>e<span class="token punctuation">.</span>department_id<span class="token punctuation">,</span>d<span class="token punctuation">.</span>department_name</pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">FROM</span> emps e <span class="token keyword">JOIN</span> depts d</pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>department_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>department_id<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token comment">/* 利用视图对数据进行格式化 */</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp_dept</pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span>e<span class="token punctuation">.</span>last_name<span class="token punctuation">,</span><span class="token string">'('</span><span class="token punctuation">,</span>d<span class="token punctuation">.</span>department_name<span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">)</span> emp_info</pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">FROM</span> emps e <span class="token keyword">JOIN</span> depts d</pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>department_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>department_id<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token comment">/* 基于视图创建视图 */</span></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">CREATE</span> vu_emp4</pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name</pre></td></tr><tr><td data-num=66></td><td><pre><span class="token keyword">FROM</span> vu_emp1<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=查看视图><a class=anchor href=#查看视图>#</a> 查看视图</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 查看数据库的表对象，视图对象 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">/* 查看视图结构 */</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">DESCRIBE</span> vu_emp1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/* 查看视图的属性信息 */</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'vu_emp1'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* 查看视图的详细定义信息 */</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> vu_emp1<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=更新视图><a class=anchor href=#更新视图>#</a> 更新视图</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 更新视图中的数据 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* 一般情况下 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> vu_emp1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* 更新视图的数据，会导致基表中数据的修改 */</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">UPDATE</span> vu_emp1</pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SET</span> salary <span class="token operator">=</span> <span class="token number">20000</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* 更新表中的数据，也会导致视图中的数据的修改 */</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">UPDATE</span> emps</pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">SET</span> salary <span class="token operator">=</span> <span class="token number">10000</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">/* 删除视图中的数据，也会导致表中的数据的删除 */</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> vu_emp1</pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">/* 不能更新视图中的数据 */</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> vu_emp_sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment">/* 更新失败案例 */</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">UPDATE</span> vu_emp_sal</pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">SET</span> avg_sal <span class="token operator">=</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> vu_emp_sal</pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>不可更新的视图</strong></p><p>要使视图可更新，视图中的行和底层基本表中的行之间必须存在一对一的关系。另外当视图定义出现如下情况时，视图不支持更新操作</p><ul><li>在定义视图的时候指定了<code>ALGORITHM = TEMPTABLE</code>，视图将不支持INSERT和DELETE操作</li><li>视图中不包含基表中所有被定义为非空又未指定默认值的列，视图将不支持INSERT操作</li><li>在定义视图的SELECT语句中使用了JOIN联合查询，视图将不支持INSERT和DELETE操作</li><li>在定义视图的SELECT语句后的字段列表中使用了数学表达式或子子查询，视图将不支持INSERT，也不支持UPDATE使用数学表达式，子查询的字段值</li><li>在定义视图的SELECT语句后的字段列表中使用DISTINCT，聚合函数，GROUP BY，HAVING，UNION等，视图将不支持INSERT，UPDATE，DELETE</li><li>在定义视图的SELECT语句中包含了子查询，而子查询中引用了FROM后面的表，视图将不支持INSERT，UPDATE，DELETE</li><li>视图定义基于一个不可更新视图</li><li>常量视图</li></ul><p>虽然可以更新视图数据，但视图作为虚拟表，主要用于方便查询，不建议更新视图的数据。对视图数据的更改都是通过对实际数据表里数据的操作来完成的。</p><h3 id=修改删除视图><a class=anchor href=#修改删除视图>#</a> 修改/删除视图</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 修改视图 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> vu_emp1</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email</pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">WHERE</span> salary <span class="token operator">></span> <span class="token number">7000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> vu_emp1</pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email<span class="token punctuation">,</span>hire_date</pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">FROM</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">/* 删除视图 */</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> vu_emp4<span class="token punctuation">;</span></pre></td></tr></table></figure><p>删除视图只是删除视图的定义，并不会删除基表的数据。</p><p>基于视图a，b创建的新的视图c，如果将视图a或者视图b删除，会导致视图c的查询失败。这样的视图c需要手动删除或修改，否则影响使用。</p><h3 id=视图总结><a class=anchor href=#视图总结>#</a> 视图总结</h3><p><strong>视图的优点</strong></p><p><strong>操作简单</strong></p><p>将经常使用的查询操作定义为视图，可以不需要关系视图对应的数据表的结构，表与表之间的关联关系，也不需要关系数据表之间的业务逻辑和查询条件，而只需简单地操作视图即可，极大简化了开发人员对数据库的操作。</p><p><strong>减少数据冗余</strong></p><p>视图跟实际数据表不一样，它存储的是查询语句。所以，在使用的时候，需要通过定义视图的查询语句来获取结果集。而视图本身不存储数据，不占用数据存储的资源，减少了数据冗余。</p><p><strong>数据安全</strong></p><p>MySQL将用户对数据的访问限制在某些数据的结果集上，而这些数据集可以使用视图来实现。用户不必直接查询或操作数据表。这也可以理解为视图具有隔离性。视图相当于在用户和实际的数据表之间加了一层虚拟表。</p><p>同时，MySQL可以根据权限将用户对数据的访问限制在某些视图上，用户不需要重新数据表，可以直接通过视图获取数据表中的信息。这在一定程度上保障了数据表中数据的安全性。</p><p><strong>适应灵活多变的需求</strong></p><p>当业务系统的需求发生变化后，如果需要改动数据表的结构，则工作量相对较大，可以使用视图来减少改动的工作量。这种方式在实际工作中使用得比较多。</p><p><strong>能够分解复杂得查询逻辑</strong></p><p>数据库中如果存在复杂得查询逻辑，则可以将问题进行分解，创建多个视图获取数据，再将创建得多个视图结合起来，完成复杂得查询逻辑。</p><p><strong>视图的不足</strong></p><p>如果在实际数据表的基础上创建了视图，那么，那么，如果实际数据表的结构变更了，就需要及时对相关的视图进行相应的维护。特别是嵌套的视图(就是在视图的基础上创建视图)，维护会变得比较复杂，可读性不好，容易变成系统的潜在隐患，因为创建视图的SQL查询可能会对字段重命名，也可能包含复杂的逻辑，这些都会增加维护成本。</p><p>实际项目中，如果视图过多，会导致数据库维护成本的问题。</p><p>所以，在创建视图的时候，需要结合实际项目需求，综合考虑视图的优点和不足，这样才能正确使用视图，使系统整体达到最优。</p><p><strong>视图练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">使用表emps创建视图employee_vu，</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">其中包括姓名(LAST_NAME),员工号(EMPLOYEE_ID),部门号(DEPARTMENT_ID)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> employee_vu<span class="token punctuation">(</span>lname<span class="token punctuation">,</span>emp_id<span class="token punctuation">,</span>dept_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SELECT</span> last_name<span class="token punctuation">,</span>employee_id<span class="token punctuation">,</span>department_id</pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">FROM</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* 显示视图的结构 */</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">DESC</span> employee_vu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">/* 查询视图中的全部内容 */</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee_vu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">/* 将视图中的数据1限定在部门号是80的范围内 */</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> employee_vu<span class="token punctuation">(</span>lname<span class="token punctuation">,</span>emp_id<span class="token punctuation">,</span>dept_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">SELECT</span> last_name<span class="token punctuation">,</span>employee_id<span class="token punctuation">,</span>department_id</pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emps</pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span>employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">/* 创建视图emp_v1，要求查询电话号码以011开头的员工姓名和工资，邮箱 */</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> emp_v1</pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">SELECT</span> last_name<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>email</pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">WHERE</span> phone_number <span class="token operator">LIKE</span> <span class="token string">'011%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token comment">要将视图emp_v1修改为查询电话号码以011开头的并且邮箱中包含e字符的员工姓名和邮箱和电话号码</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> emp_v1</pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token keyword">SELECT</span> last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>phone_number<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">WHERE</span> phone_num <span class="token operator">LIKE</span> <span class="token string">'011%'</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token operator">AND</span> email <span class="token operator">LIKE</span> <span class="token string">'%e%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token comment">/* 向mep_v1插入一条记录，是否可以？*/</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token comment">/* 实测：失败了 */</span></pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">DESC</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp_v1</pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span><span class="token string">'01012345'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token comment">/* 修改emp_v1中员工的工资，每人涨薪1000 */</span></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">FROM</span> emp_v1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token keyword">UPDATE</span> emp_v1</pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token comment">/* 删除emp_v1中姓名为Olsen的员工 */</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">DELETE</span>　<span class="token keyword">FROM</span> emp_v1</pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> <span class="token string">'Olsen'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token comment">/* 创建视图emp_v2,要求查询部门的最高工资高于12000的部门id和其最高工资 */</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> emp_v2<span class="token punctuation">(</span>dept_id<span class="token punctuation">,</span>max_sal<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">SELECT</span> department_id<span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=66></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department_id</pre></td></tr><tr><td data-num=67></td><td><pre><span class="token keyword">HAVING</span> <span class="token function">MAX</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">12000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token comment">/* 向mep_v1插入一条记录，是否可以？*/</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token comment">/* 不可以 */</span></pre></td></tr><tr><td data-num=71></td><td><pre></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token comment">/* 删除刚才的emp_v2和emp_v1 */</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token keyword">IF</span> EXITS emp_v1<span class="token punctuation">,</span>emp_v2<span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=存储过程与存储函数><a class=anchor href=#存储过程与存储函数>#</a> 存储过程与存储函数</h2><h3 id=概述-3><a class=anchor href=#概述-3>#</a> 概述</h3><p>MySQL从5.0版本开始支持存储过程和存储函数。其能够将负责的SQL逻辑封装在一起，应用程序无须关心存储过程和存储函数内部复杂的SQL逻辑，而只需简单地调用存储过程和函数即可。</p><p>存储过程(Stored Procedure)，就是一组经过预先编译的SQL语句的封装。</p><p>执行过程</p><ul><li>存储过程预先存储在MySQL服务器上，需要执行的时候，客户端只需向服务器发出调用存储过程的命令，服务端就可以把预先存储好的这一系列SQL语句全部执行</li></ul><p>好处</p><ul><li>简化操作，提供了SQL语句的复用性，减少了开发的压力</li><li>减少操作过程中的失误，提高效率</li><li>减少网络传输量(客户端不需要把所有的SQL语句通过网络发给服务器)</li><li>减少了SQL语句暴露在网上的风险，也提高了数据查询的安全性</li></ul><p>和视图，函数的对比</p><p>它和视图有着同样的优点，清晰，安全，还可以减少网络传输量。不过，视图是虚拟表，通常不对底层数据直接操作，而存储过程是程序化SQL，可以直接操作底层数据表，相比于面向集合的操作方式，能够实现一些更复杂的数据处理。</p><p>一旦存储过程被创建出来，使用它就像使用函数一样简单那，直接通过调用存储过程名即可，相较于函数，存储过程是没有返回值的。</p><p>存储过程的参数类型是IN, OUT和INOUT。根据这点分类</p><ul><li>没有参数(无参数无返回)</li><li>仅仅带IN类型(有参数无返回)</li><li>仅仅带OUT类型(无参数有返回)</li><li>即带IN又带OUT(有参数有返回)</li><li>带INOUT(有参数有返回)</li></ul><p>IN, OUT, INOUT都可以在一个存储过程中带多个。</p><h3 id=创建存储过程><a class=anchor href=#创建存储过程>#</a> 创建存储过程</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 语法 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> 存储过程名<span class="token punctuation">(</span><span class="token operator">IN</span> <span class="token operator">|</span> <span class="token keyword">OUT</span> <span class="token operator">|</span> <span class="token keyword">INOUT</span> 参数名 参数类型<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">[</span>CHARACTERISTICS<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=5></td><td><pre>	存储过程体</pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">END</span></pre></td></tr></table></figure><p>参数前面的符号的意思</p><ul><li><strong>IN</strong>指当前参数为输入参数，表示入参。存储过程只是读取这个参数的值，如果没有定义参数种类，默认就是IN，表示输入参数</li><li><strong>OUT</strong>指当前参数为输出参数，也就是表示出参。执行完成之后，调用这个存储过程的客户端或应用程序就可以读取这个参数返回的值了</li><li><strong>INOUT</strong>指当前参数即可以是输入参数，也可以是输出参数</li></ul><p>形参类型可以是MySQL数据库中的任意类型。</p><p><strong>characteristics</strong>表示创建存储过程时指定的对存储过程的约束条件，其取值信息如下</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">LANGUAGE</span> <span class="token keyword">SQL</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token operator">|</span> <span class="token punctuation">[</span><span class="token operator">NOT</span><span class="token punctuation">]</span> <span class="token keyword">DETERMINISTIC</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token operator">|</span> &#123;<span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">NO</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> <span class="token operator">|</span> <span class="token keyword">MODIFIES</span> <span class="token keyword">SQL</span> <span class="token keyword">DATE</span> &#125;</pre></td></tr><tr><td data-num=4></td><td><pre><span class="token operator">|</span> <span class="token keyword">SQL</span> SECURITY&#123;<span class="token keyword">DEFINER</span> <span class="token operator">|</span> <span class="token keyword">INVOKER</span>&#125;</pre></td></tr><tr><td data-num=5></td><td><pre><span class="token operator">|</span> <span class="token keyword">COMMENT</span> <span class="token identifier"><span class="token punctuation">`</span>string<span class="token punctuation">`</span></span></pre></td></tr></table></figure><p><strong>LANGUAGE SQL</strong>：说明存储过程执行体是由SQL语句组成的，当前系统支持的语言为SQL。</p><p><strong>[NOT] DETERMINISTIC</strong>：指明存储过程执行的结果是否确定。<strong>DETERMINISTIC</strong>表示结果是确定的。每次执行存储过程时，相同的输入会得到相同的输出。<strong>NOT DETERMINISTIC</strong>表示结果是不确定的，相同的输入可能得到不同的输出。如果没有指定任意一个值，默认为<strong>NOT DETERMINISTIC</strong>。</p><p><code>&#123;CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATE &#125;</code>：指明子程序使用SQL语句的限制。</p><ul><li><strong>CONTAINS SQL</strong>表示当前存储过程的子程序包含SQL语句，但是并不包含读写数据的SQL语句</li><li><strong>NO SQL</strong>表示当前存储过程的子程序中不包含任何SQL语句</li><li><strong>READS SQL DATA</strong>表示当前存储过程的子程序中包含读数据的SQL语句</li><li><strong>MODIFIES SQL DATE</strong>表示当前存储过程的子程序中包含写数据的SQL语句</li></ul><p><code>SQL SECURITY&#123;DEFINER | INVOKER&#125;</code>：执行当前存储过程的权限，即指明那些用户能够执行当前存储过程</p><ul><li><strong>DEFINER</strong>(默认指定值)表示只有当前存储过程的创建者或者定义者才能执行当前存储过程</li><li><strong>INVOKER</strong>表示拥有当前存储过程的访问权限的用户能够执行当前存储过程</li></ul><p><strong>COMMENT string</strong>：注释信息，可以用来描述存储过程</p><p>存储过程体中可以有多条SQL语句，如果仅仅一条SQL语句，则可以省略BEGIN和END。</p><p>编写存储过程并不是一件简单的事情，可能存储过程中需要复杂的SQL语句。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">BEGIN</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">END</span>: 中间包含了多个语句，每个语句都已<span class="token punctuation">;</span>号为结束符。</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">DECLARE</span>：用来声明变量，使用的位置在<span class="token keyword">BEGIN</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">END</span>语句中间，而且需要在其他语句使用之前进行变量的声明</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SET</span>：赋值语句，用于对变量进行赋值</pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">SELECT</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">INTO</span>：把从数据表中查询的结果存放到变量中，也就是为变量赋值</pre></td></tr></table></figure><p>需要设置新的结束标记</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">DELIMITER</span> 新的结束标志</pre></td></tr></table></figure><p>因为MySQL默认的语句结束符号为分号<code>;</code>。为了避免与存储过程中SQL语句结束符相冲突，需要使用DELIMITER改变存储过程的结束符。</p><p>当使用DELIMITER命令时，应该避免使用反斜杠，因为反斜杠是MySQL的转义字符。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 创建存储过程select_all_data()，查看employees表的所有数据 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">DELIMITER</span> $ <span class="token comment">/* 改变结束标志 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> select_all_data<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=5></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> <span class="token comment">/* 恢复默认结束标志 */</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* 存储过程的调用 */</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">CALL</span> select_all_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">/* 创建存储过程avg_employee_salary(),返回所有员工的平均工资 */</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> avg_employee_salary<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=17></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">OUT</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">创建存储过程show_min_salary(),查看emps表的最低薪资，并将最低薪资通过OUT参数ms输出 </span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_min_salary<span class="token punctuation">(</span><span class="token keyword">OUT</span> ms <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=28></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> ms </pre></td></tr><tr><td data-num=29></td><td><pre>	<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token comment">/* 调用,@表示用户定义的 */</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">CALL</span> show_min_salary<span class="token punctuation">(</span><span class="token variable">@ms</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token comment">/* 查看变量值 */</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@ms</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">IN</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token comment">创建存储过程show_someone_salary(),查看emps表的某个员工的薪资,</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token comment">并用IN参数empname输入员工名字</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_someone_salary<span class="token punctuation">(</span><span class="token operator">IN</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=46></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=47></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=48></td><td><pre>	<span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> empname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">CALL</span> show_someone_salary<span class="token punctuation">(</span><span class="token string">'Abel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@empname</span> :<span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token keyword">CALL</span> show_someone_salary<span class="token punctuation">(</span><span class="token variable">@empname</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token comment">IN 和 OUT</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token comment">创建存储过程show_someone_salary2()，查看emps表中的员工的薪资，</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token comment">并用IN参数empname输入员工姓名，用OUT参数empsalary输出员工薪资</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_someone_salary2<span class="token punctuation">(</span><span class="token operator">IN</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> empsalary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=66></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> empsalary </pre></td></tr><tr><td data-num=67></td><td><pre>	<span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=68></td><td><pre>	<span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> empname<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@empname</span> :<span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre><span class="token keyword">CALL</span> show_someone_salary2<span class="token punctuation">(</span><span class="token variable">@empanme</span><span class="token punctuation">,</span><span class="token variable">@empsalary</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=75></td><td><pre></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@empsalary</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token comment">INOUT</span></pre></td></tr><tr><td data-num=80></td><td><pre><span class="token comment">创建存储过程show_mgr_name(),查询某个员工领导的姓名，</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token comment">并用INOUT参数empname输入员工姓名再输出领导的姓名</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_mgr_name<span class="token punctuation">(</span><span class="token keyword">INOUT</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=85></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=86></td><td><pre>	<span class="token keyword">SELECT</span> last_name <span class="token keyword">INTO</span> empname</pre></td></tr><tr><td data-num=87></td><td><pre>	<span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=88></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num=89></td><td><pre>        <span class="token keyword">SELECT</span> manager_id</pre></td></tr><tr><td data-num=90></td><td><pre>        <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=91></td><td><pre>        <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> empname</pre></td></tr><tr><td data-num=92></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=94></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@empname</span> :<span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">CALL</span> show_mgr_name<span class="token punctuation">(</span><span class="token variable">@empname</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre></pre></td></tr><tr><td data-num=100></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@empname</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>如何调试</strong></p><p>在MySQL中，存储过程可以通过SELECT语句，把程序执行的中间结果查询出来，以此调试一个SQL语句的正确性。调试成功之后，把SELECT语句移到下一个SQL语句之后，再调试下一个SQL语句。这样逐步推进，就可以完成对存储过程中所有操作的调试了。也可以把存储过程中的SQL语句复制出来，逐段单独调试。</p><h3 id=存储函数><a class=anchor href=#存储函数>#</a> 存储函数</h3><p>MySQL支持自定义函数，调用方式与调用MySQL预定的系统函数一样。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre>CREAT <span class="token keyword">FUNCTION</span> 函数名<span class="token punctuation">(</span>参数名 参数类型<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">RETURNS</span> 返回值类型</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">[</span>characteristics<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=5></td><td><pre>	函数体 <span class="token comment">/* 函数体中肯定有RETURN语句 */</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">END</span></pre></td></tr></table></figure><p>参数列表：指定参数为IN, OUT或INOUT，只对PROCEDURE是合法的，FUNCTION中总是默认为IN参数。</p><p>RETURNS type语句表示函数返回数据的类型。</p><p>RETURN子句只能对FUNCTION做指定，对函数而言这是强制的。它用来指定函数的返回类型，而且函数体必须包含要给RETURN value语句。</p><p>characteristics创建函数时指定的对函数的约束。取值与创建存储过程时相同。</p><p>函数体也可以用BEGIN...END来表示SQL代码的开始和结束。如果函数体只有一条语句，也可省略BEGIN...END。</p><p>若在创建存储函数中报错<code>you might want to use the less safe log_bin_trust_function_creators variable</code>，有两种处理方法</p><ul><li>加上必要的函数特性<code>&#123;CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATE &#125;</code></li><li>创建函数之前执行<code>SET GLOBAL log_bin_trust_function_creators = 1</code></li></ul><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">创建存储函数，名称为email_by_name()，参数定义为空</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">该函数查询Abel的email，并返回，数据类型为字符串型</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> email_by_name<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 加函数特性 */</span></pre></td></tr><tr><td data-num=9></td><td><pre>		<span class="token keyword">DETERMINISTIC</span></pre></td></tr><tr><td data-num=10></td><td><pre>		<span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span></pre></td></tr><tr><td data-num=11></td><td><pre>		<span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">BEGIN</span> </pre></td></tr><tr><td data-num=13></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">SELECT</span> email <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">SELECT</span> email_by_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">/* 创建存储函数，名称为email_by_id()，参数传入emp_id，</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">该函数查询emp_id的email并返回，数据类型为字符串类型</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_bin_trust_function_creators <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> email_by_id<span class="token punctuation">(</span>emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">BEGIN</span> </pre></td></tr><tr><td data-num=30></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token keyword">SELECT</span> email <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">SELECT</span> email_by_id<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@emp_id</span> :<span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">SELECT</span> email_by_id<span class="token punctuation">(</span><span class="token variable">@emp_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>存储过程和存储函数的区别</strong></p><table><thead><tr><th></th><th>关键字</th><th>调用语法</th><th>返回值</th><th>应用场景</th></tr></thead><tbody><tr><td>存储过程</td><td>PROCEDURE</td><td>CALL存储过程()</td><td>理解为有0个或多个</td><td>一般用于更新</td></tr><tr><td>存储函数</td><td>FUNCTION</td><td>SELECT函数()</td><td>只能是一个</td><td>一般用于查询结果为一个值并返回时</td></tr></tbody></table><p>存储函数可以放在查询语句中使用，存储过程不行。反之，存储过程的功能更加强大，包括能够执行对表的操作(比如创建表，删除表)和事务操作，这些功能是存储函数不具备的。</p><h3 id=存储过程函数的增删改><a class=anchor href=#存储过程函数的增删改>#</a> 存储过程/函数的增删改</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 存储过程，存储函数的查看 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* 使用SHOW CREATE语句查看存储过程和函数的创建信息 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_mgr_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> count_by_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">/* 使用SHOW STATUS语句查看存储过程/函数的状态信息 */</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'show_max_salary'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SHOW</span> FUNTION <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'email_by_id'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">/* 从information_schema.Routines表中查看存储过程/函数的信息 */</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>Routines</pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">WHERE</span> ROUTINE_NAME <span class="token operator">=</span> <span class="token string">'email_by_id'</span> <span class="token operator">AND</span> ROUTINE_TYPE <span class="token operator">=</span> <span class="token string">'function'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>Routines</pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">WHERE</span> ROUTINE_NAME <span class="token operator">=</span> <span class="token string">'show_min_salary'</span> <span class="token operator">AND</span> ROUTINE_TYPE <span class="token operator">=</span> <span class="token string">'PROCEDURE'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/* 存储过程/函数的修改 */</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">PROCEDURE</span> show_max_salary</pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">SQL</span> SECURITY <span class="token keyword">INVOKER</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">COMMENT</span> <span class="token string">'查询最高工资'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">/* 存储过程/函数的删除 */</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> count_by_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> show_min_salary<span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>关于存储过程使用的争议</strong></p><p><strong>优点</strong></p><p>存储过程可以一次编译多次使用。存储过程只在创建时进行编译，之后的使用都不需要重新编译，这就提升了SQL的执行效率。</p><p>可以减少开发工作量。将代码封装成模块，实际上是编程的核心思想之一，这样可以把复杂的问题拆解成不同的模块，然后模块之间可以重复使用，在减少开发工作量的同时，还能保证代码的结构清晰。</p><p>存储过程的安全性强。在设定存储过程的时候可以设置对用户的使用权限，这样就和视图一样具有较强的安全性。</p><p><strong>缺点</strong></p><p>可移植性差。存储过程不能跨数据库移植，比如在MySQL，Oracle和SQL Server里编写的存储过程，在换成其他数据库时都需要重新编写。</p><p>调试困难。只有少数DBMS支持存储过程的调试。对于复杂的存储过程来说，开发和维护都不容易。虽然也有一些第三方工具可以对存储过程进行调试，但要收费。</p><p>存储过程的版本管理很困难。比如数据表索引发生变化了，可能会导致存储过程失效。在开发软件的时候往往需要进行版本管理，但是存储过程本身没有版本控制，版本迭代更新的时候很麻烦。</p><p>它不适合高并发的场景。高并发的场景需要减少数据库的压力，有时数据库会采用分库分表的方式，而且对可扩展性要求很高，在这种情况下，存储过程会变得难以维护，增加数据库的压力，虽然就不适用了。</p><p><strong>存储过程练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> test15_pro_func<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">USE</span> test15_pro_func<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">/* 创建存储过程insert_user()，实现传入用户名和密码，插入到admin表中 */</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> admin<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=6></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=7></td><td><pre>    user_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=8></td><td><pre>    pwd <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_user<span class="token punctuation">(</span><span class="token operator">IN</span> user_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">IN</span> pwd <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=15></td><td><pre>	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> admin<span class="token punctuation">(</span>user_name<span class="token punctuation">,</span>pwd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre>	<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>user_name<span class="token punctuation">,</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">CALL</span> insert_user<span class="token punctuation">(</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'abc123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> admin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token comment">/* 创建存储过程get_phone(),实现传入个人编号,返回个人姓名和个人电话 */</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> beauty<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=28></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=29></td><td><pre>    NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=30></td><td><pre>    phone <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=31></td><td><pre>    birth <span class="token keyword">DATE</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> beauty<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>phone<span class="token punctuation">,</span>birth<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">VALUES</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">(</span><span class="token string">'xxx1'</span><span class="token punctuation">,</span><span class="token string">'1311111111'</span><span class="token punctuation">,</span><span class="token string">'111112223232'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token punctuation">(</span><span class="token string">'xxx2'</span><span class="token punctuation">,</span><span class="token string">'1311111111'</span><span class="token punctuation">,</span><span class="token string">'111112223232'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token punctuation">(</span><span class="token string">'xxx3'</span><span class="token punctuation">,</span><span class="token string">'1311111111'</span><span class="token punctuation">,</span><span class="token string">'111112223232'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> beauty<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_phone<span class="token punctuation">(</span><span class="token operator">IN</span> id <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> phone <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=45></td><td><pre>	<span class="token keyword">SELECT</span> b<span class="token punctuation">.</span>name<span class="token punctuation">,</span>b<span class="token punctuation">.</span>phone <span class="token keyword">INTO</span> <span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>phone<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=46></td><td><pre>	<span class="token keyword">FROM</span> beauty b</pre></td></tr><tr><td data-num=47></td><td><pre>	<span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">CALL</span> get_phone<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token variable">@name</span><span class="token punctuation">,</span><span class="token variable">@phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@name</span><span class="token punctuation">,</span><span class="token variable">@phone</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token comment">/* 创建存储过程date_diff(),实现传入两个个人生日，返回日期间隔大小 */</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> date_diff<span class="token punctuation">(</span><span class="token operator">IN</span> birth1 <span class="token keyword">DATE</span><span class="token punctuation">,</span><span class="token operator">IN</span> birth2 <span class="token keyword">DATE</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> sum_date <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=58></td><td><pre>	<span class="token keyword">SELECT</span> DATEDIFF<span class="token punctuation">(</span>birth1<span class="token punctuation">,</span>birth2<span class="token punctuation">)</span> <span class="token keyword">INTO</span> sum_date<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@birth1</span> <span class="token operator">=</span> <span class="token string">'1992-09-08'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@birth2</span> <span class="token operator">=</span> <span class="token string">'1992-09-08'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">CALL</span> date_diff<span class="token punctuation">(</span><span class="token variable">@birth1</span><span class="token punctuation">,</span><span class="token variable">@birth2</span><span class="token punctuation">,</span><span class="token variable">@sum_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token comment">/* 创建存储过程format_date()，实现传入一个日期，格式化成xxxx年xx月xx日并返回 */</span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> format_date<span class="token punctuation">(</span><span class="token operator">IN</span> my_date <span class="token keyword">DATE</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> str_date <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=71></td><td><pre>	<span class="token keyword">SELECT</span> DATE_FORMAT<span class="token punctuation">(</span>my_date<span class="token punctuation">,</span><span class="token string">'%y年%m月%d日'</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> str_date<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token keyword">CALL</span> format_date<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@str</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@str</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token comment">/* 创建存储过程beauty_limit()，根据传入的起始索引和条目数，查询个人的记录 */</span></pre></td></tr><tr><td data-num=80></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> beauty_limit<span class="token punctuation">(</span><span class="token operator">IN</span> start_index <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token operator">IN</span> size <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=83></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> beauty <span class="token keyword">LIMIT</span> start_index<span class="token punctuation">,</span>size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=85></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre></pre></td></tr><tr><td data-num=87></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token keyword">CALL</span> beauty_limit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token comment">/* 创建带inout模式参数的存储过程 */</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token comment">/* 传入a和b两个值，最终a和b都翻倍并返回 */</span></pre></td></tr><tr><td data-num=92></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=93></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> add_double<span class="token punctuation">(</span><span class="token keyword">INOUT</span> a <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">INOUT</span> b <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=94></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=95></td><td><pre>	<span class="token keyword">SET</span> a <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=96></td><td><pre>	<span class="token keyword">SET</span> b <span class="token operator">=</span> b <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre></pre></td></tr><tr><td data-num=100></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=101></td><td><pre><span class="token keyword">CALL</span> add_double<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=102></td><td><pre></pre></td></tr><tr><td data-num=103></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@a</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token variable">@b</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=104></td><td><pre><span class="token keyword">CALL</span> add_double<span class="token punctuation">(</span><span class="token variable">@a</span><span class="token punctuation">,</span><span class="token variable">@b</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre></pre></td></tr><tr><td data-num=106></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@a</span><span class="token punctuation">,</span><span class="token variable">@b</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=107></td><td><pre></pre></td></tr><tr><td data-num=108></td><td><pre><span class="token comment">/* 删除之前的存储过程 */</span></pre></td></tr><tr><td data-num=109></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> beauty_limit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre></pre></td></tr><tr><td data-num=111></td><td><pre><span class="token comment">/* 查看题目存储过程的信息 */</span></pre></td></tr><tr><td data-num=112></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> add_double<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'add_%'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>存储函数练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">USE</span> test15_pro_func<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> departments</pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>departments<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">无参有返回</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">创建函数get_count(),返回公司的员工个数 </span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> get_count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">INT</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=19></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">SELECT</span> get_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token comment">有参有返回</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">创建函数ename_salary(),根据员工姓名，返回它的工资</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> ename_salary<span class="token punctuation">(</span>emp_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">DOUBLE</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=33></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> salary <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> emp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">SELECT</span> ename_salary<span class="token punctuation">(</span><span class="token string">'Abel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token comment">/* 创建函数dept_sal(),根据部门名，返回该部门的平均工资 */</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> dept_sal<span class="token punctuation">(</span>dept_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">DOUBLE</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=44></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token keyword">FROM</span> employees e <span class="token keyword">JOIN</span> departments d</pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token keyword">ON</span> e<span class="token punctuation">.</span>department_id <span class="token operator">=</span> d<span class="token punctuation">.</span>department_id</pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>department_name <span class="token operator">=</span> dept_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> departments<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">SELECT</span> dept_sal<span class="token punctuation">(</span><span class="token string">'Marketing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token comment">/* 创建函数add_float(),实现传入两个float，返回二者之和 */</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> add_float<span class="token punctuation">(</span>value1 <span class="token keyword">FLOAT</span><span class="token punctuation">,</span>value2 <span class="token keyword">FLOAT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">FLOAT</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=59></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> value1 <span class="token operator">+</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v1</span> :<span class="token operator">=</span> <span class="token number">12.2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v2</span> <span class="token operator">=</span> <span class="token number">2.3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">SELECT</span> add_float<span class="token punctuation">(</span><span class="token variable">@v1</span><span class="token punctuation">,</span><span class="token variable">@v2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=变量><a class=anchor href=#变量>#</a> 变量</h2><p>在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据。</p><p>在MySQL数据库中，变量分为系统变量以及用户自定义变量。</p><h3 id=系统变量><a class=anchor href=#系统变量>#</a> 系统变量</h3><p>变量有系统定义，不是用户定义，属于服务器层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性，特征。这些系统变量的值要么是编译MySQL时参数的默认值，要么时配置文件(例如my.ini等)中的参数值。</p><p>系统变量分为全局系统变量(需要添加global关键字)以及会话系统变量(需要添加session关键字)，有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为local变量。如果不写，默认会话级别。静态变量(在MySQL服务实例运行期间它们的值不能使用set动态修改)属于特殊的全局系统变量。</p><p>每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会高。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。</p><p>全局系统变量针对于所有会话(连接)有效，但不能跨重启。</p><p>会话系统变量针对于所有会话(连接)有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值。</p><p>会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。</p><p>在MySQL中有些系统变量只能是全局的，例如max_connections用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如character_set_client用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如pseudo_thread_id用于标记当前会话的MySQL连接ID。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 系统变量(全局系统变量，会话系统变量) vs 用户自定义变量 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> VARIABLES<span class="token punctuation">;</span><span class="token comment">/* 查询全局系统变量 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">SESSION</span> VARIABLES<span class="token punctuation">;</span><span class="token comment">/* 查询会话系统变量 */</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">SHOW</span> VARIABLES<span class="token punctuation">;</span><span class="token comment">/* 默认查询的是会话系统变量 */</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">/* 查询部分系统变量 */</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'admin_%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">SHOW</span> VARIABLES<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">查看指定系统变量</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">作为MySQL编码规范，MySQL中的系统变量以`两个@`开头，</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">其中“@@global”仅用于标记全局系统变量，如果会话系统变量不存在，</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">则标记全局系统变量</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">/* 查看指定的系统变量的值 */</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">SELECT</span> @<span class="token variable">@global.</span>变量名<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/* 查看指定的会话变量的值 */</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">SELECT</span> @<span class="token variable">@session.</span>变量名<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">/* 或者 */</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">SELECT</span> @@变量名<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token comment">修改系统变量的值</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">有些时候，数据库管理员需要修改系统变量的默认值，</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token comment">以便修改当前会话或者MySQL服务实质的属性，特征。具体方法：</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token comment">方式一：修改MySQL配置文件，继而修改MySQL系统变量的值(该方法需要重启MySQL服务)</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token comment">方式二：在MySQL服务运行期间，使用set命令重新设置系统变量的值</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">SET</span> @<span class="token variable">@global.max_connections</span> <span class="token operator">=</span> <span class="token number">161</span><span class="token punctuation">;</span><span class="token comment">/* 方式一 */</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> max_connections <span class="token operator">=</span> <span class="token number">171</span><span class="token punctuation">;</span><span class="token comment">/* 方式二 */</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token comment">/* 针对于当前的数据库实例是有效的，一旦重启mysql服务，就失效了 */</span></pre></td></tr><tr><td data-num=36></td><td><pre></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token comment">/* 会话系统变量 */</span></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">SET</span> @<span class="token variable">@session.character_set_client</span> <span class="token operator">=</span> <span class="token string">'gbk'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token keyword">SET</span> <span class="token keyword">SESSION</span> character_set_client <span class="token operator">=</span> <span class="token string">'gbk'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=用户变量><a class=anchor href=#用户变量>#</a> 用户变量</h3><p>用户变量是用户自己定义的，作为MySQL编码规范，MySQL中的用户变量以一个<code>@</code>开头。根据作用范围不同，又分为会话用户变量和局部变量。</p><ul><li>会话用户变量：作用域和会话变量一样，只对当前连接会话有效</li><li>局部变量：只在BEGIN和END语句块中有效。局部变量只能在存储过程和函数中使用</li></ul><p><strong>会话用户变量</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 方式一："="或":=" */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SET</span> @用户变量 <span class="token operator">=</span> 值<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SET</span> @用户变量 :<span class="token operator">=</span> 值<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* 方式二：":="或INTO关键字 */</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">SELECT</span> @用户变量 :<span class="token operator">=</span> 表达式<span class="token punctuation">[</span><span class="token keyword">FROM</span> 等子句<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SELECT</span> 表达式 <span class="token keyword">INTO</span> @用户变量 <span class="token punctuation">[</span><span class="token keyword">FROM</span> 等子句<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">/* 准备工作 */</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">USE</span> dbtest16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> departments</pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>departments<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> departments<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">/* 方式一 */</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@m1</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@m2</span> :<span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@sum</span> :<span class="token operator">=</span> <span class="token variable">@m1</span> <span class="token operator">+</span> <span class="token variable">@m2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">/* 方式二 */</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@count</span> :<span class="token operator">=</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@count</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> <span class="token variable">@avg_sal</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@avg_sal</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>局部变量</strong></p><p>定义：可以使用DECLARE语句定义一个局部变量。</p><p>作用域：仅仅在定义它的BEGIN....END中有效</p><p>位置：只能放在BEGIN...END中，而且只能放在第一句</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=2></td><td><pre>	<span class="token comment">/* 声明局部变量 */</span></pre></td></tr><tr><td data-num=3></td><td><pre>	<span class="token keyword">DECLARE</span> 变量<span class="token number">1</span> 变量数据类型 <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span> 变量默认值<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>	<span class="token keyword">DECLARE</span> 变量<span class="token number">2</span><span class="token punctuation">,</span>变量<span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>变量数据类型 <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span> 变量默认值<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>	</pre></td></tr><tr><td data-num=6></td><td><pre>	<span class="token comment">/* 局部变量赋值 */</span></pre></td></tr><tr><td data-num=7></td><td><pre>	<span class="token keyword">SET</span> 变量名<span class="token number">1</span> <span class="token operator">=</span> 值<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>	<span class="token keyword">SELECT</span> 值 <span class="token keyword">INTO</span> 变量<span class="token number">2</span> <span class="token punctuation">[</span><span class="token keyword">FROM</span> 子句<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>	</pre></td></tr><tr><td data-num=10></td><td><pre>	<span class="token comment">/* 查看局部变量的值 */</span></pre></td></tr><tr><td data-num=11></td><td><pre>	<span class="token keyword">SELECT</span> 变量<span class="token number">1</span><span class="token punctuation">,</span>变量<span class="token number">2</span><span class="token punctuation">,</span>变量<span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">END</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_var<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=17></td><td><pre>	<span class="token comment">/* 声明局部变量 */</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token keyword">DECLARE</span> a <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>	<span class="token keyword">DECLARE</span> b <span class="token keyword">INT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token keyword">DECLARE</span> emp_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>	</pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token comment">/* 局部变量赋值 */</span></pre></td></tr><tr><td data-num=23></td><td><pre>	<span class="token keyword">SET</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>	<span class="token keyword">SET</span> b :<span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>	</pre></td></tr><tr><td data-num=26></td><td><pre>	<span class="token keyword">SELECT</span> last_name <span class="token keyword">INTO</span> emp_name <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>	<span class="token keyword">SELECT</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>emp_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">CALL</span> test_var<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* 声明局部变量，并分别赋值为employees表中employee_id为102的last_name和salary   */</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_pro<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=38></td><td><pre>	<span class="token comment">/* 声明 */</span></pre></td></tr><tr><td data-num=39></td><td><pre>	<span class="token keyword">DECLARE</span> emp_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>	<span class="token keyword">DECLARE</span> sal <span class="token keyword">DOUBLE</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=42></td><td><pre>	<span class="token keyword">SELECT</span> last_name<span class="token punctuation">,</span>salary <span class="token keyword">INTO</span> emp_name<span class="token punctuation">,</span>sal</pre></td></tr><tr><td data-num=43></td><td><pre>	<span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=44></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>	<span class="token comment">/* 使用 */</span></pre></td></tr><tr><td data-num=46></td><td><pre>	<span class="token keyword">SELECT</span> emp_name<span class="token punctuation">,</span>sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token comment">/* 声明两个变量，求和并打印(分别使用会话用户变量，局部变量的方式实现) */</span></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token comment">/* 使用会话用户变量 */</span></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v1</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v2</span> :<span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@result</span> :<span class="token operator">=</span> <span class="token variable">@v1</span> <span class="token operator">+</span> <span class="token variable">@v2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token comment">/* 查看 */</span></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@result</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token comment">/* 使用局部变量 */</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> add_value<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=63></td><td><pre>	<span class="token comment">/* 声明 */</span></pre></td></tr><tr><td data-num=64></td><td><pre>	<span class="token keyword">DECLARE</span> value1<span class="token punctuation">,</span>value2 <span class="token keyword">INT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>	</pre></td></tr><tr><td data-num=66></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=67></td><td><pre>	<span class="token keyword">SET</span> value1 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>	<span class="token keyword">SET</span> value2 :<span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>	</pre></td></tr><tr><td data-num=70></td><td><pre>	<span class="token keyword">SET</span> sum_val <span class="token operator">=</span> value1 <span class="token operator">+</span> value2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=73></td><td><pre></pre></td></tr><tr><td data-num=74></td><td><pre><span class="token comment">/* 调用存储过程 */</span></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token keyword">CALL</span> add_value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre></pre></td></tr><tr><td data-num=77></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token comment">创建存储过程"different_salary"查询某员工和他领导的薪资差距，</span></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token comment">并用IN参数emp_id接收员工id,用OUT参数dif_salary输出薪资差距结果</span></pre></td></tr><tr><td data-num=80></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> different_salary<span class="token punctuation">(</span><span class="token operator">IN</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> dif_salary <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=84></td><td><pre>	<span class="token comment">/* 查询出emp_id员工的工资;查询出emp_id员工的管理者的id;查询管理者id的工资 */</span></pre></td></tr><tr><td data-num=85></td><td><pre>	<span class="token comment">/* 声明变量 */</span></pre></td></tr><tr><td data-num=86></td><td><pre>	<span class="token keyword">DECLARE</span> emp_sal <span class="token keyword">DOUBLE</span> <span class="token keyword">DEFAULT</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token comment">/* 记录员工的工资 */</span></pre></td></tr><tr><td data-num=87></td><td><pre>	<span class="token keyword">DECLARE</span> mgr_sal <span class="token keyword">DOUBLE</span> <span class="token keyword">DEFAULT</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token comment">/* 记录管理者的工资 */</span></pre></td></tr><tr><td data-num=88></td><td><pre>	<span class="token keyword">DECLARE</span> mgr_id <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/* 记录管理者的id */</span></pre></td></tr><tr><td data-num=89></td><td><pre>	</pre></td></tr><tr><td data-num=90></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=91></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> emp_sal <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=92></td><td><pre>	<span class="token keyword">SELECT</span> manager_id <span class="token keyword">INTO</span> mgr_id <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=94></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token comment">/* 调用存储过程 */</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@emp_id</span> :<span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@dif_sal</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre><span class="token keyword">CALL</span> different_salary<span class="token punctuation">(</span><span class="token variable">@emp_id</span><span class="token punctuation">,</span><span class="token variable">@dif_sal</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre></pre></td></tr><tr><td data-num=101></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@dif_sal</span><span class="token punctuation">;</span></pre></td></tr></table></figure><table><thead><tr><th></th><th>作用域</th><th>定义位置</th><th>语法</th></tr></thead><tbody><tr><td>会话用户变量</td><td>当前会话</td><td>会话的任何地方</td><td>加<code>@</code>符号，不用指定类型</td></tr><tr><td>局部变量</td><td>定义它的BEGIN END中</td><td>BEGIN END的第一句话</td><td>一般不用加<code>@</code>，需要指定类型</td></tr></tbody></table><h2 id=定义条件与处理程序><a class=anchor href=#定义条件与处理程序>#</a> 定义条件与处理程序</h2><p>定义条件是事先定义程序执行过程中可能遇到的问题，处理程序定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。</p><p>说明：定义条件和处理程序在存储过程，存储函数中都是支持的。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">错误代码：1364</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">Field 'email' doesn't have a default value</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees<span class="token punctuation">(</span>last_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 错误演示 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> UpdateDataNoCondition<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=12></td><td><pre>	<span class="token comment">/* </span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">	处理方式一</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">	DECLARE CONTINUE HANDLER FOR 1048 SET @prc_value = -1;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">	处理方式二</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">	DECLARE CONTINUE HANDLER FOR sqlstate '23000' SET @prc_VALUE = -1;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">	*/</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token keyword">SET</span> <span class="token variable">@x</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> email <span class="token operator">=</span> <span class="token boolean">NULL</span> <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token keyword">SET</span> <span class="token variable">@x</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> email <span class="token operator">=</span> <span class="token string">'aabbel'</span> <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token keyword">SET</span> <span class="token variable">@x</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">调用存储过程</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token comment">错误代码：1048</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token comment">Column 'email' cannot be null</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">CALL</span> UpdateDataNoCondition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>当@x变量的值为1。结合创建存储过程的SQL语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的SQL语句报错时，MySQL数据库会抛出错误，并退出当前SQL逻辑，不再向下进行执行。</p><h3 id=定义条件><a class=anchor href=#定义条件>#</a> 定义条件</h3><p>定义条件就是给MySQL中的错误码命名，这有助于存储的程序代码更清晰。它将一个错误名字和指定的错误条件关联起来。这个名字可以随后被用在定义处理程序的DECLARE HANDLER语句中。</p><p>定义条件使用DECLARE语句</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">DECLARE</span> 错误名称 CONDITION <span class="token keyword">FOR</span> 错误码<span class="token punctuation">(</span>或错误条件<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>错误码的说明</strong></p><p><code>MySQL_error_code</code>和<code>sqlstate_value</code>都可以表示MySQL的错误。</p><ul><li>MySQL_error_code是数值类型错误代码</li><li>sqlstate_value是长度为5的字符串类型错误代码</li></ul><p>在ERROR 1418(HY000)中，1418是MySQL_error_code，'HY000'是sqlstate_value。</p><p>在ERROR 1142(42000)中，1142是MySQL_error_code，'42000'是sqlstate_value。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">调用存储过程</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">错误代码：1048</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">Column 'email' cannot be null</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">CALL</span> UpdateDataNoCondition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">定义条件</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">格式：DECLARE错误名称 CONDITION FOR 错误码(或错误条件)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">举例1：定义"Field_Not_Be_NULL"错误名与MySQL中违反非空约束的错误类型</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">是"ERROR 1048 (23000)"对应</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">/* 使用MySQL_error_code */</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">DECLARE</span> Field_Not_Be_NULL CONDITION <span class="token keyword">FOR</span> <span class="token number">1048</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">/* 使用sqlstate_value */</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">DECLARE</span> FIeld_Not_Be_NULL CONDITION <span class="token keyword">FOR</span> SQLSTATE <span class="token string">'23000'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment">/* 定义ERROR 1148(42000)错误，名称command_not_allowed */</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">/* 方式一：使用MySQL_error_code */</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">DECLARE</span> command_not_allowed CONDITION <span class="token keyword">FOR</span> <span class="token number">1048</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token comment">/* 方式二：使用sqlstate_value */</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">DECLARE</span> command_not_allowed CONDITION <span class="token keyword">FOR</span> SQLSTATE <span class="token string">'23000'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=定义处理程序><a class=anchor href=#定义处理程序>#</a> 定义处理程序</h3><p>可以为SQL执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用DECLARE语句的语法如下<code>DECLARE 处理方式 HANDLER FOR 错误类型 处理语句</code></p><p>处理方式：处理方式有3个取值：CONTINUE，EXIT，UNDO</p><ul><li><strong>CONTINUE</strong>：表示遇到错误不处理，继续执行</li><li><strong>EXIT</strong>：表示遇到错误马上退出</li><li><strong>UNDO</strong>：表示遇到错误后撤回之前的操作。MySQL中暂时不支持这样的操作</li></ul><p>错误类型(即条件)可以有如下取值：</p><ul><li><strong>SQLSTATE '字符串错误码'</strong>：表示长度为5的sqlstate_value类型的错误代码</li><li><strong>MySQL_error_code</strong>：匹配数值类型错误代码</li><li><strong>错误名称</strong>：表示DECLARE...CONDITION定义的错误条件名称</li><li><strong>SQLWARNING</strong>：匹配所有以01开头的SQLSTATE错误条件名称</li><li><strong>NOT FOUND</strong>：匹配所有02开头的SQLSTATE错误代码</li><li><strong>SQLEXCEPTION</strong>：匹配所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE错误代码</li></ul><p>处理语句：如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像<code>&quot;SET 变量 = 值&quot;</code>这样的简单语句，也可以是使用BEGIN...END编写的复合语句。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 定义处理程序 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* 捕获sqlstate_value */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLSTATE <span class="token string">'42S02'</span> <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'NO_SUCH_TABLE'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* 捕获mysql_error_value */</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token number">1146</span> <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'NO_SUCH_TABLE'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 先定义条件，再调用 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">DECLARE</span> no_such_table CONDITION <span class="token keyword">FOR</span> <span class="token number">1146</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> NO_SUCH_TABLE <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'NO_SUCH_TABLE'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">/* 使用SQLWARNING */</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLWARNING <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'ERROR'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">/* 使用NOT FOUND */</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLEXCEPTION <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'NO_SUCH_TABLE'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/* 使用SQLEXCEPTION */</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLEXCEPTION <span class="token keyword">SET</span> <span class="token variable">@info</span> <span class="token operator">=</span> <span class="token string">'ERROR'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=流程控制><a class=anchor href=#流程控制>#</a> 流程控制</h2><p>解决复杂问题不可能通过一个SQL语句完成，需要执行多个SQL操作。流程控制语句的作用就是控制存储过程中SQL语句的执行顺序，是复杂操作必不可少的一部分。只要是执行的流程，流程就分为三大类：</p><ul><li>顺序结构 - 程序从上往下依次执行</li><li>分支结构 - 程序按条件进行选择执行，从两条或多条路径中选择一条执行</li><li>循环结构 - 程序满足一定条件下，重复执行一组语句</li></ul><p>针对于MySQL的流程控制语句主要有3类，只能用于存储程序</p><ul><li>条件判断语句 - IF语句和CASE语句</li><li>循环语句 - LOOP，WHILE和REPEAT语句</li><li>跳转语句 - ITERATE和LEAVE语句</li></ul><h3 id=分支结构><a class=anchor href=#分支结构>#</a> 分支结构</h3><p><strong>分支结构之IF</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* IF语句的语法结构是 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">IF</span> 表达式<span class="token number">1</span> <span class="token keyword">THEN</span> 操作<span class="token number">1</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">[</span><span class="token keyword">ELSE</span> <span class="token keyword">IF</span> 表达式<span class="token number">2</span> <span class="token keyword">THEN</span> 操作<span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">[</span><span class="token keyword">ELSE</span> 操作<span class="token operator">IN</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">END</span> <span class="token keyword">IF</span></pre></td></tr></table></figure><p>根据表达式的结果为TRUE或FALSE执行相应的语句。这里'[]'中的内容是可选的。</p><p>特点：不同的表达式对应不同的操作，使用在BEGIN...END中</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_if<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=4></td><td><pre>	<span class="token comment">/* 情况1：声明局部变量 */</span></pre></td></tr><tr><td data-num=5></td><td><pre>	<span class="token keyword">DECLARE</span> stu_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>	<span class="token keyword">IF</span> stu_name <span class="token operator">IS</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=7></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'stu_name is null'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    </pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token comment">/* 情况2：二选一 */</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">DECLARE</span> email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">IF</span> email <span class="token operator">IS</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=14></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'email is null'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=16></td><td><pre>    	<span class="token keyword">SELECT</span> <span class="token string">'email is not null'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    </pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">/* 情况3：多选一 */</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">DECLARE</span> age <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">IF</span> age <span class="token operator">></span> <span class="token number">40</span></pre></td></tr><tr><td data-num=22></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'中老年'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">ELSEIF</span> age <span class="token operator">></span> <span class="token number">18</span></pre></td></tr><tr><td data-num=24></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'青壮年'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">ELSEIF</span> age <span class="token operator">></span> <span class="token number">8</span></pre></td></tr><tr><td data-num=26></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'青少年'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=28></td><td><pre>    	<span class="token keyword">SELECT</span> <span class="token string">'婴幼儿'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    </pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">CALL</span> test_if<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> test_if<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token comment">声明存储过程"update_salary_by_eid1",定义IN参数emp_id,输入员工编号。</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">判断该员工薪资如果低于8000元并且入职时间超过5年，就涨薪500元，否则就不变</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_salary_by_eid1<span class="token punctuation">(</span><span class="token operator">IN</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=45></td><td><pre>	<span class="token comment">/* 声明局部变量 */</span></pre></td></tr><tr><td data-num=46></td><td><pre>	<span class="token keyword">DECLARE</span> emp_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>	<span class="token keyword">DECLARE</span> hire_year <span class="token keyword">DATE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>	</pre></td></tr><tr><td data-num=49></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=50></td><td><pre>	<span class="token keyword">SET</span> salary <span class="token keyword">INTO</span> emp_sal <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre>	<span class="token keyword">SELECT</span> DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>hire_date<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">365</span> <span class="token keyword">INTO</span> emp_hire_date </pre></td></tr><tr><td data-num=52></td><td><pre>	<span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>	</pre></td></tr><tr><td data-num=54></td><td><pre>	<span class="token keyword">IF</span> emp_sal <span class="token operator">&lt;</span> <span class="token number">8000</span> <span class="token operator">AND</span> hire_yaer <span class="token operator">>=</span> <span class="token number">5</span></pre></td></tr><tr><td data-num=55></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">500</span></pre></td></tr><tr><td data-num=56></td><td><pre>		<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">SELECT</span> DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>hire_date<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">365</span><span class="token punctuation">,</span>employee_id<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">WHERE</span> salary <span class="token operator">&lt;</span> <span class="token number">8000</span> <span class="token operator">AND</span> DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>hire_date<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">365</span> <span class="token operator">>=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> update_salary_by_eid1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token comment">声明存储过程“update_salary_by_eid3”，定义IN参数emp_id，输入员工编号</span></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token comment">判断该员工薪资如果地狱9000元，就更新薪资为9000元，薪资如果大于等于9000元且</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token comment">低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的薪资100元</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_salary_by_eid3<span class="token punctuation">(</span><span class="token operator">IN</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=74></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=75></td><td><pre>	<span class="token comment">/* 声明变量 */</span></pre></td></tr><tr><td data-num=76></td><td><pre>	<span class="token keyword">DECLARE</span> emp_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>	<span class="token keyword">DECLARE</span> bonus <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>	</pre></td></tr><tr><td data-num=79></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=80></td><td><pre>	<span class="token keyword">SELECT</span>  salary <span class="token keyword">INTO</span> emp_sal <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=81></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>	<span class="token keyword">SELECT</span> commission_pct <span class="token keyword">INTO</span> bonus <span class="token keyword">FROM</span> employees </pre></td></tr><tr><td data-num=83></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>    </pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token comment">/* 判断 */</span></pre></td></tr><tr><td data-num=86></td><td><pre>    <span class="token keyword">IF</span> emp_sal <span class="token operator">&lt;</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num=87></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num=88></td><td><pre>    	<span class="token keyword">WHERE</span> employee_id<span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    	</pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token keyword">ELSEIF</span> emp_sal <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">AND</span> bonus <span class="token operator">IS</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=91></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> commission_pct <span class="token operator">=</span> <span class="token number">0.01</span></pre></td></tr><tr><td data-num=92></td><td><pre>    	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=94></td><td><pre>    	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">100</span></pre></td></tr><tr><td data-num=95></td><td><pre>    	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=96></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>分支结构CASE</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CASE</span> 表达式</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">WHEN</span> 值<span class="token number">1</span> <span class="token keyword">THEN</span> 结果<span class="token number">1</span>或语句<span class="token number">1</span><span class="token punctuation">(</span>如果是语句，需要加分号<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">WHEN</span> 值<span class="token number">2</span> TEHN 结果<span class="token number">2</span>或语句<span class="token number">2</span><span class="token punctuation">(</span>如果是语句，需要加分号<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">ELSE</span> 结果n或语句n<span class="token punctuation">(</span>如果是语句，需要加分号<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">END</span> <span class="token punctuation">[</span><span class="token keyword">case</span><span class="token punctuation">]</span><span class="token punctuation">(</span>如果是放在<span class="token keyword">BEGIN</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">END</span>中需要加上<span class="token keyword">CASE</span>，如果放在<span class="token keyword">SELECT</span>后面不需要<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 分支结构.... */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_case<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=12></td><td><pre>	<span class="token keyword">DECLARE</span> var <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>	<span class="token keyword">CASE</span> var</pre></td></tr><tr><td data-num=14></td><td><pre>		<span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'var = 1'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>		<span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'var = 2'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>		<span class="token keyword">WHEN</span> <span class="token number">3</span> <span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'var = 3'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>		<span class="token keyword">ELSE</span> <span class="token keyword">SELECT</span> <span class="token string">'other value'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">DECLARE</span> var1 <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">CASE</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">WHEN</span> var1 <span class="token operator">></span> <span class="token number">100</span> <span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'三位数'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">WHEN</span> var1 <span class="token operator">>=</span> <span class="token number">10</span> <span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token string">'两位数'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">ELSE</span> <span class="token keyword">SELECT</span> <span class="token string">'个位数'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    </pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token comment">声明存储过程"update_salary_by_eid4", 定义IN参数emp_id，输入员工编号</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token comment">判断该员工薪资如果低于9000，就更新薪资9000元，薪资大于等于9000元且低于10000的，</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token comment">但是奖金比例为NULL，就更新奖金比例为0.01；</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">其他的涨薪100元</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_salary_by_eid4<span class="token punctuation">(</span><span class="token operator">IN</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=39></td><td><pre>	<span class="token comment">/* 局部变量的声明 */</span></pre></td></tr><tr><td data-num=40></td><td><pre>	<span class="token keyword">DECLARE</span> emp_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>	<span class="token keyword">DECLARE</span> bonus <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>	</pre></td></tr><tr><td data-num=43></td><td><pre>	<span class="token comment">/* 局部变量的赋值 */</span></pre></td></tr><tr><td data-num=44></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> emp_sal <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=45></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>	<span class="token keyword">SELECT</span> commission_pct <span class="token keyword">INTO</span> bonus <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=47></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>	</pre></td></tr><tr><td data-num=49></td><td><pre>	<span class="token keyword">CASE</span></pre></td></tr><tr><td data-num=50></td><td><pre>	<span class="token keyword">WHEN</span> emp_sal <span class="token operator">&lt;</span> <span class="token number">9000</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num=51></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>	<span class="token keyword">WHEN</span> emp_sal <span class="token operator">&lt;</span> <span class="token number">10000</span> <span class="token operator">AND</span> bonus <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees</pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token keyword">SET</span> commission_pct <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">CALL</span> update_salary_by_eid4<span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">WHERE</span> employee_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=66></td><td><pre><span class="token comment">声明存储过程update_salary_by_eid5,定义IN参数emp——id，输入员工编号。</span></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token comment">判断该员工的入职年限，如果是0年，，涨薪涨50；如果是1年，涨薪涨100；</span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token comment">如果是2年，涨薪涨200；如果是3年，涨薪涨300；如果是4年，涨薪涨400；其他的涨薪500</span></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_salary_by_eid5<span class="token punctuation">(</span><span class="token operator">IN</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=73></td><td><pre>	<span class="token keyword">DECLARE</span> hire_yaer <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>hire_date<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> hire_year</pre></td></tr><tr><td data-num=75></td><td><pre>	<span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>	</pre></td></tr><tr><td data-num=77></td><td><pre>	<span class="token keyword">CASE</span> hire_year</pre></td></tr><tr><td data-num=78></td><td><pre>		<span class="token keyword">WHEN</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">50</span></pre></td></tr><tr><td data-num=79></td><td><pre>		<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>        <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">100</span></pre></td></tr><tr><td data-num=81></td><td><pre>        <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>        <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">200</span></pre></td></tr><tr><td data-num=83></td><td><pre>        <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>		<span class="token keyword">WHEN</span> <span class="token number">3</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">300</span></pre></td></tr><tr><td data-num=85></td><td><pre>		<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre>        <span class="token keyword">WHEN</span> <span class="token number">4</span> <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">400</span></pre></td></tr><tr><td data-num=87></td><td><pre>        <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=88></td><td><pre>        <span class="token keyword">ELSE</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">CASE</span></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=循环结构><a class=anchor href=#循环结构>#</a> 循环结构</h3><p>LOOP循环语句用来重复执行某些语句。LOOP内的语句一直重复执行直到循环被退出(使用LEAVE子句)，跳出循环过程。</p><p>循环条件具备的4个要素</p><ul><li>初始化条件</li><li>循环条件</li><li>循环体</li><li>迭代条件</li></ul><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 循环结构之LOOP */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">[</span>loop_label:<span class="token punctuation">]</span> <span class="token keyword">LOOP</span></pre></td></tr><tr><td data-num=3></td><td><pre>	循环执行的语句</pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">END</span> <span class="token keyword">LOOP</span> <span class="token punctuation">[</span>loop_label<span class="token punctuation">]</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* loop_label表示LOOP语句的标注名称，该参数可以省略 */</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/* 例子 */</span></pre></td></tr><tr><td data-num=8></td><td><pre>loop_lab: <span class="token keyword">LOOP</span></pre></td></tr><tr><td data-num=9></td><td><pre>	<span class="token keyword">IF</span> avg_sal <span class="token operator">>=</span> <span class="token number">12000</span></pre></td></tr><tr><td data-num=10></td><td><pre>		<span class="token keyword">THEN</span> LLEAVE loop_lab<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">*</span> <span class="token number">1.1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">set</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">END</span> <span class="token keyword">LOOP</span> loop_lab<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/* 循环结构之WHILE */</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token punctuation">[</span>while_label:<span class="token punctuation">]</span> <span class="token keyword">WHILE</span> 循环条件 <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=20></td><td><pre>	循环体</pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">END</span> <span class="token keyword">WHILE</span> <span class="token punctuation">[</span>while_label<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">/* 例子 */</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">WHILE</span> avg_sal <span class="token operator">></span> <span class="token number">5000</span> <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=25></td><td><pre>	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>	<span class="token keyword">SET</span> while_count <span class="token operator">=</span> while_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>	</pre></td></tr><tr><td data-num=28></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 循环结构之WHILE */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">[</span>while_label:<span class="token punctuation">]</span> <span class="token keyword">WHILE</span> 循环条件 <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=3></td><td><pre>	循环体</pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">END</span> <span class="token keyword">WHILE</span> <span class="token punctuation">[</span>while_label<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">/* 例子 */</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">WHILE</span> avg_sal <span class="token operator">></span> <span class="token number">5000</span> <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=8></td><td><pre>	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>	<span class="token keyword">SET</span> while_count <span class="token operator">=</span> while_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>	</pre></td></tr><tr><td data-num=11></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 循环结构之REPEAT */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">[</span>repeat_label:<span class="token punctuation">]</span> <span class="token keyword">REPEAT</span></pre></td></tr><tr><td data-num=3></td><td><pre>	循环体</pre></td></tr><tr><td data-num=4></td><td><pre>UNTIL 结束循环的条件表达式</pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">END</span> <span class="token keyword">REPEAT</span> <span class="token punctuation">[</span>repeat_label<span class="token punctuation">]</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">当市场环境变好时，公司为了奖励大家，决定给大家涨工资。</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">声明存储过程update_salary_repeat(),声明OUT参数num,输出循环次数。</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">存储过程中实现循环给大家涨薪，涨薪涨为原来的1.15倍，直到全公司的平均</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">薪资达到13000结束，并统计循环次数</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_salary_repeat<span class="token punctuation">(</span><span class="token keyword">OUT</span> num <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">BEGIN</span> </pre></td></tr><tr><td data-num=16></td><td><pre>	<span class="token comment">/* 声明变量 */</span></pre></td></tr><tr><td data-num=17></td><td><pre>	<span class="token keyword">DECLARE</span> avg_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token keyword">DECLARE</span> while_count <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>	</pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>	</pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token keyword">REPEAT</span></pre></td></tr><tr><td data-num=23></td><td><pre>		<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary<span class="token operator">*</span> <span class="token number">1.15</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>		<span class="token keyword">SET</span> while_count <span class="token operator">=</span> while_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>		<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>		UNTIL avg_sal <span class="token operator">>=</span> <span class="token number">13000</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=跳转语句><a class=anchor href=#跳转语句>#</a> 跳转语句</h3><p><strong>LEAVE语句</strong>，可以使用在循环语句内，或者以BEGIN和END包裹起来的程序体内，表示跳出循环或者跳出从程序体的操作。可以把LEAVE理解为BREAK。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre>begin_label:<span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=2></td><td><pre>	<span class="token keyword">IF</span> num <span class="token operator">&lt;=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num=3></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">LEAVE</span> begin_label<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">ELSEIF</span> num <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num=5></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">ELSEIF</span> num <span class="token operator">=</span> <span class="token number">2</span></pre></td></tr><tr><td data-num=7></td><td><pre>    	<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>ITERATE语句，只能在循环语句内，表示重新开始循环，将执行顺序转到语句段开头处。ITERATE理解为CONTINUE。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre>loop_label:<span class="token keyword">LOOP</span></pre></td></tr><tr><td data-num=2></td><td><pre>	<span class="token keyword">SET</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>	<span class="token keyword">IF</span> num <span class="token operator">&lt;</span> <span class="token number">10</span></pre></td></tr><tr><td data-num=4></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">ITERATE</span> loop_label<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">ELSEIF</span> num <span class="token operator">></span> <span class="token number">15</span></pre></td></tr><tr><td data-num=6></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">LEAVE</span> loop_label<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=游标光标><a class=anchor href=#游标光标>#</a> 游标(光标)</h2><h3 id=概述-4><a class=anchor href=#概述-4>#</a> 概述</h3><p>虽然可以通过筛选条件WHERE和HAVING，或者是限定返回记录的关键字LIMIT返回一条记录，但是，却无法在结果集中像指针一样，向前定位一条记录，向后定位一条记录，或是随意定位到某一条记录，并对记录的数据进行处理。这种情况下，可以用游标。</p><p>游标，能够对结果集中的每一条记录进行定位，并对指向的记录中的数据进行操作的数据结构。游标让SQL这种面向集合的语言有了面向过程开发的能力。</p><p>在SQL中，游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。这里游标充当了指针的作用，可以通过操作游标来对数据进行操作。</p><p>MySQL中游标可以在存储过程和函数中使用。</p><h3 id=使用步骤><a class=anchor href=#使用步骤>#</a> 使用步骤</h3><p>游标必须在声明处理程序之前被声明，并且变量和条件还必须在声明游标或处理程序之前被声明。</p><p><strong>声明游标</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 在MySQL中 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">DECLARE</span> cursor_name <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> select_statement<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">要使用SELECT语句来获取数据结果集，而此时还没有开始遍历数据</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">这里select_satement代表的是SELECT语句，返回一个用用于创建游标的结果集</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">DECLARE</span> cur_emp <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>salary <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">DECLARE</span> cursor_fruit <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">SELECT</span> f_name<span class="token punctuation">,</span>f_price <span class="token keyword">FROM</span> fruits<span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>打开游标</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">OPEN</span> cursor_name</pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">当定义好游标之后，如果要使用游标，必须先打开游标。打开游标的时候SELECT语句的查询结果集</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">就会送到游标工作区，为后面的逐条读取结果集中的记录做准备</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">*/</span></pre></td></tr></table></figure><p><strong>使用游标(从游标中取得数据)</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">FETCH</span> cursor_name <span class="token keyword">INTO</span> var_name <span class="token punctuation">[</span><span class="token punctuation">,</span>var_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">这句的作用是使用cursor_name这个游标来读取当前行，并且将数据保存到var_name这个变量中，</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">游标指针指到下一行，如果游标读取的数据行有多个列名，则在INTO关键字后面赋值多个变量名即可</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">var_name必须在声明游标之前就定义好。</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment"></span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">游标的查询结果集中的字段数，必须跟INTO后面的变量数一致，否则，</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">在存储过程执行的时候，MySQL会提示错误。</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">*/</span></pre></td></tr></table></figure><p><strong>关闭游标</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CLOSE</span> cursor_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">/* 有OPEN就有CLOSE。因为游标会占用系统资源，如果不及时关闭，游标会一直保持到存储过程结束。 */</span></pre></td></tr></table></figure><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">创建存储过程get_count_by_limit_total_salary()，</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">声明IN参数 limit_total_salary,DOUBLE类型；</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">声明OUT参数 total_count,INT类型;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">函数的功能可以实现累加薪资最高的几个员工的薪资值，</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">直到薪资总和达到limit_total_salary参数的值，返回累加的人数给total_count</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_count_by_limit_total_salary<span class="token punctuation">(</span><span class="token operator">IN</span> limit_total_salary <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> total_count <span class="token keyword">INT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=12></td><td><pre>	<span class="token comment">/* 声明局部变量 */</span></pre></td></tr><tr><td data-num=13></td><td><pre>	<span class="token keyword">DECLARE</span> sum_sal <span class="token keyword">DOUBLE</span> <span class="token keyword">DEFAULT</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token comment">/* 记录累加的工资总额 */</span></pre></td></tr><tr><td data-num=14></td><td><pre>	<span class="token keyword">DECLARE</span> emp_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span><span class="token comment">/* 记录每一个员工的工资 */</span></pre></td></tr><tr><td data-num=15></td><td><pre>	<span class="token keyword">DECLARE</span> emp_count <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/* 记录累加的人数 */</span></pre></td></tr><tr><td data-num=16></td><td><pre>	</pre></td></tr><tr><td data-num=17></td><td><pre>	<span class="token comment">/* 声明游标 */</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token keyword">DECLARE</span> emp_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> salary <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=19></td><td><pre>	<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>	</pre></td></tr><tr><td data-num=21></td><td><pre>	<span class="token comment">/* 打开游标 */</span></pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token keyword">OPEN</span> emp_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>	</pre></td></tr><tr><td data-num=24></td><td><pre>	<span class="token keyword">REPEAT</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token comment">/* 使用游标 */</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token keyword">FETCH</span> emp_cursor <span class="token keyword">INTO</span> emp_sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        </pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token keyword">SET</span> sum_sal <span class="token operator">=</span> sum_sal <span class="token operator">+</span> emp_sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token keyword">SET</span> emp_count <span class="token operator">=</span> emp_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        UNTIL sum_sal <span class="token operator">>=</span> limit_total_salary</pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">SET</span> total_count <span class="token operator">=</span> emp_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token comment">/* 关闭游标 */</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token keyword">CLOSE</span> emp_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token keyword">CALL</span> get_count_by_limit_total_salary<span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">,</span><span class="token variable">@total_count</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@total_count</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=全局变量的持久化mysql80新特性><a class=anchor href=#全局变量的持久化mysql80新特性>#</a> 全局变量的持久化(MySQL8.0新特性)</h2><p>在MySQL数据库中，全局变量可以通过SET GLOBAL语句设置。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 例如，设置服务器语句超时的限制，可以通过设置系统变量max_execution_time来实现 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> MAX_ECECUTION_TIME <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">使用SET GLOBAL语句设置的变量值只会临时生效。</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">数据库重启后，服务器又会从MySQL配置文件中读取变量的默认值。</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* MySQL8.0版本新增了SET PERSIST命令，例如设置服务器最大连接数为1000 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SET</span> PERSIST max_connections <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">MySQL会将该命令的配置保存到数据目录下的mysqld-auto.cnf文件中，</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">下此启动时会读取该文件，用其中的配置来覆盖默认的配置文件</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">/* 查看全局变量max_connections的值 */</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%max_connections%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/* 设置全局变量max_connections的值 */</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">set</span> persist max_connections <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>课后练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 变量的使用 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* 准备工作 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> test16_var_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">USE</span> test15_pro_func<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> departments</pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>departments<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">/* 无参有返回 */</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">/* 创建函数get_count(),返回公司的员工个数 */</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> get_count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">INT</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token comment">/* 声明局部变量 */</span></pre></td></tr><tr><td data-num=21></td><td><pre>	<span class="token keyword">DECLARE</span> emp_count <span class="token keyword">INT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>	</pre></td></tr><tr><td data-num=23></td><td><pre>	<span class="token comment">/* 赋值 */</span></pre></td></tr><tr><td data-num=24></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> emp_count <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>	</pre></td></tr><tr><td data-num=26></td><td><pre>	<span class="token keyword">RETURN</span> emp_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=28></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">SELECT</span> get_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=31></td><td><pre></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token comment">/* 有参有返回 */</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token comment">/* 创建函数ename_salary(),根据员工姓名，返回它的工资 */</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> ename_salary<span class="token punctuation">(</span>emp_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">DOUBLE</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=38></td><td><pre>	<span class="token keyword">SET</span> <span class="token variable">@sal</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/* 声明变量,定义了一个会话变量 */</span></pre></td></tr><tr><td data-num=39></td><td><pre>	</pre></td></tr><tr><td data-num=40></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> <span class="token variable">@sal</span> <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=41></td><td><pre>	<span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> emp_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>	</pre></td></tr><tr><td data-num=43></td><td><pre>	<span class="token keyword">RETURN</span> <span class="token variable">@sal</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=45></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">SELECT</span> ename_salary<span class="token punctuation">(</span><span class="token string">'Abel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@sal</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token comment">/* 创建函数dept_sal(),根据部门名，返回该部门的平均工资 */</span></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> dept_sal<span class="token punctuation">(</span>dept_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">DOUBLE</span></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=56></td><td><pre>	<span class="token keyword">DECLARE</span> avg_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> avg_sal </pre></td></tr><tr><td data-num=58></td><td><pre>	<span class="token keyword">FROM</span> employees e <span class="token keyword">JOIN</span> departments d</pre></td></tr><tr><td data-num=59></td><td><pre>	<span class="token keyword">ON</span> e<span class="token punctuation">.</span>department_id <span class="token operator">=</span> d<span class="token punctuation">.</span>department_id</pre></td></tr><tr><td data-num=60></td><td><pre>	<span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>department <span class="token operator">=</span> dept_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>	</pre></td></tr><tr><td data-num=62></td><td><pre>	<span class="token keyword">RETURN</span> avg_sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre></pre></td></tr><tr><td data-num=66></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> departments<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token keyword">SELECT</span> dept_sal<span class="token punctuation">(</span><span class="token string">'Marketing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token comment">/* 创建函数add_float(),实现传入两个float,返回二者之和 */</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> add_float<span class="token punctuation">(</span>value1 <span class="token keyword">FLOAT</span><span class="token punctuation">,</span>value2 <span class="token keyword">FLOAT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">RETURN</span> <span class="token keyword">FLOAT</span></pre></td></tr><tr><td data-num=74></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=75></td><td><pre>	<span class="token keyword">DECLARE</span> sum_val <span class="token keyword">FLOAT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>	<span class="token keyword">SET</span> sum_val <span class="token operator">=</span> value1 <span class="token operator">+</span> value2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>	<span class="token keyword">RETURN</span> sum_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v1</span> :<span class="token operator">=</span> <span class="token number">12.2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@v2</span> <span class="token operator">=</span> <span class="token number">2.3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token keyword">SELECT</span> add_float<span class="token punctuation">(</span><span class="token variable">@v1</span><span class="token punctuation">,</span><span class="token variable">@v2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre></pre></td></tr><tr><td data-num=86></td><td><pre><span class="token comment">/* 流程控制 */</span></pre></td></tr><tr><td data-num=87></td><td><pre><span class="token comment">/* </span></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token comment">创建函数test_if_case(),实现传入成绩，如果成绩>90,返回A，</span></pre></td></tr><tr><td data-num=89></td><td><pre><span class="token comment">如果成绩>80，返回B,如果成绩>60，返回C,否则返回D。</span></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token comment">分别用if结构和case结构实现</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=92></td><td><pre><span class="token comment">/* if结构 */</span></pre></td></tr><tr><td data-num=93></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=94></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> test_if_case1<span class="token punctuation">(</span>score <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=95></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">CHAR</span></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=97></td><td><pre>	<span class="token keyword">DECLARE</span> score_level <span class="token keyword">CHAR</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre>	<span class="token keyword">IF</span> score <span class="token operator">></span> <span class="token number">90</span></pre></td></tr><tr><td data-num=99></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre>    <span class="token keyword">ELSEIF</span> score <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num=101></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=102></td><td><pre>    <span class="token keyword">ELSEIF</span> score <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num=103></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_levle <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=104></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=105></td><td><pre>    	<span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'D'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=106></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=107></td><td><pre>    </pre></td></tr><tr><td data-num=108></td><td><pre>    <span class="token keyword">RETURN</span> score_level<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=110></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=111></td><td><pre></pre></td></tr><tr><td data-num=112></td><td><pre><span class="token keyword">SELECT</span> test_if_case1<span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=113></td><td><pre></pre></td></tr><tr><td data-num=114></td><td><pre><span class="token comment">/* case结构 */</span></pre></td></tr><tr><td data-num=115></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=116></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> test_if_case2<span class="token punctuation">(</span>score <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=117></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">CHAR</span></pre></td></tr><tr><td data-num=118></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=119></td><td><pre>	<span class="token keyword">DECLARE</span> score_level <span class="token keyword">CHAR</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=120></td><td><pre>	<span class="token keyword">CASE</span></pre></td></tr><tr><td data-num=121></td><td><pre>	<span class="token keyword">WHEN</span> score <span class="token operator">></span> <span class="token number">90</span></pre></td></tr><tr><td data-num=122></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=123></td><td><pre>    <span class="token keyword">WHEN</span> score <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num=124></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=125></td><td><pre>    <span class="token keyword">WHEN</span> score <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num=126></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> score_levle <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=127></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=128></td><td><pre>    	<span class="token keyword">SET</span> score_level <span class="token operator">=</span> <span class="token string">'D'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=129></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=130></td><td><pre>    </pre></td></tr><tr><td data-num=131></td><td><pre>    <span class="token keyword">RETURN</span> score_level<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=132></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=133></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=134></td><td><pre></pre></td></tr><tr><td data-num=135></td><td><pre><span class="token keyword">SELECT</span> test_if_case2<span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=136></td><td><pre></pre></td></tr><tr><td data-num=137></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=138></td><td><pre><span class="token comment">创建存储过程test_if_pro(),传入工资值，如果工资值&lt;3000，则删除工资为此值的员工</span></pre></td></tr><tr><td data-num=139></td><td><pre><span class="token comment">如果3000&lt;=工资值&lt;=5000，则修改此工资值的员工涨薪1000，否则涨工资500</span></pre></td></tr><tr><td data-num=140></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=141></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=142></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_if_pro<span class="token punctuation">(</span><span class="token operator">IN</span> sal <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=143></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=144></td><td><pre>	<span class="token keyword">IF</span> sal <span class="token operator">&lt;</span> <span class="token number">3000</span></pre></td></tr><tr><td data-num=145></td><td><pre>		<span class="token keyword">THEN</span> <span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> salary <span class="token operator">=</span> sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=146></td><td><pre>    <span class="token keyword">ELSEIF</span> sal <span class="token operator">&lt;=</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num=147></td><td><pre>    	<span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">1000</span></pre></td></tr><tr><td data-num=148></td><td><pre>    	<span class="token keyword">WHERE</span> salary <span class="token operator">=</span> sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=149></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=150></td><td><pre>    	<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">+</span> <span class="token number">500</span></pre></td></tr><tr><td data-num=151></td><td><pre>    	<span class="token keyword">WHERE</span> salary <span class="token operator">=</span> sal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=152></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=153></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=154></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=155></td><td><pre></pre></td></tr><tr><td data-num=156></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=157></td><td><pre><span class="token comment">创建存储过程insert_data(),传入参数为IN的INT类型变量insert_count,</span></pre></td></tr><tr><td data-num=158></td><td><pre><span class="token comment">实现向admin表中批量插入insert_count条记录</span></pre></td></tr><tr><td data-num=159></td><td><pre><span class="token comment"> */</span></pre></td></tr><tr><td data-num=160></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> admin<span class="token punctuation">(</span></pre></td></tr><tr><td data-num=161></td><td><pre>    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=162></td><td><pre>    user_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=163></td><td><pre>    user_pwd <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num=164></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=165></td><td><pre></pre></td></tr><tr><td data-num=166></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=167></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_if_pro<span class="token punctuation">(</span><span class="token operator">IN</span> sal <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=168></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=169></td><td><pre>	<span class="token keyword">DECLARE</span> init_count <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=170></td><td><pre>	<span class="token keyword">WHILE</span> init_count <span class="token operator">&lt;=</span> insert_count <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=171></td><td><pre>		<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> admin<span class="token punctuation">(</span>user_name<span class="token punctuation">,</span>user_pwd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=172></td><td><pre>		<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span><span class="token string">'atguigu-'</span><span class="token punctuation">,</span>init_count<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=173></td><td><pre>		<span class="token keyword">SET</span> init_count <span class="token operator">=</span> init_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=174></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=175></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=176></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=177></td><td><pre></pre></td></tr><tr><td data-num=178></td><td><pre><span class="token keyword">CALL</span> insert_data<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=179></td><td><pre></pre></td></tr><tr><td data-num=180></td><td><pre><span class="token comment">/* 游标的使用 */</span></pre></td></tr><tr><td data-num=181></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=182></td><td><pre><span class="token comment">创建存储过程update_salary(),参数1为IN的INT型变量dept_id,表示部门id</span></pre></td></tr><tr><td data-num=183></td><td><pre><span class="token comment">参数2为IN的INT型变量change_sal_count，表示要调整薪资的员工个数。</span></pre></td></tr><tr><td data-num=184></td><td><pre><span class="token comment">查询指定id部门的员工信息，按照salary升序排列，根据hire_date的情况，</span></pre></td></tr><tr><td data-num=185></td><td><pre><span class="token comment">调整前change_sal_count个员工的薪资</span></pre></td></tr><tr><td data-num=186></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=187></td><td><pre><span class="token keyword">DELIMITER</span> $</pre></td></tr><tr><td data-num=188></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> test_if_pro<span class="token punctuation">(</span><span class="token operator">IN</span> sal <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=189></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=190></td><td><pre>	<span class="token comment">/* 声明变量 */</span></pre></td></tr><tr><td data-num=191></td><td><pre>	<span class="token keyword">DECLARE</span> emp_id <span class="token keyword">INT</span><span class="token punctuation">;</span><span class="token comment">/* 记录员工id */</span></pre></td></tr><tr><td data-num=192></td><td><pre>	<span class="token keyword">DECLARE</span> emp_hire_date <span class="token keyword">DATE</span><span class="token punctuation">;</span><span class="token comment">/* 记录员工入职时间 */</span></pre></td></tr><tr><td data-num=193></td><td><pre>	</pre></td></tr><tr><td data-num=194></td><td><pre>	<span class="token keyword">DECLARE</span> init_count <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* 用于表示循环结构的初始化条件 */</span></pre></td></tr><tr><td data-num=195></td><td><pre>	<span class="token keyword">DECLARE</span> add_sal_rate <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span><span class="token comment">/* 记录涨薪的比例 */</span></pre></td></tr><tr><td data-num=196></td><td><pre>	</pre></td></tr><tr><td data-num=197></td><td><pre>	<span class="token comment">/* 声明游标 */</span></pre></td></tr><tr><td data-num=198></td><td><pre>	<span class="token keyword">DECLARE</span> emp_curser <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span></pre></td></tr><tr><td data-num=199></td><td><pre>	<span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>hire_date <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=200></td><td><pre>	<span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> dept_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">ASC</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=201></td><td><pre>	</pre></td></tr><tr><td data-num=202></td><td><pre>	<span class="token comment">/* 打开游标 */</span></pre></td></tr><tr><td data-num=203></td><td><pre>	<span class="token keyword">OPEN</span> emp_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=204></td><td><pre>	</pre></td></tr><tr><td data-num=205></td><td><pre>	<span class="token keyword">WHILE</span> init_count <span class="token operator">&lt;=</span> chage_sal_count <span class="token keyword">DO</span></pre></td></tr><tr><td data-num=206></td><td><pre>		<span class="token comment">/* 使用游标 */</span></pre></td></tr><tr><td data-num=207></td><td><pre>		<span class="token keyword">FETCH</span> emp_cursor <span class="token keyword">INTO</span> emp_id<span class="token punctuation">,</span>emp_hire_date<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=208></td><td><pre>		<span class="token keyword">IF</span> <span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>emp_hire_date<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1995</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=209></td><td><pre>			<span class="token keyword">THEN</span> <span class="token keyword">SET</span> add_sal_rate <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=210></td><td><pre>        <span class="token keyword">ELSEIF</span> <span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>emp_hire_date<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1998</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=211></td><td><pre>        	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> add_sal_rate <span class="token operator">=</span> <span class="token number">1.15</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=212></td><td><pre>        <span class="token keyword">ELSEIF</span> <span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>emp_hire_date<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2001</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=213></td><td><pre>        	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> add_sal_rate <span class="token operator">=</span> <span class="token number">1.10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=214></td><td><pre>        <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num=215></td><td><pre>        	<span class="token keyword">THEN</span> <span class="token keyword">SET</span> add_sal_rate <span class="token operator">=</span> <span class="token number">1.05</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=216></td><td><pre>		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=217></td><td><pre>		</pre></td></tr><tr><td data-num=218></td><td><pre>		<span class="token comment">/* 涨薪操作 */</span></pre></td></tr><tr><td data-num=219></td><td><pre>		<span class="token keyword">UPDATE</span> employees <span class="token keyword">SET</span> salary <span class="token operator">=</span> salary <span class="token operator">*</span> add_sal_rate</pre></td></tr><tr><td data-num=220></td><td><pre>		<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=221></td><td><pre>		</pre></td></tr><tr><td data-num=222></td><td><pre>		<span class="token comment">/* 迭代条件更新 */</span></pre></td></tr><tr><td data-num=223></td><td><pre>		<span class="token keyword">SET</span> init_count <span class="token operator">=</span> init_count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=224></td><td><pre>    <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=225></td><td><pre>    </pre></td></tr><tr><td data-num=226></td><td><pre>    <span class="token comment">/* 关闭游标 */</span></pre></td></tr><tr><td data-num=227></td><td><pre>    <span class="token keyword">CLOSE</span> emp_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=228></td><td><pre><span class="token keyword">END</span> $</pre></td></tr><tr><td data-num=229></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=230></td><td><pre></pre></td></tr><tr><td data-num=231></td><td><pre><span class="token comment">/* 调用 */</span></pre></td></tr><tr><td data-num=232></td><td><pre><span class="token keyword">CALL</span> update_salary<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=233></td><td><pre></pre></td></tr><tr><td data-num=234></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>hire_date<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=235></td><td><pre><span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=236></td><td><pre><span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=237></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">ASC</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=触发器><a class=anchor href=#触发器>#</a> 触发器</h2><h3 id=概述-5><a class=anchor href=#概述-5>#</a> 概述</h3><p>在实际开发中，经常会遇到这样的情况：有2个或多个相互关联的表，如商品信息和库存信息分别放在2个不同的数据表中，当在添加一条商品记录的时候，为了保证数据的完整性，必须同时在库存表中添加一条记录。</p><p>这样一来，就必须把这两个关联的操作步骤写到程序里面，而且要用事务包裹起来，确保这两个操作成为一个原子操作，要么全部执行，要么全部不执行，要是遇到特殊情况，可能还需要对数据进行手动维护，这样就很容易忘记其中的一步，导致数据缺失。</p><p>这个时候，可以使用触发器，让商品信息数据的插入操作自动触发库存数据的插入操作。这样一来，就不用担心因忘记添加库存数据而导致的数据缺失了。</p><p>MySQL从5.0.2版本开始支持触发器。MySQL的触发器和存储过程一样，都是嵌入到MySQL服务器的一段程序。</p><p>触发器是由事件来触发某个操作，这些事件包括INSERT，UPDATE，DELETE事件。事件指用户的动作或者触发某项行为。如果定义了触发程序，这些数据库执行这些语句时，就相当于事件发生了，就会自动激发触发器执行相应的操作。</p><p>当对数据表中的数据执行插入，更新和删除操作，需要自动执行一些数据库逻辑时，可以使用触发器来实现。</p><h3 id=触发器的创建><a class=anchor href=#触发器的创建>#</a> 触发器的创建</h3><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> 触发器名称</pre></td></tr><tr><td data-num=2></td><td><pre>&#123;BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span>&#125;&#123;<span class="token keyword">INSERT</span> <span class="token operator">|</span> <span class="token keyword">UPDATE</span> <span class="token operator">|</span> <span class="token keyword">DELETE</span>&#125; <span class="token keyword">ON</span> 表名</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">FOR EACH ROW</span></pre></td></tr><tr><td data-num=4></td><td><pre>触发器执行的语句块<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">表名表示触发器监视对象</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">&#123;BEFORE | AFTER&#125;表示触发的时间。BEFORE表示在事件之前的触发；AFTER表示在事件之后的触发</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">&#123;INSERT | UPDATE | DELETE&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">- INSERT 表示插入记录时触发</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">- UPDATE 表示更新记录时触发</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">- DELETE 表示删除记录时触发</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">触发器执行的语句块：可以是单条SQL语句，也可以是由BEGIN...END结构组成的复合语句块</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">创建名称为after_insert的触发器，向test_trigger数据表插入数据后，</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">向test_trigger_log数据表中插入after_insert的日志信息</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> after_insert_test_tri</pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> test_trigger</pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">FOR EACH ROW</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=24></td><td><pre>	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_trigger_log<span class="token punctuation">(</span>t_log<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre>	<span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'after insert...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token comment">/* 测试 */</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_trigger<span class="token punctuation">(</span>t_note<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'Jerry1...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_trigger<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_trigger_log<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=查看删除触发器><a class=anchor href=#查看删除触发器>#</a> 查看/删除触发器</h3><p>查看触发器是查看数据库中已经存在的触发器的定义，状态和语法信息等。</p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 查看触发器 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">/* 方式1：查看档期那数据库的所有触发器的定义 */</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">SHOW</span> TRIGGERS\G<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">/* 方式2：查看当前数据库中某个触发器的定义 */</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> 触发器名<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">/* 方式3：从系统库information_schema的TRIGGERS表中查询salary_check_trigger触发器的信息 */</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>TRIGGERS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">/* 删除触发器 */</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> 触发器名<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=优缺点><a class=anchor href=#优缺点>#</a> 优缺点</h3><p><strong>优点</strong></p><ul><li>触发器可以确保数据的完整性</li><li>触发器可以记录操作日志</li><li>触发器还可以用在操作数据前，对数据进行合法性检查</li></ul><p><strong>缺点</strong></p><ul><li>可读性差</li><li>相关数据的变更，可能会导致触发器出错</li></ul><p>注意，如果子表中定义了外键约束，并且外键指定了ON UPDATE/DELETE CASCADE/SET NULL子句，此时修改父表被引用的键值或删除父表被引用的记录行时，也会引起子表的修改和删除操作，此时基于子表的UPDATE和DELETE语句定义的触发器并不会被激活。</p><p><strong>触发器练习/案例</strong></p><figure class="highlight sql"><figcaption data-lang=SQL></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">/* 准备工作 */</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> test17_trigger<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">USE</span> test17_trigger<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emps</pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary</pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">FROM</span> atguigudb<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">/* 复制一张emps表的空表emps_back,只有表结构，不包含任何数据 */</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emps_back</pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps</pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">WHERE</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">/* 查询emps_back表中的数据 */</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps_back<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment">创建触发器emps_insert_trigger,</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">每当向emps表中添加一条记录时，同步将这条记录添加到emps_back表中</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> emps_insert_trigger</pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> emps</pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">FOR EACH ROW</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=28></td><td><pre>	<span class="token comment">/* 将新添加到emps表中的记录添加到emps_back表中 */</span></pre></td></tr><tr><td data-num=29></td><td><pre>	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emps_back<span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>	<span class="token keyword">VALUES</span><span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span>NEW<span class="token punctuation">.</span>last_name<span class="token punctuation">,</span>NEW<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">/* 验证触发器是否起作用 */</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps_back<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps_back<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emps<span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>salary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span><span class="token string">'Tom1'</span><span class="token punctuation">,</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token comment">定义触发器salary_check_trigger,基于员工表employees的INSERT事件，</span></pre></td></tr><tr><td data-num=43></td><td><pre><span class="token comment">在INSERT之前检查将要添加的新员工薪资是否大于他领导的薪资，如果大于领导薪资，</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token comment">则报sqlstate_value为`HY000`的错误，从而使得添加失败</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token comment">*/</span></pre></td></tr><tr><td data-num=46></td><td><pre><span class="token comment">/* 准备工作 */</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees</pre></td></tr><tr><td data-num=48></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigude<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> departments</pre></td></tr><tr><td data-num=52></td><td><pre><span class="token keyword">AS</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> atguigude<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>departments<span class="token punctuation">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre></pre></td></tr><tr><td data-num=55></td><td><pre><span class="token keyword">DESC</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre></pre></td></tr><tr><td data-num=57></td><td><pre><span class="token comment">/* 创建触发器 */</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> salary_check_trigger</pre></td></tr><tr><td data-num=60></td><td><pre>BEFORE <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> employees</pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">FOR EACH ROW</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num=63></td><td><pre>	<span class="token comment">/* 查询到要添加的数据的manager的薪资 */</span></pre></td></tr><tr><td data-num=64></td><td><pre>	<span class="token keyword">DECLARE</span> mgr_sal <span class="token keyword">DOUBLE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>	</pre></td></tr><tr><td data-num=66></td><td><pre>	<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> mgr_sal <span class="token keyword">FROM</span> employees</pre></td></tr><tr><td data-num=67></td><td><pre>	<span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> NEW<span class="token punctuation">.</span>manager_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>	</pre></td></tr><tr><td data-num=69></td><td><pre>	<span class="token keyword">IF</span> NEW<span class="token punctuation">.</span>salary <span class="token operator">></span> mgr_sal</pre></td></tr><tr><td data-num=70></td><td><pre>		<span class="token keyword">THEN</span> SIGNAL SQLSTATE <span class="token string">'HY000'</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">'薪资高于领导薪资错误'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">END</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token keyword">DESC</span> employees<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre></pre></td></tr><tr><td data-num=77></td><td><pre><span class="token comment">/* 添加成功，依然触发了触发器salary_check_trigger的执行 */</span></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees<span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>hire_date<span class="token punctuation">,</span>job_id<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>manager_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'AD_VP'</span><span class="token punctuation">,</span><span class="token number">8000</span><span class="token punctuation">,</span><span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre><span class="token comment">/* 添加失败 */</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees<span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span>last_name<span class="token punctuation">,</span>email<span class="token punctuation">,</span>hire_date<span class="token punctuation">,</span>job_id<span class="token punctuation">,</span>salary<span class="token punctuation">,</span>manager_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=82></td><td><pre><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'tom@126.com'</span><span class="token punctuation">,</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'AD_VP'</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=mysql基础架构><a class=anchor href=#mysql基础架构>#</a> !MySQL基础架构</h2><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/database/4.webp alt=""></p><p><strong>MySQL主要由下面几部分构成</strong></p><ul><li><p><strong>连接器</strong> - 身份认证和权限相关(登录MySQL的时候)</p></li><li><p><strong>查询缓存</strong> - 执行查询语句的时候，会先查询缓存(MySQL 8.0版本后移除，因为这个功能不太实用)</p></li><li><p><strong>分析器</strong> - 没有命中缓存的话，SQL 语句就会经过分析器，分析器说白了就是要先看 SQL 语句要干嘛，再检查 SQL 语句语法是否正确</p></li><li><p><strong>优化器</strong> - 按照 MySQL 认为最优的方案去执行</p></li><li><p><strong>执行器</strong> - 执行语句，然后从存储引擎返回数据。 执行语句之前会先判断是否有权限，如果没有权限的话，就会报错</p></li><li><p><strong>插件式存储引擎</strong> - 主要负责数据的存储和读取，采用的是插件式架构，支持 InnoDB、MyISAM、Memory 等多种存储引擎</p></li></ul><h2 id=mysql存储引擎><a class=anchor href=#mysql存储引擎>#</a> !MySQL存储引擎</h2><p><strong>MySQL支持哪些存储引擎？默认使用哪个？</strong></p><p>MySQL支持多种存储引擎，可以通过<code>SHOW ENGINES</code>命令来查看MySQL支持的所有存储引擎。</p><p>MySQL当前默认的存储引擎是InnoDB。并且，所有的存储引擎中只有InnoDB是事务性存储引擎，也就是说只有InnoDB支持事务。</p><p>MySQL 5.5.5之前，MyISAM是MySQL的默认存储引擎。5.5.5版本之后，InnoDB是MySQL的默认存储引擎。</p><ul><li><p>可以通过<code>SELECT VERSION()</code>命令查看当前MySQL版本</p></li><li><p>可以通过 <code>SHOW VARIABLES LIKE '%storage_engine%'</code>命令直接查看MySQL当前默认的存储引擎</p></li></ul><p><strong>MyISAM和InnoDB有什么区别？</strong></p><p>虽然，MyISAM 的性能还行，各种特性也还不错(比如全文索引、压缩、空间函数等)。但是，MyISAM不支持事务和行级锁，而且最大的缺陷就是崩溃后无法安全恢复。</p><p><strong>是否支持行级锁</strong></p><p>MyISAM 不提供事务支持。</p><p>InnoDB 提供事务支持，实现了SQL标准定义了四个隔离级别，具有提交(commit)和回滚(rollback)事务的能力。并且，InnoDB默认使用的 REPEATABLE-READ(可重读)隔离级别是可以解决幻读问题发生的(基于 MVCC 和 Next-Key Lock)。</p><p><strong>是否支持外键</strong></p><p>MyISAM不支持，而InnoDB支持。</p><p>外键对于维护数据一致性非常有帮助，但是对性能有一定的损耗。因此，通常情况下，是不建议在实际生产项目中使用外键的，在业务代码中进行约束即可。</p><p>一般不建议在数据库层面使用外键的，应用层面可以解决。不过，这样会对数据的一致性造成威胁。具体要不要使用外键还是要根据项目来决定。</p><p><strong>是否支持数据库异常崩溃后的安全恢复</strong></p><p>MyISAM不支持，而InnoDB支持。</p><p>使用InnoDB的数据库在异常崩溃后，数据库重新启动的时候会保证数据库恢复到崩溃前的状态。这个恢复的过程依赖于<code>redo log</code> 。</p><p><strong>是否支持MVCC</strong></p><p>MyISAM不支持，而InnoDB支持。</p><p>讲真，这个对比有点废话，毕竟MyISAM连行级锁都不支持。MVCC可以看作是行级锁的一个升级，可以有效减少加锁操作，提高性能。</p><p><strong>索引实现不一样</strong></p><p>虽然MyISAM引擎和InnoDB引擎都是使用B+Tree作为索引结构，但是两者的实现方式不太一样。</p><p>InnoDB引擎中，其数据文件本身就是索引文件。相比MyISAM，索引文件和数据文件是分离的，其表数据文件本身就是按B+Tree组织的一个索引结构，树的叶节点data域保存了完整的数据记录。</p><p><strong>性能有差别</strong></p><p>InnoDB的性能比MyISAM更强大，不管是在读写混合模式下还是只读模式下，随着CPU核数的增加，InnoDB的读写能力呈线性增长。MyISAM因为读写不能并发，它的处理能力跟核数没关系。</p><p><strong>总结</strong></p><ul><li><p>InnoDB支持行级别的锁粒度，MyISAM不支持，只支持表级别的锁粒度</p></li><li><p>MyISAM不提供事务支持。InnoDB提供事务支持，实现了SQL标准定义了四个隔离级别</p></li><li><p>MyISAM不支持外键，而InnoDB支持</p></li><li><p>MyISAM不支持 MVCC，而InnoDB支持</p></li><li><p>虽然MyISAM引擎和InnoDB引擎都是使用B+Tree作为索引结构，但是两者的实现方式不太一样</p></li><li><p>MyISAM不支持数据库异常崩溃后的安全恢复，而InnoDB支持</p></li><li><p>InnoDB的性能比MyISAM更强大</p></li></ul><p><strong>MyISAM 和 InnoDB 如何选择？</strong></p><p>大多数时候使用的都是InnoDB存储引擎，在某些读密集的情况下，使用MyISAM也是合适的。不过，前提是项目不介意MyISAM不支持事务、崩溃恢复等缺点。</p><p>一般情况下选择InnoDB都是没有问题的，但是某些情况下并不在乎可扩展能力和并发能力，也不需要事务支持，也不在乎崩溃后的安全恢复问题的话，选择MyISAM也是一个不错的选择。但是一般情况下，都是需要考虑到这些问题的。</p><p>因此，对于日常开发的业务系统来说，几乎找不到什么理由再使用MyISAM作为自己的MySQL数据库的存储引擎。</p><h2 id=悲观锁与乐观锁><a class=anchor href=#悲观锁与乐观锁>#</a> !悲观锁与乐观锁</h2><p><strong>悲观锁</strong></p><p>当要对一个数据库中的一条数据进行修改的时候，为了避免同时被其他人修改，最好的办法就是直接对该数据进行加锁以防止并发。</p><p>这种借助数据库锁机制在修改数据之前先锁定，再修改的方式被称之为悲观并发控制(又名悲观锁，Pessimistic Concurrency Control - PCC)。之所以叫做悲观锁，是因为这是一种对数据的修改抱有悲观态度的并发控制方式。我们一般认为数据被并发修改的概率比较大，所以需要在修改之前先加锁。</p><p>悲观并发控制实际上是<strong>先取锁再访问</strong>的保守策略，为数据处理的安全提供了保证。但是在效率方面，处理加锁的机制会<strong>让数据库产生额外的开销</strong>，还有增加<strong>产生死锁</strong>的机会；另外，还会<strong>降低并行性</strong>，一个事务如果锁定了某行数据，其他事务就必须等待该事务处理完才可以处理那行数据。</p><p><strong>乐观锁</strong></p><p>乐观锁( Optimistic Locking ) 是相对悲观锁而言的，乐观锁假设数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回用户错误的信息，让用户决定如何去做。</p><p>相对于悲观锁，在对数据库进行处理的时候，乐观锁并不会使用数据库提供的锁机制。一般的实现乐观锁的方式就是记录数据版本。</p><p>乐观并发控制相信事务之间的数据竞争(data race)的概率是比较小的，因此尽可能直接做下去，直到提交的时候才去锁定，所以不会产生任何锁和死锁。</p><p><strong>数据库中乐观锁与悲观锁的区别?</strong></p><p><strong>悲观锁</strong></p><ul><li><p><strong>策略</strong> - 悲观锁假设冲突是常见的，因此在数据处理过程中(如读取或修改数据)会先锁定数据，防止其他事务对这些数据进行并发修改</p></li><li><p><strong>锁定行为</strong> - 事务在访问数据时直接进行锁定，其他事务必须等待锁释放后才能对数据进行操作</p></li><li><p><strong>适用场景</strong> - 适用于多事务竞争访问同一数据资源且冲突概率高的环境</p></li><li><p><strong>优点</strong> - 在高冲突环境中可以保持数据的一致性</p></li><li><p><strong>缺点</strong> - 可能降低并发性能，增加了死锁的可能性，同时锁定资源可能导致其他事务等待，影响系统的响应时间</p></li></ul><p><strong>乐观锁</strong></p><ul><li><p><strong>策略</strong> - 乐观锁假设冲突较少发生，不会在事务开始时就锁定数据。而是在事务提交的时候检查在事务执行期间是否发生了冲突</p></li><li><p><strong>冲突检测</strong> - 通常是通过数据版本号(如时间戳或者递增序列)来实现。在事务提交前，检查数据的版本号是否发生改变，如果改变了，表示有其他事务对数据进行了修改</p></li><li><p><strong>适用场景</strong> - 适用于冲突概率低，读多写少的应用环境</p></li><li><p><strong>优点</strong> - 提高了系统的并发性，因为大部分时间不需要锁定资源，减少了不必要的等待和锁竞争</p></li><li><p><strong>缺点</strong> - 如果冲突发生，可能需要额外的重试逻辑处理，并且在高并发冲突环境中可能会降低性能</p></li></ul><div class=tags><a href=/tags/database/ rel=tag><i class="ic i-tag"></i> 数据库</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span> <span class=text>更新于</span> <time title="修改时间：2025-09-19 22:24:59" itemprop=dateModified datetime=2025-09-19T22:24:59+08:00>2025-09-19</time></span><span class=item data-path=/computer-science/programming/database/mysql/mspart2/ title=阅读次数><span class=icon><i class="ic i-eye"></i></span> <span class=text>阅读次数</span><span class=waline-pageview-count></span> <span class=text>次</span></span></div><div id=copyright><ul><li class=author><strong>本文作者：</strong> ReverseSacle <i class="ic i-at"><em>@</em></i>逆转天平</li><li class=link><strong>本文链接：</strong> <a href=https://www.reversesacle.com/computer-science/programming/database/mysql/mspart2/ title=MySQL数据库基础-第二部分>https://www.reversesacle.com/computer-science/programming/database/mysql/mspart2/</a></li><li class=license><strong>版权声明：</strong> 本站所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class=post-nav><div class="item left"><a href=/computer-science/programming/database/mysql/mspart1/ itemprop=url rel=prev data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg21.webp title=MySQL数据库基础-第一部分><span class=type>上一篇</span><span class=category><i class="ic i-flag"></i> MySQL</span><h3>MySQL数据库基础-第一部分</h3></a></div><div class="item right"><a href=/computer-science/programming/web/hcpart1/ itemprop=url rel=next data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg16.webp title=HTML与CSS基础知识-第一部分><span class=type>下一篇</span><span class=category><i class="ic i-flag"></i> web</span><h3>HTML与CSS基础知识-第一部分</h3></a></div></div><div class=wrap id=comments><div id=waline-comment></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=文章目录><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BA%A6%E6%9D%9F><span class=toc-number>1.</span> <span class=toc-text>约束</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-number>1.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%9D%9E%E7%A9%BA%E7%BA%A6%E6%9D%9F><span class=toc-number>1.2.</span> <span class=toc-text>非空约束</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%94%AF%E4%B8%80%E6%80%A7%E7%BA%A6%E6%9D%9F><span class=toc-number>1.3.</span> <span class=toc-text>唯一性约束</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#primary-key%E7%BA%A6%E6%9D%9F><span class=toc-number>1.4.</span> <span class=toc-text>PRIMARY KEY约束</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#foreign-key%E7%BA%A6%E6%9D%9F><span class=toc-number>1.5.</span> <span class=toc-text>FOREIGN KEY约束</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%BA%A6%E6%9D%9F%E7%AD%89%E7%BA%A7><span class=toc-number>1.6.</span> <span class=toc-text>约束等级</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#check%E7%BA%A6%E6%9D%9F><span class=toc-number>1.7.</span> <span class=toc-text>CHECK约束</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#default%E7%BA%A6%E6%9D%9F><span class=toc-number>1.8.</span> <span class=toc-text>DEFAULT约束</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%A7%86%E5%9B%BE><span class=toc-number>2.</span> <span class=toc-text>视图</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-2><span class=toc-number>2.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE><span class=toc-number>2.2.</span> <span class=toc-text>创建视图</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE><span class=toc-number>2.3.</span> <span class=toc-text>查看视图</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE><span class=toc-number>2.4.</span> <span class=toc-text>更新视图</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BF%AE%E6%94%B9%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE><span class=toc-number>2.5.</span> <span class=toc-text>修改&#x2F;删除视图</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%A7%86%E5%9B%BE%E6%80%BB%E7%BB%93><span class=toc-number>2.6.</span> <span class=toc-text>视图总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0><span class=toc-number>3.</span> <span class=toc-text>存储过程与存储函数</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-3><span class=toc-number>3.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B><span class=toc-number>3.2.</span> <span class=toc-text>创建存储过程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0><span class=toc-number>3.3.</span> <span class=toc-text>存储函数</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9><span class=toc-number>3.4.</span> <span class=toc-text>存储过程&#x2F;函数的增删改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8F%98%E9%87%8F><span class=toc-number>4.</span> <span class=toc-text>变量</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F><span class=toc-number>4.1.</span> <span class=toc-text>系统变量</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F><span class=toc-number>4.2.</span> <span class=toc-text>用户变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6%E4%B8%8E%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F><span class=toc-number>5.</span> <span class=toc-text>定义条件与处理程序</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6><span class=toc-number>5.1.</span> <span class=toc-text>定义条件</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F><span class=toc-number>5.2.</span> <span class=toc-text>定义处理程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6><span class=toc-number>6.</span> <span class=toc-text>流程控制</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84><span class=toc-number>6.1.</span> <span class=toc-text>分支结构</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84><span class=toc-number>6.2.</span> <span class=toc-text>循环结构</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B7%B3%E8%BD%AC%E8%AF%AD%E5%8F%A5><span class=toc-number>6.3.</span> <span class=toc-text>跳转语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%B8%B8%E6%A0%87%E5%85%89%E6%A0%87><span class=toc-number>7.</span> <span class=toc-text>游标(光标)</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-4><span class=toc-number>7.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4><span class=toc-number>7.2.</span> <span class=toc-text>使用步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96mysql80%E6%96%B0%E7%89%B9%E6%80%A7><span class=toc-number>8.</span> <span class=toc-text>全局变量的持久化(MySQL8.0新特性)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%A7%A6%E5%8F%91%E5%99%A8><span class=toc-number>9.</span> <span class=toc-text>触发器</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-5><span class=toc-number>9.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA><span class=toc-number>9.2.</span> <span class=toc-text>触发器的创建</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9F%A5%E7%9C%8B%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8><span class=toc-number>9.3.</span> <span class=toc-text>查看&#x2F;删除触发器</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BC%98%E7%BC%BA%E7%82%B9><span class=toc-number>9.4.</span> <span class=toc-text>优缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#mysql%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84><span class=toc-number>10.</span> <span class=toc-text>!MySQL基础架构</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#mysql%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E><span class=toc-number>11.</span> <span class=toc-text>!MySQL存储引擎</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81><span class=toc-number>12.</span> <span class=toc-text>!悲观锁与乐观锁</span></a></li></ol></div><div class="related panel pjax" data-title=系列文章><ul><li><a href=/computer-science/programming/database/mysql/mspart1/ rel=bookmark title=MySQL数据库基础-第一部分>MySQL数据库基础-第一部分</a></li><li class=active><a href=/computer-science/programming/database/mysql/mspart2/ rel=bookmark title=MySQL数据库基础-第二部分>MySQL数据库基础-第二部分</a></li></ul></div><div class="overview panel" data-title=站点概览><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img class=image itemprop=image alt=ReverseSacle data-src=/images/avatar.webp><p class=name itemprop=name>ReverseSacle</p><div class=description itemprop=description>知识书库 & 学习点滴</div></div><nav class=state><div class="item posts"><a href=/archives/ ><span class=count>186</span> <span class=name>文章</span></a></div><div class="item categories"><a href=/categories/ ><span class=count>52</span> <span class=name>分类</span></a></div><div class="item tags"><a href=/tags/ ><span class=count>18</span> <span class=name>标签</span></a></div></nav><div class=social><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JldmVyc2VTYWNsZQ==" title=https:&#x2F;&#x2F;github.com&#x2F;ReverseSacle><i class="ic i-github"></i></span><span class="exturl item email" data-url="bWFpbHRvOnByaXZhdGVAcmV2ZXJzZXNhY2xlLmNvbQ==" title=mailto:private@reversesacle.com><i class="ic i-envelope"></i></span></div><ul class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i> 首页</a></li><li class="item dropdown"><a href=javascript:void(0);><i class="ic i-feather"></i> 文章</a><ul class=submenu><li class=item><a href=/archives/ rel=section><i class="ic i-list-alt"></i> 归档</a></li><li class=item><a href=/categories/ rel=section><i class="ic i-th"></i> 分类</a></li><li class=item><a href=/tags/ rel=section><i class="ic i-tags"></i> 标签</a></li></ul></li><li class=item><a href=/about/ rel=section><i class="ic i-user"></i> 关于</a></li><li class=item><a href=/friend-links/ rel=section><i class="ic i-heart"></i> 友链</a></li></ul></div></div></div><ul id=quick><li class="prev pjax"><a href=/computer-science/programming/database/mysql/mspart1/ rel=prev title=上一篇><i class="ic i-chevron-left"></i></a></li><li class=up><i class="ic i-arrow-up"></i></li><li class=down><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href=/computer-science/programming/web/hcpart1/ rel=next title=下一篇><i class="ic i-chevron-right"></i></a></li><li class=percent></li></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>随机文章</h2><ul><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/binary-tree/ title="分类于 二叉树">二叉树</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/binary-tree/sum/ title=二叉树-求和>二叉树-求和</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/network-programming/ title="分类于 网络编程">网络编程</a></div><span><a href=/computer-science/programming/network-programming/make-compiler-tool/ title=make编译工具>make编译工具</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/c-data-structure/ title="分类于 C语言数据结构">C语言数据结构</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/seqlist/ title=线性表之顺序表>线性表之顺序表</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/nonlinear-structure/binary-search-tree/ title=C语言-二叉排序(搜索&#x2F;查找)树>C语言-二叉排序(搜索/查找)树</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/nonlinear-structure/graph/ title=C语言-图>C语言-图</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/dynamic-program/ title="分类于 动态规划">动态规划</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/dynamic-program/derivatives/ title=动态规划问题派生>动态规划问题派生</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/algorithm/ title="分类于 算法">算法</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/algorithm/sort/ title="分类于 序列重组">序列重组</a></div><span><a href=/computer-science/programming/algorithm/sort/selection-sort/ title=选择排序>选择排序</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a></div><span><a href=/computer-science/programming/rust/rust-data-structure/linear-structure/seqlist/ title=Rust-顺序表>Rust-顺序表</a></span></li><li class=item><div class=breadcrumb><a href=/categories/general-science-and-technology/ title="分类于 通用科学技术">通用科学技术</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/ title="分类于 通用技术之PC端">通用技术之PC端</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/external-device/ title="分类于 外接设备">外接设备</a></div><span><a href=/general-science-and-technology/pc/external-device/external-screen-guidance/ title=外接显示屏DIY指南>外接显示屏DIY指南</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/linear-structure/doubly-link-list/ title=C语言-双向链表>C语言-双向链表</a></span></li></ul></div><div><h2>最新评论</h2><ul id=waline-recent></ul></div></div><div class=status><div class=copyright>&copy; 2021 – <span itemprop=copyrightYear>2025</span><span class=with-love><i class="ic i-sakura rotate"></i></span> <span class=author itemprop=copyrightHolder>ReverseSacle @ ReverseSacle-Blog</span></div><div class=count><i class="ic i-clock" aria-hidden=true></i> <span id=time align=center>载入时间中...<script defer>var now=new Date;function createtime(){var n=new Date("2021-11-16 22:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("time").innerHTML="已经过 "+dnum+" 天 "+hnum+" 小时 "+mnum+" 分 "+snum+" 秒 "}setInterval("createtime()",250)</script></span><span class=post-meta-item-icon>|&nbsp<i class="ic i-chart-area"></i></span> <span title=站点总字数>2.1m 字</span> <span class=post-meta-item-icon>|&nbsp<i class="ic i-coffee"></i></span> <span title=站点阅读时长>40:40</span></div></div></div></footer></div><script data-config>var LOCAL={path:"computer-science/programming/database/mysql/mspart2/",favicon:{show:"ReverseSacle-Blog",hide:"ReverseSacle-Blog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},waline:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src=https://polyfill.alicdn.com/v3/polyfill.min.js></script><script src=https://cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1.16.0/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js></script><script src=/js/app.js></script></body></html>