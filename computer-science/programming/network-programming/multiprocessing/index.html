<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#222><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/ico sizes=48x48 href=/images/favicon.ico><link rel=alternate type=application/rss+xml title=逆转天平 href=https://www.reversesacle.com/rss.xml><link rel=alternate type=application/atom+xml title=逆转天平 href=https://www.reversesacle.com/atom.xml><link rel=alternate type=application/json title=逆转天平 href=https://www.reversesacle.com/feed.json><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=/css/app.css><meta name=description content=网络编程><link rel=canonical href=https://www.reversesacle.com/computer-science/programming/network-programming/multiprocessing/ ><title>Linux多进程 - 网络编程 - 编程 - 计算机科学 | ReverseSacle-Blog</title><meta name=generator content="Hexo 6.3.0"></head><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=dotloader><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">Linux多进程</h1><div class=meta><span class=item title="创建时间：2023-07-31 15:33:55"><span class=icon><i class="ic i-calendar"></i></span> <span class=text>发表于</span> <time itemprop="dateCreated datePublished" datetime=2023-07-31T15:33:55+08:00>2023-07-31</time></span><span class=item title=本文字数><span class=icon><i class="ic i-pen"></i></span> <span class=text>本文字数</span> <span>21k</span> <span class=text>字</span></span><span class=item title=阅读时长><span class=icon><i class="ic i-clock"></i></span> <span class=text>阅读时长</span> <span>25 分钟</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div class=lines role=navigation aria-label=切换导航栏><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>ReverseSacle-Blog</a></li></ul><ul class=right><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id=imgs class=pjax><ul><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg16.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg15.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg13.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg5.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg3.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg10.webp></li></ul></div></header><div id=waves><svg class=waves xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink viewBox="0 24 150 28" preserveAspectRatio=none shape-rendering=auto><defs><path id=gentle-wave d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class=parallax><use xlink:href=#gentle-wave x=48 y=0 /><use xlink:href=#gentle-wave x=48 y=3 /><use xlink:href=#gentle-wave x=48 y=5 /><use xlink:href=#gentle-wave x=48 y=7 /></g></svg></div><main><div class=inner><div id=main class=pjax><div class="article wrap"><div class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i> <span><a href=/ >首页</a></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/ itemprop=item rel=index title="分类于 计算机科学"><span itemprop=name>计算机科学</span></a><meta itemprop=position content=1></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/ itemprop=item rel=index title="分类于 编程"><span itemprop=name>编程</span></a><meta itemprop=position content=2></span><i class="ic i-angle-right"></i> <span class=current itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/network-programming/ itemprop=item rel=index title="分类于 网络编程"><span itemprop=name>网络编程</span></a><meta itemprop=position content=3></span></div><article itemscope itemtype=http://schema.org/Article class="post block" lang=zh-CN><link itemprop=mainEntityOfPage href=https://www.reversesacle.com/computer-science/programming/network-programming/multiprocessing/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.webp><meta itemprop=name content=ReverseSacle><meta itemprop=description content="所见即所得，所思即所行, 知识书库 & 学习点滴"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=逆转天平></span><div class="body md" itemprop=articleBody><h2 id=概念><a class=anchor href=#概念>#</a> ! 概念</h2><p>进程是针对系统的一个概念。对开发者来说即程序，当输入指令执行一个程序时，这对系统而言，这就启动了一个进程。进程是在正在内存中运行的程序。在Linux系统中，一个进程在内存中有三部分数据，即<strong>代码段</strong>，<strong>堆栈段</strong>和<strong>数据段</strong></p><ul><li>代码段 - 存放了程序代码</li><li>堆栈段 - 存放了程序的返回地址，程序的参数和程序的局部变量</li><li>数据段 - 存放程序的全局变量，常数和动态内存分配的数据(malloc，new之类)</li></ul><p>系统如果同时运行多个相同的程序，它们的代码段是相同的，而堆栈段和数据段是不同的，即相同的程序，处理的数据不同。</p><p><strong>32位系统一个进程最多有多少堆内存？</strong></p><p>在32位的Linux系统中，一个进程的虚拟内存空间通常是4GB(2的32次方字节)。这个空间通常被平分为两部分，一半用于用户空间，一半用于内核空间。也就是说，一个进程最多可以拥有2GB的用户空间内存。</p><p>堆区位于用户空间，通常主要用于动态内存分配。所以理论上，一个进程最多可以拥有接近2GB的堆内存。但是，实际上可能不能使用全部的2GB，因为用户空间还包括了其他部分，如代码段、数据段、栈等。</p><p>需要注意的是，这个限制是可以配置的，有些Linux系统通过配置可以让一个进程的用户空间内存达到3GB或者更多。同时，这只是理论上的限制，实际使用中还需要考虑系统的其他资源限制，比如总的可用内存等。</p><p><strong>进程的组成部分有哪些？</strong></p><p>进程通常由进程控制块和相应的地址空间组成，Linux环境下，</p><p>进程控制块主要包含</p><ul><li>进程标识符(即进程ID)</li><li>进程的当前状态</li><li>相应的进程控制信息</li></ul><p>地址空间又可以分为</p><ul><li>文本段 - 存放相应的程序代码</li><li>用户数据段 - 存放相应的程序处理数据</li><li>系统数据段 - 存放相应的程序运行环境</li></ul><p><strong>进程的基本状态有哪些？</strong></p><p>创建、就绪、执行、等待和终止。</p><p><strong>进程间的通信方式有哪些？</strong></p><ul><li>匿名管道<code>pipe</code> - 半双工的通信方式，数据只能单向流动，且只能在有亲缘关系的进程间使用</li><li>有名管道<code>named pipe</code> - 与<code>pipe</code>相似，但允许在无亲缘关系的进程间使用</li><li>消息队列<code>message queue</code> - 消息链表，存放在内核中并由消息队列标识符进行标识，克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点</li><li>共享存储<code>shared memory</code> - 映射一段能够被其他进程访问的内存，一般与信号量配合使用</li><li>信号量<code>semophore</code> - 计数器，用来控制多个进程对共享资源的访问，常常作为锁机制，用于不同进程间或同一进程内不同线程间的同步</li><li>套接字<code>socket</code> - 可用于不同机器间的进程通信</li><li>信号<code>signal</code> - 比较复杂，用于通知进程某个事件已经发生</li></ul><p><strong>进程的上下文可以分为哪几个部分？</strong></p><ul><li>用户级上下文 - 正文、数据、用户堆栈以及共享存储区</li><li>寄存器上下文 - 通用寄存器、程序寄存器(IP)、处理器状态寄存器(EFLAGS)、栈指针(ESP)</li><li>系统级上下文 - 进程控制块(task_struct)、内存管理信息(mm_struct、vm_area_struct、pgd、pte)、内核栈</li></ul><p><strong>什么是进程切换/上下文切换？</strong></p><p>进程切换即上下文切换，是指处理器从一个进程切换到另一个进程，内核在处理器上对于进程进行以下操作</p><ul><li><p>挂起一个进程，将这个进程在处理器中的状态（即上下文）存储于内存中</p></li><li><p>在内存中检索下一个进程的上下文，并将其在CPU的寄存器中恢复</p></li><li><p>跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程</p></li></ul><p><strong>进程调度算法有哪几种？</strong></p><ul><li>先来先服务(FCFS) - 有利于长进程、CPU繁忙的进程，不利于短进程、I/O繁忙的进程</li><li>短作业优先(SJF) - 对预计执行时间短的进程优先分派处理机，通常后来的短进程不抢先正在执行的进程；相比于FCFS算法，SJF可以改善平均周转时间和平均带权周转时间，缩短进程的等待时间，提高系统的吞吐量，但是不利于长进程，而且未能根据进程的紧迫程度来划分优先级，以及难以准确估计进程的执行时间，从而影响性能</li><li>最高响应比优先(HRRN) - FCFS只考虑等待时间，SJF只考虑执行时间，而HRRN同时考虑每个作业的等待时间和执行时间，定义响应比<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>R</mi><mo>=</mo><mo stretchy=false>(</mo><mi>W</mi><mo>+</mo><mi>T</mi><mo stretchy=false>)</mo><mo>=</mo><mn>1</mn><mo>+</mo><mi>W</mi><mi mathvariant=normal>/</mi><mi>T</mi></mrow><annotation encoding=application/x-tex>R=(W+T)=1+W/T</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.68333em;vertical-align:0></span><span class="mord mathnormal" style=margin-right:.00773em>R</span><span class=mspace style=margin-right:.2777777777777778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2777777777777778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=mspace style=margin-right:.2222222222222222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222222222222222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=mclose>)</span><span class=mspace style=margin-right:.2777777777777778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2777777777777778em></span></span><span class=base><span class=strut style=height:.72777em;vertical-align:-.08333em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222222222222222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222222222222222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=mord>/</span><span class="mord mathnormal" style=margin-right:.13889em>T</span></span></span></span>，其中<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>W</mi></mrow><annotation encoding=application/x-tex>W</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.68333em;vertical-align:0></span><span class="mord mathnormal" style=margin-right:.13889em>W</span></span></span></span>为等待时间，<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>T</mi></mrow><annotation encoding=application/x-tex>T</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.68333em;vertical-align:0></span><span class="mord mathnormal" style=margin-right:.13889em>T</span></span></span></span>为执行时间；由于每次调度前都要计算响应比，系统开销相应增加</li><li>时间片轮转(RR) - 使得进程以FCFS的方式按时间片轮流使用CPU，每次调度时将CPU分派给队首进程，让其执行一个时间片，其长度从几ms到几百ms，当一个时间片结束时，发生时钟中断，调度程序据此暂停当前进程的执行，将其送到就绪队列的末尾，使其出让CPU，并通过上下文切换执行当前的队首进程；不利于处理紧急作业，而且时间片的大小对系统性能的影响很大，因此时间片的大小应适当<ul><li>那么应该如何确定时间片的大小？<ul><li>系统对响应时间的要求</li><li>就绪队列中进程的时间</li><li>系统的处理能力</li></ul></li></ul></li><li>多级反馈队列(MFQ) - 进程在不同优先级的队列间迁移，首先调度优先级高的队列中的进程，只有优先级高的队列为空时才去调度优先级低的队列中的进程；对于同一个队列中的进程，按照时间片轮转的方式进行调度，如果N个时间片后依然未能完成，则进入优先级低的队列等待；在低优先级的队列中的进程在运行时，又有新到达的作业，那么在运行完这个时间片后，CPU分配给新到达的作业，即抢占式</li></ul><p><strong>如何静态查询某一进程的具体信息？</strong></p><figure class="highlight shell"><figcaption data-lang=Bash></figcaption><table><tr><td data-num=1></td><td><pre><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> name</pre></td></tr></table></figure><h2 id=进程的编号><a class=anchor href=#进程的编号>#</a> 进程的编号</h2><ul><li><p><code>ps</code>命令 - 查看当前终端的进程</p><ul><li>UID - 启动进程的操作系统用户</li><li>PID - 进程编号</li><li>PPID - 进程的父进程的编号</li><li>C - CPU使用的资源百分比</li><li>STIME - 进程启动时间</li><li>TTY - 进程所属的终端</li><li>TIME - 进程使用掉的CPU时间</li><li>CMD - 进程执行的是什么命令</li></ul></li><li><p><code>ps -ef</code>命令 - 查看系统全部的进程</p></li><li><p><code>ps -ef | more</code>命令 - 查看系统全部的进程，结果分页显示</p><ul><li><code>|</code> 指管道输出</li><li><code>more</code>命令</li><li>把<code>ps -ef</code>这个命名通过管道<code>|</code>传给<code>more</code>命令</li></ul></li><li><p><code>ps -ef | grep book</code> - 查看系统全部进程，然后从结果中过滤出包含book字符的记录</p></li><li><p>c源文件中查看当前进程编号</p></li></ul><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"本程序的进程编号是：%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token comment">// 为了方便进程在shell下用`ps -ef | grep book`命令查看本进程的编号</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>进程的编号是系统动态分配的，相同的程序在不同的时间执行，进程的编号是不同的。</p><p>进程的编号会循环使用，但在同一时间，进程的编号是唯一的，即不管任何时间，系统不可能存在两个编号相同的进程。</p><h2 id=多进程><a class=anchor href=#多进程>#</a> ! 多进程</h2><p>充分利用CPU(多CPU，多核)资源。</p><p>实现并发。</p><h3 id=fork函数><a class=anchor href=#fork函数>#</a> fork函数</h3><ul><li>一个进程在运行中，当使用了fork函数就会产生另一个进程，即进程出现分叉</li><li>fork函数用于产生一个新的进程</li><li>函数声明 - <code>pid_t fork()</code><ul><li>返回值pid_t是一个整数</li><li>在父进程中，返回值就是子进程的编号</li><li>在子进程中，返回值是0</li></ul></li></ul><figure class="highlight c"><figcaption data-lang=c><span>案例</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"本程序的进程编号是: %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">int</span> ipid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// sleep等待进程的生成</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid = %d\n"</span><span class="token punctuation">,</span>ipid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> ipid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程编号是：%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程编号是: %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>fork函数创建了一个新的进程，新进程(子进程)与原有的进程(父进程)一模一样。子进程和父进程使用相同的代码段；子进程拷贝了父进程的堆栈段和数据段。子进程一旦开始运行，它复制了父进程的一切数据，然后各自运行，相互之间没有影响</li><li>fork函数对返回值做了特别处理，调用fork函数之后，在子进程中fork的返回值为0，在父进程中fork的返回值仍然是原进程的编号，可以通过fork的返回值来区分父进程和子进程，然后再执行不同的代码</li></ul><h3 id=相关案例><a class=anchor href=#相关案例>#</a> 相关案例</h3><p>验证子进程是复制父进程的内存变量，还是父进程与子进程内存共享？</p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        i <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程：i = %d,j = %d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        i <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>j <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程：i = %d,j = %d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>由父进程生成10个子进程，在子进程中显示它是第几个进程和子进程本身的进程编号。</p><p>此处的while循环的写法和for循环写法有区别</p><figure class="highlight c"><figcaption data-lang=c><span>for循环</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%d个子进程，编号为：%d\n"</span><span class="token punctuation">,</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>由父进程生成子进程，子进程再生成孙进程，共生成第10代进程，在各进程中显示它是第几代子进程和子进程本身的进程编号。</p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%d代子进程，编号为：%d\n"</span><span class="token punctuation">,</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>如何实现守护进程？</strong></p><p>首先，守护进程实在unix和Linux中后台运行的进程，它通常在系统引导的时候启动，系统关闭前结束</p><p>下面以Linux为例，描述一下创建一个简单的Linux守护进程的几个关键步骤</p><ol><li>调用fork()创建子进程。这使得父进程可以结束，这样新进程就不再是一个会话的领头进程，这是创建新会话的前提</li><li>在子进程中调用setsid()创建新的会话，当前进程成为新会话的领头进程和新进程组的组长进程。同时让进程摆脱原会话，原进程组的控制</li><li>调用fork()再次创建子进程，然后让第一子进程退出。这保证了该守护进程不是会话的领头进程，同时让它失去了在控制终端上打开文件的能力</li><li>改变当前的工作目录。守护进程应该在文件系统的根目录下运行，以防止它们阻止文件系统被卸载</li><li>重设文件权限掩码。将文件掩码设置为0确保守护进程具有最大的文件权限</li><li>关闭所有打开的文件描述符。因为守护进程不应在终端上打开文件</li><li>重定向标准输入、标准输出和错误输出流。因为守护进程和任何终端都不再关联，它们的标准输入、标准输出和标准错误(如果不关闭的话)也应该被重定向到/dev/null或者某个日志文件</li></ol><h2 id=linux进程之间的通信><a class=anchor href=#linux进程之间的通信>#</a> Linux进程之间的通信</h2><h3 id=概念-2><a class=anchor href=#概念-2>#</a> 概念</h3><ul><li>进程的数据空间是独立的，私有的，不能互相访问，在某些情况下进程之间需要通信来实现某功能或交换数据，包括<ul><li>数据传输 - 一个进程需要将他的数据发送给另一个进程</li><li>共享数据 - 多个进程想要操作共享数据，一个进程对共享数据的修改，别的进程应该立刻能看到</li><li>通知事件 - 一个进程需要向另一个或一组进程发送消息，通知它(它们)发生了某种事件(如通知进程退出)</li><li>进程控制 - 一个进程希望控制另一个进程的运行</li></ul></li></ul><h3 id=进程通信><a class=anchor href=#进程通信>#</a> 进程通信</h3><ul><li>进程通信的方式分为六种<ul><li>(<strong>没有实用价值</strong>)管道 - 包括无名管道(pipe)和命名管道(named pipe)<ul><li>无名管道用于父进程和子进程之间的通信</li><li>命名管道克服了管道没有名字的限制，除了具有管道所具有的功能外，还允许无亲缘关系进程间的通信</li></ul></li><li>(<strong>没有实用价值</strong>)消息队列(message) - 进程可向队列中添加消息，其他进程则可以读取队列中的消息</li><li>信号(signal) - 用于通知其他进程有某种事件的发生<ul><li>应用场景非常多，主要用于进程的控制，例如通知正在运行中的后台服务程序退出</li></ul></li><li>共享内存(shared memory) - 多个进程可以访问同一块内存空间<ul><li>进程之间采用共享内存交换数据的效率是最高的，由于共享内存没有加锁的机制，所以经常与信号灯结合一起使用，在高性能的网络服务端程序中，可以用共享内存作数据缓存(cache)</li></ul></li><li>信号量(semaphore) - 也称信号灯，用于进程之间对共享资源进行加锁</li><li>socket - 可用于不同计算机之间的进程间通信<ul><li>可以用于不同系统之间的进程通信</li><li>完全可以代替只能在同一系统中进程之间通信的管道和消息队列</li></ul></li></ul></li><li>共享内存和信号灯主要是用于多进程，多个进程和多个父子进程它们之间的数据交换。多线程由于可以共享变量，因此用不着</li></ul><h2 id=linux的共享内存shared-memory><a class=anchor href=#linux的共享内存shared-memory>#</a> Linux的共享内存(Shared Memory)</h2><h3 id=概念-3><a class=anchor href=#概念-3>#</a> ! 概念</h3><ul><li>共享内存就是允许多个进程访问同一个内存空间，是在多个进程之间共享和传递数据<strong>最高效</strong>的方式</li><li>操作系统将不同进程之间的共享内存安排在同一段物理内存，进程可以将共享内存连接到它们自己的地址空间，如果某个进程修改了共享内存中的数据，其他的进程读到的数据也将会改变</li><li>共享内存并未提供锁机制，即在某一个进程对共享内存进行读写的时候，不会阻止其他的进程对它的读写</li><li>如果要对共享内存的读/写加锁，可以使用信号灯</li></ul><p><strong>什么是临界区？进程进入临界区的调度原则是什么？</strong></p><p>临界区是一段针对共享资源的保护代码，该保护代码在任意时刻只允许一个线程对共享资源访问。</p><p>线程进入临界区的调度原则是</p><ul><li><p>如果有若干进程要求进入空闲的临界区，则每次只允许一个进程进入</p></li><li><p>任何时候，处于临界区内的进程不可多于一个</p></li><li><p>进入临界区的进程要在有限时间内退出，以便其他进程能及时进入临界区</p></li><li><p>如果进程不能进入临界区，则应让出CPU，避免进程出现忙等现象</p></li></ul><h3 id=相关函数><a class=anchor href=#相关函数>#</a> 相关函数</h3><ul><li>Linux提供了一组用于操作共享内存的函数，需包含以下头文件</li></ul><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/ipc.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/shm.h></span></span></pre></td></tr></table></figure><h4 id=shmget函数><a class=anchor href=#shmget函数>#</a> shmget函数</h4><ul><li>用于获取或创建共享内存</li><li>函数声明 - <code>int shmget(key_t key, size_t size, int shmflg)</code><ul><li>key - 是共享内存的键值(编号)，是一个整数<code>typedef unsigned int key_t</code>，是共享内存在系统中的编号。不同共享内存的编号不能相同，由开发者保证。key用十六进制表示比较好</li><li>size - 待创建的共享内存的大小，以字节为单位</li><li>shmflg - 共享内存的访问权限，与文件的权限一样，<code>0666|IPC_CREAT</code>表示全部用户对它可读写，如果共享内存不存在，就创建一个共享内存</li></ul></li></ul><h4 id=shmat函数><a class=anchor href=#shmat函数>#</a> shmat函数</h4><ul><li>把共享内存连接到当前进程的地址空间</li><li>函数声明 - <code>void* shmat(int shm_id, const void* shm_addr, int shmflg)</code><ul><li>shm_id - 由shmget函数返回的共享内存标识</li><li>shm_addr - 指定共享内存连接到当前进程中的地理位置，通常为空，表示让系统来选择共享内存的地址</li><li>shm_flg - 是一组标志位，通常为0</li></ul></li><li>调用成功时返回一个指向共享内存第一个字节的指针，如果调用失败返回-1</li></ul><h4 id=shmdt函数><a class=anchor href=#shmdt函数>#</a> shmdt函数</h4><ul><li>用于将共享内存从当前进程中分离，相当于shmat函数的反操作</li><li>函数声明 - <code>int shmdt(const void* shmaddr)</code><ul><li>shmaddr - 是shmat函数返回的地址</li><li>返回值 - 成功调用返回0，失败时返回-1</li></ul></li></ul><h4 id=shmctl函数><a class=anchor href=#shmctl函数>#</a> shmctl函数</h4><ul><li>用于删除共享内存</li><li>函数声明 - <code>int shmctl(int shm_id, int command, struct shmid_ds* buf)</code><ul><li>shm_id - 是shmget函数返回的共享内存标识符</li><li>command - 填入<code>IPC_RMID</code></li><li>buf - 填入0</li></ul></li><li>shmctl是控制共享内存的函数，其功能不只是删除共享内容，但其他的功能没什么用</li><li>用root用户创建的共享内存，不管创建的权限是什么，普通用户都无法删除</li></ul><figure class="highlight cpp"><figcaption data-lang=C++><span>案例</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/ipc.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/shm.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span><span class="token comment">// 共享内存标识符</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key_t<span class="token punctuation">)</span><span class="token number">0x5005</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shmat(0x5005) failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    </pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> ptext <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">// 用于指向共享内存的指针</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token comment">// 将共享内存连接到当前进程的地址空间，由ptext指针指向它</span></pre></td></tr><tr><td data-num=19></td><td><pre>    ptext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token comment">// 操作本程序的ptext指针，就是操作共享内存</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入前：%s\n"</span><span class="token punctuation">,</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>ptext<span class="token punctuation">,</span><span class="token string">"本程序的进程号是：%d"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入后：%s\n"</span><span class="token punctuation">,</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    </pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token comment">// 把共享内存从当前进程中分离</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 删除共享内存</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token comment">//if(-1 == shmctl(shmid,IPC_RMID,0))</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token comment">//&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token comment">//    printf("shmctl(0x5005) failed\n");</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token comment">//    return -1;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=linux的信号量><a class=anchor href=#linux的信号量>#</a> Linux的信号量</h2><h3 id=概念-4><a class=anchor href=#概念-4>#</a> 概念</h3><p>信号量(也称信号灯)，本质是一个计数器，用于协调多个进程(包括但不限于父子进程)对共享数据对象的读/写。它不以传送数据为目的，主要用来保护共享资源(信号量，消息队列，socket连接等)，保证共享资源在一个时刻只有一个进程独享。</p><p>信号量是一个特殊的变量，只允许进程对它进行等待信号和发送信号操作。</p><p>最简单的信号量是取值0和1的二元信号量，这是信号量最常见的形式。</p><p>通用信号量，可以取多个正整数值。</p><p>信号量集方面的知识比较复杂，应用场景比较少。</p><p>此处介绍二元信号量。</p><h3 id=相关函数-2><a class=anchor href=#相关函数-2>#</a> 相关函数</h3><ul><li>Linux提供了一组用于操作信号量的函数，需包含以下头文件</li></ul><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/ipc.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/sem.h></span></span></pre></td></tr></table></figure><h4 id=semget函数><a class=anchor href=#semget函数>#</a> semget函数</h4><ul><li>用于获取或创建信号量</li><li>函数声明 - <code>int semget(key_t key, int nsems, int semflg)</code><ul><li>key - 信号量的键值<code>typedef unsigned int key_t</code><ul><li>是信号量在系统中的编号，不同信号量的编号不能相同，由开发者保证。key用十六进制表示比较好</li></ul></li><li>nsems - 创建信号量集中信号量的个数，该参数只在创建信号量集时有效，这里固定填1</li><li>sem_flags - 是一组标志<ul><li>如果信号量不存在时创建一个新的信号量，可以和值<code>IPC_CREAT</code>做按位或操作</li><li>如果没有设置<code>IPC_CREAT</code>标志并且信号量不存在，就会返回错误(errno的值为0，即No such file or directory)</li></ul></li><li>返回值 - 成功返回信号量集的标识，失败返回-1，错误原因存储在error中</li></ul></li><li>示例</li></ul><p>获取键值为0x5000的信号量，如果该信号量不存在，就创建它</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">int</span> semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span><span class="token number">0x5000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>获取键值为0x5000的信号量，如果该信号量不存在，返回-1，errno的值被设置为2</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">int</span> semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span><span class="token number">0x5000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id=semctl函数><a class=anchor href=#semctl函数>#</a> semctl函数</h4><ul><li><p>用于控制信号量，常用于设置信号量的初始值和销毁信号量</p></li><li><p>函数声明 - <code>int semctl(int semid, int sem_num, int command, ...)</code></p><ul><li><p>semid - 由semget函数返回的信号量标识</p></li><li><p>sem_num - 是信号量集数组上的下标，表示某一个信号量，填0</p></li><li><p>command - 是对信号量操作的命令种类，常用以下两个</p><ul><li><code>IPC_RMID</code> - 销毁信号量，不需要第四个参数</li><li><code>SETVAL</code> - 初始化信号量的值(信号量成功创建后，需要设置初始值)，这个值由第四个参数决定</li></ul></li><li><p>第四个参数是一个自定义的共同体</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 用于信号灯操作的共同体</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">union</span> semun</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span><span class="token operator">*</span> buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">*</span> arry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>返回值 - 成功返回值非常复杂，失败返回-1</p></li></ul></li><li><p>示例</p><ul><li><p>销毁信号量</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><ul><li><p>初始化信号量的值为1，信号量可用</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">union</span> semun sem_union<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre>sem_union<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SETVAL<span class="token punctuation">,</span>sem_union<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul></li></ul><h4 id=semop函数><a class=anchor href=#semop函数>#</a> semop函数</h4><ul><li><p>该函数有两个功能</p><ul><li>等待信号量值变为1，如果等待成功便立即把信号量的值置0，这个过程也称为<strong>等待锁</strong></li><li>把信号量的值置为1，这个过程也称为<strong>释放锁</strong></li></ul></li><li><p>函数声明 - <code>int semop(int semid, struct sembuf* sops, unsigned nsops)</code></p><ul><li><p>semid - 由semget函数返回的信号量标识</p></li><li><p>sops - 一个结构体</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre>sturct sembuf</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">short</span> sem_num<span class="token punctuation">;</span><span class="token comment">// 信号量集的个数，单个信号此处置0</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">short</span> sem_op<span class="token punctuation">;</span><span class="token comment">// 信号量在本次操作中需要改变的数据；-1表示等待操作;1表示发送操作</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">short</span> sem_flg<span class="token punctuation">;</span><span class="token comment">// 把此处标志设置为SEM_UNDO，操作系统将跟踪这个信号量，</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// 如果当前进程退出时并没有释放信号量，操作系统将释放信号量，避免资源被死锁。</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>nsops - 操作信号量的个数，即sops结构体变量的个数，设置值为1(只对一个信号量的操作)</p></li></ul></li><li><p>示例</p><ul><li><p>等待信号量的值为1，如果等待成功，立即把信号量的值置0</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre>sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p>把信号量的值置0</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre>sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul></li></ul><p><strong>函数综合示例</strong></p><p>将信号量的操作封装成CSEM类，称为信号灯，类似互斥锁，包括初始化信号灯，等待信号灯，挂出信号灯和销毁信号灯</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;errno.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/ipc.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/sem.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">class</span> <span class="token class-name">CSEM</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token comment">// 用于信号灯操作的共同体</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">union</span> semun</pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span><span class="token operator">*</span> buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">*</span> arry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    </pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">int</span> sem_id<span class="token punctuation">;</span><span class="token comment">// 信号灯描述符</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token comment">// 如果信号灯已存在，获取信号灯</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token comment">// 如果信号灯不存在，则创建信号灯并初始化</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 等待信号灯挂出</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂出信号灯</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 销毁信号灯</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token comment">// 获取信号灯</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>sem_id <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token comment">// 如果信号灯不存在就创建</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> errno<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=38></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=39></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init 1 semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=42></td><td><pre>            <span class="token comment">// 信号灯创建成功后，还需初始化为可用的状态</span></pre></td></tr><tr><td data-num=43></td><td><pre>            <span class="token keyword">union</span> semun sem_union<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>            sem_union<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">semctl</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SETVAL<span class="token punctuation">,</span>sem_union<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=46></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=47></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init semctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=53></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init 2 semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=59></td><td><pre></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=62></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait semop()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=71></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=73></td><td><pre></pre></td></tr><tr><td data-num=74></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=76></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=82></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"post semop()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=87></td><td><pre></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=89></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semctl</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=92></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"destroy semctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=97></td><td><pre></pre></td></tr><tr><td data-num=98></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=99></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=100></td><td><pre>    CSEM sem<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre>    <span class="token comment">// 初始化信号灯</span></pre></td></tr><tr><td data-num=102></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">0x5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=103></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=104></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.init failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=106></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=107></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.init ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=108></td><td><pre>    </pre></td></tr><tr><td data-num=109></td><td><pre>    <span class="token comment">// 等待信号挂出，等待成功后，将持有锁</span></pre></td></tr><tr><td data-num=110></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=111></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=112></td><td><pre>        <span class="token function">pirntf</span><span class="token punctuation">(</span><span class="token string">"sem.wait failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=115></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.wait ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=116></td><td><pre>    </pre></td></tr><tr><td data-num=117></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在sleep过程中，运行其他的可执行程序将等待锁</span></pre></td></tr><tr><td data-num=118></td><td><pre>    </pre></td></tr><tr><td data-num=119></td><td><pre>    <span class="token comment">// 挂出信号灯，释放锁</span></pre></td></tr><tr><td data-num=120></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=121></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=122></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.post failde.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=123></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=124></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=125></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.poset ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=126></td><td><pre>    </pre></td></tr><tr><td data-num=127></td><td><pre>    <span class="token comment">// 销毁信号灯</span></pre></td></tr><tr><td data-num=128></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=129></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=130></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.destroy failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=131></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=132></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=133></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.destroy ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=134></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=135></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>利用信号灯给共享内存加锁</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;errno.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/ipc.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/shm.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/sem.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">class</span> <span class="token class-name">CSEM</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token comment">// 用于信号灯操作的共同体</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">union</span> semun</pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span><span class="token operator">*</span> buf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">*</span> arry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">int</span> sem_id<span class="token punctuation">;</span><span class="token comment">// 信号灯描述符</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token comment">// 如果信号灯已存在，获取信号灯</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token comment">// 如果信号灯不存在，则创建信号灯并初始化</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 等待信号灯挂出</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂出信号灯</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 销毁信号灯</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token comment">//获取信号灯</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>sem_id <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token comment">// 如果信号灯不存在就创建</span></pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> errno<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=38></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=39></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=40></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init 1 semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=43></td><td><pre>            <span class="token comment">// 信号灯创建成功后，还需初始化为可用的状态</span></pre></td></tr><tr><td data-num=44></td><td><pre>            <span class="token keyword">union</span> semun sem_union<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>            sem_union<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">semctl</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SETVAL<span class="token punctuation">,</span>sem_union<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=47></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=48></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init semctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num=53></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"init 2 semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=58></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=60></td><td><pre></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=68></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=69></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait semop()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=72></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=77></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    sem_b<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> SEM_UNDO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semop</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=82></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=83></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"post semop()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=86></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=87></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=88></td><td><pre></pre></td></tr><tr><td data-num=89></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">CSEM</span><span class="token double-colon punctuation">::</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=90></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">semctl</span><span class="token punctuation">(</span>sem_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=93></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"destroy semctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=96></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=98></td><td><pre></pre></td></tr><tr><td data-num=99></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=100></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=101></td><td><pre>     CSEM sem<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=102></td><td><pre>    <span class="token comment">// 初始化信号灯,与共享内存的键值不会起冲突</span></pre></td></tr><tr><td data-num=103></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">0x5005</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=104></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=105></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.init failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=106></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=107></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=108></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.init ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre>    </pre></td></tr><tr><td data-num=110></td><td><pre>	<span class="token keyword">int</span> shmid<span class="token punctuation">;</span><span class="token comment">// 共享内存标识符</span></pre></td></tr><tr><td data-num=111></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key_t<span class="token punctuation">)</span><span class="token number">0x5005</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">0640</span><span class="token operator">|</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=112></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=113></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shmat(0x5005) failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=115></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=116></td><td><pre>    </pre></td></tr><tr><td data-num=117></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> ptext <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 用于指向共享内存的指针</span></pre></td></tr><tr><td data-num=118></td><td><pre>    <span class="token comment">// 将共享内存连接到当前进程的地址空间，由ptext指针指向它</span></pre></td></tr><tr><td data-num=119></td><td><pre>    ptext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=120></td><td><pre>    </pre></td></tr><tr><td data-num=121></td><td><pre>    <span class="token comment">// 等待信号挂出，等待成功后，将持有锁</span></pre></td></tr><tr><td data-num=122></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=123></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=124></td><td><pre>        <span class="token function">pirntf</span><span class="token punctuation">(</span><span class="token string">"sem.wait failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=125></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=126></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=127></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.wait ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=128></td><td><pre>    </pre></td></tr><tr><td data-num=129></td><td><pre>    <span class="token comment">// 操作本程序的ptext指针，就是操作共享内存</span></pre></td></tr><tr><td data-num=130></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入前：%s\n"</span><span class="token punctuation">,</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=131></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>ptext<span class="token punctuation">,</span><span class="token string">"本程序的进程号是：%d"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=132></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入后：%s\n"</span><span class="token punctuation">,</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=133></td><td><pre>    </pre></td></tr><tr><td data-num=134></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=135></td><td><pre>    </pre></td></tr><tr><td data-num=136></td><td><pre>    <span class="token comment">// 挂出信号灯，释放锁</span></pre></td></tr><tr><td data-num=137></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> sem<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=138></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=139></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.post failde.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=140></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=141></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=142></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem.poset ok\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=143></td><td><pre>    </pre></td></tr><tr><td data-num=144></td><td><pre>    <span class="token comment">// 把共享内存从当前进程中分离</span></pre></td></tr><tr><td data-num=145></td><td><pre>    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=146></td><td><pre>    </pre></td></tr><tr><td data-num=147></td><td><pre>    <span class="token comment">// 删除共享内存</span></pre></td></tr><tr><td data-num=148></td><td><pre>    <span class="token comment">//if(-1 == shmctl(shmid,IPC_RMID,0))</span></pre></td></tr><tr><td data-num=149></td><td><pre>    <span class="token comment">//&#123;</span></pre></td></tr><tr><td data-num=150></td><td><pre>    <span class="token comment">//    printf("shmctl(0x5005) failed\n");</span></pre></td></tr><tr><td data-num=151></td><td><pre>    <span class="token comment">//    return -1;</span></pre></td></tr><tr><td data-num=152></td><td><pre>    <span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num=153></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=154></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=linux相关命令><a class=anchor href=#linux相关命令>#</a> Linux相关命令</h3><ul><li><code>ipcs -s</code> - 查看系统的信号量，内容有<ul><li>键值(key)</li><li>信号编号(semid)</li><li>创建者(owner)</li><li>权限(perms)</li><li>信号量数(nsems)</li></ul></li><li><code>ipcrm -sem 信号量编号</code> - 手动删除信号量</li></ul><h2 id=多进程的应用><a class=anchor href=#多进程的应用>#</a> 多进程的应用</h2><p><code>shell</code>(-bash) - 终端</p><p>Linux系统在启动的时候，会启动两个进程，进程编号为1和2，再由这个两个进程来启动其他进程。</p><p>当客户端创建一个会话时，Linux系统的shell就会启动一个子进程。</p><p>在Linux系统的shell下执行一个命令，其本质就是shell使用fork来创建一个子进程去执行输入的命令。</p><p><code>ssh</code>服务端(sshd)就是一个多进程的服务程序，由系统启动，每当有客户端连接，就会创建一个子进程。</p><h2 id=多进程并发的网络服务端><a class=anchor href=#多进程并发的网络服务端>#</a> 多进程并发的网络服务端</h2><h3 id=单进程><a class=anchor href=#单进程>#</a> <strong>单进程</strong></h3><details class=info><summary>server.c</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        </pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//程序直接退出，析构函数会释放资源   </span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><details class=info><summary>client.c</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpClient TcpClient<span class="token punctuation">;</span><span class="token comment">// 创建客户端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    </pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token string">"172.21.0.3"</span><span class="token punctuation">,</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"172.21.0.3\",5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    </pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token comment">// 例如循环，与服务端进行N次交互</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">"第%d个\n"</span><span class="token punctuation">,</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token comment">// 先服务端发送请求报文</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        </pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token comment">// 接收服务端的回应报文</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strubuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h3 id=多进程-2><a class=anchor href=#多进程-2>#</a> 多进程</h3><details class=info><summary>server.c</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=26></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=28></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre></pre></td></tr><tr><td data-num=31></td><td><pre>            <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=32></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>            <span class="token comment">//向客户端发送响应报文</span></pre></td></tr><tr><td data-num=34></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><details class=info><summary>client.c</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpClient TcpClient<span class="token punctuation">;</span><span class="token comment">// 创建客户端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    </pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token string">"172.21.0.3"</span><span class="token punctuation">,</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"172.21.0.3\",5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    </pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token comment">// 例如循环，与服务端进行N次交互</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">" %d : 第%d个\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token comment">// 先服务端发送请求报文</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        </pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token comment">// 接收服务端的回应报文</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strubuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h3 id=解决僵尸进程><a class=anchor href=#解决僵尸进程>#</a> ! 解决僵尸进程</h3><p>当子进程比父进程先结束，而父进程又没有回收子进程，释放子进程占用的资源，此时子进程将成为一个僵尸进程。如果父进程先退出，子进程被系统接管，子进程退出后系统会回收其占用的相关资源。</p><p>实际开发中，通过添加忽略子进程退出的信号，可解决此问题。</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>什么是孤儿进程？什么是僵尸进程？僵尸进程有什么危害？如何解决？</strong></p><ul><li><p>孤儿进程：一个父进程退出，而它的一个或多个子进程还在运行，那么这些子进程将成为孤儿进程，将被<code>init</code>进程（进程号为1）所收养，并由<code>init</code>进程对这些子进程完成状态收集工作</p></li><li><p>僵尸进程：一个进程使用<code>fork</code>创建子进程，如果子进程退出，而父进程并未调用<code>wait</code>或<code>waitpid</code>来获取子进程的状态信息，子进程的进程描述符仍然保存在系统中，那么这种子进程将成为僵尸进程</p><p>僵尸进程的危害：在子进程退出的时候，内核释放该子进程所有的资源，但仍保留进程号、退出状态、运行时间等信息，直到父进程通过<code>wait</code>或<code>waitpid</code>对其进行释放；但如果父进程不对保留信息进行释放，进程号会一直被占用，然而系统所能使用的进程号是有限的，如果产生大量的僵尸进程，系统将因没有可用的进程号而导致系统不能产生新的进程</p><p>解决僵尸进程的方法</p><ul><li>父进程通过<code>wait</code>和<code>waitpid</code>等函数等待子进程结束，但这样会导致父进程挂起</li><li>如果父进程很忙，那么可用<code>signal</code>函数为<code>SIGCHLD</code>安装<code>handler</code>，这样当子进程结束后，父进程会收到信号，在<code>handler</code>中调用<code>wait</code>回收</li><li>如果父进程不关心子进程何时结束，那么可以用<code>signal(SIGCHLD, SIG_IGN)</code>通知内核，这样当子进程结束后，内核会对其进行回收</li><li><code>fork</code>两次，父进程<code>fork</code>一个子进程后继续工作，子进程<code>fork</code>一个孙进程后退出，那么孙进程将被<code>init</code>接管，这样当子进程结束后，内核会对其进行回收</li></ul></li></ul><h3 id=关闭多余的socket><a class=anchor href=#关闭多余的socket>#</a> 关闭多余的socket</h3><p>父进程与子进程都会建立listensock和clientsock，相当于翻了4倍，Linux中打开文件的数量是有限的，这造成了严重的浪费。</p><p>每个进程是相互独立的，每个进程的socket连接的状态不会影响其他进程。</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>            TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程要关闭客户端连接上来的socket(m_connfd)</span></pre></td></tr><tr><td data-num=23></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程要关闭监听的socket</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=33></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre></pre></td></tr><tr><td data-num=36></td><td><pre>            <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=37></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>            <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=39></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=41></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=服务程序的退出和资源的释放><a class=anchor href=#服务程序的退出和资源的释放>#</a> 服务程序的退出和资源的释放</h3><p>资源释放的代码会写在析构函数中</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 父进程退出时调用的函数</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catching the signal%d \n"</span><span class="token punctuation">,</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">kill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">// 子进程退出时调用的函数</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">// 通过信号使程序退出时调用的函数</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token comment">// 关闭全部的信号和输入输出</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token comment">// 设置信号，在shell状态下可用`Kill 进程号`正常终止些进程</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token comment">// 但不要用"kill -9 进程"来强行终止</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    </pre></td></tr><tr><td data-num=16></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让父进程退出，只留下子进程</span></pre></td></tr><tr><td data-num=18></td><td><pre>    </pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=36></td><td><pre>            TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程要关闭客户端连接上来的socket(m_connfd)</span></pre></td></tr><tr><td data-num=37></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=39></td><td><pre>        TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程要关闭监听的socket</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=45></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=47></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre></pre></td></tr><tr><td data-num=50></td><td><pre>            <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=51></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>            <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=53></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=58></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=多进程服务程序的日志><a class=anchor href=#多进程服务程序的日志>#</a> 多进程服务程序的日志</h3><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 父进程退出时调用的函数</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"catching the signal%d \n"</span><span class="token punctuation">,</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">kill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"父进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">// 子进程退出时调用的函数</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"子进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CLogFile logifle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">// 通过信号使程序退出时调用的函数</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:../mpserver port logfile\nExample:./mpserver 5005 /tmp/mpserver.log\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    </pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token comment">// 关闭全部的信号和输入输出</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>    </pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token comment">// 打开日志文件</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"logfile.Open(%s) failed.\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 设置信号，在shell状态下可用`Kill 进程号`正常终止些进程</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token comment">// 但不要用"kill -9 进程"来强行终止</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让父进程退出，只留下子进程</span></pre></td></tr><tr><td data-num=35></td><td><pre>    </pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=39></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=42></td><td><pre>    </pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=48></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=53></td><td><pre>            TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程要关闭客户端连接上来的socket(m_connfd)</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程要关闭监听的socket</span></pre></td></tr><tr><td data-num=57></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre></pre></td></tr><tr><td data-num=59></td><td><pre>        <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=60></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=61></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=62></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=64></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre></pre></td></tr><tr><td data-num=67></td><td><pre>            <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=68></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>            <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=70></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=72></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=73></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=75></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class=tags><a href=/tags/network-programming/ rel=tag><i class="ic i-tag"></i> 网络编程</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span> <span class=text>更新于</span> <time title="修改时间：2024-03-08 16:14:19" itemprop=dateModified datetime=2024-03-08T16:14:19+08:00>2024-03-08</time></span><span class=item data-path=/computer-science/programming/network-programming/multiprocessing/ title=阅读次数><span class=icon><i class="ic i-eye"></i></span> <span class=text>阅读次数</span><span class=waline-pageview-count></span> <span class=text>次</span></span></div><div id=copyright><ul><li class=author><strong>本文作者：</strong> ReverseSacle <i class="ic i-at"><em>@</em></i>逆转天平</li><li class=link><strong>本文链接：</strong> <a href=https://www.reversesacle.com/computer-science/programming/network-programming/multiprocessing/ title=Linux多进程>https://www.reversesacle.com/computer-science/programming/network-programming/multiprocessing/</a></li><li class=license><strong>版权声明：</strong> 本站所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class=post-nav><div class="item left"><a href=/computer-science/programming/network-programming/signal/ itemprop=url rel=prev data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg9.webp title=Linux的信号(signal)><span class=type>上一篇</span><span class=category><i class="ic i-flag"></i> 网络编程</span><h3>Linux的信号(signal)</h3></a></div><div class="item right"><a href=/computer-science/programming/network-programming/log/ itemprop=url rel=next data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg20.webp title=C&#x2F;C++服务程序的运行日志><span class=type>下一篇</span><span class=category><i class="ic i-flag"></i> 网络编程</span><h3>C/C++服务程序的运行日志</h3></a></div></div><div class=wrap id=comments><div id=waline-comment></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=文章目录><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A6%82%E5%BF%B5><span class=toc-number>1.</span> <span class=toc-text>! 概念</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BC%96%E5%8F%B7><span class=toc-number>2.</span> <span class=toc-text>进程的编号</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B><span class=toc-number>3.</span> <span class=toc-text>! 多进程</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#fork%E5%87%BD%E6%95%B0><span class=toc-number>3.1.</span> <span class=toc-text>fork函数</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%9B%B8%E5%85%B3%E6%A1%88%E4%BE%8B><span class=toc-number>3.2.</span> <span class=toc-text>相关案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#linux%E8%BF%9B%E7%A8%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1><span class=toc-number>4.</span> <span class=toc-text>Linux进程之间的通信</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E5%BF%B5-2><span class=toc-number>4.1.</span> <span class=toc-text>概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1><span class=toc-number>4.2.</span> <span class=toc-text>进程通信</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#linux%E7%9A%84%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98shared-memory><span class=toc-number>5.</span> <span class=toc-text>Linux的共享内存(Shared Memory)</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E5%BF%B5-3><span class=toc-number>5.1.</span> <span class=toc-text>! 概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0><span class=toc-number>5.2.</span> <span class=toc-text>相关函数</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#shmget%E5%87%BD%E6%95%B0><span class=toc-number>5.2.1.</span> <span class=toc-text>shmget函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#shmat%E5%87%BD%E6%95%B0><span class=toc-number>5.2.2.</span> <span class=toc-text>shmat函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#shmdt%E5%87%BD%E6%95%B0><span class=toc-number>5.2.3.</span> <span class=toc-text>shmdt函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#shmctl%E5%87%BD%E6%95%B0><span class=toc-number>5.2.4.</span> <span class=toc-text>shmctl函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#linux%E7%9A%84%E4%BF%A1%E5%8F%B7%E9%87%8F><span class=toc-number>6.</span> <span class=toc-text>Linux的信号量</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E5%BF%B5-4><span class=toc-number>6.1.</span> <span class=toc-text>概念</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0-2><span class=toc-number>6.2.</span> <span class=toc-text>相关函数</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#semget%E5%87%BD%E6%95%B0><span class=toc-number>6.2.1.</span> <span class=toc-text>semget函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#semctl%E5%87%BD%E6%95%B0><span class=toc-number>6.2.2.</span> <span class=toc-text>semctl函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#semop%E5%87%BD%E6%95%B0><span class=toc-number>6.2.3.</span> <span class=toc-text>semop函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#linux%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4><span class=toc-number>6.3.</span> <span class=toc-text>Linux相关命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%BA%94%E7%94%A8><span class=toc-number>7.</span> <span class=toc-text>多进程的应用</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B9%B6%E5%8F%91%E7%9A%84%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E7%AB%AF><span class=toc-number>8.</span> <span class=toc-text>多进程并发的网络服务端</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%8D%95%E8%BF%9B%E7%A8%8B><span class=toc-number>8.1.</span> <span class=toc-text>单进程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B-2><span class=toc-number>8.2.</span> <span class=toc-text>多进程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%A7%A3%E5%86%B3%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B><span class=toc-number>8.3.</span> <span class=toc-text>! 解决僵尸进程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%85%B3%E9%97%AD%E5%A4%9A%E4%BD%99%E7%9A%84socket><span class=toc-number>8.4.</span> <span class=toc-text>关闭多余的socket</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%80%80%E5%87%BA%E5%92%8C%E8%B5%84%E6%BA%90%E7%9A%84%E9%87%8A%E6%94%BE><span class=toc-number>8.5.</span> <span class=toc-text>服务程序的退出和资源的释放</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%97%A5%E5%BF%97><span class=toc-number>8.6.</span> <span class=toc-text>多进程服务程序的日志</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title=系列文章><ul><li><a href=/computer-science/programming/network-programming/linux-environment/ rel=bookmark title=虚拟机-Linux环境配置>虚拟机-Linux环境配置</a></li><li><a href=/computer-science/programming/network-programming/Linux-basic/ rel=bookmark title="Linux基础(CentOS 7)">Linux基础(CentOS 7)</a></li><li><a href=/computer-science/programming/network-programming/gcc-compiler/ rel=bookmark title=GCC编译器>GCC编译器</a></li><li><a href=/computer-science/programming/network-programming/gdb-debugging-tool/ rel=bookmark title=GDB调试工具>GDB调试工具</a></li><li><a href=/computer-science/programming/network-programming/make-compiler-tool/ rel=bookmark title=make编译工具>make编译工具</a></li><li><a href=/computer-science/programming/network-programming/clibrary/ rel=bookmark title=C/C++静态库与动态库的制作和使用>C/C++静态库与动态库的制作和使用</a></li><li><a href=/computer-science/programming/network-programming/executable-program/ rel=bookmark title=在C/C++程序中调用可执行程序>在C/C++程序中调用可执行程序</a></li><li><a href=/computer-science/programming/network-programming/signal/ rel=bookmark title=Linux的信号(signal)>Linux的信号(signal)</a></li><li class=active><a href=/computer-science/programming/network-programming/multiprocessing/ rel=bookmark title=Linux多进程>Linux多进程</a></li><li><a href=/computer-science/programming/network-programming/log/ rel=bookmark title=C/C++服务程序的运行日志>C/C++服务程序的运行日志</a></li><li><a href=/computer-science/programming/network-programming/multithreading/ rel=bookmark title=Linux多线程>Linux多线程</a></li><li><a href=/computer-science/programming/network-programming/thread-synchronization/ rel=bookmark title=Linux线程同步>Linux线程同步</a></li><li><a href=/computer-science/programming/network-programming/programming/ rel=bookmark title=C/C++网络编程>C/C++网络编程</a></li><li><a href=/computer-science/programming/network-programming/http/ rel=bookmark title=HTTP网络通信基础>HTTP网络通信基础</a></li><li><a href=/computer-science/programming/network-programming/ubuntu-obs-server/ rel=bookmark title="Ubuntu服务器OBS Studio配置">Ubuntu服务器OBS Studio配置</a></li></ul></div><div class="overview panel" data-title=站点概览><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img class=image itemprop=image alt=ReverseSacle data-src=/images/avatar.webp><p class=name itemprop=name>ReverseSacle</p><div class=description itemprop=description>知识书库 & 学习点滴</div></div><nav class=state><div class="item posts"><a href=/archives/ ><span class=count>186</span> <span class=name>文章</span></a></div><div class="item categories"><a href=/categories/ ><span class=count>52</span> <span class=name>分类</span></a></div><div class="item tags"><a href=/tags/ ><span class=count>18</span> <span class=name>标签</span></a></div></nav><div class=social><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JldmVyc2VTYWNsZQ==" title=https:&#x2F;&#x2F;github.com&#x2F;ReverseSacle><i class="ic i-github"></i></span><span class="exturl item email" data-url="bWFpbHRvOnByaXZhdGVAcmV2ZXJzZXNhY2xlLmNvbQ==" title=mailto:private@reversesacle.com><i class="ic i-envelope"></i></span></div><ul class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i> 首页</a></li><li class="item dropdown"><a href=javascript:void(0);><i class="ic i-feather"></i> 文章</a><ul class=submenu><li class=item><a href=/archives/ rel=section><i class="ic i-list-alt"></i> 归档</a></li><li class=item><a href=/categories/ rel=section><i class="ic i-th"></i> 分类</a></li><li class=item><a href=/tags/ rel=section><i class="ic i-tags"></i> 标签</a></li></ul></li><li class=item><a href=/about/ rel=section><i class="ic i-user"></i> 关于</a></li><li class=item><a href=/friend-links/ rel=section><i class="ic i-heart"></i> 友链</a></li></ul></div></div></div><ul id=quick><li class="prev pjax"><a href=/computer-science/programming/network-programming/signal/ rel=prev title=上一篇><i class="ic i-chevron-left"></i></a></li><li class=up><i class="ic i-arrow-up"></i></li><li class=down><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href=/computer-science/programming/network-programming/log/ rel=next title=下一篇><i class="ic i-chevron-right"></i></a></li><li class=percent></li></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>随机文章</h2><ul><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/c-basic/ title="分类于 C语言基础">C语言基础</a></div><span><a href=/computer-science/programming/c-language/basis/c/cpart3/ title=C语言基础-第三部分-C99标准>C语言基础-第三部分-C99标准</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/network-programming/ title="分类于 网络编程">网络编程</a></div><span><a href=/computer-science/programming/network-programming/executable-program/ title=在C&#x2F;C++程序中调用可执行程序>在C/C++程序中调用可执行程序</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/algorithm/ title="分类于 算法">算法</a></div><span><a href=/computer-science/programming/algorithm/math/sieve-of-eratosthenes/ title=埃拉托斯特尼筛法>埃拉托斯特尼筛法</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a></div><span><a href=/computer-science/programming/rust/rust-data-structure/linear-structure/doubly-link-list/ title=Rust-双向链表>Rust-双向链表</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/c-data-structure/ title="分类于 C语言数据结构">C语言数据结构</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/generalized-table/ title=线性表进阶之广义表(列表)>线性表进阶之广义表(列表)</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/seqlist/ title="分类于 顺序表">顺序表</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/seqlist/sum/ title=顺序表-求和>顺序表-求和</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/rust-basic/ title="分类于 Rust基础">Rust基础</a></div><span><a href=/computer-science/programming/rust/rust-basic/rustpart1/ title=Rust语言-基础-第一部分>Rust语言-基础-第一部分</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/nonlinear-structure/threaded-binary-tree/ title=C语言-二叉树线索化(线索链表)>C语言-二叉树线索化(线索链表)</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/rust-example/ title="分类于 Rust案例">Rust案例</a></div><span><a href=/computer-science/programming/rust/rust-example/socket/ title=rust版HTTP协议的socket通信>rust版HTTP协议的socket通信</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/linear-structure/link-queue/ title=C语言-链队列>C语言-链队列</a></span></li></ul></div><div><h2>最新评论</h2><ul id=waline-recent></ul></div></div><div class=status><div class=copyright>&copy; 2021 – <span itemprop=copyrightYear>2025</span><span class=with-love><i class="ic i-sakura rotate"></i></span> <span class=author itemprop=copyrightHolder>ReverseSacle @ ReverseSacle-Blog</span></div><div class=count><i class="ic i-clock" aria-hidden=true></i> <span id=time align=center>载入时间中...<script defer>var now=new Date;function createtime(){var n=new Date("2021-11-16 22:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("time").innerHTML="已经过 "+dnum+" 天 "+hnum+" 小时 "+mnum+" 分 "+snum+" 秒 "}setInterval("createtime()",250)</script></span><span class=post-meta-item-icon>|&nbsp<i class="ic i-chart-area"></i></span> <span title=站点总字数>2.1m 字</span> <span class=post-meta-item-icon>|&nbsp<i class="ic i-coffee"></i></span> <span title=站点阅读时长>40:40</span></div></div></div></footer></div><script data-config>var LOCAL={path:"computer-science/programming/network-programming/multiprocessing/",favicon:{show:"ReverseSacle-Blog",hide:"ReverseSacle-Blog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},waline:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src=https://polyfill.alicdn.com/v3/polyfill.min.js></script><script src=https://cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1.16.0/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js></script><script src=/js/app.js></script></body></html>