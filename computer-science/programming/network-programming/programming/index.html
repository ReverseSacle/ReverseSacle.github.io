<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#222><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/ico sizes=48x48 href=/images/favicon.ico><link rel=alternate type=application/rss+xml title=逆转天平 href=https://www.reversesacle.com/rss.xml><link rel=alternate type=application/atom+xml title=逆转天平 href=https://www.reversesacle.com/atom.xml><link rel=alternate type=application/json title=逆转天平 href=https://www.reversesacle.com/feed.json><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=/css/app.css><meta name=description content=网络编程><link rel=canonical href=https://www.reversesacle.com/computer-science/programming/network-programming/programming/ ><title>C/C++网络编程 - 网络编程 - 编程 - 计算机科学 | ReverseSacle-Blog</title><meta name=generator content="Hexo 6.3.0"></head><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=dotloader><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">C/C++网络编程</h1><div class=meta><span class=item title="创建时间：2023-08-01 15:31:55"><span class=icon><i class="ic i-calendar"></i></span> <span class=text>发表于</span> <time itemprop="dateCreated datePublished" datetime=2023-08-01T15:31:55+08:00>2023-08-01</time></span><span class=item title=本文字数><span class=icon><i class="ic i-pen"></i></span> <span class=text>本文字数</span> <span>54k</span> <span class=text>字</span></span><span class=item title=阅读时长><span class=icon><i class="ic i-clock"></i></span> <span class=text>阅读时长</span> <span>1:02</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div class=lines role=navigation aria-label=切换导航栏><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>ReverseSacle-Blog</a></li></ul><ul class=right><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id=imgs class=pjax><ul><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg15.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg16.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg21.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg14.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg17.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg18.webp></li></ul></div></header><div id=waves><svg class=waves xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink viewBox="0 24 150 28" preserveAspectRatio=none shape-rendering=auto><defs><path id=gentle-wave d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class=parallax><use xlink:href=#gentle-wave x=48 y=0 /><use xlink:href=#gentle-wave x=48 y=3 /><use xlink:href=#gentle-wave x=48 y=5 /><use xlink:href=#gentle-wave x=48 y=7 /></g></svg></div><main><div class=inner><div id=main class=pjax><div class="article wrap"><div class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i> <span><a href=/ >首页</a></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/ itemprop=item rel=index title="分类于 计算机科学"><span itemprop=name>计算机科学</span></a><meta itemprop=position content=1></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/ itemprop=item rel=index title="分类于 编程"><span itemprop=name>编程</span></a><meta itemprop=position content=2></span><i class="ic i-angle-right"></i> <span class=current itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/network-programming/ itemprop=item rel=index title="分类于 网络编程"><span itemprop=name>网络编程</span></a><meta itemprop=position content=3></span></div><article itemscope itemtype=http://schema.org/Article class="post block" lang=zh-CN><link itemprop=mainEntityOfPage href=https://www.reversesacle.com/computer-science/programming/network-programming/programming/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.webp><meta itemprop=name content=ReverseSacle><meta itemprop=description content="所见即所得，所思即所行, 知识书库 & 学习点滴"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=逆转天平></span><div class="body md" itemprop=articleBody><h2 id=socket><a class=anchor href=#socket>#</a> Socket</h2><h3 id=概述><a class=anchor href=#概述>#</a> 概述</h3><ul><li>网络中的两个程序通过一个双向的通道连接实现数据的交换，连接的一端称为一个socket，由于通道是双向的，因此，任何一端都称为socket</li><li>建立网络通信连接时至少需要<strong>一个端口号</strong></li><li>socket本质是编程接口(API)，封装了TCP/IP体系结构</li><li>socket有字节流socket(stream)和数据报socket(datagram)<ul><li>字节流socket的类型是<code>SOCK_STREAM</code>，它提供一个有序，可靠，双向字节流连接，发生的数据可以确保不会丢失，重复或乱序到达，并且还具有错误后重新发送的机制</li><li>数据报socket的类型是<code>SOCK_DGRAM</code>，它不需要建立和维持一个连接，采用UDP/IP协议实现。对可发送数据的长度有限制，数据报作为一个单独的网络消息被传输，传输中可能会丢失，复制或错乱到达。但，它的速度快并且不需要建立和维持连接(例如短信发送)。实际开发中应用场景极少</li></ul></li></ul><h3 id=连接步骤><a class=anchor href=#连接步骤>#</a> ! 连接步骤</h3><ul><li>连接过程基本可以分为三个步骤<ul><li>服务器监听 - 服务器socket并不定位具体的客户端socket，而是处于等待连接的状态，实时监控网络状态</li><li>客户端请求 - 由客户端socket提出连接请求，要连接的目标是服务器socket。客户端socket必须先描述它</li><li>连接确认 - 当服务器socket监听到或接收到客户端socket的连接请求，它就响应客户端socket的请求并建立一个新的线程，把服务器socket的描述发给客户端，一旦客户端确认了此描述，连接就建立好了。而服务器socket继续处于监听状态，继续接收其他客户端socket的连接请求</li></ul></li><li>如果连接过程还包含数据交换和断开连接，那连接过程一共是五个步骤</li><li>进行连接的过程叫做<strong>三次握手</strong>，进行断开连接的过程叫<strong>四次挥手</strong></li></ul><p><strong>socket什么情况下可读？</strong></p><p>在网络编程中，<code>socket</code>可读的情况通常指的是socket上存在可供读取的数据或者在某些特定情况下表明socket的状态发生了变化。以下是几种情况下一个socket可能被认为是可读的</p><ul><li><p><strong>数据到达</strong> - 远程发送方向本地socket发送了数据，并且这些数据已经到达本地缓冲区，等待被读取</p></li><li><p><strong>连接建立</strong> - 对于非阻塞的socket，在执行<code>connect()</code>操作后，当连接成功建立时，socket变为可读</p></li><li><p><strong>监听socket</strong> - 对于处于监听状态的服务器socket(例如，执行了<code>listen()</code>调用的TCP服务器)，当有新的连接请求到达时，socket变为可读</p></li><li><p><strong>连接关闭</strong> - 当远程端点关闭了连接，即发送了FIN包，本地socket会收到一个空的数据段，此时socket可读以允许本地程序识别到关闭事件</p></li><li><p><strong>错误或中断</strong> - 如果在socket上发生了错误或者其他异常情况，它可能也会被标记为可读，以便应用程序可以通过检查socket的状态或者进行错误处理</p></li><li><p><strong>紧急数据</strong> - 对于支持OutOf-Band(OOB)数据的协议(如TCP)，当有紧急数据到达时，socket也可能被标记为可读</p></li></ul><p>要检测一个socket是否可读，可以使用多种方法，包括使用<code>select()</code>、<code>poll()</code>或<code>epoll()</code>等系统调用，在给定的一组socket上等待事件发生，从而在非阻塞的情况下有效地管理多个连接。这些调用都可以提示哪些socket是可读的，哪些是可写的，以及是否有任何异常情况需要注意。</p><h3 id=服务端的工作流程><a class=anchor href=#服务端的工作流程>#</a> ! 服务端的工作流程</h3><ul><li>创建服务端的socket</li><li>把服务端用于通信的地址和端口绑定到socket上</li><li>把socket设置为监听模式</li><li>接受客户端的连接</li><li>与客户端通信，接收客户端发送的报文后，回复并处理结果</li><li>不断重复(与客户端通信，接收客户端发送的报文后，回复并处理结果)这一步骤，直到客户端断开连接</li><li>关闭socket并释放资源</li></ul><details class=info><summary>serve.c</summary><div><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;netdb.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=12></td><td><pre>	<span class="token comment">// 1.创建服务端socket</span></pre></td></tr><tr><td data-num=13></td><td><pre>	<span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token comment">// 2.将服务端用于通信的地址和端口绑定到socket上</span></pre></td></tr><tr><td data-num=21></td><td><pre>	<span class="token comment">// 构建存储服务端地址信息的结构体</span></pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serve_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serve_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>	serve_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span><span class="token comment">// 指定协议族</span></pre></td></tr><tr><td data-num=25></td><td><pre>	serve_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定任意IP</span></pre></td></tr><tr><td data-num=26></td><td><pre>	<span class="token comment">//serv_addr.sin_addr.s_addr = inet_addr("118.89.50.198");// 指定指定IP</span></pre></td></tr><tr><td data-num=27></td><td><pre>	serve_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5051</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定通信端口</span></pre></td></tr><tr><td data-num=28></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serve_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serve_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=29></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=30></td><td><pre>		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>		<span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre>	<span class="token comment">// 3.把socket设置为监听模式</span></pre></td></tr><tr><td data-num=36></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=37></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=38></td><td><pre>		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>		<span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=42></td><td><pre></pre></td></tr><tr><td data-num=43></td><td><pre>	<span class="token comment">// 4.接受客户端连接请求</span></pre></td></tr><tr><td data-num=44></td><td><pre>	<span class="token keyword">int</span> serve_fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 客户端socket</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token comment">// struct sockaddr_in结构体的字节大小,方便填入参数</span></pre></td></tr><tr><td data-num=46></td><td><pre>	<span class="token keyword">int</span> socklen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>	<span class="token comment">// 构建用于存储客户端地址信息的结构体</span></pre></td></tr><tr><td data-num=48></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>	serve_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listend_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">socklen_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>socklen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端%s已连接\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre></pre></td></tr><tr><td data-num=52></td><td><pre>	<span class="token comment">// 5.与客户端通信并接收客户端的报文数据，再回复确认</span></pre></td></tr><tr><td data-num=53></td><td><pre>	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=55></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=56></td><td><pre>		<span class="token keyword">int</span> iret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>		<span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre>		<span class="token comment">// 接收客户端的请求报文</span></pre></td></tr><tr><td data-num=59></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>serve_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=60></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=61></td><td><pre>			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d\n"</span><span class="token punctuation">,</span> iret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=64></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ret=%d，接收:%s\n"</span><span class="token punctuation">,</span> iret<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>		<span class="token function">strcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre></pre></td></tr><tr><td data-num=67></td><td><pre>		<span class="token comment">// 向客户端发送响应确认报文</span></pre></td></tr><tr><td data-num=68></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>serve_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=69></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=70></td><td><pre>			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=73></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d,发送:%s\n"</span><span class="token punctuation">,</span> iret<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=75></td><td><pre>	<span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>	<span class="token function">close</span><span class="token punctuation">(</span>serve_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h3 id=客户端的工作流程><a class=anchor href=#客户端的工作流程>#</a> 客户端的工作流程</h3><ul><li>创建客户端的socket</li><li>向服务器发起连接请求</li><li>与服务端通信，发送一个报文后等待回复，然后再发送下一个报文</li><li>不断重复(与服务端通信，发送一个报文后等待回复，然后再发送下一个报文)这一步骤，直到全部的数据被发送完</li><li>关闭socket并释放资源</li></ul><details class=info><summary>client.c</summary><div><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;netdb.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=12></td><td><pre>	<span class="token comment">// 1.创建客户端socket</span></pre></td></tr><tr><td data-num=13></td><td><pre>	<span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>client_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre>	<span class="token comment">// 2.向服务端发起连接请求</span></pre></td></tr><tr><td data-num=20></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> _host<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token punctuation">(</span>_host <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token string">"192.168.159.128"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"gethostbyname failde.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>		<span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>	<span class="token comment">// 构建存储客户端地址信息的结构体</span></pre></td></tr><tr><td data-num=28></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serve_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serve_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serve_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>	client_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span><span class="token comment">// 指定协议族</span></pre></td></tr><tr><td data-num=31></td><td><pre>	client_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5051</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定端口号</span></pre></td></tr><tr><td data-num=32></td><td><pre>	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>serve_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_host<span class="token operator">-></span>h_addr_list<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _host<span class="token operator">-></span>h_length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>	<span class="token comment">// 执行连接请求</span></pre></td></tr><tr><td data-num=34></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">connect</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serve_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serve_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=35></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=36></td><td><pre>		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>		<span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=40></td><td><pre></pre></td></tr><tr><td data-num=41></td><td><pre>	<span class="token comment">// 3.与服务端通信，发送一个报文后等待回复，然后再发送下一个报文</span></pre></td></tr><tr><td data-num=42></td><td><pre>	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=45></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=46></td><td><pre>		<span class="token keyword">int</span> iret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>		<span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>		<span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">"%d....%03d"</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>		<span class="token comment">// 向服务端发送请求报文</span></pre></td></tr><tr><td data-num=50></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>iret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=51></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=52></td><td><pre>			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=55></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d,发送：%s\n"</span><span class="token punctuation">,</span> iret<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>		<span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>		<span class="token comment">// 接收服务端的响应报文</span></pre></td></tr><tr><td data-num=58></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=59></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=60></td><td><pre>			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d\n"</span><span class="token punctuation">,</span>iret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=63></td><td><pre>		<span class="token operator">++</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=65></td><td><pre>	<span class="token comment">// 4.关闭socket</span></pre></td></tr><tr><td data-num=66></td><td><pre>	<span class="token function">close</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=67></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h3 id=注意事项><a class=anchor href=#注意事项>#</a> 注意事项</h3><p>在程序运行前，必须保证服务器的防火墙已经开通了网络访问策略(云服务器还需要开通访问策略)。</p><h4 id=服务端程序绑定地址><a class=anchor href=#服务端程序绑定地址>#</a> <strong>服务端程序绑定地址</strong></h4><p>如果服务器有多个网卡，多个IP地址，socket通信可以指定用其中一个地址来进行通信，也可以任意IP地址。在实际开发中，采用任意ip地址的方式比较多。</p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 指定IP</span></pre></td></tr><tr><td data-num=2></td><td><pre>m_servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.149.129"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">// 任意IP地址</span></pre></td></tr><tr><td data-num=4></td><td><pre>m_servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id=服务端程序绑定通信端口><a class=anchor href=#服务端程序绑定通信端口>#</a> <strong>服务端程序绑定通信端口</strong></h4><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>m_servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id=客户端程序指定服务端的ip地址><a class=anchor href=#客户端程序指定服务端的ip地址>#</a> <strong>客户端程序指定服务端的IP地址</strong></h4><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// IP地址信息的数据结构</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> h<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token string">"192.168.149.129"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"gethostbyname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id=客户端程序指定服务端的通信端口><a class=anchor href=#客户端程序指定服务端的通信端口>#</a> <strong>客户端程序指定服务端的通信端口</strong></h4><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id=服务端有两个socket><a class=anchor href=#服务端有两个socket>#</a> 服务端有两个socket</h4><p>一个用于监听socket，还有一个是客户端连接成功后，由accep函数创建的用于与客户端收发报文的socket。</p><h4 id=程序退出时先关闭socket><a class=anchor href=#程序退出时先关闭socket>#</a> 程序退出时先关闭socket</h4><p>socket是系统资源，操作系统打开的socket数量是有限的，在程序退出之前必须关闭已打开的socket。</p><p>关闭socket代码不能只在main函数最后，那是程序运行的理想状态，还应该在main函数中的每个return前面添加关闭socket代码。</p><h3 id=库函数详解><a class=anchor href=#库函数详解>#</a> 库函数详解</h3><p>需包含头文件 - <code>#include&lt;sys/types.h&gt;</code>和<code>#include&lt;sys/socket.h&gt;</code></p><h4 id=socket函数><a class=anchor href=#socket函数>#</a> socket函数</h4><ul><li>用于创建一个新的socket，也就是向系统申请一个socket资源</li><li>socket函数用于用户客户端和服务端</li><li>函数声明 - <code>int socket(int domain, int type, int protocol)</code><ul><li>domain - 协议域，又称协议族(family)<ul><li>常用协议族有<code>AF_INET</code>，<code>AF_INET6</code>，<code>AF_LOCAL</code>(或称<code>AF_UNIX</code>，Unix域Socket)，<code>AF_ROUTE</code>等</li><li>协议族决定了socket的地址类型，在通信中必须采用对应的地址，如<code>AF_INET</code>规定要用IPv4地址(32位)与端口号(16位)的组合，<code>AF_UNIX</code>规定要用一个绝对路径名作为地址</li></ul></li><li>type - 指定socket类型<ul><li>常用socket类型有<code>SOCK_STREAM</code>，<code>SOCK_DGRAM</code>，<code>SOCK_RAW</code>，<code>SOCK_PACKET</code>，<code>SOCK_SEQPACKET</code>等</li><li>字节流式socket(<code>SCOK_STREAM</code>)是一种面向连接的socket，针对于面向连接的TCP服务应用</li><li>数据报式socket(<code>SOCK_DGRAM</code>)是一种无连接的socket，应用于无连接的UDP服务应用</li></ul></li><li>protocol - 指定协议<ul><li>常用协议有<code>IPPROTO_TCP</code>，<code>IPPROTO_UDP</code>，<code>IPPROTO_STCP</code>，<code>IPPROTO_TIPC</code>等</li><li>分别表示为TCP传输协议，UDP传输协议，STCP传输协议，TIPC传输协议</li></ul></li><li>返回值 - 成功返回一个socket，失败返回-1，错误原因存储在errno中</li></ul></li><li>函数第一个参数只能填<code>AF_INET</code>，第二个参数只能填<code>SOCK_STREAM</code>，第三个参数只能填<code>0</code></li><li>除非系统资源耗尽，否则socket函数不会返回失败</li></ul><h4 id=gethostbyname函数><a class=anchor href=#gethostbyname函数>#</a> gethostbyname函数</h4><ul><li>用于将IP地址或域名转换为由hostent结构体表达的地址</li><li>函数声明 - <code>struct hostent* gethostbyname(const char* name)</code><ul><li>name - 域名或主机名，例如<code>&quot;192.168.1.3&quot;</code>，<code>www.example.com</code></li><li>返回值 - 成功返回一个hostent结构体指针，失败返回NULL</li></ul></li><li>gethostbyname只用于<strong>客户端</strong>。只是把字符串的IP地址转化为结构体格式的IP地址，只要地址格式没错，一般不会返回错误，函数执行失败不会设置errno的值</li></ul><h4 id=connect函数><a class=anchor href=#connect函数>#</a> ! connect函数</h4><ul><li>用于客户端向服务器发起连接请求</li><li>函数声明 - <code>int connect(int sockfd, struct sockaddr* serv_addr, int addrlen)</code><ul><li>connect函数用于将参数sockfd的socket连接至参数serv_addr指定的服务端</li><li>addrlen - 结构体serv_addr的长度</li><li>返回值 - 成功返回0，失败返回-1，错误原因存储在errno中</li></ul></li><li>connect函数只用于<strong>客户端</strong></li><li>如果服务器地址错误，或端口号错误，或者服务端没有启动，执行connect函数一定会失败</li></ul><p><strong>connect会阻塞怎么解决?</strong></p><p>当调用<code>connect</code>函数对远程服务器进行连接时，如果使用的是阻塞式socket，<code>connect</code>会一直阻塞到连接成功或者发生错误为止。这可能导致应用程序的其它部分无法执行，尤其是在图形用户界面或需要同时处理多个连接的服务器应用程序中，这可能是不可接受的。为了解决<code>connect</code>函数的阻塞问题，可以采用以下几种方法</p><p><strong>使用非阻塞socket</strong></p><ul><li>将socket设置为非阻塞模式，这样<code>connect</code>调用将立即返回。如果连接未立即建立，<code>connect</code>会返回一个错误码，通常是<code>EINPROGRESS</code>，表明连接尝试正在进行中</li><li>接下来，可以使用<code>select</code>，<code>poll</code>或<code>epoll</code>等函数来监视socket的状态。当socket可写时(<code>select</code>等的写集合中返回)，这通常意味着连接已经建立或者连接尝试失败，此时可以使用<code>getsockopt</code>来检查socket的<code>SO_ERROR</code>选项，以确定是否连接成功</li></ul><p><strong>使用异步I/O或事件驱动模型</strong></p><ul><li>通过异步I/O库(比如Linux的<code>libaio</code>或Windows的<code>IOCP</code>)或者事件驱动的网络库(比如<code>libevent</code>、<code>libuv</code>或<code>Boost.Asio</code>)，可以在不阻塞主线程的情况下执行<code>connect</code></li><li>这些库通常提供了在连接完成时触发的回调机制</li></ul><p><strong>创建辅助线程或进程</strong></p><ul><li>在单独的线程或进程中执行<code>connect</code>调用，这样即使<code>connect</code>阻塞，也不会影响主线程或进程的执行。</li><li>连接成功后，可以通过线程间通信机制(如信号量、消息队列、事件等)通知主线程或进程</li></ul><p><strong>使用<code>O_NONBLOCK</code>与<code>connect</code>结合后的特殊处理</strong></p><ul><li>在某些系统中，对于非阻塞socket，<code>connect</code>可能立即返回<code>-1</code>，并设置<code>errno</code>为<code>EINPROGRESS</code>。在这种情况下，可以使用<code>select</code>或<code>poll</code>等函数来监视连接是否成功</li></ul><p>下面用代码来举一个例子，先将socket设置为非阻塞，然后尝试连接。如果<code>connect</code>返回<code>EINPROGRESS</code>错误，利用<code>select</code>监视socket的写事件，如果<code>select</code>返回后，socket的写事件被触发，则调用<code>getsockopt</code>检查<code>SO_ERROR</code>，看是否连接成功。</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">// 设置socket为非阻塞</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">// 设置server_addr的成员变量...</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=27></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINPROGRESS<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token comment">// 连接正在尝试中</span></pre></td></tr><tr><td data-num=31></td><td><pre>        fd_set writefds<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>writefds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>writefds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 设置超时时间</span></pre></td></tr><tr><td data-num=35></td><td><pre></pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token comment">// 使用select等待连接完成或超时</span></pre></td></tr><tr><td data-num=37></td><td><pre>        result <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>sockfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>writefds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=40></td><td><pre>            <span class="token comment">// select错误或超时</span></pre></td></tr><tr><td data-num=41></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token keyword">else</span> </pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=47></td><td><pre>            <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>            socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>            <span class="token comment">// 获取socket选项</span></pre></td></tr><tr><td data-num=50></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_ERROR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=51></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=52></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getsockopt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>                <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>            <span class="token comment">// 检查是否有错误发生</span></pre></td></tr><tr><td data-num=57></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=58></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=59></td><td><pre>                errno <span class="token operator">=</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>                <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=65></td><td><pre>    <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token keyword">else</span> </pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>        <span class="token comment">// 连接尝试出错</span></pre></td></tr><tr><td data-num=69></td><td><pre>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre><span class="token comment">// socket现在已连接</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token comment">// ...</span></pre></td></tr><tr><td data-num=77></td><td><pre></pre></td></tr><tr><td data-num=78></td><td><pre><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>UDP中使用connect的好处？</strong></p><p>在使用UDP进行网络编程时，<code>connect</code>函数通常不是必须的，因为UDP是一个无连接的协议，它不需要像TCP那样进行三次握手来建立连接。然而，在某些场景下，即使对于UDP，使用<code>connect</code>也有一些好处</p><ul><li><p><strong>指定默认的对等方</strong> - 调用<code>connect</code>后，你可以使用<code>send</code>和<code>recv</code>(而不是<code>sendto</code>和<code>recvfrom</code>)函数来发送和接收数据。系统会自动使用<code>connect</code>时指定的地址作为数据的目的地，这使得代码更简洁，因为你不需要每次发送数据时都提供对等方的地址</p></li><li><p><strong>错误报告</strong> - 一旦对UDPsocket调用了<code>connect</code>，当往指定的对等方发送数据时，如果发生传输错误，操作系统会将错误报告给socket。例如，如果目标主机不可达，你可能会收到<code>ECONNREFUSED</code>错误。这在没有调用<code>connect</code>的情况下是不可能的，因为UDP通常不会为无连接的操作提供错误反馈</p></li><li><p><strong>过滤接收到的数据包</strong> - 使用<code>connect</code>连接到特定的远程端点后，该socket只接受来自这个特定端点的数据包。这意味着，该socket不会接收到其他任何地址的数据，从而相当于为该socket设置了一个过滤器</p></li><li><p><strong>效率</strong> - 虽然这个优点可能不是非常显著，但是在某些情况下，由于内核不需要在每次数据传输时处理源和目的地址，可能会略微减少CPU的工作负载</p></li><li><p><strong>简化状态管理</strong> - 对于需要持久通信状态的应用程序，例如一个客户端频繁地与同一个服务器端点进行交互，使用<code>connect</code>可以简化程序的状态管理</p></li><li><p><strong>安全性</strong> - 使用<code>connect</code>可以提高一定的安全性，因为socket只接收来自已连接对等方的数据，这减少了接收到恶意或无关数据包的可能性</p></li></ul><p>尽管有这些好处，也要考虑到<code>connect</code>对UDP socket的影响，因为它使得socket从一个可以与多个对等方通信的socket变成了只能与一个对等方通信的socket。如果需要与多个对等方通信，你或许需要创建多个socket或者不使用<code>connect</code>。</p><h4 id=bind函数><a class=anchor href=#bind函数>#</a> ! bind函数</h4><ul><li><p>用于将通信的地址和端口绑定到socket上</p></li><li><p>函数声明 - <code>int bind(int sockfd, const struct sockaddr* addr, int addrlen)</code></p><ul><li>sockfd - 需要绑定的socket</li><li>addr - 存放服务端用于通信的地址和端口</li><li>addrlen - 结构体addr的长度</li><li>返回值 - 成功返回0，失败返回-1，错误原因存储在erron中</li></ul></li><li><p>bind函数一般不会返回错误，如果绑定的地址错误，或端口已被占用，执行bind函数一定会报错</p></li><li><p>当一个端口被使用时，再次使用该端口后会提示<code>bind: Address already in use</code></p></li><li><p>用于监听的端口范围不确定</p></li></ul><p><strong>设置服务端socket的SO_REUSEADDR属性</strong></p><p>服务端程序的端口释放后可能会处于TIME_WAIT状态，等待两分钟之后才能再被使用，SO_REUSEADDR是让端口释放后立即就被再次使用。</p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 设置SO_REUSEADDR选项</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> len  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id=listen函数><a class=anchor href=#listen函数>#</a> listen函数</h4><ul><li>将主动连接socket变为被动连接socket，使这个socket可以接受其他socket的连接请求，从而成为一个服务端socket</li><li>函数声明 - <code>int listen(int sockfd, int backlog)</code><ul><li>sockfd - 已被传入到bind函数的socket。socket函数返回的socket是一个主动的socket，在服务编程中要求这个socket可以接受外来的连接请求，即被动等待客户端连接。由于系统默认认为一个socket是主动连接的，因此需要通过listen函数告知系统来完成这件事</li><li>backlog - 涉及一些网络细节，填5，10，一般填入值不超过30</li><li>返回值 - 成功返回0，失败返回-1，错误原因存储在errno中</li></ul></li><li>当调用listen之后，服务端socket即可调用accpet函数来接受客户端的连接请求</li><li>listen函数一般不会返回错误</li></ul><h4 id=accept函数><a class=anchor href=#accept函数>#</a> ! accept函数</h4><ul><li>用于服务端接受客户端的连接请求，从已经准备好的连接队列中获取一个请求，如果队列为空，accept函数将阻塞等待</li><li>函数声明 - <code>int accept(int sockfd, struct sockaddr* addr, socklen_t* addrlen)</code><ul><li>sockfd - 已被传入listen函数的socket</li><li>addr - 存放客户端的地址信息，由sockaddr结构体表达。如果不需要客户端的地址，可填入0</li><li>addrlen - 用于存放addr参数的长度。如果addr为0，此处的addrlen也为0</li><li>返回值 - 成功返回一个用于通信的新socket，失败返回-1，错误原因存储在errno中</li></ul></li><li>accept函数等待客户端的连接，如果没有客户端连接，就一直处于等待，这个过程称为<strong>阻塞</strong></li><li>accept函数等待客户端的连接中，如果有客户端的连接请求，就会创建一个新的socket，函数返回值就是这个新的socket，服务端通过这个新的socket于客户端进行报文的收发</li><li>accpt在等待过程中，如果被中断或其他的原因，函数返回-1，表示失败，如果失败，还可以重新accpet</li><li><code>192.xxx.xxx.xxx</code>是局域网内的地址，用于客户端的是互联网出口的地址</li></ul><p><strong>SYN 队列</strong></p><p>SYN队列是TCP(传输控制协议)中用于存储半开放连接(half-open connections)的队列。在TCP的三次握手过程中，客户端发送SYN(同步)请求，服务器接收到后会发送SYN-ACK(同步-确认)，最后客户端发送ACK(确认)以完成连接的建立。在这个过程中，当服务器发送SYN-ACK后，连接处于半开放状态，等待客户端的最终确认。</p><p>如果服务器接收到了客户端的SYN请求，但还没有接收到客户端的最终确认ACK，这个连接就被认为是半开放连接。这时，服务器会将这些半开放连接存储在一个专门的队列中，即SYN队列。SYN队列的作用是管理等待建立连接的请求，防止服务器因为连接请求过多而不堪重负。</p><p>如果SYN队列被填满，服务器可能会拒绝新的连接请求，从而防止资源耗尽。这种情况通常称为SYN队列溢出。为了应对这种情况，系统管理员可以调整SYN队列的大小或采取其他措施，以确保服务器能够正常处理连接请求。</p><p>SYN队列存储了收到 SYN 包的连接，它的职责是回复 SYN+ACK 包，并且在没有收到 ACK 包时重传。发送完SYN+ACK之后，SYN 队列等待从客户端发出的ACK包(也即三次握手的最后一个包)。</p><p>当收到ACK包时，首先找到对应的SYN队列，再在对应的SYN队列中检查相关的数据看是否匹配，如果匹配，内核将该连接相关的数据从SYN队列中移除，创建一个完整的连接，并将这个连接加入Accept队列。</p><p><strong>SYN队列溢出了怎么办？</strong></p><p>查看 SYN 队列，就是查看处在 SYN_RECV 状态的进程连接个数</p><figure class="highlight bash"><figcaption data-lang=bash></figcaption><table><tr><td data-num=1></td><td><pre><span class="token function">netstat</span> <span class="token parameter variable">-natp</span> <span class="token operator">|</span> <span class="token function">grep</span> SYN_RECV <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span></pre></td></tr></table></figure><p>查看溢出情况</p><figure class="highlight bash"><figcaption data-lang=bash></figcaption><table><tr><td data-num=1></td><td><pre><span class="token function">netstat</span> <span class="token parameter variable">-s</span></pre></td></tr></table></figure><p>预防 SYN 攻击</p><ul><li>增大半连接队列</li><li>开启 SYN cookies 算法</li><li>减少 SYN+ACK 重传次数</li></ul><p>当服务端受到 SYN 攻击时，就会有大量处于 SYN_REVC 状态的 TCP 连接，处于这个状态的 TCP 会重传 SYN+ACK ，当重传超过次数达到上限后，就会断开连接。那减少了重传次数，就会加速断开连接，这里可以联想如果在第三次握手失败了之后的场景。</p><p><strong>Accept 队列</strong></p><p>在TCP(传输控制协议)中，Accept队列是用于存储已经完成三次握手的连接的队列。一旦TCP连接的三次握手完成，连接就会被放入Accept队列中等待服务器进程来接收(accept)这个连接。</p><p>当客户端请求建立连接并完成三次握手后，连接会先进入服务器的SYN队列(参见前面关于SYN队列的回答)，等待服务器的最终确认。一旦连接的三次握手完成，连接就会被移动到Accept队列中。Accept队列的长度通常由操作系统的配置参数决定。</p><p>服务器进程通过调用accept系统调用来从Accept队列中接收连接。当服务器调用accept时，它从Accept队列中取出一个连接，并将其分配给一个新的套接字(socket)，使得服务器能够与客户端进行通信。这个过程允许服务器同时处理多个连接，因为连接可以在Accept队列中等待，等待服务器进程处理它们。</p><p>管理Accept队列的大小以及服务器处理连接的速度都是网络性能调优中的重要方面，以确保服务器能够有效地处理连接请求。</p><p><strong>Accept 全连接队列</strong></p><p>在TCP(传输控制协议)中，Accept全连接队列(Full Accept Queue)是指已经完成三次握手的连接，已经通过监听套接字(listening socket)加入到服务器的Accept队列中，但是服务器还没有调用<code>accept</code>系统调用来接收(accept)这些连接。</p><p>当服务器进程调用<code>accept</code>系统调用时，它从Accept队列中取出一个连接，将其分配给一个新的套接字，以便服务器可以与客户端进行通信。如果Accept队列已满，新的连接请求可能会被拒绝。</p><p>如果Accept队列已满，新的连接请求将被放入到一个被称为&quot;半连接队列&quot;(Half-open Queue)的队列中，也被称为SYN队列。这是因为在TCP的三次握手中，服务器已经发送了SYN-ACK，但还没有收到客户端的最终确认。这些半开放的连接等待客户端的进一步确认，或者在一定时间内被丢弃。</p><p>全连接队列的大小是由操作系统的配置参数决定的，通常是在服务器应用程序启动时指定或者通过系统的网络配置进行调整。调整这个队列的大小可以影响服务器的性能，因为它直接影响了服务器能够同时处理的连接数。</p><h4 id=send函数><a class=anchor href=#send函数>#</a> <strong>send函数</strong></h4><ul><li>用于将数据通过socket发送给另一端。不论客户端还是服务端。应用程序都用send函数来向TCP连接的另一端发送数据</li><li>函数声明 - <code>ssize_t send(int sockfd, const void* buf, size_t len, int flags)</code><ul><li>sockfd - 是指已建立好连接的socket</li><li>buf - 指需要发送的数据的内存地址，可以是C语言基本数据类型变量的地址，也可以是数组/结构体/字符串，任意类型都可以</li><li>len - 需要发送的数据的长度，为buf中有效数据的长度</li><li>flags - 填入0，其他填入值得意义不大</li><li>函数执行成功时返回已发送的字符个数，出错时返回-1，错误信息存储在errno</li></ul></li><li>当网络突然断开，或socket已被另一端关闭，send函数也不会立即报错，需要过几秒才会报错</li><li>如果send函数返回的错误(&lt;=0)，表示通信链路已不可用</li></ul><h4 id=recv函数><a class=anchor href=#recv函数>#</a> recv函数</h4><ul><li>用于接收另一端socket发送过来的数据</li><li>不论时客户端还是服务端，应用程序都用rev函数接收来自TCP连接的另一端发送过来的数据</li><li>函数声明 - <code>ssize_t recv(int sockfd, void* buf, size_t len, int flags)</code><ul><li>sockfd - 是指已建立好连接的socket</li><li>buf - 指需要发送的数据的内存地址，可以是C语言基本数据类型变量的地址，也可以是数组/结构体/字符串，任意类型都可以</li><li>len - 需要接收数据的长度，不能超过buf的大小，否则内存溢出</li><li>flags - 填入0，其他填入值得意义不大</li><li>函数返回已接收的字符数，出错时返回-1，失败时不会设置errno的值</li></ul></li><li>如果socket的另一端没有发送数据，recv函数就会等待</li><li>如果socket的另一端发生了数据，函数返回已接收到的字符数</li><li>如果socket被另一端关闭，返回值为0</li></ul><h4 id=函数调用详情><a class=anchor href=#函数调用详情>#</a> 函数调用详情</h4><ul><li><p>服务端的函数调用流程 - socket - bind - listen - accept - recv/send - close</p></li><li><p>客户端的函数调用流程 - socket - connect - send/recv - close</p></li><li><p>其中send/recv可以进行多次交互</p></li></ul><p>服务端在调用<code>listen()</code>函数之前，客户端不能向服务端发起连接请求。</p><p>服务端调用<code>listen()</code>函数后，服务端的socket开始监听客户端的连接。</p><p>客户端调用<code>connect()</code>函数向服务端发起连接请求。</p><p>在TCP底层，客户端和服务端握手后建立起通信通道，如果有多个客户端请求，在服务端就会形成一个已准备好的连接的队列。</p><p>服务端调用<code>accept()</code>函数从队列中获取一个已准备好的连接，函数返回一个新的socket，新的socket用于与客户端通信，listen的socket只负责监听客户端的连接请求。</p><h3 id=主机字节序与网络字节序><a class=anchor href=#主机字节序与网络字节序>#</a> 主机字节序与网络字节序</h3><p><strong>字节顺序</strong>是指内存多于一个字节类型的数据在内存中的存放顺序，一个32位整数由4个字节组成。内存中存储这4个字节有两种方法：一种是将低序字节存储在起始地址，称为小端(little-endian)字节序；另一种方法是将高序字节存储在起始地址，称为大端(big-endian)字节序。</p><p>这两种字节序之间没有标准，两种格式都有系统使用。比如<code>Inter x86</code>，ARM核采用的是小端模式，<code>Power PC</code>，<code>MIPS UNIX</code>和<code>HP-PA</code> UNIX采用大端模式。</p><p>大于一个字节类型的数据在内存中的存放有顺序，一个字节的数据没有顺序的问题。</p><p><strong>网络字节序</strong>是TCP/IP中规定好的一种数据表示格式，它与具体的CPU类型，操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释。网络字节序采用大端模式的排序方式。</p><p><strong>主机字节序</strong>中不同的机器主机字节序不相同，与CPU设计有段，数据的顺序是由CPU决定的，与操作系统无关。</p><p>由于这个原因不同体系结构的机器之间无法通信，所以需要转换成一种约定的字节序，即网络字节序。</p><p>即使同一台机器上的两个进程(比如一个由C语言，另一个由Java编写)通信，也要考虑字节序的问题(JVM采用大端字节序)。</p><p>网络字节序与主机字节序之间的转换函数</p><ul><li><code>htons()</code></li><li><code>ntohs()</code></li><li><code>htonl()</code></li><li><code>ntohl()</code></li></ul><p><code>htons()</code>和<code>ntohs()</code>完成16位无符号数的相互转换。</p><p><code>htonl()</code>和<code>ntohl()</code>完成32位无符号数的相互转换。</p><p>全称<code>host to network short/long</code> - <code>network to host short/long</code></p><h3 id=通信结构体><a class=anchor href=#通信结构体>#</a> 通信结构体</h3><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> sa_family<span class="token punctuation">;</span><span class="token comment">// 地址协议，AF_xxx</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 14字节的端口和地址</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">short</span> <span class="token keyword">int</span> sin_family<span class="token punctuation">;</span><span class="token comment">// 地址类型</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> sin_port<span class="token punctuation">;</span><span class="token comment">// 端口号</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span><span class="token comment">// 地址</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 为了保持与struct sockaddr一样的长度</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> s_addr<span class="token punctuation">;</span><span class="token comment">// 地址</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>int inet_aton(const char* cp,struct in_addr* inp)</code></p><ul><li><p>将一个字符串IP地址转换为一个32位的网络字节序IP地址</p></li><li><p>如果函数执行成功，返回非零值；如果输入地址不正确则返回0</p></li><li><p>函数错误码不会存放在errno中，而是直接忽略</p></li></ul><p><code>char* inet_ntoa(struct in_addr in)</code> - 把网络字节序IP地址转换成字符串的IP地址</p><p><code>in_addr_t inet_addr(const char* cp)</code> - 与<code>inet_aton()</code>函数功能一样</p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> h_name<span class="token punctuation">;</span><span class="token comment">// 主机名</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> h_aliaset<span class="token punctuation">;</span><span class="token comment">// 主机所有别名构成的字符串数组，同一IP可绑定多个域名</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">int</span> h_addrtype<span class="token punctuation">;</span><span class="token comment">// 主机IP地址的类型，例如IPv4(AF_INET)或IPv6</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">int</span> h_length<span class="token punctuation">;</span><span class="token comment">// 主机IP地址长度，IPv4长度为4字节，IPv6长度为16字节</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> h_addr_list<span class="token punctuation">;</span><span class="token comment">// 主机IP地址，以网络字节序存储</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">h_addr</span> <span class="token expression">h_addr_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span></span></pre></td></tr></table></figure><p><code>struct hostent* gethostbyname(const char* name)</code> - 利用字符串格式的域名获得IP网络字节顺序地址</p><h3 id=listen的socket队列><a class=anchor href=#listen的socket队列>#</a> listen的socket队列</h3><p>内核会为listen状态的socket维护两个队列</p><ul><li>不完全请求队列(<code>SYN_RECV</code>状态)</li><li>等待accept建立socket的队列(<code>ESTABLISHED</code>状态)</li></ul><p>在Linux内核2.2之后，backlog参数的行为改变了，现在它指等待accept的完全建立的socket的队列长度，而不是不完全连接请求的数量。</p><p>不完全连接的长度可在<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>设置(缺省值128)。</p><p>backlog参数如果比<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>大，则截断。</p><h2 id=tcp报文分包和粘包><a class=anchor href=#tcp报文分包和粘包>#</a> TCP报文分包和粘包</h2><p><strong>分包</strong> - 发送方发送字符串<code>”helloworld“</code>，接收方却接收到了两个字符串<code>&quot;hello&quot;</code>和<code>&quot;world&quot;</code></p><p><strong>粘包</strong> - 发送方发送两个字符串<code>&quot;hello&quot;</code>和<code>&quot;world&quot;</code>，接收方却一次性接收到了<code>&quot;helloworld&quot;</code></p><p><strong>TCP传输数据可保证以下几点</strong></p><ul><li>顺序不变，例如发送方发送<code>&quot;hello&quot;</code>，接收方也一定按顺序接收到<code>&quot;hello&quot;</code>，这是由于TCP协议是可靠传输，因此这就成了解决分包和粘包问题的关键</li><li>分割的包中间不会插入其他数据</li></ul><p>实际开发中，为了解决分包和粘包的问题，一定要自定义一份协议，最常用的方法是</p><ul><li>报文长度 + 报文内容 - 0010helloworld</li><li>报文长度可用ASCII码或二进制的数字</li></ul><h2 id=封装函数轮子><a class=anchor href=#封装函数轮子>#</a> 封装函数(轮子)</h2><h3 id=writen函数和readn函数><a class=anchor href=#writen函数和readn函数>#</a> Writen()函数和Readn()函数</h3><p>recv函数可能存在读取的报文不完整的情况。</p><p>send函数也可能存在写入数据不完整的情况。</p><p><code>ssize_t recvfrom(int sockfd,void* buf,size_t len,int flags,struct sockaddr* src_addr,socklen_t* addrlen)</code></p><p><code>ssize_t recvmsg(int sockfd,struct msghdr* msg,int flags)</code></p><p>上面两个函数用于UDP传输。</p><p><strong>自定义recv函数</strong></p><p><code>bool Readn(const int sockfd,char* buffer,const size_t n)</code></p><ul><li><p>从已经准备好的socket中读取数据</p></li><li><p>sockfd - 已经准备好的socket连接</p></li><li><p>buffer - 接收数据缓冲区的地址</p></li><li><p>n - 本次接收数据的字节数</p></li><li><p>返回值 - 成功返回true，失败返回false</p></li></ul><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 读取准确指定数量的数据，否则处于阻塞状态</span></pre></td></tr><tr><td data-num=2></td><td><pre>bool <span class="token function">Readn</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">int</span> nLeft<span class="token punctuation">,</span>nread<span class="token punctuation">,</span>idx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    nLeft <span class="token operator">=</span> n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    </pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>nLeft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        </pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buffer <span class="token operator">+</span> idx<span class="token punctuation">,</span>nLeft<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre>           <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        idx <span class="token operator">+=</span> nread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        nLeft <span class="token operator">-=</span> nread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>自定义send函数</strong></p><p><code>bool Writen(const int sockfd,const char* buffer,const size_t n)</code></p><ul><li>向已经准备好的socket中写入数据</li><li>sockfd - 已经准备好的socket连接</li><li>buffer - 待发送数据缓冲区的地址</li><li>n - 待发送数据的字节数</li><li>返回值 - 成功返回true，失败返回false</li></ul><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>bool <span class="token function">Writen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">int</span> nLeft<span class="token punctuation">,</span>idx<span class="token punctuation">,</span>nwritten<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    nLeft <span class="token operator">=</span> n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>nLeft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buffer <span class="token operator">+</span> idx<span class="token punctuation">,</span>nLeft<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>           <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        nLeft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        idx <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=tcpwrite函数和tcpread函数><a class=anchor href=#tcpwrite函数和tcpread函数>#</a> TcpWrite()函数和TcpRead()函数</h3><p>自定义的socket通信报文格式如下 - <code>报文长度 + 报文内容</code></p><p>报文长度为4个字节的整数，表示的是报文内容的长度，而不是整个TCP报文的长度，整个TCP报文的长度是报文内容的长度加4。</p><p>报文长度是4字节的整数倍，即int类型，是以字节流的方式写入socket，而不是ASCII码。</p><p><code>bool TcpWrite(const int sockfd,const char* buffer,const int ibuflen = 0)</code></p><ul><li>向socket的另一端发送数据</li><li>sockfd - 可用的socket连接</li><li>buffer - 待发送数据缓冲区的地址</li><li>ibuflen - 待发送数据的字节数，如果发送的是ASCII字符串，ibuflen取0，如果是二进制流数据，ibuflen为二进制数据块的大小</li><li>返回值 - 成功返回true，失败返回false，失败表示socket连接已不可用</li></ul><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>bool <span class="token function">TcpWrite</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> ibufle<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> sockfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    fd_set tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    </pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    </pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    timeout<span class="token punctuation">.</span>tv_userc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span>sockfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    </pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">int</span> ilen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    </pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token comment">// 如果长度为0，就采用字符串的长度</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ibuflen<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=20></td><td><pre>        ilen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num=22></td><td><pre>        ilen <span class="token operator">=</span> ibuflen<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    </pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">int</span> ilenn <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>ilen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转换为网络字节序</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">char</span> strTBuffer<span class="token punctuation">[</span>ilen<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>strTBuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strTBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>strTBuffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>ilenn<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>strTBuffer<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>ilen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    </pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> <span class="token function">Writen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>strTBuffer<span class="token punctuation">,</span>ilen<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>bool TcpRead(const int sockfd,char* buffer,int* ibuflen,const int itimeout = 0)</code></p><ul><li>接收socket的另一端发送过来的数据</li><li>sockfd - 可用的socket连接</li><li>buffer - 接收数据缓冲区的地址</li><li>ibuflen - 本次成功接收数据的字节数</li><li>itimeout - 接收等待超时的时间，单位：秒，缺省值是0-无线等待</li><li>返回值 - 成功true，失败false，失败有两种情况，等待超时和socket连接已不可用</li></ul><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>bool <span class="token function">TcpRead</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span> ibuflen<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> itimeout<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> sockfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>itimeout <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        fd_set tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        </pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> itimeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>        timeout<span class="token punctuation">.</span>tv_userc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        </pre></td></tr><tr><td data-num=14></td><td><pre>        itn i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>sockfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre>            <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token punctuation">(</span><span class="token operator">*</span>ibuflen<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> <span class="token function">Readn</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ibuflen<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=19></td><td><pre>           <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token punctuation">(</span><span class="token operator">*</span>ibuflen<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token operator">*</span>ibuflen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把网络字节序转换为主机字节序</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> <span class="token function">Readn</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">*</span>ibuflen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>           <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=socket通信的服务端类><a class=anchor href=#socket通信的服务端类>#</a> socket通信的服务端类</h3><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>class CTcpServer</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>private<span class="token operator">:</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">int</span> m_socklen<span class="token punctuation">;</span><span class="token comment">// 结构体struct sockaddr_in的大小</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> m_clientaddr<span class="token punctuation">;</span><span class="token comment">// 客户端的地址信息</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> m_servaddr<span class="token punctuation">;</span><span class="token comment">// 服务端的地址信息</span></pre></td></tr><tr><td data-num=7></td><td><pre>public<span class="token operator">:</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">int</span> m_listenfd<span class="token punctuation">;</span><span class="token comment">// 服务端用于监听的socket</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">int</span> m_connfd<span class="token punctuation">;</span><span class="token comment">// 客户端连接上来的socket</span></pre></td></tr><tr><td data-num=10></td><td><pre>    bool m_btimeout<span class="token punctuation">;</span><span class="token comment">// 调用Read和Write方法时，失败的原因是超时;true-超时，false-未超时</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">int</span> m_buflen<span class="token punctuation">;</span><span class="token comment">// 调用Read方法后，接收到的报文的大小，单位: 字节</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">CTcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 构造函数</span></pre></td></tr><tr><td data-num=14></td><td><pre>    </pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token comment">// 服务端初始化</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token comment">// port - 指定服务端用于监听的端口</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token comment">// 返回值，成功true，失败false，只要port设置正确，没有被占用，初始化都会成功</span></pre></td></tr><tr><td data-num=18></td><td><pre>    bool <span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token comment">// 阻塞等待客户端的连接请求</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token comment">// 返回值，有新的客户端已连接上了(true)，失败false，Accept被中断返回失败，可以重新Accept</span></pre></td></tr><tr><td data-num=22></td><td><pre>    bool <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    </pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token comment">// 获取客户端的ip地址</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token comment">// 返回值，客户端的IP地址</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 接收客户端发送的数据</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token comment">// buffer，接收数据缓冲区的地址，数据的长度存放在m_buflen成员变量中</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token comment">// itimeout，等待数据的超时时间，单位：秒，缺省值是0-无线等待</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token comment">// 返回值，成功true，失败false</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token comment">// 失败有两种情况，等待超时，成员变量m_btimeout的值被设置为true;socket连接已不可用</span></pre></td></tr><tr><td data-num=33></td><td><pre>    bool <span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> itimeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    </pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token comment">// 向客户端发送数据</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token comment">// buffer，待发送数据缓冲区的地址</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token comment">// ibuflen，待发送数据的大小，单位字节，缺省值为0，如果发送的是ASCII字符串，ibuflen取0，如果是字节流数据，ibuflen为二进制数据块的大小。</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token comment">// 返回值，成功true，失败false，失败表示socket连接已不可用</span></pre></td></tr><tr><td data-num=39></td><td><pre>    bool <span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> ibuflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    </pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token comment">// 关闭监听的socket，即m_listenfd，常用于多进程服务程序的子进程代码中</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">void</span> <span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    </pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token comment">// 关闭客户端的socket，即m_connfd，常用于多进程服务程序的父进程代码中</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token keyword">void</span> <span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    </pre></td></tr><tr><td data-num=47></td><td><pre>    <span class="token operator">~</span><span class="token function">CTcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 析构函数自动关闭socket，释放资源</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>CTcpServer<span class="token operator">::</span><span class="token function">CTcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    m_listenfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    m_connfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    m_socklen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>bool CTcpServer<span class="token operator">::</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_listenfd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        m_listenfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    </pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token comment">// WINDOWS平台如下</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token comment">//char b_opt = '1';</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token comment">//setsockopt(m_listenfd,SOL_SOCKET,SO_REUSEADDR,&amp;b_opt,sizeof(b_opt));</span></pre></td></tr><tr><td data-num=23></td><td><pre>    </pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token comment">// Linux平台如下</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    </pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_servaddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    m_servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    m_servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    m_servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">bind</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_servaddr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">listen</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=41></td><td><pre>        <span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    </pre></td></tr><tr><td data-num=45></td><td><pre>    m_socklen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=48></td><td><pre></pre></td></tr><tr><td data-num=49></td><td><pre>bool CTcpServer<span class="token operator">::</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>    </pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_clientaddr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">socklen_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_socklen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=54></td><td><pre>       <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=57></td><td><pre></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> CTcpServer<span class="token operator">::</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=60></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>m_clientaddr<span class="token punctuation">,</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=62></td><td><pre></pre></td></tr><tr><td data-num=63></td><td><pre>bool CTcpServer<span class="token operator">::</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> itimeout<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=64></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=65></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> m_connfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>itimeout <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>        fd_set tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>        </pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>        <span class="token function">FD_SET</span><span class="token punctuation">(</span>m_connfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>        </pre></td></tr><tr><td data-num=73></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre>        timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> itimeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=75></td><td><pre>        timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>        </pre></td></tr><tr><td data-num=77></td><td><pre>        m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>        </pre></td></tr><tr><td data-num=79></td><td><pre>        <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>m_connfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=81></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=82></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> m_btimeout <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre>            <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=86></td><td><pre>    m_buflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token keyword">return</span> <span class="token function">TcpRead</span><span class="token punctuation">(</span>m_connfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>m_buflen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=88></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=89></td><td><pre></pre></td></tr><tr><td data-num=90></td><td><pre>bool CTcpServer<span class="token operator">::</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> ibuflen<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> m_connfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>    </pre></td></tr><tr><td data-num=94></td><td><pre>    fd_set tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    </pre></td></tr><tr><td data-num=96></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>m_connfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre>    </pre></td></tr><tr><td data-num=99></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre>    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre>    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=102></td><td><pre>    </pre></td></tr><tr><td data-num=103></td><td><pre>    m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=104></td><td><pre>    </pre></td></tr><tr><td data-num=105></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=106></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>m_connfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=107></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=108></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> m_btimeout <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=111></td><td><pre>    </pre></td></tr><tr><td data-num=112></td><td><pre>    <span class="token keyword">int</span> ilen <span class="token operator">=</span> ibuflen<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ilen<span class="token punctuation">)</span> ilen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre>    </pre></td></tr><tr><td data-num=115></td><td><pre>    <span class="token keyword">return</span> <span class="token function">TcpWrite</span><span class="token punctuation">(</span>m_connfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>ilen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=116></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=117></td><td><pre></pre></td></tr><tr><td data-num=118></td><td><pre><span class="token keyword">void</span> CTcpServer<span class="token operator">::</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=119></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=120></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_listenfd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=121></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=122></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=123></td><td><pre>        m_listenfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=124></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=125></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=126></td><td><pre></pre></td></tr><tr><td data-num=127></td><td><pre></pre></td></tr><tr><td data-num=128></td><td><pre><span class="token keyword">void</span> CTcpServer<span class="token operator">::</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=129></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=130></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_connfd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=131></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=132></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_connfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=133></td><td><pre>        m_connfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=134></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=135></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=136></td><td><pre></pre></td></tr><tr><td data-num=137></td><td><pre>CTcpServer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">CTcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=138></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=139></td><td><pre>    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=140></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=socket通信的客户端类><a class=anchor href=#socket通信的客户端类>#</a> socket通信的客户端类</h3><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>class CTcpClient</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>public<span class="token operator">:</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">int</span> m_sockfd<span class="token punctuation">;</span><span class="token comment">// 客户端的socket</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">char</span> m_ip<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 服务端的ip地址</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">int</span> m_port<span class="token punctuation">;</span><span class="token comment">// 与服务端通信的端口</span></pre></td></tr><tr><td data-num=7></td><td><pre>    bool m_btimeout<span class="token punctuation">;</span><span class="token comment">// 调用Read和Write方法时，失败的原因是超时;true-超时，false-未超时</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">int</span> m_buflen<span class="token punctuation">;</span><span class="token comment">// 调用Read方法后，接收到的报文的大小，单位: 字节</span></pre></td></tr><tr><td data-num=9></td><td><pre>    </pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token function">CTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 构造函数</span></pre></td></tr><tr><td data-num=11></td><td><pre>    </pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token comment">// ip，服务端的IP地址</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token comment">// port，服务端监听的端口</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token comment">// 返回值，成功true，失败false</span></pre></td></tr><tr><td data-num=16></td><td><pre>    bool <span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    </pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token comment">// 接收服务端发来的数据</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">// buffer，接收数据缓冲区的地址，数据的长度存放在m_buflen成员变量中</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token comment">// itimeout，等待数据的超时时间，单位：秒，缺省值是0-无限等待</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token comment">// 返回值；成功true，失败false，失败有两种情况</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token comment">// 等待超时，成员变量m_btimeout的值被设置为true;socket连接已不可用</span></pre></td></tr><tr><td data-num=23></td><td><pre>    bool <span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> itimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    </pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token comment">// 向服务端发送数据</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// buffer，待发送数据缓冲区的地址</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token comment">// ibuflen，待发送数据的大小，单位为字节，缺省值为0，如果发送的是ASCII字符串，ibuflen取0，如果是字节流数据，ibuflen为二进制数据块的大小。</span></pre></td></tr><tr><td data-num=28></td><td><pre>    bool <span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> ibuflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    </pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token keyword">void</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 断开与服务端的连接</span></pre></td></tr><tr><td data-num=31></td><td><pre>    </pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token operator">~</span><span class="token function">CTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 析构函数自动关闭socket，释放资源</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre>CTcpClient<span class="token operator">::</span><span class="token function">CTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    m_port <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>bool CTcpClient<span class="token operator">::</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> m_sockfd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    </pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">,</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    m_port <span class="token operator">=</span> port<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> h<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    </pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre>    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>m_port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定服务端的通讯端口</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span>h<span class="token operator">-></span>h_addr<span class="token punctuation">,</span>h<span class="token operator">-></span>h_length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">connect</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>        m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=46></td><td><pre></pre></td></tr><tr><td data-num=47></td><td><pre>bool CTcpClient<span class="token operator">::</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> itimeout<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> m_sockfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>    </pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>itimeout <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=52></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=53></td><td><pre>        fd_set tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>        </pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token function">FD_SET</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>        </pre></td></tr><tr><td data-num=58></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre>        timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> itimeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre>        timeout<span class="token punctuation">.</span>tv_userc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>        </pre></td></tr><tr><td data-num=62></td><td><pre>        m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>        </pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>m_sockfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=66></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=67></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> m_btimeout <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>            <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=70></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=71></td><td><pre>    m_buflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>    <span class="token keyword">return</span> <span class="token function">TcpRead</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>m_buflen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=74></td><td><pre></pre></td></tr><tr><td data-num=75></td><td><pre>bool CTcpClient<span class="token operator">::</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> ibuflen<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=76></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=77></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> m_sockfd<span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>    </pre></td></tr><tr><td data-num=79></td><td><pre>    fd_est tmpfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    </pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre>    </pre></td></tr><tr><td data-num=84></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre>    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=87></td><td><pre>    </pre></td></tr><tr><td data-num=88></td><td><pre>    m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    </pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>m_sockfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=93></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> m_btimeout <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=96></td><td><pre>    </pre></td></tr><tr><td data-num=97></td><td><pre>    <span class="token keyword">int</span> ilen <span class="token operator">=</span> ibuflen<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ibuflen<span class="token punctuation">)</span> ilen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre>    <span class="token keyword">return</span> <span class="token function">TcpWrite</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>ilen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=101></td><td><pre></pre></td></tr><tr><td data-num=102></td><td><pre><span class="token keyword">void</span> CTcpClietn<span class="token operator">::</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=103></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=104></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_sockfd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre>    </pre></td></tr><tr><td data-num=106></td><td><pre>    m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=107></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>m_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=108></td><td><pre>    m_port <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre>    m_btimeout <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=111></td><td><pre>CTcpClietn<span class="token operator">::</span><span class="token operator">~</span><span class="token function">CTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=112></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=113></td><td><pre>    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=使用案例><a class=anchor href=#使用案例>#</a> 使用案例</h3><p><strong>服务端</strong></p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../_freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    </pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端%s已连接. \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    </pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=23></td><td><pre>    </pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token comment">//if(flase == TcpServer.Read(strbuffer,300)) break;// 接收客户端发送的请求报文</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 接收客户端发送的请求报文</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        </pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后加上ok</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送 %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开开\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>客户端</strong></p><figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../_freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    CTcpClient TcpClient<span class="token punctuation">;</span><span class="token comment">// 创建客户端的对象</span></pre></td></tr><tr><td data-num=6></td><td><pre>    </pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token string">"172.21.0.3"</span><span class="token punctuation">,</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"172.21.0.3\",5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    </pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">"第%d个"</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpClietn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 向服务端发送请求报文</span></pre></td></tr><tr><td data-num=21></td><td><pre>        </pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>false <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 接收服务端的响应报文</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收： %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=给多进程的socket服务端增加业务逻辑><a class=anchor href=#给多进程的socket服务端增加业务逻辑>#</a> 给多进程的socket服务端增加业务逻辑</h2><p>客户端身份验证</p><p>业务报文的格式自定义，客户端与服务商协商就好，建议采用xml，其具有可读性，可扩展性，容错性。</p><figure class="highlight xml"><figcaption data-lang=XML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">&lt;!-- 客户端请示报文示例 --></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bizcode</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bizcode</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">></span></span>wucz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>p@sswOrd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">&lt;!-- 服务端回应报文示例 --></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retcode</span><span class="token punctuation">></span></span>-1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retcode</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>message</span><span class="token punctuation">></span></span>成功。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>message</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retcode</span><span class="token punctuation">></span></span>-1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retcode</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>message</span><span class="token punctuation">></span></span>用户名或密码不正确。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>message</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>其他业务</p><details class=info><summary>server.cpp</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 父进程退出时调用的函数</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"catching the signal%d \n"</span><span class="token punctuation">,</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">kill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    </pre></td></tr><tr><td data-num=13></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"父进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">// 子进程退出时调用的函数</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"子进程退出。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 编写善后代码(释放资源，提交或回滚事务)</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=31></td><td><pre></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token comment">// 身份验证业务处理函数</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token keyword">char</span> username<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span>password<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token string">"username"</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token string">"password"</span><span class="token punctuation">,</span>password<span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    </pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span><span class="token string">"wucz"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span><span class="token string">"p@sswOrd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span><span class="token string">"&lt;retcode>0&lt;/retcode>&lt;message>成功。&lt;/message>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span><span class="token string">"&lt;retcode>-1&lt;/retcode>&lt;message>用户名或密码不正确。&lt;/message>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=48></td><td><pre></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=51></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=52></td><td><pre>    <span class="token keyword">int</span> ibizcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token string">"bizcode"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>ibizcode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>    </pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token keyword">switch</span><span class="token punctuation">(</span>ibizcode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=56></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span><span class="token comment">// 身份验证</span></pre></td></tr><tr><td data-num=58></td><td><pre>            <span class="token function">biz001</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre>        <span class="token comment">//case 2:// 其他业务</span></pre></td></tr><tr><td data-num=60></td><td><pre>            <span class="token comment">//bizoo2(strrecvbuffer,strsendbuffer); break;</span></pre></td></tr><tr><td data-num=61></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=62></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"非法报文：%s\n"</span><span class="token punctuation">,</span>strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=64></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CLogFile logifle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">// 通过信号使程序退出时调用的函数</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 身份验证业务处理函数</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">bool</span> <span class="token function">bizoo1</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:../mpserver port logfile\nExample:./mpserver 5005 /tmp/mpserver.log\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    </pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token comment">// 关闭全部的信号和输入输出</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 打开日志文件</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"logfile.Open(%s) failed.\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token comment">// 设置信号，在shell状态下可用`Kill 进程号`正常终止些进程</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token comment">// 但不要用"kill -9 进程"来强行终止</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre> 	CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让父进程退出，只留下子进程</span></pre></td></tr><tr><td data-num=40></td><td><pre>    </pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    </pre></td></tr><tr><td data-num=48></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=53></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=58></td><td><pre>            TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程要关闭客户端连接上来的socket(m_connfd)</span></pre></td></tr><tr><td data-num=59></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=61></td><td><pre>        </pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token comment">// 子进程重新设置退出信号</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        </pre></td></tr><tr><td data-num=66></td><td><pre>        TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程要关闭监听的socket</span></pre></td></tr><tr><td data-num=67></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>        </pre></td></tr><tr><td data-num=69></td><td><pre>		<span class="token comment">// 以下是子进程，负责与客户端通信</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token keyword">char</span> strrecvbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=71></td><td><pre>        </pre></td></tr><tr><td data-num=72></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=75></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=77></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre></pre></td></tr><tr><td data-num=80></td><td><pre>            <span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=81></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">_main</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre></pre></td></tr><tr><td data-num=83></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>            <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=85></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=87></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=88></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><details class=info><summary>client.cpp</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../_freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CTcpClient TcpClient<span class="token punctuation">;</span><span class="token comment">// 创建客户端的对象</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">// 身份验证</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=8></td><td><pre>    </pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token string">"&lt;bizcode>1&lt;/bizcode>&lt;username>wucz&lt;/username>&lt;password>p@sswOrd&lt;/password>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送： %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token comment">// 向服务端发送请求报文</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token comment">// 接收服务端的响应报文</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> fase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    </pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"retcode"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>   	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> iretcode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">pirntf</span><span class="token punctuation">(</span><span class="token string">"身份验证成功\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"身份验证失败\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=30></td><td><pre></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    </pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span><span class="token string">"172.21.0.3"</span><span class="token punctuation">,</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"172.21.0.3\",5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    </pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz001() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><h2 id=tcp短连接与长连接><a class=anchor href=#tcp短连接与长连接>#</a> ! TCP短连接与长连接</h2><p>客户端与服务端建立连接进行通信，通信完成后释放连接，建立连接时需要3次握手，释放连接时需要4次挥手，连接的建立和释放都需要时间，服务端还有创建新进程或线程的开销。</p><p><strong>短连接</strong></p><p>客户端与服务端之间只进行一次或连续多次通信，通信完成后马上断开连接。管理起来比较简单，不需要额外的控制手段。</p><ul><li>每次通信都需要建立一个新的连接</li><li>客户端向服务器发送请求后，服务器响应请求，数据发送完成之后，立即断开连接</li><li>短连接适用于请求-响应模式，常见于HTTP/1.0协议的交互</li><li>短连接由于频繁地进行TCP三次握手和四次挥手过程，对于服务器资源消耗较大，但可以较好地释放资源，适用于轻量级的、偶尔的数据交换</li><li>短连接通常用于处理瞬间高并发的场景</li></ul><p><strong>长连接</strong></p><p>客户端与服务端之间需要多次通信，通信的频率和次数不确定，所以客户端和服务端需要保持这个连接。</p><ul><li>一旦建立，连接会保持开放，直到客户端或服务器明确地关闭它</li><li>客户端与服务器建立连接后，可以进行多次的数据传输，直到任一方主动关闭连接</li><li>长连接减少了因为建立和关闭连接而产生的额外开销，适用于需要频繁交换数据的应用</li><li>在HTTP/1.1协议中，默认使用长连接，通过<code>Connection: keep-alive</code>头部实现</li><li>长连接适用于需要维持持久状态或频繁通信的场景，如数据库连接、文件传输、实时通信等</li><li>心跳机制常用于维护长连接，确保连接的活性，并能及时发现异常断开</li></ul><p><strong>短连接与长连接如何选择？</strong></p><ul><li>应用场景 - 如果客户端与服务器之间的交云频繁且持续，长连接可以减少因建立和关闭连接而产生的开销。如果交互是偶尔的，可能短连接更合适。</li><li>资源消耗 - 长连接可以减少CPU和网络的消耗，但会占用更多的内存资源，因为连接需要保持状态。短连接会增加</li></ul><h2 id=长连接的心跳机制keepalive><a class=anchor href=#长连接的心跳机制keepalive>#</a> ! 长连接的心跳机制(Keepalive)</h2><p>如果客户端与服务端采用长连接，在连接空闲时，客户端每若干秒向服务端发送一个心跳报文，服务端也回复一个心跳报文，确认连接继续生效中。</p><p>如果服务端在约定的时间内没有收到客户端的任何报文，则认为客户端已掉线，就主动断开连接，释放资源。</p><p>心跳报文建议在60秒之内，不要超过120秒。由于交换机上有个设置，如果连接空闲它会在60秒到120秒之间断开连接。</p><details class=info><summary>client.cpp</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 发送心跳报文</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=5></td><td><pre>    </pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token string">"&lt;bizcode>0&lt;/bizcode>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">WRite</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">// 向服务端发送请求报文</span></pre></td></tr><tr><td data-num=10></td><td><pre>    </pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> fasel<span class="token punctuation">;</span><span class="token comment">// 接收服务端的响应报文</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    </pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../_freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CTcpClient TcpClient<span class="token punctuation">;</span><span class="token comment">// 创建客户端的对象</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发送心跳报文</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 身份验证</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 余额查询</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:../demo47_biz port\nExample:./demo47_biz 170.21.0.3 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    </pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token comment">// 向服务端发起连接请求</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"%s\",%s) failed. \n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    </pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token comment">// 身份验证</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz001() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 余额查询</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 余额查询</span></pre></td></tr><tr><td data-num=34></td><td><pre>    </pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=38></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><details class=info><summary>server.cpp</summary><div><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 心跳报文</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span><span class="token string">"&lt;retcode>0&lt;/retcode>&lt;message>成功。&lt;/message>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    retur <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">int</span> ibizcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token string">"bizcode"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>ibizcode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    </pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">switch</span><span class="token punctuation">(</span>ibizcode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span><span class="token comment">// 心跳</span></pre></td></tr><tr><td data-num=17></td><td><pre>            <span class="token function">biz000</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span><span class="token comment">// 身份验证</span></pre></td></tr><tr><td data-num=19></td><td><pre>            <span class="token function">biz001</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token comment">//case 2:// 其他业务</span></pre></td></tr><tr><td data-num=21></td><td><pre>            <span class="token comment">//bizoo2(strrecvbuffer,strsendbuffer); break;</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num=23></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"非法报文：%s\n"</span><span class="token punctuation">,</span>strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CLogFile logifle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">// 通过信号使程序退出时调用的函数</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 身份验证业务处理函数</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">bool</span> <span class="token function">bizoo1</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:../mpserver port logfile\nExample:./mpserver 5005 /tmp/mpserver.log\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    </pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token comment">// 关闭全部的信号和输入输出</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 打开日志文件</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"logfile.Open(%s) failed.\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token comment">// 设置信号，在shell状态下可用`Kill 进程号`正常终止些进程</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token comment">// 但不要用"kill -9 进程"来强行终止</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre> 	CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让父进程退出，只留下子进程</span></pre></td></tr><tr><td data-num=40></td><td><pre>    </pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    </pre></td></tr><tr><td data-num=48></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=53></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=58></td><td><pre>            TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程要关闭客户端连接上来的socket(m_connfd)</span></pre></td></tr><tr><td data-num=59></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=61></td><td><pre>        </pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token comment">// 子进程重新设置退出信号</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        </pre></td></tr><tr><td data-num=66></td><td><pre>        TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程要关闭监听的socket</span></pre></td></tr><tr><td data-num=67></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>        </pre></td></tr><tr><td data-num=69></td><td><pre>		<span class="token comment">// 以下是子进程，负责与客户端通信</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token keyword">char</span> strrecvbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">;</span><span class="token comment">//存放数据的缓冲区</span></pre></td></tr><tr><td data-num=71></td><td><pre>        </pre></td></tr><tr><td data-num=72></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=75></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>            <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=77></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre></pre></td></tr><tr><td data-num=80></td><td><pre>            <span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=81></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">_main</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre></pre></td></tr><tr><td data-num=83></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>            <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=85></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=87></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源</span></pre></td></tr><tr><td data-num=88></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details><p><strong>TCP Keepalive</strong></p><p>TCP Keepalive是一种可选的心跳机制，用于检测对方是否仍然活跃。当连接在一定时间内没有数据传输时，Keepalive能够确定对方是否仍然可达，从而避免因对方意外断开而导致的长时间无响应。</p><p>在Keepalive启用的情况下，系统会在连接空闲期间周期性地发送探测包。如果连续发送多个探测包都没有得到ACK响应，则认为连接已断开，并将其关闭。Keepalive参数(如空闲时间、探测间隔和失败尝试次数)可以根据实际需求进行配置。<strong>一般为八小时</strong></p><p>需要注意的是，并非所有场景都需要启用Keepalive。在一些情况下，如HTTP长轮询或WebSockets，应用层协议自身就具备类似的心跳检测功能，此时不必启用Keepalive。</p><p><strong>keepalive是什么</strong></p><p>Keepalive是一个网络功能，用于检测两台计算机之间的连接是否仍然活跃。在TCP/IP协议中，它是指定期发送探测包以确保连接仍然存在并且对方尚未崩溃或无法到达。Keepalive可以帮助识别死亡、挂起或不再活跃的连接，并允许应用程序采取相应的行动，如重新连接或释放资源。</p><p>在很多情况下，默认的TCP连接没有开启Keepalive，因为频繁地发送Keepalive探测包可能会增加不必要的网络流量。但是，在长时间打开的连接中(例如数据库连接)，可能需要使用Keepalive来确保持续的服务可用性。</p><p><strong>如何使用Keepalive？</strong></p><p><strong>在Socket编程中设置</strong></p><p>Keepalive参数通常可以通过socket的选项来设置。例如，在C语言中，可以使用<code>setsockopt</code>函数来设置<code>TCP Keepalive</code></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">int</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre>socklen_t optlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>optval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">// 开启Keepalive属性</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> optlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>在操作系统级别设置</strong></p><p>对于类Unix系统，比如Linux，可以通过修改系统文件中的以下参数来调整Keepalive的行为：</p><ul><li><code>/proc/sys/net/ipv4/tcp_keepalive_time</code> - 在开始发送Keepalive探测前的空闲时间</li><li><code>/proc/sys/net/ipv4/tcp_keepalive_probes</code> - 在断开连接前发送Keepalive探测的最大次数</li><li><code>/proc/sys/net/ipv4/tcp_keepalive_intvl</code> - 两个Keepalive探测之间的间隔</li></ul><figure class="highlight sh"><figcaption data-lang=sh></figcaption><table><tr><td data-num=1></td><td><pre><span class="token builtin class-name">echo</span> <span class="token number">600</span> <span class="token operator">></span> /proc/sys/net/ipv4/tcp_keepalive_time</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token builtin class-name">echo</span> <span class="token number">10</span> <span class="token operator">></span> /proc/sys/net/ipv4/tcp_keepalive_probes</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token builtin class-name">echo</span> <span class="token number">60</span> <span class="token operator">></span> /proc/sys/net/ipv4/tcp_keepalive_intvl</pre></td></tr></table></figure><p>这些命令将设置TCP连接在空闲10分钟后开始发送Keepalive探测，每次发送间隔1分钟，总共发送10次探测。</p><p><strong>在应用程序层面设置</strong></p><p>很多高级语言的网络库也提供了设置Keepalive的接口。例如，在Python的<code>socket</code>模块中，可以这样设置Keepalive</p><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">import</span> socket</pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre>s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>当Keepalive被启用时，如果在设定的时间内没有数据交换，系统会自动发送Keepalive探测包。如果对端响应，则连接继续保持活跃状态；如果对端未响应(经过一定数量的重试后)，则操作系统会认为连接已经失效，并通知应用程序(通过返回错误码等方式)，应用程序可以据此关闭连接，清理资源，或者尝试重连等操作。</p><h2 id=多线程网络服务端框架><a class=anchor href=#多线程网络服务端框架>#</a> 多线程网络服务端框架</h2><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">void</span> <span class="token function">mainexit</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"maineixt begin. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    </pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token comment">// 关闭监听的socket</span></pre></td></tr><tr><td data-num=6></td><td><pre>    TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    </pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token comment">// 取消全部的线程</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"cancel %ld\n"</span><span class="token punctuation">,</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token function">pthread_cancle</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token comment">//pthread_join(vpthid[i],NULL);</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    </pre></td></tr><tr><td data-num=16></td><td><pre>   logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"mainexit end. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment">// 线程清理函数</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token keyword">void</span> <span class="token function">pthmainexit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit begin. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭与客户端的socket</span></pre></td></tr><tr><td data-num=25></td><td><pre>    </pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 从vpthid中删除本线程的id</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>        	vpthid<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit end. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pthmain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>pthmainexit<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注册线程清理函数</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 分离线程，用于网络服务，数据类处理不需要</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span>PTHREAD_CANCEL_DISABLE<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置取消方式为立即取消</span></pre></td></tr><tr><td data-num=41></td><td><pre>    </pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 与客户端的socket连接</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">int</span> ibuflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>    </pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=47></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=48></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>        <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">TcpRead</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>strbuffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>ibuflen<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        </pre></td></tr><tr><td data-num=53></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=54></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">TcpWrite</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=58></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源   </span></pre></td></tr><tr><td data-num=59></td><td><pre>    </pre></td></tr><tr><td data-num=60></td><td><pre>    <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>    <span class="token function">pthread_eixt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"../freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre>CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=4></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> vpthid<span class="token punctuation">;</span><span class="token comment">// 存放线程id的容器</span></pre></td></tr><tr><td data-num=5></td><td><pre>CLogFile logfile<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// 处理业务的主函数</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">// 心跳报文</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">// 身份验证业务处理函数</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">// 查询余客业务处理函数</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:../mtserver_bize port logfile\nExample:./mpserver_bize 5005 /tmp/mpserver_bize.log\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 关闭全部的信号和输入输出</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    </pre></td></tr><tr><td data-num=31></td><td><pre>	<span class="token comment">// 打开日志文件</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"logfile.Open(%s) failed.\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token comment">// 设置信号，在shell状态下可用`kill 进程号`正常终止进程</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token comment">// 但不要用`kill -9 进程号`强制张总</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>    </pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=46></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.IinitServer(%s) failed.\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=49></td><td><pre>    </pre></td></tr><tr><td data-num=50></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token punctuation">&#123;</span>     </pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=53></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=54></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=55></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=58></td><td><pre></pre></td></tr><tr><td data-num=59></td><td><pre>        pthread_t pthid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=60></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthmain<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>TcpServer<span class="token punctuation">.</span>m_connfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=61></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=62></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthread_create faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        </pre></td></tr><tr><td data-num=66></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=67></td><td><pre>        vpthid<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pthid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把线程id保存到vpthid容器中</span></pre></td></tr><tr><td data-num=68></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=69></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=网络服务端的性能测试><a class=anchor href=#网络服务端的性能测试>#</a> 网络服务端的性能测试</h2><h3 id=概述-2><a class=anchor href=#概述-2>#</a> 概述</h3><p>在实际项目开发中，除了完成程序的功能，还需要测试性能。</p><p>在充分了解服务端的性能后，才能决定如何选择服务端的架构，还有网络带宽，硬件配置等。</p><p>主要的性能指标如下</p><ul><li>服务端的并发能力</li><li>服务端的业务处理能力</li><li>服务端业务响应时效</li><li>网络带宽</li></ul><h3 id=服务端并发性能测试><a class=anchor href=#服务端并发性能测试>#</a> 服务端并发性能测试</h3><p>服务端最大并发量，即可以接受客户端连接的最大数量。</p><p>注意客户端业务请求不要太频繁。</p><p>重视CPU和内存使用率的变化(磁盘I/O，网络I/O)。</p><p><code>top</code>命令 - 看CPU</p><p><code>free -m</code>命令 - 看内存</p><p>使用1000行的shell执行命令(执行客户端发送心跳报文)的<code>.sh</code>文件</p><h3 id=服务端业务性能测试><a class=anchor href=#服务端业务性能测试>#</a> 服务端业务性能测试</h3><p>服务端最大业务处理能力，即每秒可以处理的业务请求数量</p><p>注意客户端的数量不能太多。</p><p>重视CPU和内存使用率的变化。</p><p>修改usleep()来加大业务处理数量，再通过100个执行命令的客户端脚本(<code>.sh</code>文件)测试</p><p>通过命令<code>grep &quot;2020-10-01 16：05：37 接收&quot; /tmp/mpserver_biz.log | wc</code>命令来查看每秒可处理的业务。</p><h3 id=多进程与多线程服务端性能差异><a class=anchor href=#多进程与多线程服务端性能差异>#</a> 多进程与多线程服务端性能差异</h3><p>在处理业务测试上，多线程在CPU和内存的消耗上有优势，即多线程比多进程更省资源。</p><p>在并发测试上，多进程比多线程更省CPU和内存资源。</p><p>两者的性能差异是对不同条件而言的，设置不同的条件组合，利弊也不同。</p><h3 id=客户端业务响应时间测试><a class=anchor href=#客户端业务响应时间测试>#</a> 客户端业务响应时间测试</h3><p>客户端业务的响应时间，即发出业务请求与收到服务端响应的时间，这个指标关系到用户体验。</p><p>测试环境包括</p><ul><li>业务的闲时/忙时；</li><li>不同的网络环境(局域网，互联网，移动通信网络)</li></ul><p>通过计时器计时</p><h3 id=网络带宽的测试><a class=anchor href=#网络带宽的测试>#</a> 网络带宽的测试</h3><p>测试的目的是根据业务需求，判断出对网络带宽要求。</p><ul><li>测试网络的有效带宽</li><li>测试网络带宽能承载的业务量，不同的业务对带宽的利用率不一样。要求测试环境的各环节不能存在性能瓶颈，确保唯一的瓶颈就是网络带宽</li></ul><p>注意事项，只发送数据，不接收回应；上行和下行分开测试。</p><h2 id=io复用><a class=anchor href=#io复用>#</a> ! I/O复用</h2><h3 id=概述-3><a class=anchor href=#概述-3>#</a> 概述</h3><p>多进程/线程网络服务端在创建进程/线程时CPU和内存开销很大。</p><p>多进程/线程并发模型，为每个socket分配一个进程/线程。</p><p>I/O(多路)复用，采用单个进程/线程就可以管理多个socket。</p><p>网络设备(交换机，路由器)，大型游戏的后台，ngnix，redis</p><p>I/O复用有三种方案：select，poll，epoll，各有优缺点，select并不是一定就不行，epoll也不是什么都好，各有各的应用场景，需全部掌握。</p><p><strong>五种IO模式</strong></p><ul><li><p><strong>阻塞I/O</strong> - 这是最常见的I/O模型。在此模式中，当应用程序执行I/O操作时，如果数据还没有准备好，应用程序就会被阻塞(挂起)，直到数据准备好为止。这期间，应用程序不能做其他事情</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/3.webp alt=""></p></li><li><p><strong>非阻塞I/O</strong> - 在此模式中，如果I/O操作的数据还没有准备好，操作会立即返回一个错误，而不是阻塞应用程序。应用程序可以继续执行其他操作，也可以反复尝试该I/O操作</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/4.webp alt=""></p></li><li><p><strong>I/O多路复用</strong> - 也常称为事件驱动I/O。在此模式中，应用程序可以同时监控多个I/O描述符(比如，socket)，当任何一个I/O描述符准备好数据时，应用程序就可以对其进行处理。这可以在一个单独的进程或线程中同时处理多个I/O操作，并且不需要阻塞或轮询。select、poll、epoll都是这种模型的实现</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/5.webp alt=""></p></li><li><p><strong>信号驱动I/O</strong> - 在此模型中，应用程序可以向操作系统注册一个信号处理函数，当数据准备好时，操作系统会发送一个信号，应用程序可以在接收到信号时读取数据。这种模式避免了阻塞和轮询，但是编程复杂性较高</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/6.webp alt=""></p></li><li><p><strong>异步I/O</strong> - 在此模型中，应用程序发起I/O操作后，可以立即开始做其他事情，当数据准备好时，操作系统会将数据复制到应用程序的缓冲区，并通知应用程序。这种模型的优点是应用程序不需要等待I/O操作的完成，缺点是编程复杂性较高</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/7.webp alt=""></p></li></ul><p>同步I/O包含阻塞I/O，非阻塞I/O，I/O多路复用，信号驱动。</p><p><strong>五种I/O的区别？</strong></p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/8.webp alt=""></p><p><strong>阻塞和非阻塞有什么区别？</strong></p><ul><li>阻塞是指在发起一个调用之后，在消息返回之前，当前进程/线程会被挂起，直到有消息返回，当前进程/线程才会被激活</li><li>非阻塞是指在发起一个调用之后，不会阻塞当前进程/线程，而会立即返回</li></ul><p>需要注意的是，阻塞/非阻塞强调的是等待消息时的状态。</p><p><strong>select、poll、epoll之间有什么区别？</strong></p><ul><li><p><code>select</code>本质上是通过设置和轮询<code>fd_set</code>来检查是否有就绪的文件描述符，其缺点在于</p><ul><li>单个进程可监视的文件描述符数量较少，在32位机器上默认为1024个，在64位机器上默认为2048个</li><li>每次调用<code>select</code>都需要把<code>fd_set</code>从用户空间拷贝到内核空间，文件描述符较多时开销较大</li><li>每次调用<code>select</code>都需要线性扫描<code>fd_set</code>，文件描述符较多时开销较大</li></ul></li><li><p><code>poll</code>与<code>select</code>相似，不同之处在于<code>poll</code>使用<code>pollfd</code>链表结构保存文件描述符，因此与<code>select</code>相比，没有文件描述符数量的限制</p></li><li><p><code>epoll</code>提供了三个函数</p><ul><li><p><code>epoll_create</code>用于创建一个<code>epoll</code>句柄</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>epoll_ctl</pre></td></tr></table></figure><p>用于注册要监听的事件类型，其特点是</p><ul><li>每次注册新的事件到<code>epoll</code>句柄中时，会把所有的文件描述符拷贝进内核空间，保证了每个文件描述符在整个过程中只拷贝一次，不会出现重复拷贝</li><li>为每个文件描述符指定一个回调函数，当事件发生时，就会调用这个回调函数，把就绪的文件描述符加入到就绪链表中</li></ul></li><li><p><code>epoll_wait</code>用于等待事件的发生，唤醒等待中的进程</p></li><li><p><code>epoll</code>对文件描述符的操作有两种模式</p><ul><li><p>水平触发 - 当<code>epoll_wait</code>检测到描述符事件发生并将此事件通知应用程序，应用程序可以不立即处理该事件，下次调用<code>epoll_wait</code>时，将会再次响应应用程序并通知此事件</p></li><li><p>边缘触发 - 当<code>epoll_wait</code>检测到描述符事件发生并将此事件通知应用程序，应用程序必须立即处理该事件，如果不处理，下次调用<code>epoll_wait</code>时，不会再次响应应用程序并通知此事件</p></li></ul></li></ul></li></ul><p>需要注意的是，表面上看<code>epoll</code>的性能最好，但是连接数量较少并且都十分活跃的情况下，<code>select</code>和<code>poll</code>的性能可能较好，因为<code>epoll</code>的通知机制需要使用回调函数。</p><h3 id=select模型><a class=anchor href=#select模型>#</a> select模型</h3><p>select模型是一个单进程或单线程的，可以搞定全部的等待和阻塞。</p><p>这是最古老的一种IO多路复用模型。它的主要功能是<strong>监视多个文件描述符</strong>(在网络编程中，文件描述符通常代表一个socket连接)，<strong>直到其中一个文件描述符准备好进行某种IO操作(如读或写)为止。使用select模型的优点是跨平台性好</strong>，基本上所有的操作系统都支持。但是它有一些明显的<strong>缺点，如单个进程能够监视的文件描述符数量有限(通常是1024)，处理效率较低</strong>(每次调用select都需要遍历所有的文件描述符)，以及它不能随着连接数的增加而线性扩展。</p><h4 id=流程><a class=anchor href=#流程>#</a> <strong>流程</strong></h4><p>select的流程</p><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/1.webp alt=""></p><p>有数据可读 - 有请求报文</p><p>当socket连接断开便会从集合中被移除</p><p>监听的socket用于等待客户端的连接，客户端的socket用于等待客户端的报文，这两者的阻塞全部在<code>select()</code>中，该select可以同时阻塞多个socket，不管是监听的socket或者是客户端的socket，当其中存在socket有事件(新的客户端的连接，客户端的请求)，<code>select()</code>函数就会返回。</p><p><strong>应用代码</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">int</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    </pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token comment">// Linux如下</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_KEEPALIVE<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    </pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>    </pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind() faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listen() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token keyword">return</span> sock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/fcntl.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// 初始化服务端的监听端口</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">int</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage:./tcpselect prot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    </pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">// 初始化服务端用于监听的socket</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">int</span> listensock <span class="token operator">=</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listensock = %d\n"</span><span class="token punctuation">,</span>listensock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    </pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>listensock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"initserver() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    </pre></td></tr><tr><td data-num=29></td><td><pre>    fd_set readfdset<span class="token punctuation">;</span><span class="token comment">// 读事件的集合，包括监听socket和客户端连接上来的socket</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token keyword">int</span> maxfd<span class="token punctuation">;</span><span class="token comment">// readfdset中socket的最大值</span></pre></td></tr><tr><td data-num=31></td><td><pre>    </pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token comment">// 初始化结构体，把listensock添加到集合中</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>    </pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>listensock<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    maxfd <span class="token operator">=</span> listensoc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token comment">// 调用select函数时，会改变socket集合的内容，</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token comment">// 所以要把socket集合保存下来，传一个临时的给select。</span></pre></td></tr><tr><td data-num=41></td><td><pre>        fd_set tmpfdset <span class="token operator">=</span> readfdset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>        </pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token keyword">int</span> infds <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfdset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token comment">//printf("select infds = %d\n",inds);</span></pre></td></tr><tr><td data-num=45></td><td><pre>        </pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token comment">// 返回失败</span></pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>infds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=48></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=49></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select() faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=53></td><td><pre>        </pre></td></tr><tr><td data-num=54></td><td><pre>        <span class="token comment">// 超时，在本程序中，select函数最后一个参数为空，不存在超时的情况，但以下代码还是留着</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> infds<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=57></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select(() timeout. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=60></td><td><pre>        </pre></td></tr><tr><td data-num=61></td><td><pre>        <span class="token comment">// 检查有事件发生的socket，包括监听和客户端连接的socket</span></pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token comment">// 这里是客户端的socket事件，每次要遍历整个集合，因为可能有多个socket有事件</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>eventfd <span class="token operator">&lt;=</span> maxfd<span class="token punctuation">;</span><span class="token operator">++</span>eventfd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=65></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfdset<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>eventfd <span class="token operator">==</span> listensock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=67></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>                <span class="token comment">// 如果发生事件的是listensock，表示有新的客户端连上来</span></pre></td></tr><tr><td data-num=69></td><td><pre>                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>                socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>                <span class="token keyword">int</span> clientsock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listensock<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>clistenscok <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=75></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=77></td><td><pre>                </pre></td></tr><tr><td data-num=78></td><td><pre>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(socke = %d) connected ok. \n"</span><span class="token punctuation">,</span>clientsock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre>                </pre></td></tr><tr><td data-num=80></td><td><pre>                <span class="token comment">// 把新的客户端socket加入集合</span></pre></td></tr><tr><td data-num=81></td><td><pre>                <span class="token function">FD_SET</span><span class="token punctuation">(</span>clientsock<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>                </pre></td></tr><tr><td data-num=83></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>maxfd <span class="token operator">&lt;</span> clientsock<span class="token punctuation">)</span> maxfd <span class="token operator">=</span> clientsock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=86></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num=87></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=88></td><td><pre>                <span class="token comment">// 客户端有数据过来或客户端的socket连接被断开</span></pre></td></tr><tr><td data-num=89></td><td><pre>                <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=90></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre>                </pre></td></tr><tr><td data-num=92></td><td><pre>                <span class="token comment">// 读取客户端数据</span></pre></td></tr><tr><td data-num=93></td><td><pre>                ssize_t isize <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>                </pre></td></tr><tr><td data-num=95></td><td><pre>                <span class="token comment">// 发生了错误或socket被对方关闭</span></pre></td></tr><tr><td data-num=96></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>isize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=97></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=98></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(eventfd = %d) disconnected. \n"</span><span class="token punctuation">,</span>eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre>                    <span class="token function">close</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭客户端的socket</span></pre></td></tr><tr><td data-num=100></td><td><pre>                    <span class="token function">FD_CLR</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从集合中移去客户端的socket</span></pre></td></tr><tr><td data-num=101></td><td><pre>                    </pre></td></tr><tr><td data-num=102></td><td><pre>                    <span class="token comment">// 重新计算maxfd的值，注意，只有当eventfd == maxfd时才需计算</span></pre></td></tr><tr><td data-num=103></td><td><pre>                    <span class="token keyword">if</span><span class="token punctuation">(</span>maxfd <span class="token operator">==</span> eventfd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=104></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=105></td><td><pre>                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> maxfd<span class="token punctuation">;</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">--</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=106></td><td><pre>                        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=107></td><td><pre>                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=108></td><td><pre>                            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=109></td><td><pre>                                maxfd <span class="token operator">=</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre>                                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=111></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=112></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=113></td><td><pre>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"maxfd = %d\n"</span><span class="token punctuation">,</span>maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre>                        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=115></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=116></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv(eventfd=%d,size = %d): %s\n"</span><span class="token punctuation">,</span>eventfd<span class="token punctuation">,</span>isize<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=117></td><td><pre>                    </pre></td></tr><tr><td data-num=118></td><td><pre>                    <span class="token comment">// 把收到的报文发回给客户端</span></pre></td></tr><tr><td data-num=119></td><td><pre>                    <span class="token function">write</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=120></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=121></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=122></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=123></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=124></td><td><pre>  	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=125></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>socket的值</strong></p><ul><li>描述符 - 说明</li><li>0 - 标准输入</li><li>1 - 标准输出</li><li>2 - 标准出错</li><li>3 - listenfd</li><li>4 - connfd1</li><li>5 - connfd2</li><li>6 - connfd3</li></ul><p><strong>fd_set结构体</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_FD_SETSIZE</span> <span class="token expression"><span class="token number">1024</span></span></span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> fds_bits<span class="token punctuation">[</span>__FD_SETSIZE <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span>__kernel_fd_set<span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src=https://cdn.jsdelivr.net/gh/ReverseSacle/Gallery@latest/programming/network-programming/programming/2.webp alt=""></p><p><code>/usr/include/linux/posix_types.h</code></p><p><code>fd_set</code>是一个<strong>位图</strong>(Bitmap)，每个socket在上面都有对应的位置，一共1024个，即只能加入1024个socket，但可调整<code>_FD_SETSIZE</code>宏来改变最大值(没必要)。</p><p><strong>宏</strong></p><ul><li><p><code>void FD_CLR(int fd,fd_set* set)</code> - 清除一个socket，将清除位置的值变为0</p></li><li><p><code>int FD_ISSET(int fd,fd_set* set)</code> - 判断位置是否为1，即socket是否在fd_set中</p></li><li><p><code>void FD_SET(int fd,fd_set* set)</code> - 加入一个socket，将加入的位置的值变为1</p></li><li><p><code>void FD_ZERO(fd_set* set)</code> - 初始化，将位图全部位置置0</p></li></ul><p> </p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 调用select函数时，会改变socket集合的内容，</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">// 所以要把socket集合保存下来，传一个临时的给select。</span></pre></td></tr><tr><td data-num=3></td><td><pre>fd_set tmpfdset <span class="token operator">=</span> readfdset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">int</span> infds <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfdset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>监视(监听)tmpfdset中哪些socket有事件，由于select函会修改传入的位图(fd_set)，其只会改变有事件的socket位置值，其他位置会被置0，这会导致原来存在的socket被弄个丢，因此需要拷贝原来传入之间的一份。</p><p><strong>select相关函数详解</strong></p><p>需包含头文件 - <code>#include&lt;sys/select.h&gt;</code></p><p><code>int select(int nfds,fd_set* readfds,fd_set* writefds,fd_set* exceptfds,struct timeval* timeout)</code></p><ul><li>nfds - 用来表示位图的大小，是指集合中所有描述符的最大值加1</li><li>readfds - 用于监听socket的位图，监视是否有新的socket连接，或现有的描述符是否有数据可读</li><li>writefds - 用于往socket中写数据，监视是否可以向描述符中写入数据，很少用</li><li>exceptfds - 用于接收有异常的socket，监视描述符中的异常，从未使用过</li><li>timeout - 超时机制</li><li>返回值 - 成功会返回传入的所有集合的所有发生事件的个数，超时会返回0，失败(内存满了，传入错误的集合)会返回<code>-1</code></li></ul><p><strong>select的超时机制</strong></p><figure class="highlight cpp"><figcaption data-lang=C++><span>超时机制</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 超时机制传入的是一个结构体</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">// 结构体在库中的定义</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">timeval</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span><span class="token comment">//秒</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span><span class="token comment">//微秒</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span>；</pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// 使用示例</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">timeval</span> sttime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>sttime<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>sttime<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token function">select</span><span class="token punctuation">(</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tmpfdset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>sttime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>int pselect(int nfds,fd_set* readfds,fd_set* writefds,fd_set* exceptfds,struct timeval* timeout,const sigset_t* sigmask)</code></p><p>相较于<code>select</code>函数多了一个参数sigmask，指明select在工作时可以屏蔽哪些信号。</p><h4 id=select的水平触发><a class=anchor href=#select的水平触发>#</a> select的水平触发</h4><p>select采用水平触发的方式，如果报告了fd后事件没有被处理或数据没有被全部读取，那么下次select时会再次报告该fd，即分次序将整个数据读取。</p><h4 id=select的性能测试><a class=anchor href=#select的性能测试>#</a> select的性能测试</h4><p>一定要排除网络环境的影响。</p><p>需要好几十万的数据才算测试。</p><h4 id=select的缺点><a class=anchor href=#select的缺点>#</a> select的缺点</h4><p>select支持的文件描述符数量太小了，默认是1024，虽然可以调整，但是，描述符数量越大，效率将更低，调整的意义不大。</p><p>每次调用select，都需要把fdset从用户态拷贝到内核。</p><p>同时在线的大量客户端有事件发生的可能很少，但还是需要遍历fdset，因此随着监视的描述符数量的增长，其效率也会称线性下降。</p><h4 id=select的其他用途><a class=anchor href=#select的其他用途>#</a> select的其他用途</h4><p>在unix(Linux)世界里，一切皆文件，文件就是一串二进制流，不管socket，管道，终端，设备等都是文件，一切都是流。在信息交换的过程中，都是对这些流进行数据的收发操作，简称<code>I/O操作</code>(input and output)，往流中读取数据，系统调用read，写入数据，系统调用write。</p><p>select是I/O复用函数，除了网络通信，还可以用于文件，管道，终端，设备等操作，但开发场景比较少。</p><h3 id=poll模型><a class=anchor href=#poll模型>#</a> poll模型</h3><p><strong>poll模型和select模型非常相似，但它没有最大文件描述符数量的限制</strong>。和select一样，poll每次调用时也需要遍历所有的文件描述符，同样不能随着连接数的增加而线性扩展。</p><p>poll和select本质上没有多大差别，管理多个描述符也是进行轮询，根据描述符的状态进行处理，但是poll没有最大文件描述符数量的限制。</p><p>select采用fdset(bitmap)，poll采用了数组。</p><p>poll和select同样存在一个缺点，即文件描述符的数组被整体复制于用户态和内核态的地址空间之间，而不论这些文件描述符是否有事件，它的开销随着文件描述符数量的增加而称线性增大。</p><p>还有poll返回后，也需要遍历整个描述符的数组才能的得到有事件的描述符。</p><p><strong>poll函数和参数</strong></p><p><code>int poll(struct pollfd* ds,nfds_t nfds,int timeout)</code></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">pollfd</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token comment">// 文件描述符</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">short</span> events<span class="token punctuation">;</span><span class="token comment">// 需要监听的事件</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">short</span> revents<span class="token punctuation">;</span><span class="token comment">// 标志位，当有事件时会修改此标志位</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>如果fd是负数便会被poll忽略</li><li>events的监听事件有<ul><li>POLLIN - 表示数据可读</li><li>POLLPRI - 表示以按优先级的数据可读</li><li>POLLOUT - 表示数据可写</li></ul></li></ul><p><strong>示例</strong></p><p><code>ulimit -n</code> - 查看内核参数</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">inlcude</span><span class="token expression"><span class="token operator">&lt;</span>poll<span class="token punctuation">.</span>h<span class="token operator">></span></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/fcntl.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">// ulimit -n</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXNFDS</span> <span class="token expression"><span class="token number">1024</span></span></span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 初始化服务端的监听端口</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">int</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage:./tcpselect prot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    </pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token comment">// 初始化服务端用于监听的socket</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token keyword">int</span> listensock <span class="token operator">=</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listensock = %d\n"</span><span class="token punctuation">,</span>listensock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    </pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>listensock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"initserver() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    </pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">int</span> maxfd<span class="token punctuation">;</span><span class="token comment">// fds数组中需要监视的socket大小</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span>MAXNFDS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// fds存放需要监视的socket</span></pre></td></tr><tr><td data-num=35></td><td><pre>    </pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token comment">// 初始化数组，把全部的fd设置为-1</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> MAXNFDS<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token comment">// 把listensock添加到数组中</span></pre></td></tr><tr><td data-num=40></td><td><pre>    fds<span class="token punctuation">[</span>listensock<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listensock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token comment">// 有数据可读事件，包括新客户端的连接，客户端socket有数据可读和客户端socket断开三种情况</span></pre></td></tr><tr><td data-num=42></td><td><pre>    fds<span class="token punctuation">[</span>listensock<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    maxfd <span class="token operator">=</span> listensock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    </pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token keyword">int</span> infds <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>        </pre></td></tr><tr><td data-num=49></td><td><pre>        <span class="token comment">// 返回失败</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>infds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=52></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"poll() faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        </pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token comment">// 超时，在本程序中，select函数最后一个参数为空，不存在超时的情况，但以下代码还是留着</span></pre></td></tr><tr><td data-num=58></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> infds<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=59></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=60></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"poll(() timeout. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=63></td><td><pre>        </pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token comment">// 检查有事件发生的socket，包括监听和客户端连接的socket</span></pre></td></tr><tr><td data-num=65></td><td><pre>        <span class="token comment">// 这里是客户端的socket事件，每次要遍历整个集合，因为可能有多个socket有事件</span></pre></td></tr><tr><td data-num=66></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>eventfd <span class="token operator">&lt;=</span> maxfd<span class="token punctuation">;</span><span class="token operator">++</span>eventfd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=67></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>            fds<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先把revents清空</span></pre></td></tr><tr><td data-num=71></td><td><pre>            </pre></td></tr><tr><td data-num=72></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>eventfd <span class="token operator">==</span> listensock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>                <span class="token comment">// 如果发生事件的是listensock，表示有新的客户端连上来</span></pre></td></tr><tr><td data-num=75></td><td><pre>                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>                socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>                <span class="token keyword">int</span> clientsock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listensock<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>clistenscok <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=79></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=80></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=81></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=83></td><td><pre>                </pre></td></tr><tr><td data-num=84></td><td><pre>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(socke = %d) connected ok. \n"</span><span class="token punctuation">,</span>clientsock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre>                </pre></td></tr><tr><td data-num=86></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>clientsock <span class="token operator">></span> MAXNFDS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=87></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=88></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"clientsock(%d) > MAXNFDS(%D) \n"</span><span class="token punctuation">,</span>clientsock<span class="token punctuation">,</span>MAXNFDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>                    <span class="token function">close</span><span class="token punctuation">(</span>clientsock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=90></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=92></td><td><pre>                fds<span class="token punctuation">[</span>clientsock<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> clientsock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>                fds<span class="token punctuation">[</span>clientsock<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>                fds<span class="token punctuation">[</span>clientsock<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>                </pre></td></tr><tr><td data-num=96></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>maxfd <span class="token operator">&lt;</span> clientsock<span class="token punctuation">)</span> maxfd <span class="token operator">=</span> clientsock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre>                </pre></td></tr><tr><td data-num=98></td><td><pre>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"maxfd = %d\n"</span><span class="token punctuation">,</span>maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=101></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num=102></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=103></td><td><pre>                <span class="token comment">// 客户端有数据过来或客户端的socket连接被断开</span></pre></td></tr><tr><td data-num=104></td><td><pre>                <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=106></td><td><pre>                </pre></td></tr><tr><td data-num=107></td><td><pre>                <span class="token comment">// 读取客户端数据</span></pre></td></tr><tr><td data-num=108></td><td><pre>                ssize_t isize <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre>                </pre></td></tr><tr><td data-num=110></td><td><pre>                <span class="token comment">// 发生了错误或socket被对方关闭</span></pre></td></tr><tr><td data-num=111></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>isize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=112></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=113></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(eventfd = %d) disconnected. \n"</span><span class="token punctuation">,</span>eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=114></td><td><pre>                    <span class="token function">close</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭客户端的socket</span></pre></td></tr><tr><td data-num=115></td><td><pre>                    fds<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=116></td><td><pre>                    </pre></td></tr><tr><td data-num=117></td><td><pre>                    <span class="token comment">// 重新计算maxfd的值，注意，只有当eventfd == maxfd时才需计算</span></pre></td></tr><tr><td data-num=118></td><td><pre>                    <span class="token keyword">if</span><span class="token punctuation">(</span>maxfd <span class="token operator">==</span> eventfd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=119></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=120></td><td><pre>                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> maxfd<span class="token punctuation">;</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">--</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=121></td><td><pre>                        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=122></td><td><pre>                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfdset<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=123></td><td><pre>                            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=124></td><td><pre>                                maxfd <span class="token operator">=</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=125></td><td><pre>                                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=126></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=127></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=128></td><td><pre>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"maxfd = %d\n"</span><span class="token punctuation">,</span>maxfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=129></td><td><pre>                        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=130></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=131></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv(eventfd=%d,size = %d): %s\n"</span><span class="token punctuation">,</span>eventfd<span class="token punctuation">,</span>isize<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=132></td><td><pre>                    </pre></td></tr><tr><td data-num=133></td><td><pre>                    <span class="token comment">// 把收到的报文发回给客户端</span></pre></td></tr><tr><td data-num=134></td><td><pre>                    <span class="token function">write</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=135></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=136></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=137></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=138></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=139></td><td><pre>  	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=140></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=epoll模型><a class=anchor href=#epoll模型>#</a> epoll模型</h3><p>epoll解决了select和poll所有的问题(fdset拷贝和轮询)，采用了最合理的设计和实现方案</p><p>这是一个在Linux 2.6及以后版本中引入的新型IO多路复用模型。与select和poll相比，epoll在处理大量并发连接时更高效。它默认使用了一个事件驱动的方式(ET)，<strong>以红黑树作为底层的数据结构</strong>，只有当某个文件描述符准备好进行IO操作时，它才会将这个文件描述符添加到就绪列表中，这避免了遍历所有文件描述符的开销。另外，epoll没有最大文件描述符数量的限制，因此它可以处理更多的并发连接。</p><p><strong>epoll的函数和参数</strong></p><p>需要头文件 - <code>#include&lt;sys/epoll.h&gt;</code></p><p><strong>创建epoll的句柄，它本身就是一个fd</strong></p><p><code>int epoll_create(int size)</code></p><ul><li>传入一个大于零的值即可</li></ul><p><strong>注册需要监视fd和事件</strong></p><p><code>int epoll_ctl(int epfd,int op,int fd,struct epoll_event* event)</code></p><ul><li>op中有<ul><li>EPOLL_CTL_ADD - 添加</li><li>EPOLL_CTL_MOD - 修改</li><li>EPOLL_CTL_DEL - 删除</li></ul></li></ul><p><strong>等待事件发生</strong></p><p><code>int epoll_wait(int epfd,struct epoll_event* events,int maxevents,int timeout)</code></p><p><strong>示例</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;errno.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;netinet/in.h></span></span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h></span></span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token expression"><span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h</span></span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment">// 事件结果数组大小</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXEVENTS</span> <span class="token expression"><span class="token number">100</span></span></span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment">// 初始化服务端的监听端口</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">int</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">!=</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage:./tcpselect prot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    </pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token comment">// 初始化服务端用于监听的socket</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">int</span> listensock <span class="token operator">=</span> <span class="token function">initserver</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listensock = %d\n"</span><span class="token punctuation">,</span>listensock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    </pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>listensock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"initserver() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token keyword">int</span> epollfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    </pre></td></tr><tr><td data-num=42></td><td><pre>    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建一个描述符</span></pre></td></tr><tr><td data-num=43></td><td><pre>    </pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token comment">// 添加监听描述符事件</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> listensock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>listensock<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>    </pre></td></tr><tr><td data-num=50></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span>MAXEVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放有事件发生的结果数组</span></pre></td></tr><tr><td data-num=53></td><td><pre>        </pre></td></tr><tr><td data-num=54></td><td><pre>        <span class="token comment">// 等待监视的socket有事件发生</span></pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token keyword">int</span> infds <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>events<span class="token punctuation">,</span>MAXEVENTS<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>        </pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token comment">// 返回失败</span></pre></td></tr><tr><td data-num=58></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>infds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=59></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=60></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll_wait() faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=61></td><td><pre>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll_wait()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=64></td><td><pre>        </pre></td></tr><tr><td data-num=65></td><td><pre>        <span class="token comment">// 超时，在本程序中，select函数最后一个参数为空，不存在超时的情况，但以下代码还是留着</span></pre></td></tr><tr><td data-num=66></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> infds<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=67></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=68></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"poll_wait() timeout. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=71></td><td><pre>        </pre></td></tr><tr><td data-num=72></td><td><pre>        <span class="token comment">// 遍历有事件发生的结构数组</span></pre></td></tr><tr><td data-num=73></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>eventfd <span class="token operator">&lt;</span> infds<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=74></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=75></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listensock <span class="token operator">==</span> events<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=76></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=77></td><td><pre>                <span class="token comment">// 如果发生事件的是listensock，表示有新的客户端连上来</span></pre></td></tr><tr><td data-num=78></td><td><pre>                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre>                socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>                <span class="token keyword">int</span> clientsock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listensock<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>clientsock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=83></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=84></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept() failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=87></td><td><pre>                </pre></td></tr><tr><td data-num=88></td><td><pre>                <span class="token comment">// 把新的客户端添加到epoll中</span></pre></td></tr><tr><td data-num=89></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=90></td><td><pre>				ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> clientsock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=91></td><td><pre>                ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=92></td><td><pre>                <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>clientsock<span class="token punctuation">,</span><span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>                </pre></td></tr><tr><td data-num=94></td><td><pre>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(socket=%d) connected ok.\n"</span><span class="token punctuation">,</span>clientsock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=96></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=97></td><td><pre>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=98></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=99></td><td><pre>                <span class="token comment">// 客户端有数据过来或客户端的socket连接被断开</span></pre></td></tr><tr><td data-num=100></td><td><pre>                <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre>                <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=102></td><td><pre>                </pre></td></tr><tr><td data-num=103></td><td><pre>                <span class="token comment">// 读取客户端数据</span></pre></td></tr><tr><td data-num=104></td><td><pre>                ssize_t isize <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=105></td><td><pre>                </pre></td></tr><tr><td data-num=106></td><td><pre>                <span class="token comment">// 发生了错误或socket被对方关闭</span></pre></td></tr><tr><td data-num=107></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>isize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=108></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=109></td><td><pre>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client(eventfd = %d) disconnected. \n"</span><span class="token punctuation">,</span>eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre>                    </pre></td></tr><tr><td data-num=111></td><td><pre>                    <span class="token comment">// 把已断开的客户端从epoll中删除</span></pre></td></tr><tr><td data-num=112></td><td><pre>                    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre>                    <span class="token comment">// 还可以不删除，close后会自动排除，添加是为了兼容性</span></pre></td></tr><tr><td data-num=114></td><td><pre>                    <span class="token comment">//ev.event = EPOLLIN;</span></pre></td></tr><tr><td data-num=115></td><td><pre>                    <span class="token comment">//ev.data.fd = events[i].data.fd;</span></pre></td></tr><tr><td data-num=116></td><td><pre>                    <span class="token comment">//epoll_ctl(epollfd,EPOLL_CTL_DEL,events[i].data.fd,&amp;ev);</span></pre></td></tr><tr><td data-num=117></td><td><pre>                    <span class="token function">close</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=118></td><td><pre>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=119></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=120></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=121></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv(eventfd=%d,size=%d):%s\n"</span><span class="token punctuation">,</span>events<span class="token punctuation">[</span>eventfd<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>isize<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=122></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=123></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=124></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=125></td><td><pre>  	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=126></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id=epoll的水平触发和边缘触发><a class=anchor href=#epoll的水平触发和边缘触发>#</a> epoll的水平触发和边缘触发</h4><p><strong>水平触发(LT)-缺省</strong></p><p>这是epoll的默认工作模式。在这种模式下，只要被监控的文件描述符还有数据可以读取或者还能写入数据，就会一直通知该事件。也就是说，如果你没有处理完所有的数据，那么每次调用epoll的时候，它都会响应这个事件。只有你读或写到了EAGAIN，也就是没有更多的数据可以处理了，那么它在下一次epoll调用的时候才不会响应。</p><p>如果报告了fd后事件没有被处理或数据没有被全部读取，那么epoll会立即再报告该fd。</p><p><strong>边缘触发(ET)</strong></p><p>在这种模式下，当被监控的文件描述符状态发生变化时，epoll只会通知一次该事件，直到该文件描述符的状态再次发生变化为止。也就是说，如果你没有处理完所有的数据或没有处理该事件，那么在下一次epoll调用的时候，它不会再响应这个事件。</p><p>如果报告了fd后事件没有被处理或数据没有被全部读取，那么epoll会下次再报告该fd。</p><p>设置为边缘触发 - <code>ev.events = EPOLLIN | EPOLLET</code></p><p>ET模式比LT模式效率更高，因为它避免了多次响应同一个事件，但使用ET模式需要更小心，因为如果你没有处理完所有的数据或没有处理该事件，那么可能会丢失数据。在使用ET模式时，通常会使用非阻塞IO，这样可以尽可能的读取或写入所有的数据，直到收到EAGAIN错误为止。</p><p><strong>select、poll和epoll的区别？</strong></p><p>当有多个计算机对服务端发起链接请求的时候，需要处理这些请求，于是就有了这些处理的方法</p><p><strong>select</strong></p><ul><li><strong>select工作方式是轮询检查</strong>用户所关心的<strong>socket是否就绪</strong>，然后进行处理。由于每次调用select都要在用户态和内核态之间进行切换，且需要重新传递数据结构，所以效率较低</li><li><strong>select对socket数量也有限制，默认是1024个</strong>，因为它使用了位图的方式来存储socket信息</li><li>select无法扩展到大规模并发连接，主要是因为它采用线性遍历的方式来处理事件，同时每次调用select都需要遍历全部的文件描述符</li></ul><p><strong>poll</strong></p><ul><li><strong>poll没有最大文件描述符数量的限制</strong>。在select中，由于它使用了位图的方式来存储文件描述符，所以默认的最大数目是1024。而<strong>poll使用链表来存储</strong>，所以理论上只受限于系统内存</li><li>poll提供了更多的事件类型，并且它的事件类型是通过结构体的方式进行传递的，这远比select的位操作要清晰很多</li><li>当文件描述符就绪时，select需要重新设置所有文件描述符，但poll只需要关注那些就绪的文件描述符</li></ul><p><strong>epoll</strong></p><ul><li><strong>epoll是Linux特有的I/O多路复用机制，相比于select和poll，通过使用基于红黑树的底层数据结构使得epoll更加灵活且没有最大并发限制</strong></li><li>epoll使用一个文件描述符管理多个事件，通过系统调用epoll_ctl注册fd，然后epoll_wait获取已经准备好的描述符</li><li>epoll中的系统调用会将所有监听的socket进行逻辑上的分组，应用程序只需要检查已经就绪的socket。这样在实际开发中，可以根据应用程序的实际需求，只监听并处理那些真正需要关注的事件，而无需像select和poll那样每次都进行全量的轮询</li><li>epoll的效率比select高，主要体现在大量并发连接的处理上</li></ul><div class=tags><a href=/tags/network-programming/ rel=tag><i class="ic i-tag"></i> 网络编程</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span> <span class=text>更新于</span> <time title="修改时间：2025-09-19 22:24:59" itemprop=dateModified datetime=2025-09-19T22:24:59+08:00>2025-09-19</time></span><span class=item data-path=/computer-science/programming/network-programming/programming/ title=阅读次数><span class=icon><i class="ic i-eye"></i></span> <span class=text>阅读次数</span><span class=waline-pageview-count></span> <span class=text>次</span></span></div><div id=copyright><ul><li class=author><strong>本文作者：</strong> ReverseSacle <i class="ic i-at"><em>@</em></i>逆转天平</li><li class=link><strong>本文链接：</strong> <a href=https://www.reversesacle.com/computer-science/programming/network-programming/programming/ title=C&#x2F;C++网络编程>https://www.reversesacle.com/computer-science/programming/network-programming/programming/</a></li><li class=license><strong>版权声明：</strong> 本站所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class=post-nav><div class="item left"><a href=/computer-science/programming/network-programming/thread-synchronization/ itemprop=url rel=prev data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg9.webp title=Linux线程同步><span class=type>上一篇</span><span class=category><i class="ic i-flag"></i> 网络编程</span><h3>Linux线程同步</h3></a></div><div class="item right"><a href=/computer-science/programming/database/theory/ itemprop=url rel=next data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg8.webp title=数据库基础理论><span class=type>下一篇</span><span class=category><i class="ic i-flag"></i> 数据库</span><h3>数据库基础理论</h3></a></div></div><div class=wrap id=comments><div id=waline-comment></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=文章目录><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#socket><span class=toc-number>1.</span> <span class=toc-text>Socket</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-number>1.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%BF%9E%E6%8E%A5%E6%AD%A5%E9%AA%A4><span class=toc-number>1.2.</span> <span class=toc-text>! 连接步骤</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B><span class=toc-number>1.3.</span> <span class=toc-text>! 服务端的工作流程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B><span class=toc-number>1.4.</span> <span class=toc-text>客户端的工作流程</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9><span class=toc-number>1.5.</span> <span class=toc-text>注意事项</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A8%8B%E5%BA%8F%E7%BB%91%E5%AE%9A%E5%9C%B0%E5%9D%80><span class=toc-number>1.5.1.</span> <span class=toc-text>服务端程序绑定地址</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A8%8B%E5%BA%8F%E7%BB%91%E5%AE%9A%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3><span class=toc-number>1.5.2.</span> <span class=toc-text>服务端程序绑定通信端口</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A8%8B%E5%BA%8F%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84ip%E5%9C%B0%E5%9D%80><span class=toc-number>1.5.3.</span> <span class=toc-text>客户端程序指定服务端的IP地址</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A8%8B%E5%BA%8F%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3><span class=toc-number>1.5.4.</span> <span class=toc-text>客户端程序指定服务端的通信端口</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9C%89%E4%B8%A4%E4%B8%AAsocket><span class=toc-number>1.5.5.</span> <span class=toc-text>服务端有两个socket</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E7%A8%8B%E5%BA%8F%E9%80%80%E5%87%BA%E6%97%B6%E5%85%88%E5%85%B3%E9%97%ADsocket><span class=toc-number>1.5.6.</span> <span class=toc-text>程序退出时先关闭socket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%BA%93%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3><span class=toc-number>1.6.</span> <span class=toc-text>库函数详解</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#socket%E5%87%BD%E6%95%B0><span class=toc-number>1.6.1.</span> <span class=toc-text>socket函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#gethostbyname%E5%87%BD%E6%95%B0><span class=toc-number>1.6.2.</span> <span class=toc-text>gethostbyname函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#connect%E5%87%BD%E6%95%B0><span class=toc-number>1.6.3.</span> <span class=toc-text>! connect函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#bind%E5%87%BD%E6%95%B0><span class=toc-number>1.6.4.</span> <span class=toc-text>! bind函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#listen%E5%87%BD%E6%95%B0><span class=toc-number>1.6.5.</span> <span class=toc-text>listen函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#accept%E5%87%BD%E6%95%B0><span class=toc-number>1.6.6.</span> <span class=toc-text>! accept函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#send%E5%87%BD%E6%95%B0><span class=toc-number>1.6.7.</span> <span class=toc-text>send函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#recv%E5%87%BD%E6%95%B0><span class=toc-number>1.6.8.</span> <span class=toc-text>recv函数</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%AF%A6%E6%83%85><span class=toc-number>1.6.9.</span> <span class=toc-text>函数调用详情</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%BB%E6%9C%BA%E5%AD%97%E8%8A%82%E5%BA%8F%E4%B8%8E%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F><span class=toc-number>1.7.</span> <span class=toc-text>主机字节序与网络字节序</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%80%9A%E4%BF%A1%E7%BB%93%E6%9E%84%E4%BD%93><span class=toc-number>1.8.</span> <span class=toc-text>通信结构体</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#listen%E7%9A%84socket%E9%98%9F%E5%88%97><span class=toc-number>1.9.</span> <span class=toc-text>listen的socket队列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#tcp%E6%8A%A5%E6%96%87%E5%88%86%E5%8C%85%E5%92%8C%E7%B2%98%E5%8C%85><span class=toc-number>2.</span> <span class=toc-text>TCP报文分包和粘包</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%B0%81%E8%A3%85%E5%87%BD%E6%95%B0%E8%BD%AE%E5%AD%90><span class=toc-number>3.</span> <span class=toc-text>封装函数(轮子)</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#writen%E5%87%BD%E6%95%B0%E5%92%8Creadn%E5%87%BD%E6%95%B0><span class=toc-number>3.1.</span> <span class=toc-text>Writen()函数和Readn()函数</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#tcpwrite%E5%87%BD%E6%95%B0%E5%92%8Ctcpread%E5%87%BD%E6%95%B0><span class=toc-number>3.2.</span> <span class=toc-text>TcpWrite()函数和TcpRead()函数</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#socket%E9%80%9A%E4%BF%A1%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%B1%BB><span class=toc-number>3.3.</span> <span class=toc-text>socket通信的服务端类</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#socket%E9%80%9A%E4%BF%A1%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B1%BB><span class=toc-number>3.4.</span> <span class=toc-text>socket通信的客户端类</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B><span class=toc-number>3.5.</span> <span class=toc-text>使用案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BB%99%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84socket%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A2%9E%E5%8A%A0%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91><span class=toc-number>4.</span> <span class=toc-text>给多进程的socket服务端增加业务逻辑</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#tcp%E7%9F%AD%E8%BF%9E%E6%8E%A5%E4%B8%8E%E9%95%BF%E8%BF%9E%E6%8E%A5><span class=toc-number>5.</span> <span class=toc-text>! TCP短连接与长连接</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%95%BF%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6keepalive><span class=toc-number>6.</span> <span class=toc-text>! 长连接的心跳机制(Keepalive)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A1%86%E6%9E%B6><span class=toc-number>7.</span> <span class=toc-text>多线程网络服务端框架</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95><span class=toc-number>8.</span> <span class=toc-text>网络服务端的性能测试</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-2><span class=toc-number>8.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95><span class=toc-number>8.2.</span> <span class=toc-text>服务端并发性能测试</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%9A%E5%8A%A1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95><span class=toc-number>8.3.</span> <span class=toc-text>服务端业务性能测试</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%80%A7%E8%83%BD%E5%B7%AE%E5%BC%82><span class=toc-number>8.4.</span> <span class=toc-text>多进程与多线程服务端性能差异</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%9A%E5%8A%A1%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E6%B5%8B%E8%AF%95><span class=toc-number>8.5.</span> <span class=toc-text>客户端业务响应时间测试</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD%E7%9A%84%E6%B5%8B%E8%AF%95><span class=toc-number>8.6.</span> <span class=toc-text>网络带宽的测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#io%E5%A4%8D%E7%94%A8><span class=toc-number>9.</span> <span class=toc-text>! I&#x2F;O复用</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0-3><span class=toc-number>9.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#select%E6%A8%A1%E5%9E%8B><span class=toc-number>9.2.</span> <span class=toc-text>select模型</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%B5%81%E7%A8%8B><span class=toc-number>9.2.1.</span> <span class=toc-text>流程</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#select%E7%9A%84%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91><span class=toc-number>9.2.2.</span> <span class=toc-text>select的水平触发</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#select%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95><span class=toc-number>9.2.3.</span> <span class=toc-text>select的性能测试</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#select%E7%9A%84%E7%BC%BA%E7%82%B9><span class=toc-number>9.2.4.</span> <span class=toc-text>select的缺点</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#select%E7%9A%84%E5%85%B6%E4%BB%96%E7%94%A8%E9%80%94><span class=toc-number>9.2.5.</span> <span class=toc-text>select的其他用途</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#poll%E6%A8%A1%E5%9E%8B><span class=toc-number>9.3.</span> <span class=toc-text>poll模型</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#epoll%E6%A8%A1%E5%9E%8B><span class=toc-number>9.4.</span> <span class=toc-text>epoll模型</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#epoll%E7%9A%84%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E5%92%8C%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91><span class=toc-number>9.4.1.</span> <span class=toc-text>epoll的水平触发和边缘触发</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title=系列文章><ul><li><a href=/computer-science/programming/network-programming/linux-environment/ rel=bookmark title=虚拟机-Linux环境配置>虚拟机-Linux环境配置</a></li><li><a href=/computer-science/programming/network-programming/Linux-basic/ rel=bookmark title="Linux基础(CentOS 7)">Linux基础(CentOS 7)</a></li><li><a href=/computer-science/programming/network-programming/gcc-compiler/ rel=bookmark title=GCC编译器>GCC编译器</a></li><li><a href=/computer-science/programming/network-programming/gdb-debugging-tool/ rel=bookmark title=GDB调试工具>GDB调试工具</a></li><li><a href=/computer-science/programming/network-programming/make-compiler-tool/ rel=bookmark title=make编译工具>make编译工具</a></li><li><a href=/computer-science/programming/network-programming/clibrary/ rel=bookmark title=C/C++静态库与动态库的制作和使用>C/C++静态库与动态库的制作和使用</a></li><li><a href=/computer-science/programming/network-programming/executable-program/ rel=bookmark title=在C/C++程序中调用可执行程序>在C/C++程序中调用可执行程序</a></li><li><a href=/computer-science/programming/network-programming/signal/ rel=bookmark title=Linux的信号(signal)>Linux的信号(signal)</a></li><li><a href=/computer-science/programming/network-programming/multiprocessing/ rel=bookmark title=Linux多进程>Linux多进程</a></li><li><a href=/computer-science/programming/network-programming/log/ rel=bookmark title=C/C++服务程序的运行日志>C/C++服务程序的运行日志</a></li><li><a href=/computer-science/programming/network-programming/multithreading/ rel=bookmark title=Linux多线程>Linux多线程</a></li><li><a href=/computer-science/programming/network-programming/thread-synchronization/ rel=bookmark title=Linux线程同步>Linux线程同步</a></li><li class=active><a href=/computer-science/programming/network-programming/programming/ rel=bookmark title=C/C++网络编程>C/C++网络编程</a></li><li><a href=/computer-science/programming/network-programming/http/ rel=bookmark title=HTTP网络通信基础>HTTP网络通信基础</a></li><li><a href=/computer-science/programming/network-programming/ubuntu-obs-server/ rel=bookmark title="Ubuntu服务器OBS Studio配置">Ubuntu服务器OBS Studio配置</a></li></ul></div><div class="overview panel" data-title=站点概览><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img class=image itemprop=image alt=ReverseSacle data-src=/images/avatar.webp><p class=name itemprop=name>ReverseSacle</p><div class=description itemprop=description>知识书库 & 学习点滴</div></div><nav class=state><div class="item posts"><a href=/archives/ ><span class=count>186</span> <span class=name>文章</span></a></div><div class="item categories"><a href=/categories/ ><span class=count>52</span> <span class=name>分类</span></a></div><div class="item tags"><a href=/tags/ ><span class=count>18</span> <span class=name>标签</span></a></div></nav><div class=social><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JldmVyc2VTYWNsZQ==" title=https:&#x2F;&#x2F;github.com&#x2F;ReverseSacle><i class="ic i-github"></i></span><span class="exturl item email" data-url="bWFpbHRvOnByaXZhdGVAcmV2ZXJzZXNhY2xlLmNvbQ==" title=mailto:private@reversesacle.com><i class="ic i-envelope"></i></span></div><ul class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i> 首页</a></li><li class="item dropdown"><a href=javascript:void(0);><i class="ic i-feather"></i> 文章</a><ul class=submenu><li class=item><a href=/archives/ rel=section><i class="ic i-list-alt"></i> 归档</a></li><li class=item><a href=/categories/ rel=section><i class="ic i-th"></i> 分类</a></li><li class=item><a href=/tags/ rel=section><i class="ic i-tags"></i> 标签</a></li></ul></li><li class=item><a href=/about/ rel=section><i class="ic i-user"></i> 关于</a></li><li class=item><a href=/friend-links/ rel=section><i class="ic i-heart"></i> 友链</a></li></ul></div></div></div><ul id=quick><li class="prev pjax"><a href=/computer-science/programming/network-programming/thread-synchronization/ rel=prev title=上一篇><i class="ic i-chevron-left"></i></a></li><li class=up><i class="ic i-arrow-up"></i></li><li class=down><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href=/computer-science/programming/database/theory/ rel=next title=下一篇><i class="ic i-chevron-right"></i></a></li><li class=percent></li></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>随机文章</h2><ul><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/network-programming/ title="分类于 网络编程">网络编程</a></div><span><a href=/computer-science/programming/network-programming/signal/ title=Linux的信号(signal)>Linux的信号(signal)</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/linear-structure/seqstring/ title=C语言-字符序列存储>C语言-字符序列存储</a></span></li><li class=item><div class=breadcrumb><a href=/categories/general-science-and-technology/ title="分类于 通用科学技术">通用科学技术</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/smartphone/ title="分类于 通用技术之手机端">通用技术之手机端</a></div><span><a href=/general-science-and-technology/smartphone/del-builtin-softwares/ title=手机内置软件卸载>手机内置软件卸载</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/network-programming/ title="分类于 网络编程">网络编程</a></div><span><a href=/computer-science/programming/network-programming/http/ title=HTTP网络通信基础>HTTP网络通信基础</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/simulation/ title="分类于 模拟">模拟</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/simulation/pattern/ title=模拟-模式>模拟-模式</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/shoka-theme/ title="分类于 Shoka主题">Shoka主题</a></div><span><a href=/computer-science/shoka-theme/image/ title=主要图片及图床配置>主要图片及图床配置</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/rust-basic/ title="分类于 Rust基础">Rust基础</a></div><span><a href=/computer-science/programming/rust/rust-basic/rustpart2/ title=Rust语言-基础-第二部分>Rust语言-基础-第二部分</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/database/ title="分类于 数据库">数据库</a></div><span><a href=/computer-science/programming/database/theory/ title=数据库基础理论>数据库基础理论</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/database/ title="分类于 数据库">数据库</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/database/mysql/ title="分类于 MySQL">MySQL</a></div><span><a href=/computer-science/programming/database/mysql/mspart1/ title=MySQL数据库基础-第一部分>MySQL数据库基础-第一部分</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/linear-structure/doubly-link-list/ title=C语言-双向链表>C语言-双向链表</a></span></li></ul></div><div><h2>最新评论</h2><ul id=waline-recent></ul></div></div><div class=status><div class=copyright>&copy; 2021 – <span itemprop=copyrightYear>2025</span><span class=with-love><i class="ic i-sakura rotate"></i></span> <span class=author itemprop=copyrightHolder>ReverseSacle @ ReverseSacle-Blog</span></div><div class=count><i class="ic i-clock" aria-hidden=true></i> <span id=time align=center>载入时间中...<script defer>var now=new Date;function createtime(){var n=new Date("2021-11-16 22:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("time").innerHTML="已经过 "+dnum+" 天 "+hnum+" 小时 "+mnum+" 分 "+snum+" 秒 "}setInterval("createtime()",250)</script></span><span class=post-meta-item-icon>|&nbsp<i class="ic i-chart-area"></i></span> <span title=站点总字数>2.1m 字</span> <span class=post-meta-item-icon>|&nbsp<i class="ic i-coffee"></i></span> <span title=站点阅读时长>40:40</span></div></div></div></footer></div><script data-config>var LOCAL={path:"computer-science/programming/network-programming/programming/",favicon:{show:"ReverseSacle-Blog",hide:"ReverseSacle-Blog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},waline:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src=https://polyfill.alicdn.com/v3/polyfill.min.js></script><script src=https://cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1.16.0/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js></script><script src=/js/app.js></script></body></html>