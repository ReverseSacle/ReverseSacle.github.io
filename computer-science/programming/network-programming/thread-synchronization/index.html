<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#222><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/ico sizes=48x48 href=/images/favicon.ico><link rel=alternate type=application/rss+xml title=逆转天平 href=https://www.reversesacle.com/rss.xml><link rel=alternate type=application/atom+xml title=逆转天平 href=https://www.reversesacle.com/atom.xml><link rel=alternate type=application/json title=逆转天平 href=https://www.reversesacle.com/feed.json><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=/css/app.css><meta name=description content=网络编程><link rel=canonical href=https://www.reversesacle.com/computer-science/programming/network-programming/thread-synchronization/ ><title>Linux线程同步 - 网络编程 - 编程 - 计算机科学 | ReverseSacle-Blog</title><meta name=generator content="Hexo 6.3.0"></head><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=dotloader><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">Linux线程同步</h1><div class=meta><span class=item title="创建时间：2023-07-31 15:39:55"><span class=icon><i class="ic i-calendar"></i></span> <span class=text>发表于</span> <time itemprop="dateCreated datePublished" datetime=2023-07-31T15:39:55+08:00>2023-07-31</time></span><span class=item title=本文字数><span class=icon><i class="ic i-pen"></i></span> <span class=text>本文字数</span> <span>19k</span> <span class=text>字</span></span><span class=item title=阅读时长><span class=icon><i class="ic i-clock"></i></span> <span class=text>阅读时长</span> <span>22 分钟</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div class=lines role=navigation aria-label=切换导航栏><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>ReverseSacle-Blog</a></li></ul><ul class=right><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id=imgs class=pjax><ul><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg8.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg3.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg20.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg15.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg21.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg6.webp></li></ul></div></header><div id=waves><svg class=waves xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink viewBox="0 24 150 28" preserveAspectRatio=none shape-rendering=auto><defs><path id=gentle-wave d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class=parallax><use xlink:href=#gentle-wave x=48 y=0 /><use xlink:href=#gentle-wave x=48 y=3 /><use xlink:href=#gentle-wave x=48 y=5 /><use xlink:href=#gentle-wave x=48 y=7 /></g></svg></div><main><div class=inner><div id=main class=pjax><div class="article wrap"><div class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i> <span><a href=/ >首页</a></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/ itemprop=item rel=index title="分类于 计算机科学"><span itemprop=name>计算机科学</span></a><meta itemprop=position content=1></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/ itemprop=item rel=index title="分类于 编程"><span itemprop=name>编程</span></a><meta itemprop=position content=2></span><i class="ic i-angle-right"></i> <span class=current itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/network-programming/ itemprop=item rel=index title="分类于 网络编程"><span itemprop=name>网络编程</span></a><meta itemprop=position content=3></span></div><article itemscope itemtype=http://schema.org/Article class="post block" lang=zh-CN><link itemprop=mainEntityOfPage href=https://www.reversesacle.com/computer-science/programming/network-programming/thread-synchronization/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.webp><meta itemprop=name content=ReverseSacle><meta itemprop=description content="所见即所得，所思即所行, 知识书库 & 学习点滴"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=逆转天平></span><div class="body md" itemprop=articleBody><h2 id=概述><a class=anchor href=#概述>#</a> ! 概述</h2><p>线程同步不是一起，相同的意思，而是协调，协同的意思。</p><ul><li>按预定的先后次序进行运行，如，线程A生成数据后再交给线程B处理</li><li>公共资源同一时刻只能被一个线程使用。共享数据在同一时刻只能被一个线程修改，以保证数据的完整性</li></ul><p>对于多线程，资源是共享的，基本上不存在不允许访问的情况，但，共享资源在某一时间点只能被一个线程占用，因此需要给资源加锁。</p><p>线程同步有五种方式，即线程的锁的种类有</p><ul><li>互斥锁</li><li>读写锁</li><li>条件变量</li><li>自旋锁</li><li>信号灯(或称信号量，二元信号量)</li></ul><p>多线程可以共享资源(变量和对象)，但是某些对象虽然可以共享，但在同一个时间只能由一个线程使用，多个线程同时使用会产生冲突，例如socket链接，数据库连接池。</p><p><strong>互斥锁</strong> - 互斥锁是一种用于线程同步的工具，能够保证同一时刻只有一个线程可以访问共享资源。如果一个线程已经取得了互斥锁，其他尝试获得该锁的线程将会被阻塞，直到第一个线程释放了该锁。</p><p><strong>乐观锁</strong> - 乐观锁假定冲突发生的几率很小，因此在数据操作前并不会加锁，但会在进行更新等操作时检查是否有其他线程对数据进行了修改。如果有，则操作失败；没有，则操作成功。乐观锁一般适用于读多写少的场景。</p><p><strong>悲观锁</strong> - 悲观锁假设冲突发生的几率很大，所以在每次读写数据前都会先加锁。这种方式虽然保证了数据的一致性，但也可能造成资源的浪费。悲观锁主要通过数据库提供的锁机制实现，例如行级锁、表级锁等。</p><p><strong>Linux系统的同步机制？</strong></p><ul><li><p>互斥锁- 互斥锁用于保护临界区资源，确保同一时刻只有一个线程能访问特定资源</p></li><li><p>读写锁 - 允许多个读者同时访问，但在写者访问时，其他所有读写者都将阻塞</p></li><li><p>条件变量- 线程间同步的另一种方式，它可以允许某些情况下的线程有序地访问共享数据</p></li><li><p>信号量 - 原始信号量和 POSIX 信号量是 Linux 提供的两种信号量</p></li><li><p>自旋锁 - 当锁已经被占用时，继续尝试获取锁，直到成功为止</p></li><li><p>屏障(barrier)- 确保所有进程在继续执行前达到某个点</p></li></ul><p><strong>线程同步的方法有哪些？</strong></p><ul><li>临界区 - 串行化访问公共资源或代码段，速度较快</li><li>互斥量 - 采用互斥对象机制，只有拥有互斥对象的线程才能访问公共资源，而因为互斥对象只有一个，所以可以保证公共资源不会被多个线程同时访问</li><li>信号量 - 允许多个线程在同一时刻访问同一公共资源，但限制同一时刻访问该公共资源的最大线程数量</li><li>事件：使用通知操作的方式，可以方便地实现多线程优先级的比较操作</li></ul><p><strong>Linux系统的异步机制？</strong></p><ul><li><p>异步IO(AIO) - 在发起IO请求后，立即返回，不阻塞当前进程或线程。当IO操作完成后，再通知用户程序</p></li><li><p>信号(Signal) - 当某些事件发生时，系统会发送信号给进程。对信号的处理可以是忽略、捕捉(指定处理函数)、执行默认操作等</p></li><li><p>回调函数 - 在某些操作完成后，调用预先定义的函数</p></li><li><p>epoll/select/poll异步IO模型 - Linux下的多路复用IO模型，可以同时监控多个文件描述符的读写状态，当文件描述符准备好后，通过回调通知应用程序</p></li></ul><p><strong>同步和异步有什么区别？</strong></p><ul><li>同步是指在发起一个调用之后，调用者需要一直等待调用结果的通知，才能进行后续的操作</li><li>异步是指在发起一个调用之后，调用者不能立即得到调用结果的返回，需要被调用者通过状态、通知和回调来通知调用者</li></ul><p>需要注意的是，同步/异步强调的是消息通信机制。</p><h2 id=互斥锁mutex><a class=anchor href=#互斥锁mutex>#</a> 互斥锁(Mutex)</h2><p>互斥锁机制是同一时刻只允许一个线程占有共享资源。</p><p>存在优先唤醒的问题，线程有优先级的高和低，优先级高的先得到锁。</p><p><strong>初始化锁</strong></p><ul><li>函数声明 - <code>int pthread_mutex_init(pthread_mutex_t* mutex,const pthread_mutex_attr_t* mutexattr)</code><ul><li>mutexattr - 用于指定锁的属性，如果为NULL则使用缺省属性</li><li>互斥锁的属性在创建锁的时候指定，当资源被某线程锁住时，其他的线程再试图加锁时表现将不同。当前有四个值可供选择<ul><li><code>PTHREAD_MUTEX_TIMED_NP</code> - 缺省值，也是普通锁。当一个线程加锁以后，其余请求锁的线程将形成一个等待队列，并再解锁后按优先级获得锁。这种锁策略保证了资源分配的公平性</li><li><code>PTHREAD_MUTEXC_RECURSIVE_NP</code> - 嵌套锁，允许同一个线程对同一个锁成功获得多次，并通过多次<code>unlock</code>解锁</li><li><code>PTHREAD_MUTEX_ERRORCHECK_NP</code> - 检错锁，如果同一个线程请求同一个锁，则返回EDEADLK，否则<code>PTHREAD_MUTEX_TIMED_NP</code>类型动作相同</li><li><code>PTHREAD_MUTEX_ADAPTIVE_NP</code> - 适应锁，动作最简单的锁类型，等待解锁后并重新竞争</li></ul></li></ul></li></ul><p><strong>阻塞加锁</strong></p><ul><li>若互斥锁已经被其他线程上锁，则调用者一直等待，直到被解锁后才上锁</li><li>函数声明 - <code>int pthread_mutex_lock(pthread_mutex* mutex)</code></li><li>如果锁是空闲状态，本线程将获得这个锁</li><li>如果锁已被占用，本线程将排队等待，直到成功获取锁</li></ul><p><strong>非阻塞加锁</strong></p><ul><li>若互斥锁未加锁，则上锁；若互斥锁已加锁，则函数立即返回失败</li><li>函数声明 - <code>int pthread_mutex_trylock(pthread_mutex_t* mutex)</code></li><li>与<code>pthread_mutex_lock</code>函数类似，不同的是在锁已经被占据时会立刻返回EBUSY，而不是挂起等待</li></ul><p><strong>解锁</strong></p><ul><li>函数声明 - <code>int pthread_mutex_unlock(pthread_mutex* mutex)</code></li><li>线程把自己持有的锁释放</li></ul><p><strong>销毁锁</strong></p><ul><li>函数声明 - <code>int pthread_mutex_destroy(pthread_mutex* mutex)</code></li><li>锁销毁之前，此时锁必需是<code>unlock</code>状态(空闲状态)，否则返回EBUSY</li></ul><p><strong>示例</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 使用互斥锁解决多线程抢占资源的问题</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 全局共享的buffer</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">//pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;// 声明互斥锁</span></pre></td></tr><tr><td data-num=10></td><td><pre>pthread_mutex_t mutex<span class="token punctuation">;</span><span class="token comment">// 声明互斥锁</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pthfun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %d;b:lock..\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:lock 0k. \n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        </pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token comment">// 操作共享的全局变量</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"%d : %ld,%d"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        </pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:unlock...\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        </pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=30></td><td><pre></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化锁</span></pre></td></tr><tr><td data-num=34></td><td><pre>    </pre></td></tr><tr><td data-num=35></td><td><pre>    pthread_t pthid1<span class="token punctuation">,</span>pthid2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    </pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 销毁锁</span></pre></td></tr><tr><td data-num=43></td><td><pre>    </pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=互斥锁实现数据库连接池><a class=anchor href=#互斥锁实现数据库连接池>#</a> 互斥锁实现数据库连接池</h2><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 初始化数据库连接池</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">bool</span> <span class="token function">initconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> conns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">connecttodb</span><span class="token punctuation">(</span><span class="token string">"scott/tiger"</span><span class="token punctuation">,</span><span class="token string">"Simplified_Chinese_China.ZHS16GBK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"connect database failed. \n%s\n"</span><span class="token punctuation">,</span>conns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>m_cda<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">// 从连接池中获取一个数据库连接</span></pre></td></tr><tr><td data-num=17></td><td><pre>connect<span class="token operator">*</span> <span class="token function">getconn</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=22></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"get a conn[%d] ok. \n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=24></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">&amp;</span>conns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token comment">// 释放数据库连接</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token keyword">void</span> <span class="token function">freeconn</span><span class="token punctuation">(</span>connection<span class="token operator">*</span> in_conn<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>in_conn <span class="token operator">==</span> <span class="token operator">&amp;</span>conns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=38></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=39></td><td><pre></pre></td></tr><tr><td data-num=40></td><td><pre><span class="token comment">// 释放数据库连接池</span></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">void</span> <span class="token function">freeconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        conns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=48></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"/freecplus/_freecplus.h"</span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"/freecplus/db/oracle/_ooci.h"</span></span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre>pthread_mutex_t mutexs<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 用于数据库连接池的锁</span></pre></td></tr><tr><td data-num=5></td><td><pre>connection conns<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 数据库连接池</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">bool</span> <span class="token function">initconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化数据库连接池</span></pre></td></tr><tr><td data-num=7></td><td><pre>connection<span class="token operator">*</span> <span class="token function">getconn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从连接池中获取一个数据库连接</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">void</span> <span class="token function">freeconn</span><span class="token punctuation">(</span>connection<span class="token operator">*</span> in_conn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 释放数据库连接</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">void</span> <span class="token function">freeconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 释放数据库连接池</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre>CTcpServer TcpServer<span class="token punctuation">;</span><span class="token comment">// 创建服务端对象</span></pre></td></tr><tr><td data-num=12></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> vpthid<span class="token punctuation">;</span><span class="token comment">// 存放线程id的容器</span></pre></td></tr><tr><td data-num=13></td><td><pre>CLogFile logfile<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">void</span> <span class="token function">mainexit</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"maineixt begin. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    </pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">// 关闭监听的socket</span></pre></td></tr><tr><td data-num=20></td><td><pre>    TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>    </pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token comment">// 取消全部的线程</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"cancel %ld\n"</span><span class="token punctuation">,</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token function">pthread_cancle</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token comment">//pthread_join(vpthid[i],NULL);</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">freeconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 释放数据库连接池</span></pre></td></tr><tr><td data-num=30></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"mainexit end. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=33></td><td><pre></pre></td></tr><tr><td data-num=34></td><td><pre><span class="token comment">// 程清理函数</span></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">void</span> <span class="token function">pthmainexit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit begin. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭与客户端的socket</span></pre></td></tr><tr><td data-num=39></td><td><pre>    </pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token comment">// 从vpthid中删除本线程的id</span></pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=42></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=44></td><td><pre>        	vpthid<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit end. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=48></td><td><pre></pre></td></tr><tr><td data-num=49></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pthmain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=51></td><td><pre>    <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>pthmainexit<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注册线程清理函数</span></pre></td></tr><tr><td data-num=52></td><td><pre>    </pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 分离线程，用于网络服务，数据类处理不需要</span></pre></td></tr><tr><td data-num=54></td><td><pre>    <span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span>PTHREAD_CANCEL_DISABLE<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置取消方式为立即取消</span></pre></td></tr><tr><td data-num=55></td><td><pre>    </pre></td></tr><tr><td data-num=56></td><td><pre>    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 与客户端的socket连接</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放数据的缓冲区</span></pre></td></tr><tr><td data-num=58></td><td><pre>    <span class="token keyword">int</span> ibuflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=59></td><td><pre>    </pre></td></tr><tr><td data-num=60></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=61></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token comment">// 接收客户端发来的请求报文</span></pre></td></tr><tr><td data-num=64></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">TcpRead</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>strbuffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>ibuflen<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收: %s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=66></td><td><pre>        </pre></td></tr><tr><td data-num=67></td><td><pre>        connection<span class="token operator">*</span> conn <span class="token operator">=</span> <span class="token function">getconn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取一个数据库连接</span></pre></td></tr><tr><td data-num=68></td><td><pre>        <span class="token comment">// 处理业务</span></pre></td></tr><tr><td data-num=69></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>        <span class="token function">freeconn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 释放一个数据库连接</span></pre></td></tr><tr><td data-num=71></td><td><pre>        </pre></td></tr><tr><td data-num=72></td><td><pre>        <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token string">"0K"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在客户端的报文后面加上Ok.</span></pre></td></tr><tr><td data-num=73></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=74></td><td><pre>        <span class="token comment">// 向客户端发送响应报文</span></pre></td></tr><tr><td data-num=75></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token function">TcpWrite</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=77></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 程序直接退出，析构函数会释放资源   </span></pre></td></tr><tr><td data-num=78></td><td><pre>    </pre></td></tr><tr><td data-num=79></td><td><pre>    <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    <span class="token function">pthread_eixt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=82></td><td><pre></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token comment">// 设置捕获信号2和15</span></pre></td></tr><tr><td data-num=86></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=88></td><td><pre>	</pre></td></tr><tr><td data-num=89></td><td><pre>    logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/tmp/demo48.log"</span><span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=90></td><td><pre>    <span class="token comment">// 初始化TcpServer的通信端口</span></pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5858</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=93></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5858) failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=96></td><td><pre>    </pre></td></tr><tr><td data-num=97></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">initconns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=98></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=99></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"initconns() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=100></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=102></td><td><pre>    </pre></td></tr><tr><td data-num=103></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=104></td><td><pre>    <span class="token punctuation">&#123;</span>     </pre></td></tr><tr><td data-num=105></td><td><pre>        <span class="token comment">// 等待客户端连接</span></pre></td></tr><tr><td data-num=106></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=107></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=108></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=109></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=110></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=111></td><td><pre></pre></td></tr><tr><td data-num=112></td><td><pre>        pthread_t pthid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=113></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthmain<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>TcpServer<span class="token punctuation">.</span>m_connfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=114></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=115></td><td><pre>            logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthread_create faild. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=116></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=117></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=118></td><td><pre>        </pre></td></tr><tr><td data-num=119></td><td><pre>        logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端(%s)已连接。 \n"</span><span class="token punctuation">,</span>TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=120></td><td><pre>        vpthid<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pthid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把线程id保存到vpthid容器中</span></pre></td></tr><tr><td data-num=121></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=122></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=123></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=条件变量conditional-variable><a class=anchor href=#条件变量conditional-variable>#</a> 条件变量(Conditional Variable)</h2><p>条件变量用来阻塞一个线程，直到其他的线程通知它条件已满足为止。</p><p><strong>初始化条件变量</strong></p><p><code>int pthread_cond_init(pthread_cond_t* cond,pthread_condattr_t* cond_attr)</code></p><p><strong>阻塞等待</strong></p><p><code>int pthread_cond_wait(pthread_cond_t* cond,pthread_mutex_t* mutex)</code></p><p><strong>超时等待</strong></p><p><code>int pthread_cond_timewait(pthread_cond_t* cond,pthread_mutex* mutex,const timespec* abstime)</code></p><p><strong>唤醒一个等待该条件的线程</strong></p><p><code>int pthread_cond_signal(pthread_cond_t* cond)</code></p><p><strong>唤醒全部等待该条件的所有线程</strong></p><p><code>int pthread_cond_broadcast(pthread_cond_t* cond)</code></p><p><strong>销毁条件变量</strong></p><p><code>int pthread_cond_destroy(pthread_cond_t* cond)</code></p><p><strong>示例</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre>pthread_mutex_t mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>pthread_cond_t cond<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>pthread_cond_t cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化条件变量</span></pre></td></tr><tr><td data-num=9></td><td><pre>pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化互斥锁</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程一被唤醒. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">ptrhead_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程二被唤醒。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=28></td><td><pre></pre></td></tr><tr><td data-num=29></td><td><pre><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token comment">//pthread_cond_broadcast(&amp;cond);</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    </pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>    </pre></td></tr><tr><td data-num=42></td><td><pre>    pthread_t thid1<span class="token punctuation">,</span>thid2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>    </pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>    </pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=条件变量与互斥锁><a class=anchor href=#条件变量与互斥锁>#</a> 条件变量与互斥锁</h2><p><code>pthread_cond_wait</code>函数里发生了什么？</p><p>1.释放了互斥锁 - 2.等待条件 - 3.条件被触发 - 4.互斥锁加锁</p><p>第3，4步其实为一步，称为原子操作。</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre>pthread_mutex_t mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>pthread_cond_t cond<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>pthread_cond_t cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化条件变量</span></pre></td></tr><tr><td data-num=9></td><td><pre>pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化互斥锁</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程一开始等待条件。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程一被唤醒. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=27></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程二开始等待条件。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>        <span class="token function">ptrhead_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"线程二被唤醒。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=33></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=34></td><td><pre></pre></td></tr><tr><td data-num=35></td><td><pre><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token comment">//pthread_cond_broadcast(&amp;cond);</span></pre></td></tr><tr><td data-num=39></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=40></td><td><pre></pre></td></tr><tr><td data-num=41></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=42></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>    </pre></td></tr><tr><td data-num=45></td><td><pre>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>    </pre></td></tr><tr><td data-num=48></td><td><pre>    pthread_t thid1<span class="token punctuation">,</span>thid2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre>    </pre></td></tr><tr><td data-num=52></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>    </pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=生产-消费者模型><a class=anchor href=#生产-消费者模型>#</a> 生产-消费者模型</h2><p><img data-src=https://jd.reversesacle.com/gh/ReverseSacle/Gallery@latest/programming/network-programming/thread/1.webp alt=""></p><p>生产者线程产生的数据会放到缓冲中。其他消费者线程会从缓冲中取出数据并处理。</p><p>数据缓存可以用容器，共享内存，链表等方式，其为线程的共享资源。</p><p>生产者可以是一个线程或多个线程，线程产生的数据往缓冲中存放时会产生竞争的关系。</p><p>消费者线程之间也会产生竞争关系，从数据缓存中取出一条数据拷贝后就在删除数据缓存中的那一条数据(或者改变那一条数据的位置)。</p><p>生产者与消费者之间也会产生竞争关系，例如，生产者线程看到数据缓存队列中某一区域为空，当生产者线程将数据放入时，缓存队列中对应位置就不为空了，但在生产者将数据放入的过程中，消费者也会对那一区域做改动，导致生产者存放数据的位置一直在变动。</p><p>以上的竞争关系的解决方法是利用<strong>互斥锁</strong>。</p><p>当消费者查看数据缓存中是否有数据时，这个查看过程需一直保持着，但这很耗费计算机资源，这个问题可通过<strong>条件变量</strong>来解决。</p><p><img data-src=https://jd.reversesacle.com/gh/ReverseSacle/Gallery@latest/programming/network-programming/thread/2.webp alt=""></p><p>假如上面图中是一个应用，服务端用epoll来实现，epoll可以做到单个进程或线程就能响应很多个并发，当epoll接收到客户端数据后，(一直处理，处理完后再返回)这是不可能的，因为在处理业务当中，其他客户也有数据的传来，如果在epoll之后马上再处理其他客户的业务，那epoll就废掉了。正确的做法是，epoll服务端收到业务请求后，不会去处理这个报文，而是将其扔到一个缓存中，后面的线程池会处理缓存中的数据。这里介绍的这个缓存被称为高速缓存。</p><h2 id=高速缓存的实现条件变量和互斥锁><a class=anchor href=#高速缓存的实现条件变量和互斥锁>#</a> 高速缓存的实现(条件变量和互斥锁)</h2><p>利用条件变量和互斥锁实现高速缓存</p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector></span></span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> mesgid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 消息的计数器</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 缓存消息的结构体</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">st_message</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">int</span> mesgid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">char</span> mesage<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token punctuation">&#125;</span>stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token operator">></span> vcache<span class="token punctuation">;</span><span class="token comment">// 用vector容器做缓存</span></pre></td></tr><tr><td data-num=20></td><td><pre>pthread_cond_t cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化条件变量</span></pre></td></tr><tr><td data-num=21></td><td><pre>pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// 声明并初始化互斥锁</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">// 消费者，出队，线程主函数</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">outcache</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 增加线程清理函数，释放锁</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    </pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=32></td><td><pre>        </pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token comment">// 如果缓存为空，等待。  //条件变量虚假唤醒</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token comment">// 由于数据一直是在变动的因此需要循环判断</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vcache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=36></td><td><pre>            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>        </pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token comment">// 从缓存中获取第一条记录，然后删除该记录</span></pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token operator">&amp;</span>vcache<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>        vcache<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vache<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=41></td><td><pre>        </pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=43></td><td><pre>        </pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token comment">// 以下是处理业务的代码</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"phid = %ld,mesgid = %d\n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>stmesg<span class="token punctuation">.</span>mesgid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>        </pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token comment">// 如果不使用uslepp，任务会被一个线程占有；使用后会呈现排队形式的接收任务</span></pre></td></tr><tr><td data-num=48></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=50></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=51></td><td><pre></pre></td></tr><tr><td data-num=52></td><td><pre><span class="token comment">// 生产者，把生产的数据存入缓存</span></pre></td></tr><tr><td data-num=53></td><td><pre><span class="token keyword">void</span> <span class="token function">incache</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=54></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=56></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    </pre></td></tr><tr><td data-num=58></td><td><pre>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=59></td><td><pre>    </pre></td></tr><tr><td data-num=60></td><td><pre>    <span class="token comment">// 生产数据，放入缓存</span></pre></td></tr><tr><td data-num=61></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>    </pre></td></tr><tr><td data-num=65></td><td><pre>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=66></td><td><pre>    </pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token comment">//pthread_cond_signal(&amp;cond);// 触发条件，激活排队中的第一个线程</span></pre></td></tr><tr><td data-num=68></td><td><pre>    <span class="token comment">// 如果不广播，会被某一个线程一直占用，因为其他线程没有收到通知信号</span></pre></td></tr><tr><td data-num=69></td><td><pre>    <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发条件，激活全部的线程</span></pre></td></tr><tr><td data-num=70></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=71></td><td><pre></pre></td></tr><tr><td data-num=72></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>incache<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 接收15的信号，调用生产者函数</span></pre></td></tr><tr><td data-num=75></td><td><pre>    </pre></td></tr><tr><td data-num=76></td><td><pre>    pthread_t thid1<span class="token punctuation">,</span>thid2<span class="token punctuation">,</span>thid3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=78></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=79></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    </pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=83></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=84></td><td><pre>    </pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=86></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>触发条件要写在锁的外面。</p><p>持有锁的时间应该越短越好，这样效率会更高。</p><p><code>usleep()函数</code>可解决业务时间短，线程被一个线程占据的问题。</p><p>容器作高速缓存是不够快的，将数据放入容器会有一次内存拷贝，取出数据也会有一次内存拷贝，解决高速缓存不够快的方法，可使用链表来创建缓存。</p><h2 id=信号量semaphore><a class=anchor href=#信号量semaphore>#</a> 信号量(Semaphore)</h2><p>信号量是一个整数计数器，其数值可以用于表示空闲临界资源的数量。</p><p>当有进程释放资源时，信号量增加，表示可用资源数增加；当有进程申请到资源时，信号量减少，表示可用资源数减少。</p><p><strong>初始化信号量</strong></p><p><code>int sem_init(sem_t* sem,int pshared,unsigned int value)</code></p><p><strong>等待信号量</strong></p><p>如果信号量的值为0则等待，如果信号量的值大于0则返回，同时对值做减1操作。</p><p><code>int sem_wait(sem_t* sem)</code></p><p><code>int sem_trywait(sem_t* sem)</code></p><p><code>int sem_timedwait(sem_t* sem,const struct timespec* abs_timeout)</code></p><p><strong>释放信号量，信号量加1操作</strong></p><p><code>int sem_post(sem_t* sem)</code></p><p><strong>获取信号量的值</strong></p><p><code>int sem_getvalue(sem_t* sem,int* sval)</code></p><p><strong>销毁信号量，释放资源</strong></p><p><code>int sem_destroy(sem_t* sem)</code></p><p><strong>示例</strong></p><figure class="highlight cpp"><figcaption data-lang=C++><span>实现互斥锁的功能</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 全局共享的buffer</span></pre></td></tr><tr><td data-num=2></td><td><pre>sem_t sem<span class="token punctuation">;</span><span class="token comment">// 声明信号量</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pthfun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:lock..\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:lock ok.\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        </pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token comment">// 操作共享的全局变量</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"%d : %dld,%d"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        </pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %dld:unlock.. \n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment">// 开(1)，关(0)</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token function">sem_int</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化信号量</span></pre></td></tr><tr><td data-num=26></td><td><pre>    </pre></td></tr><tr><td data-num=27></td><td><pre>    pthread_t pthid1<span class="token punctuation">,</span>pthid2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=30></td><td><pre>    </pre></td></tr><tr><td data-num=31></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=33></td><td><pre>    </pre></td></tr><tr><td data-num=34></td><td><pre>    <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 销毁信号量</span></pre></td></tr><tr><td data-num=35></td><td><pre>    </pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=高速缓存的实现信号量><a class=anchor href=#高速缓存的实现信号量>#</a> 高速缓存的实现(信号量)</h2><figure class="highlight cpp"><figcaption data-lang=C++><span>信号与互斥锁</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector></span></span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> mesgid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 消息的计数器</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 缓存消息的结构体</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">st_message</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">int</span> mesgid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">char</span> mesage<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token punctuation">&#125;</span>stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token operator">></span> vcache<span class="token punctuation">;</span><span class="token comment">// 用vector容器做缓存</span></pre></td></tr><tr><td data-num=20></td><td><pre>sem_t sem<span class="token punctuation">;</span><span class="token comment">// 声明信号量</span></pre></td></tr><tr><td data-num=21></td><td><pre>pthread_mutex_t mutex<span class="token punctuation">;</span><span class="token comment">// 声明并初始化互斥锁</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">// 消费者，出队，线程主函数</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">outcache</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 增加线程清理函数，释放锁</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    </pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token comment">// 如果缓存张没有数据，等待信号</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token comment">// 使用while防止数据变动，导致多余的锁操作</span></pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vcache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=35></td><td><pre>        </pre></td></tr><tr><td data-num=36></td><td><pre>        <span class="token comment">// 如果缓存为空，等待。  // 条件变量虚假唤醒</span></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token comment">// 由于数据一直是在变动的因此需要循环判断</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vcache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=40></td><td><pre>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=41></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=43></td><td><pre>        </pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token comment">// 从缓存中获取第一条记录，然后删除该记录</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token operator">&amp;</span>vcache<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=46></td><td><pre>        vcache<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vache<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=47></td><td><pre>        </pre></td></tr><tr><td data-num=48></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=49></td><td><pre>        </pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token comment">// 以下是处理业务的代码</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"phid = %ld,mesgid = %d\n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>stmesg<span class="token punctuation">.</span>mesgid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        </pre></td></tr><tr><td data-num=53></td><td><pre>        <span class="token comment">// 如果不使用uslepp，任务会被一个线程占有；使用后会呈现排队形式的接收任务</span></pre></td></tr><tr><td data-num=54></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=56></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=57></td><td><pre></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token comment">// 生产者，把生产的数据存入缓存</span></pre></td></tr><tr><td data-num=59></td><td><pre><span class="token keyword">void</span> <span class="token function">incache</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=61></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=62></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    </pre></td></tr><tr><td data-num=64></td><td><pre>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=65></td><td><pre>    </pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token comment">// 生产数据，放入缓存</span></pre></td></tr><tr><td data-num=67></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=68></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=69></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=70></td><td><pre>    </pre></td></tr><tr><td data-num=71></td><td><pre>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=72></td><td><pre>    </pre></td></tr><tr><td data-num=73></td><td><pre>    <span class="token comment">// 许多个post，倘若只使用1个，就只有一个线程能获取信号</span></pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=75></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=76></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=77></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=78></td><td><pre></pre></td></tr><tr><td data-num=79></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=80></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>incache<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 接收15的信号，调用生产者函数</span></pre></td></tr><tr><td data-num=82></td><td><pre>    </pre></td></tr><tr><td data-num=83></td><td><pre>    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化信号量</span></pre></td></tr><tr><td data-num=84></td><td><pre>    <span class="token function">pthread_muex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化互斥锁</span></pre></td></tr><tr><td data-num=85></td><td><pre>    </pre></td></tr><tr><td data-num=86></td><td><pre>    pthread_t thid1<span class="token punctuation">,</span>thid2<span class="token punctuation">,</span>thid3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=88></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=90></td><td><pre>    </pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>    </pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=96></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang=c><span>全信号</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector></span></span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>using namespace std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">int</span> mesgid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 消息的计数器</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">// 缓存消息的结构体</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">st_message</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token keyword">int</span> mesgid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token keyword">char</span> mesage<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token punctuation">&#125;</span>stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre>vector<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token operator">></span> vcache<span class="token punctuation">;</span><span class="token comment">// 用vector容器做缓存</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token class-name">sem_t</span> sem<span class="token punctuation">;</span><span class="token comment">// 声明信号量1</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token class-name">sem_t</span> lock<span class="token punctuation">;</span><span class="token comment">// 声明信号量2</span></pre></td></tr><tr><td data-num=22></td><td><pre></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment">// 消费者，出队，线程主函数</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">outcache</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token comment">// 增加线程清理函数，释放锁</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>    </pre></td></tr><tr><td data-num=29></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=30></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token comment">// 如果缓存张没有数据，等待信号</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token comment">// 使用while防止数据变动，导致多余的锁操作</span></pre></td></tr><tr><td data-num=33></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vcache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>        <span class="token comment">//pthread_mutex_lock(&amp;mutex);// 加锁</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=36></td><td><pre>        </pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token comment">// 如果缓存为空，等待。  // 条件变量虚假唤醒</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token comment">// 由于数据一直是在变动的因此需要循环判断</span></pre></td></tr><tr><td data-num=39></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> vcache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=41></td><td><pre>            <span class="token comment">//pthread_mutex_unlock(&amp;mutex);// 解锁</span></pre></td></tr><tr><td data-num=42></td><td><pre>            <span class="token function">sem_poset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=43></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        </pre></td></tr><tr><td data-num=46></td><td><pre>        <span class="token comment">// 从缓存中获取第一条记录，然后删除该记录</span></pre></td></tr><tr><td data-num=47></td><td><pre>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token operator">&amp;</span>vcache<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=48></td><td><pre>        vcache<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vache<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=49></td><td><pre>        </pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=51></td><td><pre>        </pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token comment">// 以下是处理业务的代码</span></pre></td></tr><tr><td data-num=53></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"phid = %ld,mesgid = %d\n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>stmesg<span class="token punctuation">.</span>mesgid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=54></td><td><pre>        </pre></td></tr><tr><td data-num=55></td><td><pre>        <span class="token comment">// 如果不使用uslepp，任务会被一个线程占有；使用后会呈现排队形式的接收任务</span></pre></td></tr><tr><td data-num=56></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=57></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=58></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=59></td><td><pre></pre></td></tr><tr><td data-num=60></td><td><pre><span class="token comment">// 生产者，把生产的数据存入缓存</span></pre></td></tr><tr><td data-num=61></td><td><pre><span class="token keyword">void</span> <span class="token function">incache</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=62></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=63></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">st_message</span> stmesg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=64></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmesg<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">st_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>    </pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token comment">//pthread_mutex_lock(&amp;mutex);// 加锁</span></pre></td></tr><tr><td data-num=67></td><td><pre>    <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=68></td><td><pre>    </pre></td></tr><tr><td data-num=69></td><td><pre>    <span class="token comment">// 生产数据，放入缓存</span></pre></td></tr><tr><td data-num=70></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=72></td><td><pre>    stmesg<span class="token punctuation">.</span>mesgid <span class="token operator">=</span> mesgid<span class="token operator">++</span><span class="token punctuation">;</span> vcache<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>stmesg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=73></td><td><pre>    </pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token comment">//pthread_mutex_unlock(&amp;mutex);// 解锁</span></pre></td></tr><tr><td data-num=75></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>    </pre></td></tr><tr><td data-num=77></td><td><pre>    <span class="token comment">// 许多个post，倘若只使用1个，就只有一个线程能获取信号</span></pre></td></tr><tr><td data-num=78></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=79></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=80></td><td><pre>    <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 信号加1</span></pre></td></tr><tr><td data-num=81></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=82></td><td><pre></pre></td></tr><tr><td data-num=83></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=84></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=85></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>incache<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 接收15的信号，调用生产者函数</span></pre></td></tr><tr><td data-num=86></td><td><pre>    </pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化信号量</span></pre></td></tr><tr><td data-num=88></td><td><pre>    <span class="token comment">//pthread_muex_init(&amp;mutex,NULL);// 初始化互斥锁</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化信号量</span></pre></td></tr><tr><td data-num=90></td><td><pre>    </pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token class-name">pthread_t</span> thid1<span class="token punctuation">,</span>thid2<span class="token punctuation">,</span>thid3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=92></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=93></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=94></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>outcache<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=95></td><td><pre>    </pre></td></tr><tr><td data-num=96></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=97></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=98></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thid3<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=99></td><td><pre>    </pre></td></tr><tr><td data-num=100></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=101></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=自旋锁spinlock><a class=anchor href=#自旋锁spinlock>#</a> 自旋锁(spinlock)</h2><p>自旋锁也是为实现保护共享资源而提出的一种锁机制。其实，自旋锁与互斥锁比较类似，都为了解决对某项资源的互斥所使用。</p><p>无论是互斥锁，还是自旋锁，在任何时刻，最多只能有一个保持者，即在任何时刻最多只能有一个执行单元获得锁。</p><p>但是两者在调度机制上略有不同。对于互斥锁，如果资源已经被占用，资源申请者进入睡眠状态。但是自旋锁不会引起申请者睡眠，如果自旋锁已经被占用，调用者就一直循环在那里判断占用者是否已经释放了锁，因此，自旋一词就以此得名(空转锁)。</p><p>自旋锁主要用于Linux内核同步。</p><p><strong>初始化锁</strong></p><p><code>int pthread_spin_init(pthread_spinlock_t* lock,int pshared)</code></p><p><strong>阻塞加锁</strong></p><p>若互斥锁已经被其他线程上锁，则调用者一直阻塞等待，直到被解锁后才上锁</p><p><code>int pthread_spin_lock(pthread_spinlock_t* lock)</code></p><p><strong>非阻塞加锁</strong></p><p><code>int pthread_spin_trylock(pthread_spinlock_t* lock)</code></p><p>若互斥锁未加锁，则上锁，若互斥锁已加锁，则函数立即返回失败</p><p><strong>解锁</strong></p><p><code>int pthread_spin_unlock(pthread_spinlock_t* lock)</code></p><p><strong>销毁锁</strong></p><p>释放资源</p><p><code>int pthread_spin_destroy(pthread_spinlock_t* lock)</code></p><p>自旋锁也存在线程优先级的问题。</p><p><strong>示例</strong></p><figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 使用互斥锁解决多线程抢占资源的问题</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 全局共享的buffer</span></pre></td></tr><tr><td data-num=9></td><td><pre>pthread_spinlock_t spin<span class="token punctuation">;</span><span class="token comment">// 声明自旋锁</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">pthfun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %d;b:lock..\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">pthread_spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:lock 0k. \n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>        </pre></td></tr><tr><td data-num=19></td><td><pre>        <span class="token comment">// 操作共享的全局变量</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"%d : %ld,%d"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=22></td><td><pre>        </pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token function">pthread_spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解锁</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d : %ld:unlock...\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        </pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=27></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=28></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=31></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=32></td><td><pre>    <span class="token function">pthread_spin_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>spin<span class="token punctuation">,</span>PTHREAS_PROCESS_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化锁</span></pre></td></tr><tr><td data-num=33></td><td><pre>    </pre></td></tr><tr><td data-num=34></td><td><pre>    pthread_t pthid1<span class="token punctuation">,</span>pthid2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=35></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=36></td><td><pre>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>pthfun<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=37></td><td><pre>    </pre></td></tr><tr><td data-num=38></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=39></td><td><pre>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>    </pre></td></tr><tr><td data-num=41></td><td><pre>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 销毁锁</span></pre></td></tr><tr><td data-num=42></td><td><pre>    </pre></td></tr><tr><td data-num=43></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=44></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=读写锁read-write-lock><a class=anchor href=#读写锁read-write-lock>#</a> 读写锁(Read-Write Lock)</h2><p>互斥锁只有加锁和不加锁两种状态，同一时间只能有一个线程加锁。</p><p>读写锁可以有三种状态</p><ul><li>读模式下加锁(读锁)</li><li>写模式下加锁(写锁)</li><li>不加锁</li></ul><p>读写锁的特点</p><ul><li>如果某线程申请了读锁，其他线程可以再申请读锁，但不能申请写锁</li><li>如果某线程申请了写锁，其他线程即不能申请读锁，也不能申请写锁</li></ul><p>读写锁适用于数据的读写次数多的情况。</p><p>读写锁只有一种锁的机制，合适的场景，但是，在程序中，并<strong>没有规定</strong>持有读锁就一定要读数据，持有写锁就一定要写数据。</p><p><strong>初始化读写锁</strong></p><p><code>int pthread_rwlock_init(pthread_rwlock_t* rwlock,const pthread_rwlockattr_t* attr)</code></p><p><strong>申请读锁</strong></p><p><code>int pthread_rwlock_rdlock(pthread_rwlock_t* rwlock)</code></p><p><strong>申请写锁</strong></p><p><code>int pthread_rwlock_wrlock(pthread_rwlock_t* rwlock)</code></p><p><strong>尝试申请写锁</strong></p><p>如果有线程持有读或写锁，则返回失败，否则成功</p><p><code>int pthread_rwlock_trywrlock(pthread_rwlock_t* rwlock)</code></p><p><strong>解锁</strong></p><p><code>int pthread_rwlock_unlock(pthread_rwlock_t* rwlock)</code></p><p><strong>销毁读写锁</strong></p><p><code>int pthread_rwlock_destroy(pthread_rwlock_t* rwlock)</code></p><p><img data-src=https://jd.reversesacle.com/gh/ReverseSacle/Gallery@latest/programming/network-programming/thread/3.webp alt=""></p><p>客户端要访问数据，数据最终要存入磁盘中，数据库和磁盘之间会有一个缓存。</p><p><strong>读取数据过程</strong></p><p>当客户端访问数据的时候，数据库会先访问缓存，如果缓存里面没有才会到磁盘里面找，找到后再将数据放入缓存，然后数库再次访问缓存并将数据取得。</p><p><strong>写数据过程</strong></p><p>数据库会先将数据写入缓存中，数据库会定期将缓存更新到磁盘中。</p><p>数据库，缓存，磁盘，三者会经常用到读写锁。</p><p>当从磁盘读取数据到缓存中时，会先锁住缓存，让数据库那边读到的数据不会是不完整的，锁住缓存不是锁住全部缓存，只是锁住一块。</p><p>数据库用读写锁的次数是最多的。</p><h2 id=死锁><a class=anchor href=#死锁>#</a> ! 死锁</h2><p>锁(Deadlock)是指在多个进程或线程之间，每个进程都在等待其他进程释放资源，而自己却不释放已经占有的资源，从而导致所有进程都无法继续执行的状态。</p><p>在死锁发生时，每个进程都占有一些资源，并且等待其他进程释放它们需要的资源。由于每个进程都在等待其他进程释放资源，而自己又不释放已经占有的资源，因此所有的进程都被阻塞，无法继续执行下去。这是一种非常不利于系统正常运行的状态。</p><p>死锁的产生通常涉及到多个并发执行的任务，并且这些任务都在竞争系统中的有限资源。为了解决死锁问题，需要采取一些策略，如资源分配策略、死锁检测与恢复策略、死锁预防策略等。</p><p><strong>死锁的四个必要条件</strong></p><ul><li><p><strong>互斥条件</strong> - 进程对所分配到的资源进行排他性使用，即在一段时间内某资源只由一个进程占用。如果此时还有其他进程请求资源，则请求者只能等待，直至占有资源的进程用毕释放</p></li><li><p><strong>持有并等待条件</strong> - 进程已经保持至少一个资源，但又提出了新的资源请求，而该资源已被其他进程占有，此时请求进程阻塞，但对自己已获得的资源保持不放</p></li><li><p><strong>非抢占条件</strong> - 进程在持有资源的同时不能被强制中断，资源只能由进程自己释放</p></li><li><p><strong>循环等待条件</strong> - 进程之间存在一个等待循环，其中每个进程都在等待下一个进程所持有的资源</p></li></ul><p><strong>避免死锁的方法</strong></p><ul><li><p>鸽巢算法 - 避免死锁最具代表性的算法是鸽巢算法。它通过预测分配资源可能导致死锁的情况，防止死锁的发生</p></li><li><p>银行家算法 - 这是一种用于避免死锁并确保系统稳定运作的算法。该算法在为进程分配资源之前，会判断进行资源分配后是否安全，即是否可能导致系统出现死锁。如果判断可能发生死锁，那么就拒绝进行资源分配</p></li><li><p>资源有序分配法 - 系统给每类资源赋予一个编号，每一个进程按编号递增的顺序请求资源，释放资源则可以任意顺序。这样就破坏了循环等待条件，因此可避免死锁</p></li><li><p>尽量避免使用不可抢占调度算法 - 使用可抢占的调度算法可以让已经占用资源的进程，在必要时释放资源，从而避免死锁</p></li></ul><p>实际上并没有万能的解决死锁的方法，比如<strong>操作系统内核中断等问题会让原先的死锁算法失效</strong>。需要根据实际情况选择合适的策略。</p><div class=tags><a href=/tags/network-programming/ rel=tag><i class="ic i-tag"></i> 网络编程</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span> <span class=text>更新于</span> <time title="修改时间：2025-01-09 17:58:14" itemprop=dateModified datetime=2025-01-09T17:58:14+08:00>2025-01-09</time></span><span class=item data-path=/computer-science/programming/network-programming/thread-synchronization/ title=阅读次数><span class=icon><i class="ic i-eye"></i></span> <span class=text>阅读次数</span><span class=waline-pageview-count></span> <span class=text>次</span></span></div><div id=copyright><ul><li class=author><strong>本文作者：</strong> ReverseSacle <i class="ic i-at"><em>@</em></i>逆转天平</li><li class=link><strong>本文链接：</strong> <a href=https://www.reversesacle.com/computer-science/programming/network-programming/thread-synchronization/ title=Linux线程同步>https://www.reversesacle.com/computer-science/programming/network-programming/thread-synchronization/</a></li><li class=license><strong>版权声明：</strong> 本站所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class=post-nav><div class="item left"><a href=/computer-science/programming/network-programming/multithreading/ itemprop=url rel=prev data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg7.webp title=Linux多线程><span class=type>上一篇</span><span class=category><i class="ic i-flag"></i> 网络编程</span><h3>Linux多线程</h3></a></div><div class="item right"><a href=/computer-science/programming/network-programming/programming/ itemprop=url rel=next data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg3.webp title=C&#x2F;C++网络编程><span class=type>下一篇</span><span class=category><i class="ic i-flag"></i> 网络编程</span><h3>C/C++网络编程</h3></a></div></div><div class=wrap id=comments><div id=waline-comment></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=文章目录><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-number>1.</span> <span class=toc-text>! 概述</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BA%92%E6%96%A5%E9%94%81mutex><span class=toc-number>2.</span> <span class=toc-text>互斥锁(Mutex)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BA%92%E6%96%A5%E9%94%81%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0><span class=toc-number>3.</span> <span class=toc-text>互斥锁实现数据库连接池</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8Fconditional-variable><span class=toc-number>4.</span> <span class=toc-text>条件变量(Conditional Variable)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E4%B8%8E%E4%BA%92%E6%96%A5%E9%94%81><span class=toc-number>5.</span> <span class=toc-text>条件变量与互斥锁</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%94%9F%E4%BA%A7-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B><span class=toc-number>6.</span> <span class=toc-text>生产-消费者模型</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E5%92%8C%E4%BA%92%E6%96%A5%E9%94%81><span class=toc-number>7.</span> <span class=toc-text>高速缓存的实现(条件变量和互斥锁)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BF%A1%E5%8F%B7%E9%87%8Fsemaphore><span class=toc-number>8.</span> <span class=toc-text>信号量(Semaphore)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BF%A1%E5%8F%B7%E9%87%8F><span class=toc-number>9.</span> <span class=toc-text>高速缓存的实现(信号量)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%87%AA%E6%97%8B%E9%94%81spinlock><span class=toc-number>10.</span> <span class=toc-text>自旋锁(spinlock)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%AF%BB%E5%86%99%E9%94%81read-write-lock><span class=toc-number>11.</span> <span class=toc-text>读写锁(Read-Write Lock)</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%AD%BB%E9%94%81><span class=toc-number>12.</span> <span class=toc-text>! 死锁</span></a></li></ol></div><div class="related panel pjax" data-title=系列文章><ul><li><a href=/computer-science/programming/network-programming/linux-environment/ rel=bookmark title=虚拟机-Linux环境配置>虚拟机-Linux环境配置</a></li><li><a href=/computer-science/programming/network-programming/Linux-basic/ rel=bookmark title="Linux基础(CentOS 7)">Linux基础(CentOS 7)</a></li><li><a href=/computer-science/programming/network-programming/gcc-compiler/ rel=bookmark title=GCC编译器>GCC编译器</a></li><li><a href=/computer-science/programming/network-programming/gdb-debugging-tool/ rel=bookmark title=GDB调试工具>GDB调试工具</a></li><li><a href=/computer-science/programming/network-programming/make-compiler-tool/ rel=bookmark title=make编译工具>make编译工具</a></li><li><a href=/computer-science/programming/network-programming/clibrary/ rel=bookmark title=C/C++静态库与动态库的制作和使用>C/C++静态库与动态库的制作和使用</a></li><li><a href=/computer-science/programming/network-programming/executable-program/ rel=bookmark title=在C/C++程序中调用可执行程序>在C/C++程序中调用可执行程序</a></li><li><a href=/computer-science/programming/network-programming/signal/ rel=bookmark title=Linux的信号(signal)>Linux的信号(signal)</a></li><li><a href=/computer-science/programming/network-programming/multiprocessing/ rel=bookmark title=Linux多进程>Linux多进程</a></li><li><a href=/computer-science/programming/network-programming/log/ rel=bookmark title=C/C++服务程序的运行日志>C/C++服务程序的运行日志</a></li><li><a href=/computer-science/programming/network-programming/multithreading/ rel=bookmark title=Linux多线程>Linux多线程</a></li><li class=active><a href=/computer-science/programming/network-programming/thread-synchronization/ rel=bookmark title=Linux线程同步>Linux线程同步</a></li><li><a href=/computer-science/programming/network-programming/programming/ rel=bookmark title=C/C++网络编程>C/C++网络编程</a></li><li><a href=/computer-science/programming/network-programming/http/ rel=bookmark title=HTTP网络通信基础>HTTP网络通信基础</a></li><li><a href=/computer-science/programming/network-programming/ubuntu-obs-server/ rel=bookmark title="Ubuntu服务器OBS Studio配置">Ubuntu服务器OBS Studio配置</a></li></ul></div><div class="overview panel" data-title=站点概览><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img class=image itemprop=image alt=ReverseSacle data-src=/images/avatar.webp><p class=name itemprop=name>ReverseSacle</p><div class=description itemprop=description>知识书库 & 学习点滴</div></div><nav class=state><div class="item posts"><a href=/archives/ ><span class=count>186</span> <span class=name>文章</span></a></div><div class="item categories"><a href=/categories/ ><span class=count>52</span> <span class=name>分类</span></a></div><div class="item tags"><a href=/tags/ ><span class=count>18</span> <span class=name>标签</span></a></div></nav><div class=social><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JldmVyc2VTYWNsZQ==" title=https:&#x2F;&#x2F;github.com&#x2F;ReverseSacle><i class="ic i-github"></i></span><span class="exturl item email" data-url="bWFpbHRvOnByaXZhdGVAcmV2ZXJzZXNhY2xlLmNvbQ==" title=mailto:private@reversesacle.com><i class="ic i-envelope"></i></span></div><ul class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i> 首页</a></li><li class="item dropdown"><a href=javascript:void(0);><i class="ic i-feather"></i> 文章</a><ul class=submenu><li class=item><a href=/archives/ rel=section><i class="ic i-list-alt"></i> 归档</a></li><li class=item><a href=/categories/ rel=section><i class="ic i-th"></i> 分类</a></li><li class=item><a href=/tags/ rel=section><i class="ic i-tags"></i> 标签</a></li></ul></li><li class=item><a href=/about/ rel=section><i class="ic i-user"></i> 关于</a></li><li class=item><a href=/friend-links/ rel=section><i class="ic i-heart"></i> 友链</a></li></ul></div></div></div><ul id=quick><li class="prev pjax"><a href=/computer-science/programming/network-programming/multithreading/ rel=prev title=上一篇><i class="ic i-chevron-left"></i></a></li><li class=up><i class="ic i-arrow-up"></i></li><li class=down><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href=/computer-science/programming/network-programming/programming/ rel=next title=下一篇><i class="ic i-chevron-right"></i></a></li><li class=percent></li></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>随机文章</h2><ul><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/web/ title="分类于 web">web</a></div><span><a href=/computer-science/programming/web/anti-scraping-vs-countermeasures/ title=防爬虫与反防爬虫知识聚合>防爬虫与反防爬虫知识聚合</a></span></li><li class=item><div class=breadcrumb><a href=/categories/general-science-and-technology/ title="分类于 通用科学技术">通用科学技术</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/ title="分类于 通用技术之PC端">通用技术之PC端</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/router/ title="分类于 路由器">路由器</a></div><span><a href=/general-science-and-technology/pc/router/side-router-setting/ title=副路由的设置方法>副路由的设置方法</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/binary-tree/ title="分类于 二叉树">二叉树</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/binary-tree/traversal/ title=二叉树-遍历>二叉树-遍历</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/dynamic-program/ title="分类于 动态规划">动态规划</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/dynamic-program/derivatives/ title=动态规划问题派生>动态规划问题派生</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/string/ title="分类于 字符串">字符串</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/string/nums/ title=字符串-数理>字符串-数理</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/link-list/ title="分类于 链表">链表</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/link-list/sort/ title=链表-序列重组>链表-序列重组</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/app-development/ title="分类于 应用开发">应用开发</a></div><span><a href=/computer-science/programming/app-development/web-exe-application/ title=web桌面应用开发(Electron与C语言)>web桌面应用开发(Electron与C语言)</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/c-data-structure/ title="分类于 C语言数据结构">C语言数据结构</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/seqstring/ title=结构串之字符存储>结构串之字符存储</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/two-pointer/ title="分类于 双指针">双指针</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/two-pointer/search/ title=双指针-查找>双指针-查找</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a></div><span><a href=/computer-science/programming/rust/rust-data-structure/linear-structure/seqlist/ title=Rust-顺序表>Rust-顺序表</a></span></li></ul></div><div><h2>最新评论</h2><ul id=waline-recent></ul></div></div><div class=status><div class=copyright>&copy; 2021 – <span itemprop=copyrightYear>2025</span><span class=with-love><i class="ic i-sakura rotate"></i></span> <span class=author itemprop=copyrightHolder>ReverseSacle @ ReverseSacle-Blog</span></div><div class=count><i class="ic i-clock" aria-hidden=true></i> <span id=time align=center>载入时间中...<script defer>var now=new Date;function createtime(){var n=new Date("2021-11-16 22:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("time").innerHTML="已经过 "+dnum+" 天 "+hnum+" 小时 "+mnum+" 分 "+snum+" 秒 "}setInterval("createtime()",250)</script></span><span class=post-meta-item-icon>|&nbsp<i class="ic i-chart-area"></i></span> <span title=站点总字数>2.1m 字</span> <span class=post-meta-item-icon>|&nbsp<i class="ic i-coffee"></i></span> <span title=站点阅读时长>40:40</span></div></div></div></footer></div><script data-config>var LOCAL={path:"computer-science/programming/network-programming/thread-synchronization/",favicon:{show:"ReverseSacle-Blog",hide:"ReverseSacle-Blog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},waline:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src=https://polyfill.alicdn.com/v3/polyfill.min.js></script><script src=https://jd.reversesacle.com/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1.16.0/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js></script><script src=/js/app.js></script></body></html>