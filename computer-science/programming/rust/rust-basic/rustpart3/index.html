<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#222><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/ico sizes=48x48 href=/images/favicon.ico><link rel=alternate type=application/rss+xml title=逆转天平 href=https://www.reversesacle.com/rss.xml><link rel=alternate type=application/atom+xml title=逆转天平 href=https://www.reversesacle.com/atom.xml><link rel=alternate type=application/json title=逆转天平 href=https://www.reversesacle.com/feed.json><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=/css/app.css><meta name=description content=编程语言><link rel=canonical href=https://www.reversesacle.com/computer-science/programming/rust/rust-basic/rustpart3/ ><title>Rust语言-基础-第三部分 - Rust基础 - Rust - 编程 - 计算机科学 | ReverseSacle-Blog</title><meta name=generator content="Hexo 6.3.0"></head><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=dotloader><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div><div class=dot></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">Rust语言-基础-第三部分</h1><div class=meta><span class=item title="创建时间：2023-10-14 20:01:20"><span class=icon><i class="ic i-calendar"></i></span> <span class=text>发表于</span> <time itemprop="dateCreated datePublished" datetime=2023-10-14T20:01:20+08:00>2023-10-14</time></span><span class=item title=本文字数><span class=icon><i class="ic i-pen"></i></span> <span class=text>本文字数</span> <span>33k</span> <span class=text>字</span></span><span class=item title=阅读时长><span class=icon><i class="ic i-clock"></i></span> <span class=text>阅读时长</span> <span>39 分钟</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div class=lines role=navigation aria-label=切换导航栏><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>ReverseSacle-Blog</a></li></ul><ul class=right><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id=imgs class=pjax><ul><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg7.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg9.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg19.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg3.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg21.webp></li><li class=item data-background-image=https://resa-imgs.oss-accelerate.aliyuncs.com/img/acg17.webp></li></ul></div></header><div id=waves><svg class=waves xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink viewBox="0 24 150 28" preserveAspectRatio=none shape-rendering=auto><defs><path id=gentle-wave d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352z"/></defs><g class=parallax><use xlink:href=#gentle-wave x=48 y=0 /><use xlink:href=#gentle-wave x=48 y=3 /><use xlink:href=#gentle-wave x=48 y=5 /><use xlink:href=#gentle-wave x=48 y=7 /></g></svg></div><main><div class=inner><div id=main class=pjax><div class="article wrap"><div class=breadcrumb itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i> <span><a href=/ >首页</a></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/ itemprop=item rel=index title="分类于 计算机科学"><span itemprop=name>计算机科学</span></a><meta itemprop=position content=1></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/ itemprop=item rel=index title="分类于 编程"><span itemprop=name>编程</span></a><meta itemprop=position content=2></span><i class="ic i-angle-right"></i> <span itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/rust/ itemprop=item rel=index title="分类于 Rust"><span itemprop=name>Rust</span></a><meta itemprop=position content=3></span><i class="ic i-angle-right"></i> <span class=current itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a href=/categories/computer-science/programming/rust/rust-basic/ itemprop=item rel=index title="分类于 Rust基础"><span itemprop=name>Rust基础</span></a><meta itemprop=position content=4></span></div><article itemscope itemtype=http://schema.org/Article class="post block" lang=zh-CN><link itemprop=mainEntityOfPage href=https://www.reversesacle.com/computer-science/programming/rust/rust-basic/rustpart3/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.webp><meta itemprop=name content=ReverseSacle><meta itemprop=description content="所见即所得，所思即所行, 知识书库 & 学习点滴"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=逆转天平></span><div class="body md" itemprop=articleBody><h2 id=生命周期><a class=anchor href=#生命周期>#</a> 生命周期</h2><p>生命周期，简而言之就是引用的有效作用域。大多数时候无需手动声明生命周期，因为编译器可以自动进行推导，当存在多个生命周期且编译器无法推导出某个引用的生命周期时，就需要手动标明生命周期。</p><h3 id=悬垂指针与生命周期><a class=anchor href=#悬垂指针与生命周期>#</a> 悬垂指针与生命周期</h3><p>生命周期的主要作用是避免悬垂引用，它会导致程序引用了本不该引用的数据</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token comment">// 声明方式貌似存在使用null的风险。当不初始化它就使用时，编译器会给予报错。</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">let</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        r <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"r: &#123;&#125;"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment"> * r引用了内部花括号中的x变量，但 x会在内部花括号`&#125;`处被释放，</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment"> * 因此回到外部花括号后，r会引用一个无效的x。</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment"> *</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment"> * 报错</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment"> *    error[E0597]: `x` does not live long enough // `x` 活得不够久</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment"> *     --> src/main.rs:7:17</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment"> *      |</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment"> *   7  |             r = &amp;x;</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment"> *      |                 ^^ borrowed value does not live long enough // 被借用的 `x` 活得不够久</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token comment"> *   8  |         &#125;</span></pre></td></tr><tr><td data-num=23></td><td><pre><span class="token comment"> *      |         - `x` dropped here while still borrowed // `x` 在这里被丢弃，但是它依然还在被借用</span></pre></td></tr><tr><td data-num=24></td><td><pre><span class="token comment"> *   9  |</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token comment"> *   10 |         println!("r: &#123;&#125;", r);</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token comment"> *      |                           - borrow later used here // 对 `x` 的借用在此处被使用</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><p>此处<code>r</code>就是一个悬垂指针，它引用了提前被释放的变量<code>x</code>。<code>r</code>拥有更大的作用域或者说<strong>活得更久</strong>。如果Rust不阻止该悬垂引用的发生，那么当<code>x</code>被释放后，<code>r</code>所引用的值就不再是合法的，会导致程序发生异常行为，且该异常行为有时候会很难被发现。</p><h3 id=借用检查><a class=anchor href=#借用检查>#</a> 借用检查</h3><p>Rust为了保证所有权和借用的正确性，使用了一个借用检查器(Borrow checker)来检查程序的借用正确性。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 增加对变量生命周期的注释</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">let</span> r<span class="token punctuation">;</span>                <span class="token comment">// ---------+-- 'a</span></pre></td></tr><tr><td data-num=4></td><td><pre>                          <span class="token comment">//          |</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#123;</span>                     <span class="token comment">//          |</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token comment">// -+-- 'b  |</span></pre></td></tr><tr><td data-num=7></td><td><pre>        r <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span>           <span class="token comment">//  |       |</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span>                     <span class="token comment">// -+       |</span></pre></td></tr><tr><td data-num=9></td><td><pre>                          <span class="token comment">//          |</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"r: &#123;&#125;"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//          |</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span>                         <span class="token comment">// ---------+</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment"> * r变量被赋予了生命周期`'a`，x被赋予了生命周期`'b`。</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token comment"> * 生命周期`'b`比`'a`小很多。</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><p>在编译期，Rust会比较两个变量的生命周期，发现<code>r</code>拥有生命周期 <code>'a</code>，却引用了一个比<code>'a</code>小得多的生命周期<code>'b</code>，这种情况下，编译器认为程序存在风险，因此拒绝运行。如果想要编译通过，只要<code>'b</code>比<code>'a</code>大就行了。也就是<code>x</code>变量只要比<code>r</code>活得久，那么<code>r</code>就能随意引用<code>x</code>且不会存在危险。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>            <span class="token comment">// ----------+-- 'b</span></pre></td></tr><tr><td data-num=3></td><td><pre>                          <span class="token comment">//           |</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span>           <span class="token comment">// --+-- 'a  |</span></pre></td></tr><tr><td data-num=5></td><td><pre>                          <span class="token comment">//   |       |</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"r: &#123;&#125;"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |       |</span></pre></td></tr><tr><td data-num=7></td><td><pre>                          <span class="token comment">// --+       |</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#125;</span>                         <span class="token comment">// ----------+</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">// 现在x的生命周期`'b`大于r的生命周期`'a`，因此r对变量x的引用是安全的</span></pre></td></tr></table></figure><h3 id=函数中的生命周期问题><a class=anchor href=#函数中的生命周期问题>#</a> 函数中的生命周期问题</h3><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">if</span> x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> y<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        x</pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        y</pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">let</span> string1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">let</span> string2 <span class="token operator">=</span> <span class="token string">"xyz"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">longest</span><span class="token punctuation">(</span>string1<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> string2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The longest string is &#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>// 报错</pre></td></tr><tr><td data-num=2></td><td><pre>error<span class="token punctuation">[</span>E0106<span class="token punctuation">]</span>: missing lifetime specifier</pre></td></tr><tr><td data-num=3></td><td><pre> --> src/main.rs:9:33</pre></td></tr><tr><td data-num=4></td><td><pre>  |</pre></td></tr><tr><td data-num=5></td><td><pre>9 | fn longest(x: <span class="token punctuation">&amp;</span>str, y: <span class="token punctuation">&amp;</span>str) -> <span class="token punctuation">&amp;</span>str <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>  |               ----     ----     ^ expected named lifetime parameter // 参数需要一个生命周期</pre></td></tr><tr><td data-num=7></td><td><pre>  |</pre></td></tr><tr><td data-num=8></td><td><pre>  = help: this function's return type contains a borrowed value, but the signature does not say whether it is</pre></td></tr><tr><td data-num=9></td><td><pre>  borrowed from `x` or `y`</pre></td></tr><tr><td data-num=10></td><td><pre>  = 帮助： 该函数的返回值是一个引用类型，但是函数签名无法说明，该引用是借用自 `x` 还是 `y`</pre></td></tr><tr><td data-num=11></td><td><pre>help: consider introducing a named lifetime parameter // 考虑引入一个生命周期</pre></td></tr><tr><td data-num=12></td><td><pre>  |</pre></td></tr><tr><td data-num=13></td><td><pre>9 | fn longest&lt;'a>(x: <span class="token punctuation">&amp;</span>'a str, y: <span class="token punctuation">&amp;</span>'a str) -> <span class="token punctuation">&amp;</span>'a str <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=14></td><td><pre>  |           ^^^^    ^^^^^^^     ^^^^^^^     ^^^</pre></td></tr></table></figure><p>报错原因是编译器无法知道该函数的返回值引用的是<code>x</code>还是<code>y</code>，编译器需要知道这些来确保函数调用后的引用生命周期分析。就该函数的创建而言，是不知道传递给函数的具体值的，因此到底是<code>if</code>还是<code>else</code>被执行是无法知道的。其次，传入参数引用的具体生命周期也不知道，因此也不能通过分析生命周期来确定引用是否有效。同时，编译器的借用检查也无法推导出返回值的生命周期，因为它不知道<code>x</code>和<code>y</code>的生命周期跟返回值的生命周期之间的关系是怎样的。</p><h3 id=生命周期标注语法><a class=anchor href=#生命周期标注语法>#</a> 生命周期标注语法</h3><p>生命周期标注并不会改变任何引用的实际作用域。例如，一个变量只能活一个花括号，那么就算给它标注一个活全局的生命周期，它还是会在前面的花括号结束处被释放掉，并不会真的全局存活。</p><p>生命周期的语法以 <code>'</code> 开头，名称往往是一个单独的小写字母，大多数人都用 <code>'a</code> 来作为生命周期的名称。 如果是引用类型的参数，那么生命周期会位于引用符号 <code>&amp;</code> 之后，并用一个空格来将生命周期和引用参数分隔开。</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">&amp;</span>i32        // 一个引用</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token punctuation">&amp;</span>'a i32     // 具有显式生命周期的引用</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&amp;</span>'a mut i32 // 具有显式生命周期的可变引用</pre></td></tr></table></figure><p>一个生命周期标注，它自身并不具有什么意义，因为生命周期的作用就是告诉编译器多个引用之间的关系。例如，有一个函数，它的第一个参数<code>first</code>是一个指向<code>i32</code>类型的引用，具有生命周期<code>'a</code>；另一个参数<code>second</code>，它也是指向<code>i32</code>类型的引用，并且同样具有生命周期<code>'a</code>。此处生命周期标注仅仅说明，这两个参数<code>first</code>和<code>second</code>至少活得和<code>'a</code>一样久，至于到底活多久或者哪个活得更久，都无法得知。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">useless</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>first<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> second<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font size=3><ins><strong>函数签名中的生命周期标注</strong></ins></font></p><p>使用生命周期参数时需要先声明<code>&lt;'a&gt;</code>。在通过函数签名指定生命周期参数时，并没有改变传入引用或者返回引用的真实生命周期，而是告诉编译器当不满足此约束条件时就拒绝编译通过。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 从两个字符串切片中返回较长的那个</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">if</span> x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> y<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        x</pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        y</pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">// x、y和返回值至少活得和`'a`一样久(因为返回值要么是x，要么是y)</span></pre></td></tr></table></figure><p>该函数签名表明对于某些生命周期<code>'a</code>，函数的两个参数都至少跟<code>'a</code>活得一样久并且函数返回的引用也至少跟<code>'a</code>活得一样久。实际上，返回值的生命周期与参数生命周期中的较小的那个一致。虽然两个参数的生命周期都是标注了<code>'a</code>，但实际上这两个参数的真实生命周期可能是不一样的(生命周期<code>'a</code>不代表生命周期等于<code>'a</code>，而是大于等于<code>'a</code>)。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> string1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"long string is long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token keyword">let</span> string2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"xyz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">longest</span><span class="token punctuation">(</span>string1<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> string2<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The longest string is &#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在上例代码中，<code>string1</code>的作用域是直到<code>main</code>函数的结束为止，而<code>string2</code>的作用域是到内部花括号的结束<code>&#125;</code>为止。根据之前的理论，<code>'a</code>是两者中作用域较小的那个，即<code>'a</code>的生命周期等于<code>string2</code>的生命周期。同理，由于函数返回的生命周期也是'<code>a</code>，可以得出函数返回的生命周期也等于<code>string2</code>的生命周期。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> string1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"long string is long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">let</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token keyword">let</span> string2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"xyz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        result <span class="token operator">=</span> <span class="token function">longest</span><span class="token punctuation">(</span>string1<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> string2<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The longest string is &#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>以上例子会报错，以此证明了生命周期等于参数中生命周期较小的那个。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    x</pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用生命周期的方式往往取决于函数的功能，以上例子中，函数永远只返回第一个参数<code>x</code>，参数<code>y</code>完全没有被使用，因此<code>y</code>的生命周期与<code>x</code>和返回值的生命周期没有任何关系。这意味着不必再为<code>y</code>标注生命周期，只需要标注<code>x</code>参数和返回值即可。</p><p>函数的返回值如果是一个引用类型，那么它的生命周期只会来源于</p><ul><li>函数参数的生命周期</li><li>函数体中某个新建引用的生命周期</li></ul><p>如果函数返回值是函数体中某个新建引用的生命周期，就是典型的悬垂引用场景。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"really long string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    result<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment">// 函数的返回值与参数x，y没有任何关系，而是引用了函数体内创建的字符串</span></pre></td></tr></table></figure><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>// 报错</pre></td></tr><tr><td data-num=2></td><td><pre>error<span class="token punctuation">[</span>E0515<span class="token punctuation">]</span>: cannot return value referencing local variable `result` // 返回值result引用了本地的变量</pre></td></tr><tr><td data-num=3></td><td><pre>  --> src/main.rs:11:5</pre></td></tr><tr><td data-num=4></td><td><pre>   |</pre></td></tr><tr><td data-num=5></td><td><pre>11 |     result.as_str()</pre></td></tr><tr><td data-num=6></td><td><pre>   |     ------^^^^^^^^^</pre></td></tr><tr><td data-num=7></td><td><pre>   |     |</pre></td></tr><tr><td data-num=8></td><td><pre>   |     returns a value referencing data owned by the current function</pre></td></tr><tr><td data-num=9></td><td><pre>   |     `result` is borrowed here</pre></td></tr></table></figure><p>报错原因是<code>result</code>在函数结束后就被释放，但是在函数结束后对<code>result</code>的引用依然在继续。遇到这种情况，最好的解决方法是返回内部字符串的所有权，然后把字符串的所有权转移给调用者。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>_x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> _y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"really long string"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>   <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token function">longest</span><span class="token punctuation">(</span><span class="token string">"not"</span><span class="token punctuation">,</span> <span class="token string">"important"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=生命周期的消除><a class=anchor href=#生命周期的消除>#</a> 生命周期的消除</h3><p>编译器为了简化用户的使用，运用了生命周期消除大法。例如，</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">first_word</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这类代码，生命周期可被消除。消除规则不是万能的，若编译器不能确定某件事是正确时，会直接判为不正确，那么还是需要手动标注生命周期。</p><p>函数或者方法中参数的生命周期被称为<strong>输入生命周期</strong>，返回值的生命周期被称为<strong>输出生命周期</strong>。</p><p>编译器使用<strong>三条消除规则</strong>来确定哪些场景不需要显式地去标注生命周期。</p><ol><li><p><strong>每一个引用参数都会获得独自的生命周期</strong></p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>例如一个引用参数的函数就有一个生命周期标注 - fn foo&lt;'a>(x: <span class="token punctuation">&amp;</span>'a i32)，</pre></td></tr><tr><td data-num=2></td><td><pre>两个引用参数的有两个生命周期标注:fn foo&lt;'a, 'b>(x: <span class="token punctuation">&amp;</span>'a i32, y: <span class="token punctuation">&amp;</span>'b i32), 依此类推。</pre></td></tr></table></figure></li><li><p><strong>若只有一个输入生命周期(函数参数中只有一个引用类型)，那么该生命周期会被赋给所有的输出生命周期</strong>，也就是所有返回值的生命周期都等于该输入生命周期</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>例如函数 - fn foo(x: <span class="token punctuation">&amp;</span>i32) -> <span class="token punctuation">&amp;</span>i32，x参数的生命周期会被自动赋给返回值<span class="token punctuation">&amp;</span>i32，</pre></td></tr><tr><td data-num=2></td><td><pre>因此该函数等同于fn foo&lt;'a>(x: <span class="token punctuation">&amp;</span>'a i32) -> <span class="token punctuation">&amp;</span>'a i32</pre></td></tr></table></figure></li><li><p><strong>若存在多个输入生命周期，且其中一个是 <code>&amp;self</code> 或 <code>&amp;mut self</code>，则 <code>&amp;self</code> 的生命周期被赋给所有的输出生命周期</strong></p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>拥有<span class="token punctuation">&amp;</span>self形式的参数，说明该函数是一个方法，该规则让方法的使用便利度大幅提升。</pre></td></tr></table></figure></li></ol><p>其中第一条规则应用在输入生命周期上，第二、三条应用在输出生命周期上。若编译器发现三条规则都不适用时，就会报错，提示你需要手动标注生命周期。</p><h3 id=结构体中的生命周期><a class=anchor href=#结构体中的生命周期>#</a> 结构体中的生命周期</h3><p>不在结构体中使用字符串字面量或者字符串切片，而是统一使用String类型，是因为String类型在结构体初始化时，只要转移所有权即可，但字符串字面量或者字符串切片却不能这样做。应对这种情况，只要为结构体中的每一个引用标注上生命周期即可。结构体引用的字符串活得比结构体久。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    part<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">let</span> novel <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Call me Ishmael. Some years ago..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">let</span> first_sentence <span class="token operator">=</span> novel<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Could not find a '.'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token class-name">ImportantExcerpt</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        part<span class="token punctuation">:</span> first_sentence<span class="token punctuation">,</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>ImportantExcerpt</code>结构体中有一个引用类型的字段<code>part</code>，需要为其标注上生命周期。结构体的生命周期标注需要对生命周期参数进行声明<code>&lt;'a&gt;</code>。该生命周期标注说明，结构体<code>ImportantExcerpt</code>所引用的字符串<code>str</code>必须比该结构体活得更久。</p><h3 id=方法中的生命周期><a class=anchor href=#方法中的生命周期>#</a> 方法中的生命周期</h3><p>生命周期标注也是结构体类型的一部分，<code>impl</code>中必须使用结构体的完整名称，包括<code>&lt;'a&gt;</code>。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 泛型的语法</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    x<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    y<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Point</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">T</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>x</pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">// 具有生命周期的结构体实现方法</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    part<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">level</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=20></td><td><pre>        <span class="token number">3</span></pre></td></tr><tr><td data-num=21></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>方法签名中往往不需要标注生命周期，得益于生命周期消除的第一和第三规则。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 生命周期消除的第三规则的应用</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">// 首先，编译器应用第一规则，给予每个输入参数一个生命周期</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment"> * 编译器不知道announcement的生命周期到底多长，</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment"> * 因此无法简单的给予它生命周期`'a`，而是重新声明了一个生命周期`'b`。</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">**/</span></pre></td></tr><tr><td data-num=20></td><td><pre></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">// 接着，编译器应用第三规则，将&amp;self的生命周期赋给返回值&amp;str</span></pre></td></tr><tr><td data-num=22></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=23></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=24></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=26></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=27></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>假如将方法返回的生命周期改为<code>'b</code></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>编译器会报错，因为编译器无法知道<code>'a</code>和<code>'b</code>的关系。<code>&amp;self</code>生命周期是<code>'a</code>，那么<code>self.part</code>的生命周期也是<code>'a</code>。此处手动为返回值<code>self.part</code>标注了生命周期<code>'b</code>，因此编译器需要知道<code>'a</code>和<code>'b</code>的关系。由于<code>&amp;'a self</code>是被引用的一方，因此引用它的<code>&amp;'b str</code>必须要活得比它短，否则会出现悬垂引用。因此说明生命周期<code>'b</code>必须要比<code>'a</code>小，只要满足了这一点，编译器就不会再报错。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 可以把`'a`和`'b`都在同一个地方声明</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'b</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment">// `'a: 'b` - 是生命周期约束语法，用于说明`'a`必须比`'b`活得久。</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment">// 分开声明，通过`where 'a: 'b`约束生命周期关系</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">announce_and_return_part</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> announcement<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">str</span></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token keyword">where</span></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'b</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Attention please: &#123;&#125;"</span><span class="token punctuation">,</span> announcement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>        <span class="token keyword">self</span><span class="token punctuation">.</span>part</pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=静态生命周期><a class=anchor href=#静态生命周期>#</a> 静态生命周期</h3><p>静态生命周期 - <code>'static</code>，拥有该生命周期的引用可以和整个程序活得一样久。</p><p>字符串字面量以及那些被硬编码进 Rust 的二进制文件中的这些字符串变量全部具有<code>'static</code>的生命周期。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">let</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"我没啥优点，就是活得久，嘿嘿"</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id=文件操作><a class=anchor href=#文件操作>#</a> 文件操作</h2><p>需导入模块 - <code>use std::fs;</code></p><h3 id=文件的创建><a class=anchor href=#文件的创建>#</a> 文件的创建</h3><p><code>create</code>方法 - 创建一个目录</p><p><code>create_dir_all</code>方法 - 创建整个路径不包括文件</p><p>返回一个<code>Result</code>枚举，可能包含成功或失败的结果，如果文件已存在将尝试打开，打开后将被清空并写入新的内容。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span>create_dir_all<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">let</span> file_result <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/test/example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">match</span> file_result <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token class-name">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=8></td><td><pre>            <span class="token comment">// 文件成功创建</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=11></td><td><pre>            <span class="token comment">// 文件创建失败，处理错误</span></pre></td></tr><tr><td data-num=12></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: &#123;&#125;"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用<code>OpenOptions</code> 的new方法，可追加相应的打开模式，可追加模式create来执行当文件不存在时自动创建，只会创建文件所在的目标文件，但不会创建中间目录。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">OpenOptions</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token string">"example_dir/example_file.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 创建文件(如果不存在)</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">//        .write(true) // 用于写入内容</span></pre></td></tr><tr><td data-num=10></td><td><pre>    	<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 文件已存在时追加内容而不是覆盖</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre>    file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Creating and writing to a new file"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=文件的打开><a class=anchor href=#文件的打开>#</a> 文件的打开</h3><p>关联函数签名 - <code>pub fn open&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;File&gt;</code></p><p>返回一个Result枚举类型，包含了一个<code>File</code>实例或一个错误信息。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> file_result <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">match</span> file_result <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token class-name">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>            <span class="token comment">// 文件成功打开，可以进行读取或写入操作</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>            <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Error: &#123;&#125;"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=文件的元信息查看><a class=anchor href=#文件的元信息查看>#</a> 文件的元信息查看</h3><p>关联函数签名 - <code>pub fn metadata&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;Metadata&gt;</code></p><p>可以获取文件的元信息，如文件大小、修改时间等。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> metadata <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">metadata</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"File size: &#123;&#125;"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Modified: &#123;:?&#125;"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">modified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token comment">// ...</span></pre></td></tr><tr><td data-num=10></td><td><pre>    </pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=文件的内容读取><a class=anchor href=#文件的内容读取>#</a> 文件的内容读取</h3><p>关联函数签名 - <code>pub fn read_to_string&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;String&gt;</code></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Read</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Unable to open file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> content <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Unable to read file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>特征方法签名 - <code>fn read_to_end(&amp;mut self, buf: &amp;mut Vec&lt;u8&gt;) -&gt; Result&lt;usize&gt;</code></p><p>从一个可读取的对象中将数据读取到一个可变的字节数组中</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">Read</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token comment">// 打开文件，如果文件不存在，可以使用File::open创建一个新文件。</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token comment">// 创建一个可变的字节数组来存储文件内容</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token comment">// 使用read_to_end将文件内容读取到buffer中</span></pre></td></tr><tr><td data-num=12></td><td><pre>    file<span class="token punctuation">.</span><span class="token function">read_to_end</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token comment">// 输出文件内容</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"File content: &#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=文件的内容写入><a class=anchor href=#文件的内容写入>#</a> 文件的内容写入</h3><p>关联函数签名 - <code>pub fn write&lt;P: AsRef&lt;Path&gt;, C: AsRef&lt;[u8]&gt;&gt;(path: P, contents: C) -&gt; Result&lt;()&gt;</code></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Unable to create file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">"Hello, Rust!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    file<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Unable to write to file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=文件的删除><a class=anchor href=#文件的删除>#</a> 文件的删除</h3><p>关联函数签名 - <code>pub fn remove_file&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;()&gt;</code></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">remove_file</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">match</span> result <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"File successfully deleted."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre>        <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error deleting file: &#123;&#125;"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=迭代器与迭代器的消费><a class=anchor href=#迭代器与迭代器的消费>#</a> 迭代器与迭代器的消费</h2><h3 id=字符串><a class=anchor href=#字符串>#</a> 字符串</h3><p><code>.take_while()</code>方法</p><p>用于迭代器的终止条件判断</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">take_while</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TakeWhile</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">P</span><span class="token operator">></span> ⓘ</pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">where</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>.collect()</code>方法</p><p>用于迭代器元素的收集</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">collect</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">B</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">where</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">FromIterator</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>例子</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    </pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> result<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">// 转换为字符迭代器</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token punctuation">.</span><span class="token function">take_while</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>c<span class="token closure-punctuation punctuation">|</span></span> c <span class="token operator">!=</span> <span class="token char">' '</span><span class="token punctuation">)</span>               <span class="token comment">// 仅获取空格之前的字符</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 将满足条件的字符收集到字符串</span></pre></td></tr><tr><td data-num=7></td><td><pre>    </pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token keyword">let</span> result2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre>    	<span class="token punctuation">.</span><span class="token function">take_while</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>c<span class="token closure-punctuation punctuation">|</span></span> c <span class="token operator">!=</span> <span class="token char">' '</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=10></td><td><pre>    	<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        </pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Result: &#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 "Hello,"</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>String::from_utf8_lossy()</code></p><p>用于将字节数组(<code>[u8]</code>)转换为<code>String</code>类型。它的名称中的lossy意味着在转换时可能会有信息丢失，因为不是所有的字节序列都可以有效地转换为有效的UTF-8字符串。这个方法的主要作用是处理包含无效UTF-8编码字节序列的输入，并尽可能将其转换为有效的UTF-8字符串，同时用特殊的占位符<code>�</code>来表示无效字节。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> bytes <span class="token operator">=</span> <span class="token string">b"Hello, \xF0\x90\x80World!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">let</span> utf8_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> utf8_string<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>.split()</code>方法</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token string">"apple,banana,cherry"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">let</span> split_text<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">></span> <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token char">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">for</span> part <span class="token keyword">in</span> split_text <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> part<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token comment"> * split方法使用逗号, 作为分隔符来拆分字符串，</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment"> * 然后使用collect方法将结果收集到一个Vec&lt;&amp;str>中，</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token comment"> * 最后遍历输出每个分隔后的部分。</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><h3 id=数组><a class=anchor href=#数组>#</a> 数组</h3><p><code>.sum()</code>方法</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">find_average</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">f64</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">match</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token number">0</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>        n <span class="token operator">=></span> slice<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>n <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token comment"> * 将数组元素累加</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><h2 id=常用标准库方法><a class=anchor href=#常用标准库方法>#</a> 常用标准库方法</h2><h3 id=大小比较><a class=anchor href=#大小比较>#</a> 大小比较</h3><p><code>std::cmp::max()</code> - 比较最大值并返回最大值</p><p><code>std::cmp::min()</code> - 比较最小值并返回最小值</p><h2 id=unsafe-rust><a class=anchor href=#unsafe-rust>#</a> Unsafe Rust</h2><p>unsafe中能</p><ul><li>解引用裸指针</li><li>调用一个<code>unsafe</code>或外部的函数</li><li>访问或修改一个可变的静态变量</li><li>实现一个<code>unsafe</code>特征</li><li>访问<code>union</code>中的字段</li></ul><p><code>unsafe</code>并不能绕过 Rust 的借用检查，也不能关闭任何Rust的安全检查规则，例如当在<code>unsafe</code>中使用<strong>引用</strong>时，该有的检查一样都不会少。</p><p>写代码时要尽量控制好<code>unsafe</code>的边界大小，另一个很常用的方式就是在<code>unsafe</code>代码块外包裹一层<code>safe</code>的API。</p><h3 id=解引用裸指针><a class=anchor href=#解引用裸指针>#</a> 解引用裸指针</h3><p>裸指针(raw pointer，又称原生指针)在功能上跟引用类似，同时它也需要显式地注明可变性。但是又和引用有所不同，例如裸指针<code>*const T</code>和<code>*mut T</code>，它们分别代表了不可变和可变。在裸指针<code>*const T</code>中，这里的<code>*</code>只是类型名称的一部分，并没有解引用的含义。</p><p>与引用、智能指针不同，裸指针</p><ul><li>可以绕过 Rust 的借用规则，可以同时拥有一个数据的可变、不可变指针，甚至还能拥有多个可变的指针</li><li>并不能保证指向合法的内存</li><li>可以是<code>null</code></li><li>没有实现任何自动的回收(drop)</li></ul><p>裸指针跟C指针是非常像，创建裸指针是安全的行为，而解引用裸指针才是不安全的行为。</p><p><strong>基于引用创建裸指针</strong></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"r1 is: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token operator">*</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>基于内存地址创建裸指针</strong></p><p>这种行为是相当危险的。试图使用任意的内存地址往往是一种未定义的行为(undefined behavior)，因为该内存地址有可能存在值，也有可能没有。如果真的要使用内存地址，也是类似下面的用法，先取地址，再使用，而不是凭空捏造一个地址。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token namespace">slice<span class="token punctuation">::</span></span>from_raw_parts<span class="token punctuation">,</span> <span class="token keyword">str</span><span class="token punctuation">::</span>from_utf8_unchecked<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">// 获取字符串的内存地址和长度</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">get_memory_location</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>  <span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>  <span class="token keyword">let</span> pointer <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>  <span class="token keyword">let</span> length <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>  <span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment">// 在指定的内存地址读取字符串</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">get_str_at_location</span><span class="token punctuation">(</span>pointer<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=13></td><td><pre>  <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span> <span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token function">from_raw_parts</span><span class="token punctuation">(</span>pointer <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=17></td><td><pre>  <span class="token keyword">let</span> <span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">get_memory_location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=18></td><td><pre>  <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token function">get_str_at_location</span><span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre>  <span class="token macro property">println!</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token string">"The &#123;&#125; bytes at 0x&#123;:X&#125; stored: &#123;&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=21></td><td><pre>    length<span class="token punctuation">,</span> pointer<span class="token punctuation">,</span> message</pre></td></tr><tr><td data-num=22></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>  <span class="token comment">// 如果大家想知道为何处理裸指针需要 `unsafe`，可以试着反注释以下代码</span></pre></td></tr><tr><td data-num=24></td><td><pre>  <span class="token comment">// let message = get_str_at_location(1000, 10);</span></pre></td></tr><tr><td data-num=25></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>基于智能指针创建裸指针</strong></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">let</span> a<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token comment">// 需要先解引用a</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">let</span> b<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token operator">*</span>a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment">// 使用 into_raw 来创建</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">let</span> c<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">into_raw</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>使用<code>*</code>解引用</strong></p><p>使用<code>*</code>可以对裸指针进行解引用，由于该指针的内存安全性并没有任何保证，因此需要使用<code>unsafe</code>来包裹解引用的逻辑(切记，<code>unsafe</code>语句块的范围一定要尽可能的小)。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">let</span> b<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>a <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">let</span> c<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>除了使用<code>as</code>来显式的转换，还使用了隐式的转换方式<code>let c: *const i32 = &amp;a;</code>。在实际使用中，建议使用<code>as</code>来转换，因为这种显式的方式更能表明当前使用的指针是裸指针，需要小心。</p><h3 id=调用unsafe函数或方法><a class=anchor href=#调用unsafe函数或方法>#</a> 调用unsafe函数或方法</h3><p><code>unsafe</code>函数需要使用<code>unsafe fn</code>来进行定义。在<code>unsafe</code>函数体中使用<code>unsafe</code>语句块是多余的行为。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">dangerous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token function">dangerous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=用安全抽象包裹unsafe代码><a class=anchor href=#用安全抽象包裹unsafe代码>#</a> 用安全抽象包裹unsafe代码</h3><p>例如，需要将一个数组分成两个切片，且每一个切片都要求是可变的。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>slice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mid<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">let</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token macro property">assert!</span><span class="token punctuation">(</span>mid <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token punctuation">(</span></pre></td></tr><tr><td data-num=11></td><td><pre>            <span class="token namespace">slice<span class="token punctuation">::</span></span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=12></td><td><pre>            <span class="token namespace">slice<span class="token punctuation">::</span></span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">-</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=13></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=18></td><td><pre>    <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=19></td><td><pre></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> v<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=21></td><td><pre></pre></td></tr><tr><td data-num=22></td><td><pre>    <span class="token keyword">let</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre></pre></td></tr><tr><td data-num=24></td><td><pre>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=25></td><td><pre>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=26></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码需要像C语言那样，通过指针地址的偏移去控制数组的分割。</p><ul><li><code>as_mut_ptr</code>会返回指向<code>slice</code>首地址的裸指针<code>*mut i32</code></li><li><code>slice::from_raw_parts_mut</code>函数通过指针和长度来创建一个新的切片，简单来说，该切片的初始地址是<code>ptr</code>，长度为<code>mid</code></li><li><code>ptr.add(mid)</code>可以获取第二个切片的初始地址，由于切片中的元素是<code>i32</code>类型，每个元素都占用了4个字节的内存大小，因此我们不能简单的用<code>ptr + mid</code>来作为初始地址，而应该使用<code>ptr + 4 * mid</code>，但是这种使用方式并不安全，因此<code>.add</code>方法是最佳选择</li></ul><p>由于<code>slice::from_raw_parts_mut</code>使用裸指针作为参数，因此它是一个<code>unsafe fn</code>，在使用它时，就必须用<code>unsafe</code>语句块进行包裹，类似的，<code>.add</code>方法也是如此(不要将无关的代码包含在<code>unsafe</code>语句块中)。</p><p>至于这段代码怎么保证<code>unsafe</code>中使用的裸指针<code>ptr</code>和<code>ptr.add(mid)</code>是合法的，在于通过<code>assert!(mid &lt;= len);</code>这个断言保证了裸指针一定指向了<code>slice</code>切片中的某个元素，而不是一个莫名其妙的内存地址。</p><p>虽然<code>split_at_mut</code>使用了<code>unsafe</code>，但无需将其声明为<code>unsafe fn</code>，这种情况下就是使用安全的抽象包裹<code>unsafe</code>代码，这里的<code>unsafe</code>使用是非常安全的，因为是从合法数据中创建了的合法指针。</p><h3 id=ffiforeign-function-interface><a class=anchor href=#ffiforeign-function-interface>#</a> FFI(Foreign Function Interface)</h3><p><code>FFI</code>可以用来与其它语言进行交互，通过<code>FFI</code> , Rust代码可以跟其它语言的外部代码进行交互。但是并不是所有语言都这么称呼例，如Java称之为<code>JNI(Java Native Interface)</code>。</p><p><code>FFI</code>之所以存在是由于现实中很多代码库都是由不同语言编写的，如果我们需要使用某个库，但是它是由其它语言编写的，那么往往只有两个选择</p><ul><li>对该库进行重写或者移植</li><li>使用<code>FFI</code></li></ul><p>例如调用C标准库中的<code>abs</code>函数</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">abs</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Absolute value of -3 according to C: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>C语言的代码定义在了<code>extern</code>代码块中， 而<code>extern</code>必须使用<code>unsafe</code>才能进行进行调用，原因在于其它语言的代码并不会强制执行Rust的规则，因此Rust无法对这些代码进行检查，最终还是要靠开发者自己来保证代码的正确性和程序的安全性。</p><p><strong>ABI</strong></p><p>在<code>extern &quot;C&quot;</code>代码块中，列出了想要调用的外部函数的签名。其中<code>&quot;C&quot;</code>定义了外部函数所使用的<strong>应用二进制接口</strong><code>ABI</code> (Application Binary Interface) - <code>ABI</code>定义了如何在汇编层面来调用该函数。在所有<code>ABI</code>中，C 语言的是最常见的。</p><p><strong>在其它语言中调用 Rust 函数</strong></p><p>可以使用<code>extern</code>来创建一个接口，其它语言可以通过该接口来调用相关的Rust函数。但是此处的语法与之前有所不同，之前用的是语句块，而这里是在函数定义时加上<code>extern</code>关键字，当然，别忘了指定相应的<code>ABI</code>。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token attribute attr-name">#[no_mangle]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function-definition function">call_from_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Just called a Rust function from C!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上面的代码可以让<code>call_from_c</code>函数被<code>C</code>语言的代码调用，当然，前提是将其编译成一个共享库，然后链接到C语言中。</p><p><code>#[no_mangle]</code>是用于告诉Rust编译器，不要乱改函数的名称。<code>Mangling</code>的定义是，当Rust因编译需要去修改函数的名称，例如为了让名称包含更多的信息，这样其它的编译部分就能从该名称获取相应的信息时，这种修改会导致函数名变得相当不可读。因此，为了让Rust函数能顺利被其它语言调用，必须要禁止掉该功能。</p><h3 id=实现unsafe特征><a class=anchor href=#实现unsafe特征>#</a> 实现unsafe特征</h3><p>之所以会有<code>unsafe</code>的特征，是因为该特征至少有一个方法包含有编译器无法验证的内容。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">unsafe</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Foo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token comment">// 方法列表</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">unsafe</span> <span class="token keyword">impl</span> <span class="token class-name">Foo</span> <span class="token keyword">for</span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// 实现相应的方法</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过<code>unsafe impl</code>的使用来告诉编译器，相应的正确性由编写者来保证。</p><h3 id=访问union中的字段><a class=anchor href=#访问union中的字段>#</a> 访问union中的字段</h3><p>截止目前，还没介绍过<code>union</code>，因为它主要用于跟<code>C</code>代码进行交互。访问<code>union</code>的字段是不安全的，因为Rust无法保证当前存储在<code>union</code>实例中的数据类型。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token attribute attr-name">#[repr(C)]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">union</span> <span class="token type-definition class-name">MyUnion</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    f1<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=4></td><td><pre>    f2<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>union</code>的使用方式跟结构体确实很相似，但是前者的所有字段都共享同一个存储空间，意味着往<code>union</code>的某个字段写入值，会导致其它字段的值会被覆盖。</p><h2 id=linux下安装rust><a class=anchor href=#linux下安装rust>#</a> Linux下安装Rust</h2><figure class="highlight shell"><figcaption data-lang=Bash></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment"># 确保安装了curl</span></pre></td></tr><tr><td data-num=2></td><td><pre>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">curl</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment"># 卸载Rust</span></pre></td></tr><tr><td data-num=5></td><td><pre>rustup self uninstall</pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment"># 切换下载源</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">RUSTUP_DIST_SERVER</span><span class="token operator">=</span>https://mirrors.ustc.edu.cn/rust-static</pre></td></tr><tr><td data-num=9></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">RUSTUP_UPDATE_ROOT</span><span class="token operator">=</span>https://mirrors.ustc.edu.cn/rust-static/rustup</pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token comment"># 安装Rust</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">--proto</span> <span class="token string">'=https'</span> <span class="token parameter variable">--tlsv1.2</span> <span class="token parameter variable">-sSf</span> https://sh.rustup.rs <span class="token operator">|</span> <span class="token function">sh</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment"># 输入1</span></pre></td></tr><tr><td data-num=14></td><td><pre></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token comment"># 配置环境</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token builtin class-name">source</span> <span class="token environment constant">$HOME</span>/.cargo/env</pre></td></tr><tr><td data-num=17></td><td><pre></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment"># 查看安装版本</span></pre></td></tr><tr><td data-num=19></td><td><pre>rustc <span class="token parameter variable">--version</span></pre></td></tr><tr><td data-num=20></td><td><pre></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment"># 安装编译环境</span></pre></td></tr><tr><td data-num=22></td><td><pre>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc</pre></td></tr><tr><td data-num=23></td><td><pre>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc-c++</pre></td></tr></table></figure><h2 id=项目包模块相关概念><a class=anchor href=#项目包模块相关概念>#</a> 项目/包/模块相关概念</h2><p><strong>项目</strong>(Packages) - 一个由<code>Cargo</code>提供的<code>feature</code>，可以用来构建、测试和分享包</p><p><strong>包</strong>(Crate) - 一个由多个模块组成的树形结构，可作为第三方库进行分发，也可生成可执行文件并进行运行</p><p><strong>模块</strong>(Module) - 可以将一个文件分成多个模块，也可将一个文件作为一个模块</p><p>项目与包是两个不同的概念，模块可以被认为是真实项目中的代码组织单元。</p><h2 id=包与项目><a class=anchor href=#包与项目>#</a> 包与项目</h2><h3 id=包crate><a class=anchor href=#包crate>#</a> 包(Crate)</h3><p>对于Rust而言，包是一个独立的可编译单元，编译后会生成一个可执行文件或一个库。一个包会将相关联的功能打包在一起，使得该功能可以很方便的在多个项目中分享，例如使用第三方库(<code>use rand;</code>)。同一个包中不能有同名的类型，但是在不同包中就可以。</p><h3 id=项目packages><a class=anchor href=#项目packages>#</a> 项目(Packages)</h3><p>项目可以理解为工程、软件包。Package就是一个项目，它包含独立的<code>Cargo.toml</code>文件，以及因为功能性被组织在一起的一个或多个包。一个Package只能包含<strong>一个</strong>库(library)类型的包，但是可以包含<strong>多个</strong>二进制可执行类型的包。</p><h4 id=二进制package><a class=anchor href=#二进制package>#</a> 二进制Package</h4><p>创建一个名为project的Package - <code>cargo new project</code></p><p>该Package下有<code>Cargo.toml</code>文件。其中<code>src/main.rs</code>是二进制包的根文件，该二进制包的名字与所属的Package的名字相同，都是<code>project</code>。</p><p>所有的代码执行都从<code>src/main.rs</code>文件中的<code>fn main()</code>函数开始，使用<code>cargo run</code>可以运行该项目。</p><h4 id=库package><a class=anchor href=#库package>#</a> 库Package</h4><p>创建一个<strong>库</strong>类型的Package - <code>cargo new my-lib --lib</code></p><p>库类型的<code>Package</code>只能作为三方库被其它项目引用，而不能独立运行，因此无法使用<code>cargo run</code>运行。</p><p>Cargo知道，如果一个<code>Package</code>包含<code>src/lib.rs</code>，这意味它有一个库类型的同名包<code>my-lib</code>，该包的根文件是 <code>src/lib.rs</code>。</p><p><font size=3><ins><strong>混淆点</strong></ins></font></p><p>用<code>cargo new</code>创建的<code>Package</code>和它其中包含的包是同名的，这就是Package与包容易混淆的原因。<code>Package</code>是一个项目工程，而包只是一个编译单元。<code>src/main.rs</code>和<code>src/lib.rs</code>都是编译单元，因此它们都是包。</p><h4 id=典型的package结构><a class=anchor href=#典型的package结构>#</a> 典型的Package结构</h4><p>创建的<code>Package</code>中仅包含<code>src/main.rs</code>文件，意味着它仅包含一个二进制同名包<code>my-project</code>。如果一个<code>Package</code>同时拥有<code>src/main.rs</code>和<code>src/lib.rs</code>，那就意味着它包含两个包，库包和二进制包，这两个包的包名也都是<code>my-project</code>，都与<code>Package</code>同名。</p><hr><p>真实项目中典型的<code>Package</code>，会包含多个二进制包，这些包文件被放在<code>src/bin</code>目录下，每一个文件都是独立的二进制包，同时也会包含一个库包，该包只能存在一个<code>src/lib.rs</code>。</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>.</pre></td></tr><tr><td data-num=2></td><td><pre>├── Cargo.toml</pre></td></tr><tr><td data-num=3></td><td><pre>├── Cargo.lock</pre></td></tr><tr><td data-num=4></td><td><pre>├── src</pre></td></tr><tr><td data-num=5></td><td><pre>│   ├── main.rs</pre></td></tr><tr><td data-num=6></td><td><pre>│   ├── lib.rs</pre></td></tr><tr><td data-num=7></td><td><pre>│   └── bin</pre></td></tr><tr><td data-num=8></td><td><pre>│       └── main1.rs</pre></td></tr><tr><td data-num=9></td><td><pre>│       └── main2.rs</pre></td></tr><tr><td data-num=10></td><td><pre>├── tests</pre></td></tr><tr><td data-num=11></td><td><pre>│   └── some_integration_tests.rs</pre></td></tr><tr><td data-num=12></td><td><pre>├── benches</pre></td></tr><tr><td data-num=13></td><td><pre>│   └── simple_bench.rs</pre></td></tr><tr><td data-num=14></td><td><pre>└── examples</pre></td></tr><tr><td data-num=15></td><td><pre>    └── simple_example.rs</pre></td></tr></table></figure><p>唯一库包 - <code>src/lib.rs</code></p><p>默认二进制包 - <code>src/main.rs</code>，编译后生成的可执行文件与<code>Package</code>同名</p><p>其余二进制包 - <code>src/bin/main1.rs</code>和<code>src/bin/main2.rs</code>，它们会分别生成一个与文件同名的二进制可执行文件</p><p>集成测试文件 - <code>tests</code>目录下</p><p>基准性能测试<code>benchmark</code>文件 - <code>benches</code>目录下</p><p>项目示例 - <code>examples</code> 目录下</p><hr><p>这种目录结构基本上是Rust的标准目录结构，在<code>GitHub</code>的大多数项目上也是这种结构。</p><h2 id=模块module><a class=anchor href=#模块module>#</a> 模块(Module)</h2><p>Rust的代码构成单元 - 模块，使用模块可以将包中的代码按照功能性进行重组，最终实现更好的可读性及易用性。</p><h3 id=嵌套模块的创建><a class=anchor href=#嵌套模块的创建>#</a> 嵌套模块的创建</h3><p>以一个小餐馆为例来描述Rust的模块应用。</p><p>使用命令<code>cargo new --lib restaurant</code>来创建一个库Package - <code>restaurant</code>，接着在<code>src/libs.rs</code>中写入</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 餐厅前厅，用于吃饭</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">seat_at_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">mod</span> <span class="token module-declaration namespace">serving</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">take_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">serve_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=13></td><td><pre></pre></td></tr><tr><td data-num=14></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">take_payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=15></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>以上的代码创建了三个模块，有以下几点需要注意</p><ul><li><p><code>mod</code>关键字用来创建新模块，后面紧跟着模块名称</p></li><li><p>模块可以嵌套，这里嵌套的原因是模拟了真实场景，即招待客人和服务都发生在前厅</p></li><li><p>模块中可以定义各种 Rust 类型，例如函数、结构体、枚举、特征等</p></li><li><p>所有模块均定义在同一个文件中</p></li></ul><h3 id=模块树><a class=anchor href=#模块树>#</a> 模块树</h3><p><code>src/main.rs</code>和<code>src/lib.rs</code>被称为<code>crate root</code>，这两个文件的内容形成了一个模块<code>crate</code>，该模块位于包的树形结构(由模块组成的树形结构)的根部。</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>crate</pre></td></tr><tr><td data-num=2></td><td><pre> └── front_of_house</pre></td></tr><tr><td data-num=3></td><td><pre>     ├── hosting</pre></td></tr><tr><td data-num=4></td><td><pre>     │   ├── add_to_waitlist</pre></td></tr><tr><td data-num=5></td><td><pre>     │   └── seat_at_table</pre></td></tr><tr><td data-num=6></td><td><pre>     └── serving</pre></td></tr><tr><td data-num=7></td><td><pre>         ├── take_order</pre></td></tr><tr><td data-num=8></td><td><pre>         ├── serve_order</pre></td></tr><tr><td data-num=9></td><td><pre>         └── take_payment</pre></td></tr></table></figure><p>这颗树展示了模块之间彼此的嵌套关系，因此被称为<strong>模块树</strong>。其中<code>crate</code>的<code>crate root</code>是<code>src/lib.rs</code>文件，<code>crate root</code>文件中的三个模块分别形成了模块树的剩余部分。</p><p><font size=3><ins><strong>父子模块</strong></ins></font></p><p>如果模块<code>A</code>包含模块<code>B</code>，那么<code>A</code>是<code>B</code>的父模块，<code>B</code>是<code>A</code>的子模块。在上例中，<code>front_of_house</code>是<code>hosting</code>和 <code>serving</code>的父模块，反之，后两者是前者的子模块。</p><h3 id=使用路径引用模块><a class=anchor href=#使用路径引用模块>#</a> 使用路径引用模块</h3><h4 id=基本使用><a class=anchor href=#基本使用>#</a> 基本使用</h4><p><strong>绝对路径</strong> - 从<code>crate root</code>开始，路径名以包名或者<code>crate</code>作为开头</p><p><strong>相对路径</strong> - 从当前模块开始，以<code>self</code>，<code>super</code>或当前模块的标识符作为开头</p><p>接着引用之前的小餐馆例子，在<code>src/lib.rs</code>中追加</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token comment">// ...</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// ...</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token comment">// 绝对路径</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>front_of_house<span class="token punctuation">::</span>hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token comment">// 相对路径</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token namespace">front_of_house<span class="token punctuation">::</span>hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=16></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token comment"> * eat_at_restaurant是一个定义在`crate root`中的函数，</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment"> * 在该函数中使用了两种方式对add_to_waitlist进行调用。</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><figure class="highlight tex"><figcaption data-lang=TeX><span>模块树</span></figcaption><table><tr><td data-num=1></td><td><pre>crate</pre></td></tr><tr><td data-num=2></td><td><pre> └── eat_at_restaurant</pre></td></tr><tr><td data-num=3></td><td><pre> └── front_of_house</pre></td></tr><tr><td data-num=4></td><td><pre>     ├── hosting</pre></td></tr><tr><td data-num=5></td><td><pre>     │   ├── add_to_waitlist</pre></td></tr><tr><td data-num=6></td><td><pre>     │   └── seat_at_table</pre></td></tr><tr><td data-num=7></td><td><pre>     └── serving</pre></td></tr><tr><td data-num=8></td><td><pre>         ├── take_order</pre></td></tr><tr><td data-num=9></td><td><pre>         ├── serve_order</pre></td></tr><tr><td data-num=10></td><td><pre>         └── take_payment</pre></td></tr></table></figure><p><font size=3><ins><strong>绝对路径引用</strong></ins></font></p><p>因为<code>eat_at_restaurant</code>和<code>add_to_waitlist</code>都定义在一个包中，因此在使用绝对路径引用时，可以直接以<code>crate</code>开头，然后逐层引用，每一层之间使用<code>::</code>分隔。</p><p><font size=3><ins><strong>相对路径引用</strong></ins></font></p><p>因为<code>eat_at_restaurant</code>和 <code>front_of_house</code> 都处于<code>crate root</code>的<code>crate</code>中，因此相对路径可以使用<code>front_of_house</code>作为开头。有点像文件位置 - <code>front_of_house/hosting/add_to_waitlist</code>。</p><p><font size=3><ins><strong>使用绝对还是相对？</strong></ins></font></p><p>如果只是为了引用到指定模块中的对象，那么两种都可以。但在实际使用时，需要遵循一个原则 - <strong>当代码被挪动位置时，尽量减少引用路径的修改</strong>。</p><p>例如，如果把<code>front_of_house</code>模块和<code>eat_at_restaurant</code>移动到一个模块中<code>customer_experience</code>，那么绝对路径的引用方式就必须进行修改<code>crate::customer_experience::front_of_house ...</code>；要是使用相对路径，那么该路径就无需修改，因为它们两个的相对位置其实没有变。</p><figure class="highlight tex"><figcaption data-lang=TeX><span>改动后的模块树</span></figcaption><table><tr><td data-num=1></td><td><pre>crate</pre></td></tr><tr><td data-num=2></td><td><pre> └── customer_experience</pre></td></tr><tr><td data-num=3></td><td><pre>    └── eat_at_restaurant</pre></td></tr><tr><td data-num=4></td><td><pre>    └── front_of_house</pre></td></tr><tr><td data-num=5></td><td><pre>        ├── hosting</pre></td></tr><tr><td data-num=6></td><td><pre>        │   ├── add_to_waitlist</pre></td></tr><tr><td data-num=7></td><td><pre>        │   └── seat_at_table</pre></td></tr></table></figure><p>再例如，其它的都不动，把<code>eat_at_restaurant</code>移动到模块<code>dining</code>中，如果使用相对路径就需要修改该路径，但如果使用的是绝对路径，就无需修改。</p><figure class="highlight tex"><figcaption data-lang=TeX><span>改动后的模块树</span></figcaption><table><tr><td data-num=1></td><td><pre>crate</pre></td></tr><tr><td data-num=2></td><td><pre> └── dining</pre></td></tr><tr><td data-num=3></td><td><pre>     └── eat_at_restaurant</pre></td></tr><tr><td data-num=4></td><td><pre> └── front_of_house</pre></td></tr><tr><td data-num=5></td><td><pre>     ├── hosting</pre></td></tr><tr><td data-num=6></td><td><pre>     │   ├── add_to_waitlist</pre></td></tr></table></figure><h4 id=使用super引用模块><a class=anchor href=#使用super引用模块>#</a> 使用super引用模块</h4><p>相对路径的<code>super</code>引用方式。<code>super</code>代表的是父模块为开始的引用方式，类似文件系统中的<code>..</code>语法(<code>../a/b</code>)。</p><p>之前的小餐馆模块，在<code>src/lib.rs</code>中追加</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">serve_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">// 厨房模块</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">back_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">fix_incorrect_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>        <span class="token function">cook_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>serve_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用了父模块(crate root)中的serve_order函数</span></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=9></td><td><pre></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">cook_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id=使用self引用模块><a class=anchor href=#使用self引用模块>#</a> 使用self引用模块</h4><p>相对路径的<code>self</code>引用方式。<code>self</code>其实就是引用自身模块中的项，调用同一模块中的内容。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">serve_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">self</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>back_of_house<span class="token punctuation">::</span></span><span class="token function">cook_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">back_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">fix_incorrect_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token function">cook_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>serve_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=10></td><td><pre></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">cook_order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=pub关键字制约代码的可见性><a class=anchor href=#pub关键字制约代码的可见性>#</a> pub关键字制约代码的可见性</h3><p>之前的小餐馆模块，</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>        <span class="token comment">// ...</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token comment">// ...</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>front_of_house<span class="token punctuation">::</span>hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token namespace">front_of_house<span class="token punctuation">::</span>hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当调用后会发生错误，因为<code>hosting</code>模块是私有的，无法在<code>crate root</code>中进行访问，从而导致私有化错误。而<code>front_of_house</code>与<code>eat_at_restaurant</code>同属于一个<code>crate root</code>作用域内，同一个模块内的代码自然不存在私有化问题。</p><p>模块还能定义代码的私有化边界，在这个边界内，什么内容能让外界看到，什么内容不能，都有很明确的定义。如果希望让函数或者结构体等类型变成私有化的，可以使用模块。</p><p>Rust出于安全的考虑，默认情况下所有的类型都是私有化的，包括函数、方法、结构体、枚举、常量，是的，就连模块本身也是私有化的。但是在Rust中，<strong>父模块完全无法访问子模块中的私有项，但是子模块却可以访问父模块、父父..模块的私有项</strong>。</p><p>类似cpp语言的<code>public</code>关键字，Rust提供了<code>pub</code>关键字，用于控制模块和模块中指定项的可见性。模块可见性不代表模块内部项的可见性，模块的可见性仅仅是允许其它模块去引用它，但是想要引用它内部的项，还得继续将对应的项标记为<code>pub</code>。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment">/*--- snip ----*/</span></pre></td></tr></table></figure><p><font size=3><ins><strong>结构体和枚举的可见性</strong></ins></font></p><p>结构体和枚举的成员字段拥有完全不同的可见性</p><ul><li>将结构体设置为<code>pub</code>，但它的所有字段依然是私有的</li><li>将枚举设置为<code>pub</code>，它的所有字段也将对外可见</li></ul><p>原因在于，枚举和结构体的使用方式不一样。如果枚举的成员对外不可见，那该枚举将一点用都没有，因此枚举成员的可见性自动跟枚举可见性保持一致。而结构体的应用场景比较复杂，其中的字段也往往部分在A处被使用，部分在B处被使用，因此无法确定成员的可见性，那索性就设置为全部不可见，将选择权交出。</p><h3 id=分离模块与文件><a class=anchor href=#分离模块与文件>#</a> 分离模块与文件</h3><p>假如所有的模块都定义在<code>src/lib.rs</code>中，当模块变多或者变大时，难以维护，就需要将模块放入一个单独的文件中。</p><p><font size=3><ins><strong>拆分为不同文件的方式</strong></ins></font></p><p>之前的小餐馆模块，把<code>front_of_house</code>前厅分离出来，放入一个单独的文件中<code>src/front_of_house.rs</code>，</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后，将以下代码留在<code>src/lib.rs</code>中，</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span><span class="token punctuation">;</span><span class="token comment">// 从另一个和模块front_of_house同名的文件中加载该模块的内容</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment"> * use关键字用来将外部模块中的项引入到当前作用域中来，</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token comment"> * 这样无需冗长的父模块前缀即可调用。</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token comment">**/</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>front_of_house<span class="token punctuation">::</span></span>hosting<span class="token punctuation">;</span><span class="token comment">// 使用绝对路径的方式来引用hosting模块</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>和之前代码中<code>mod front_of_house&#123;..&#125;</code>的完整模块不同，现在的代码中，模块的声明和实现是分离的，实现是在单独的<code>front_of_house.rs</code>文件中，然后通过<code>mod front_of_house;</code>这条声明语句从该文件中把模块内容加载进来。模块<code>front_of_house</code>的定义还是在<code>src/lib.rs</code>中，只不过模块的具体内容被移动到了<code>src/front_of_house.rs</code>文件中。</p><p><font size=3><ins><strong>拆分为不同文件夹的方式</strong></ins></font></p><p>当一个模块有许多子模块时，也可以通过文件夹的方式来组织这些子模块。</p><p>创建一个目录<code>front_of_house</code>，然后在文件夹里创建一个<code>hosting.rs</code>文件，<code>hosting.rs</code>文件现在就剩下，</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将文件夹作为一个模块，需要进行显示指定暴露哪些子模块，有两种方式</p><ul><li>在<code>front_of_house</code>目录里创建一个<code>mod.rs</code></li><li>在<code>front_of_house</code>同级目录里创建一个与模块(目录)同名的rs文件<code>front_of_house.rs</code></li></ul><p><ins><strong>使用总结</strong></ins></p><p>一个<code>.rs</code>文件就是一个crate，<code>.rs</code>文件目录下的<code>文件名.rs</code>或<code>文件夹名/mod.rs</code>文件都是<code>.rs</code>文件的组成模块，模块里面还能有子模块。</p><p>同一个模块文件里面的内容对外是私有的。同一文件内部调用不需要函数有pub关键字，而当前模块或crate调用其他模块时，其他模块里面的被调用的内容需添加pub关键字。</p><h2 id=use引入与其受限可见性><a class=anchor href=#use引入与其受限可见性>#</a> use引入与其受限可见性</h2><p>简化<code>crate::front_of_house::hosting::add_to_waitlist</code>这样的函数调用形式。</p><h3 id=基本引入方式><a class=anchor href=#基本引入方式>#</a> 基本引入方式</h3><figure class="highlight rust"><figcaption data-lang=Rust><span>绝对路径引入模块</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>front_of_house<span class="token punctuation">::</span></span>hosting<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight rust"><figcaption data-lang=Rust><span>相对路径引入模块中的函数</span></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">use</span> <span class="token namespace">front_of_house<span class="token punctuation">::</span>hosting<span class="token punctuation">::</span></span>add_to_waitlist<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>优先使用最细粒度(引入函数、结构体等)的引用方式，如果引起了某种麻烦(例如前面两种情况)，再使用引入模块的方式。</p><h3 id=避免同名引用><a class=anchor href=#避免同名引用>#</a> 避免同名引用</h3><p><font size=3><ins><strong>(模块::函数)限定引用</strong></ins></font></p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token comment">// --snip--</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token comment">// --snip--</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font size=3><ins><strong>as关键字的别名引用</strong></ins></font></p><p>使用<code>as</code>关键字可以赋予引入项一个全新的名称。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token keyword">as</span> <span class="token class-name">IoResult</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token comment">// --snip--</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IoResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token comment">// --snip--</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=引入项再导出><a class=anchor href=#引入项再导出>#</a> 引入项再导出</h3><p>当外部的模块项<code>A</code>被引入到当前模块中时，它的可见性自动被设置为私有的，如果希望允许其它外部代码引用当前引入的外部模块项<code>A</code>，可以使用<code>pub use</code>对它进行再导出。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">front_of_house</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">hosting</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>front_of_house<span class="token punctuation">::</span></span>hosting<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">eat_at_restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre>    <span class="token namespace">hosting<span class="token punctuation">::</span></span><span class="token function">add_to_waitlist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id=使用简化引入方式><a class=anchor href=#使用简化引入方式>#</a> 使用{}简化引入方式</h3><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 一行一行的引入方式</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">BTreeMap</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cmp<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=8></td><td><pre></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token comment">// 使用&#123;&#125;来一起引入进来</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">HashMap</span><span class="token punctuation">,</span><span class="token class-name">BTreeMap</span><span class="token punctuation">,</span><span class="token class-name">HashSet</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">,</span> io<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token comment">// self关键字代替模块自身</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">Write</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 简化</span></pre></td></tr><tr><td data-num=18></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num=19></td><td><pre><span class="token comment"> * use self::xxx，表示加载当前模块中的xxx。此时self可省略</span></pre></td></tr><tr><td data-num=20></td><td><pre><span class="token comment"> * use xxx::&#123;self, yyy&#125;，表示加载当前路径下模块xxx本身，以及模块xxx下的yyy</span></pre></td></tr><tr><td data-num=21></td><td><pre><span class="token comment">**/</span></pre></td></tr></table></figure><h3 id=使用引入模块下的所有项><a class=anchor href=#使用引入模块下的所有项>#</a> 使用*引入模块下的所有项</h3><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id=受限可见性><a class=anchor href=#受限可见性>#</a> 受限可见性</h3><p>想要让某一项可以在整个包中都可以被使用，那么有两种办法</p><ul><li>在<code>crate root</code>中定义一个非<code>pub</code>类型的<code>X</code>(父模块的项对子模块都是可见的，因此<code>crate root</code>中各项对模块树上的所有模块都可见)</li><li>在子模块中定义一个<code>pub</code>类型的<code>Y</code>，同时通过<code>use</code>将其引入到<code>crate root</code></li></ul><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">a</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=2></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">b</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span><span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">X</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre>        <span class="token attribute attr-name">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=8></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Y</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=11></td><td><pre></pre></td></tr><tr><td data-num=12></td><td><pre><span class="token attribute attr-name">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=13></td><td><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">X</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=14></td><td><pre><span class="token keyword">use</span> <span class="token namespace">a<span class="token punctuation">::</span>b<span class="token punctuation">::</span></span><span class="token class-name">Y</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=15></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=16></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span><span class="token class-name">Y</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>限制可见性语法</strong></p><ul><li><code>pub</code> - 意味着可见性无任何限制</li><li><code>pub(crate)</code> - 表示在当前包可见</li><li><code>pub(self)</code> - 在当前模块可见</li><li><code>pub(super)</code> - 在父模块可见</li><li><code>pub(in &lt;path&gt;)</code> - 表示在某个路径代表的模块中可见，其中 <code>path</code> 必须是父模块或者祖先模块</li></ul><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment">// 一个名为 `my_mod` 的模块</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token keyword">mod</span> <span class="token module-declaration namespace">my_mod</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=3></td><td><pre>    <span class="token comment">// 模块中的项默认具有私有的可见性</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">fn</span> <span class="token function-definition function">private_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=5></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::private_function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre>    <span class="token comment">// 使用 `pub` 修饰语来改变默认可见性。</span></pre></td></tr><tr><td data-num=9></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=10></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=11></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=12></td><td><pre></pre></td></tr><tr><td data-num=13></td><td><pre>    <span class="token comment">// 在同一模块中，项可以访问其它项，即使它是私有的。</span></pre></td></tr><tr><td data-num=14></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">indirect_access</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=15></td><td><pre>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::indirect_access()`, that\n> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=16></td><td><pre>        <span class="token function">private_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=17></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=18></td><td><pre></pre></td></tr><tr><td data-num=19></td><td><pre>    <span class="token comment">// 模块也可以嵌套</span></pre></td></tr><tr><td data-num=20></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">nested</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=21></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=22></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::nested::function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=23></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=24></td><td><pre></pre></td></tr><tr><td data-num=25></td><td><pre>        <span class="token attribute attr-name">#[allow(dead_code)]</span></pre></td></tr><tr><td data-num=26></td><td><pre>        <span class="token keyword">fn</span> <span class="token function-definition function">private_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=27></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::nested::private_function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=28></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=29></td><td><pre></pre></td></tr><tr><td data-num=30></td><td><pre>        <span class="token comment">// 使用 `pub(in path)` 语法定义的函数只在给定的路径中可见。</span></pre></td></tr><tr><td data-num=31></td><td><pre>        <span class="token comment">// `path` 必须是父模块（parent module）或祖先模块（ancestor module）</span></pre></td></tr><tr><td data-num=32></td><td><pre>        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>my_mod</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">public_function_in_my_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=33></td><td><pre>            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::nested::public_function_in_my_mod()`, that\n > "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=34></td><td><pre>            <span class="token function">public_function_in_nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num=35></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=36></td><td><pre></pre></td></tr><tr><td data-num=37></td><td><pre>        <span class="token comment">// 使用 `pub(self)` 语法定义的函数则只在当前模块中可见。</span></pre></td></tr><tr><td data-num=38></td><td><pre>        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">public_function_in_nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=39></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::nested::public_function_in_nested"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=40></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=41></td><td><pre></pre></td></tr><tr><td data-num=42></td><td><pre>        <span class="token comment">// 使用 `pub(super)` 语法定义的函数只在父模块中可见。</span></pre></td></tr><tr><td data-num=43></td><td><pre>        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">public_function_in_super_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=44></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called my_mod::nested::public_function_in_super_mod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=45></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=46></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=47></td><td><pre></pre></td></tr><tr><td data-num=48></td><td><pre>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">call_public_function_in_my_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=49></td><td><pre>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::call_public_funcion_in_my_mod()`, that\n> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=50></td><td><pre>        <span class="token namespace">nested<span class="token punctuation">::</span></span><span class="token function">public_function_in_my_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=51></td><td><pre>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=52></td><td><pre>        <span class="token namespace">nested<span class="token punctuation">::</span></span><span class="token function">public_function_in_super_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=53></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=54></td><td><pre></pre></td></tr><tr><td data-num=55></td><td><pre>    <span class="token comment">// `pub(crate)` 使得函数只在当前包中可见</span></pre></td></tr><tr><td data-num=56></td><td><pre>    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">public_function_in_crate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=57></td><td><pre>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::public_function_in_crate()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=58></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=59></td><td><pre></pre></td></tr><tr><td data-num=60></td><td><pre>    <span class="token comment">// 嵌套模块的可见性遵循相同的规则</span></pre></td></tr><tr><td data-num=61></td><td><pre>    <span class="token keyword">mod</span> <span class="token module-declaration namespace">private_nested</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=62></td><td><pre>        <span class="token attribute attr-name">#[allow(dead_code)]</span></pre></td></tr><tr><td data-num=63></td><td><pre>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=64></td><td><pre>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `my_mod::private_nested::function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=65></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=66></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=67></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=68></td><td><pre></pre></td></tr><tr><td data-num=69></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=70></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"called `function()`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=71></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num=72></td><td><pre></pre></td></tr><tr><td data-num=73></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=74></td><td><pre>    <span class="token comment">// 模块机制消除了相同名字的项之间的歧义。</span></pre></td></tr><tr><td data-num=75></td><td><pre>    <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=76></td><td><pre>    <span class="token namespace">my_mod<span class="token punctuation">::</span></span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=77></td><td><pre></pre></td></tr><tr><td data-num=78></td><td><pre>    <span class="token comment">// 公有项，包括嵌套模块内的，都可以在父模块外部访问。</span></pre></td></tr><tr><td data-num=79></td><td><pre>    <span class="token namespace">my_mod<span class="token punctuation">::</span></span><span class="token function">indirect_access</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=80></td><td><pre>    <span class="token namespace">my_mod<span class="token punctuation">::</span>nested<span class="token punctuation">::</span></span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=81></td><td><pre>    <span class="token namespace">my_mod<span class="token punctuation">::</span></span><span class="token function">call_public_function_in_my_mod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=82></td><td><pre></pre></td></tr><tr><td data-num=83></td><td><pre>    <span class="token comment">// pub(crate) 项可以在同一个 crate 中的任何地方访问</span></pre></td></tr><tr><td data-num=84></td><td><pre>    <span class="token namespace">my_mod<span class="token punctuation">::</span></span><span class="token function">public_function_in_crate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=85></td><td><pre></pre></td></tr><tr><td data-num=86></td><td><pre>    <span class="token comment">// pub(in path) 项只能在指定的模块中访问</span></pre></td></tr><tr><td data-num=87></td><td><pre>    <span class="token comment">// 报错！函数 `public_function_in_my_mod` 是私有的</span></pre></td></tr><tr><td data-num=88></td><td><pre>    <span class="token comment">//my_mod::nested::public_function_in_my_mod();</span></pre></td></tr><tr><td data-num=89></td><td><pre>    <span class="token comment">// 试一试 ^ 取消该行的注释</span></pre></td></tr><tr><td data-num=90></td><td><pre></pre></td></tr><tr><td data-num=91></td><td><pre>    <span class="token comment">// 模块的私有项不能直接访问，即便它是嵌套在公有模块内部的</span></pre></td></tr><tr><td data-num=92></td><td><pre></pre></td></tr><tr><td data-num=93></td><td><pre>    <span class="token comment">// 报错！`private_function` 是私有的</span></pre></td></tr><tr><td data-num=94></td><td><pre>    <span class="token comment">//my_mod::private_function();</span></pre></td></tr><tr><td data-num=95></td><td><pre>    <span class="token comment">// 试一试 ^ 取消此行注释</span></pre></td></tr><tr><td data-num=96></td><td><pre></pre></td></tr><tr><td data-num=97></td><td><pre>    <span class="token comment">// 报错！`private_function` 是私有的</span></pre></td></tr><tr><td data-num=98></td><td><pre>    <span class="token comment">//my_mod::nested::private_function();</span></pre></td></tr><tr><td data-num=99></td><td><pre>    <span class="token comment">// 试一试 ^ 取消此行的注释</span></pre></td></tr><tr><td data-num=100></td><td><pre></pre></td></tr><tr><td data-num=101></td><td><pre>    <span class="token comment">// 报错！ `private_nested` 是私有的</span></pre></td></tr><tr><td data-num=102></td><td><pre>    <span class="token comment">//my_mod::private_nested::function();</span></pre></td></tr><tr><td data-num=103></td><td><pre>    <span class="token comment">// 试一试 ^ 取消此行的注释</span></pre></td></tr><tr><td data-num=104></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id=cargo包管理工具><a class=anchor href=#cargo包管理工具>#</a> Cargo包管理工具</h2><h3 id=概述><a class=anchor href=#概述>#</a> 概述</h3><p>Rust有两种类型的包，库包和二进制包，前者是依赖包，用于被其它包所引入，而后者是一个应用服务，可以编译成二进制可执行文件进行运行。</p><p>包是通过Rust编译器<code>rustc</code>进行编译的 - <code>rustc hello.rs</code>，该方式虽然简单，但有几个问题</p><ul><li>必须要指定文件名编译，当项目复杂后，这种编译方式也随之更加复杂</li><li>如果要指定编译参数，情况将更加复杂</li></ul><p>外部依赖库的引入是一个大问题，实际的项目都有不少的依赖包，而这些依赖包又间接的依赖了新的依赖包，在这种复杂情况下，如何管理依赖包及其版本也成为一个相当棘手的问题。因此，<code>Cargo</code>能解决之前描述的所有问题，同时它保证每次重复的构建都不会改变上一次构建的结果，这背后是通过完善且强大的依赖包版本管理来实现的。</p><p><code>Cargo</code>是包管理工具，可以用于依赖包的下载、编译、更新、分发。Cargo会在安装Rust的时候一并进行安装，无需手动的操作执行安装。<code>Cargo</code>为了实现目标，做了四件事</p><ul><li>引入两个元数据文件，包含项目的方方面面信息 - <code>Cargo.toml</code>和<code>Cargo.lock</code></li><li>获取和构建项目的依赖，例如<code>Cargo.toml</code>中的依赖包版本描述，以及从<code>crates.io</code>下载包</li><li>调用<code>rustc</code>(或其它编译器)并使用的正确的参数来构建项目，例如<code>cargo build</code></li><li>引入一些惯例，让项目的使用更加简单</li></ul><p><span class=exturl data-url=aHR0cHM6Ly9jcmF0ZXMuaW8v>crates.io</span>是社区提供的包注册中心，用户可以将自己的包发布到该注册中心，其它用户通过注册中心引入该包。</p><p><code>Package</code> - 项目/工程/软件包</p><p>创建一个新的二进制Package - <code>cargo new hello_world</code>，该项目可以作为一个服务运行或被编译成可执行文件运行。等价于<code>cargo new hello_world --bin</code>，<code>bin</code>是<code>binary</code>的简写，代表着二进制程序，由于<code>--bin</code>是默认参数，因此可以对其进行省略。创建后生成的目录结构(使用命令<code>tree .</code>)</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>.</pre></td></tr><tr><td data-num=2></td><td><pre>├── Cargo.toml</pre></td></tr><tr><td data-num=3></td><td><pre>└── src</pre></td></tr><tr><td data-num=4></td><td><pre>    └── main.rs</pre></td></tr></table></figure><p><code>Cargo.toml</code>是<code>Cargo</code>使用的配置文件，它们之间的关系类似<code>package.json</code>与<code>npm</code>。</p><p><code>Cargo.toml</code>的内容被称为清单( manifest )，包含了<code>Cargo</code>编译程序所需的所有元数据。</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"hello_world"</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2021"</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p><code>Cargo</code>还会自动生成一个<code>hello world</code>程序(二进制包)，使用<code>Debug</code>模式命令<code>cargo build</code>对程序进行编译构建，该模式主要用于测试目的。如果想要进行生产编译，可执行<code>Release</code>模式命令<code>cargo build --release</code>。</p><p>日常开发中，使用<code>cargo run</code>命令。该命令会自动完成编译、运行的过程，也支持<code>Release</code>模式命令<code>cargo run --release</code>。</p><h3 id=下载并构建package><a class=anchor href=#下载并构建package>#</a> 下载并构建Package</h3><p>下载开源项目并通过cargo来完成构建。</p><figure class="highlight bash"><figcaption data-lang=bash></figcaption><table><tr><td data-num=1></td><td><pre><span class="token comment"># 拉取源码</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token function">git</span> clone https://github.com/rust-lang/regex.git</pre></td></tr><tr><td data-num=3></td><td><pre></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token comment"># 进入项目目录</span></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token builtin class-name">cd</span> regex</pre></td></tr><tr><td data-num=6></td><td><pre></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token comment"># 通过cargo构建项目</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token function">cargo</span> build</pre></td></tr></table></figure><p><code>cargo build</code>命令将下载相关的依赖库，等下载成功后，再对<code>package</code>和下载的依赖进行一同的编译构建，而背后隐藏的复杂配置、参数都无需关心。</p><h3 id=添加依赖><a class=anchor href=#添加依赖>#</a> 添加依赖</h3><p><code>cargo</code>默认就是从<span class=exturl data-url=aHR0cHM6Ly9jcmF0ZXMuaW8v>crates.io</span>中下载依赖。</p><p>若<code>Cargo.toml</code>文件中没有<code>[dependencies]</code>部分就手动添加一个，并添加目标包名和版本号</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"hello_world"</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2021"</span></pre></td></tr><tr><td data-num=5></td><td><pre></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token key property">time</span> <span class="token punctuation">=</span> <span class="token string">"0.1.12"</span> <span class="token comment"># 指定了time包的版本号"0.1.12"</span></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token key property">regex</span> <span class="token punctuation">=</span> <span class="token string">"0.1.41"</span></pre></td></tr></table></figure><p>通过运行<code>cargo build</code>命令来构建，<code>Cargo</code>会获取新的依赖以及依赖的依赖, 接着对它们进行编译并更新 <code>Cargo.lock</code>文件。在<code>Cargo.lock</code>中包含项目使用的所有依赖的准确版本信息。就算<code>regexp</code>的作者升级了该包，依然会下载<code>Cargo.lock</code>中的版本，而不是最新的版本。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token keyword">use</span> <span class="token namespace">regex<span class="token punctuation">::</span></span><span class="token class-name">Regex</span><span class="token punctuation">;</span><span class="token comment">// 使用新引入的regexp包</span></pre></td></tr><tr><td data-num=2></td><td><pre></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num=4></td><td><pre>    <span class="token keyword">let</span> re <span class="token operator">=</span> <span class="token class-name">Regex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">r"^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=5></td><td><pre>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Did our date match? &#123;&#125;"</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span><span class="token function">is_match</span><span class="token punctuation">(</span><span class="token string">"2014-01-01"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>相关命令</strong></p><ul><li><code>cargo add regex</code> - 添加regex依赖(包)</li><li><code>cargo remove regex</code> - 移除regex依赖(包)</li><li><code>cargo update</code> - 更新所有依赖</li><li><code>cargo update -p regex</code> - 只更新regex，<code>-p</code>传递的参数实际上是一个<code>Package ID</code></li></ul><h3 id=标准的package目录结构><a class=anchor href=#标准的package目录结构>#</a> 标准的Package目录结构</h3><p><code>Cargo</code>推荐的目录结构。</p><figure class="highlight tex"><figcaption data-lang=TeX></figcaption><table><tr><td data-num=1></td><td><pre>.</pre></td></tr><tr><td data-num=2></td><td><pre>├── Cargo.lock</pre></td></tr><tr><td data-num=3></td><td><pre>├── Cargo.toml</pre></td></tr><tr><td data-num=4></td><td><pre>├── src/</pre></td></tr><tr><td data-num=5></td><td><pre>│   ├── lib.rs</pre></td></tr><tr><td data-num=6></td><td><pre>│   ├── main.rs</pre></td></tr><tr><td data-num=7></td><td><pre>│   └── bin/</pre></td></tr><tr><td data-num=8></td><td><pre>│       ├── named-executable.rs</pre></td></tr><tr><td data-num=9></td><td><pre>│       ├── another-executable.rs</pre></td></tr><tr><td data-num=10></td><td><pre>│       └── multi-file-executable/</pre></td></tr><tr><td data-num=11></td><td><pre>│           ├── main.rs</pre></td></tr><tr><td data-num=12></td><td><pre>│           └── some_module.rs</pre></td></tr><tr><td data-num=13></td><td><pre>├── benches/</pre></td></tr><tr><td data-num=14></td><td><pre>│   ├── large-input.rs</pre></td></tr><tr><td data-num=15></td><td><pre>│   └── multi-file-bench/</pre></td></tr><tr><td data-num=16></td><td><pre>│       ├── main.rs</pre></td></tr><tr><td data-num=17></td><td><pre>│       └── bench_module.rs</pre></td></tr><tr><td data-num=18></td><td><pre>├── examples/</pre></td></tr><tr><td data-num=19></td><td><pre>│   ├── simple.rs</pre></td></tr><tr><td data-num=20></td><td><pre>│   └── multi-file-example/</pre></td></tr><tr><td data-num=21></td><td><pre>│       ├── main.rs</pre></td></tr><tr><td data-num=22></td><td><pre>│       └── ex_module.rs</pre></td></tr><tr><td data-num=23></td><td><pre>└── tests/</pre></td></tr><tr><td data-num=24></td><td><pre>    ├── some-integration-tests.rs</pre></td></tr><tr><td data-num=25></td><td><pre>    └── multi-file-test/</pre></td></tr><tr><td data-num=26></td><td><pre>        ├── main.rs</pre></td></tr><tr><td data-num=27></td><td><pre>        └── test_module.rs</pre></td></tr></table></figure><p><code>Cargo.toml</code>和<code>Cargo.lock</code>保存在<code>package</code>根目录下。</p><p>源代码放在<code>src</code>目录下。默认<code>lib</code>的<code>crate root</code>是<code>src/lib.rs</code>。默认的二进制<code>crate root</code>是<code>src/main.rs</code>。其它二进制<code>crate root</code>放在<code>src/bin/</code>目录下。</p><p>基准测试benchmark放在<code>benches</code>目录下。示例代码放在<code>examples</code>目录下。集成测试代码放在<code>tests</code>目录下。</p><p><code>bin</code>、<code>tests</code>、<code>examples</code>等目录路径都可以通过配置文件进行配置，它们被统一称之为<code>Cargo Target</code>。</p><h3 id=cargotoml与cargolock><a class=anchor href=#cargotoml与cargolock>#</a> Cargo.toml与Cargo.lock</h3><p><code>Cargo.toml</code>和<code>Cargo.lock</code>是<code>Cargo</code>的两个元配置文件</p><ul><li><code>Cargo.toml</code> - 从用户的角度出发来描述项目信息和依赖管理，由用户来编写</li><li><code>Cargo.lock</code> - 包含依赖的精确描述信息，由<code>Cargo</code>自行维护，不需要手动修改</li></ul><h4 id=是否需要上传本地的cargolock><a class=anchor href=#是否需要上传本地的cargolock>#</a> 是否需要上传本地的Cargo.lock</h4><p><code>Cargo.lock</code>会详尽描述上一次成功构建的各种信息，例如环境状态、依赖、版本等。Cargo可以根据这些提供确定性的构建环境和流程。这种特性对于终端服务非常重要，因为能确定、稳定的在用户环境中运行起来是终端服务最重要的特性之一。而对于三方库来说，它不仅仅被库的开发者所使用，还会间接影响依赖链下游的使用者。用户引入了三方库是不会去看它的<code>Cargo.lock</code>信息的，也不应该受这个库的确定性运行条件所限制。此外，在项目中，可能会有几个依赖库引用同一个三方库的同一个版本，那如果该三方库使用了<code>Cargo.lock</code>文件，那可能三方库的多个版本会被引入使用，这时就会造成版本冲突。</p><p>关于是否上传，有如下经验准则</p><ul><li><p>从实践角度出发，如果构建的是三方库类型的服务，需把<code>Cargo.lock</code>加入到<code>.gitignore</code></p></li><li><p>若构建的是一个面向用户终端的产品，例如可以像命令行工具、应用程序一样执行，就把<code>Cargo.lock</code>上传到源代码目录中</p></li></ul><p>例如web开发框架属于三方库类型的服务，因此源码目录中不应该出现<code>Cargo.lock</code>的身影，它的归宿是<code>.gitignore</code>。</p><h4 id=当没有cargolock文件时><a class=anchor href=#当没有cargolock文件时>#</a> 当没有Cargo.lock文件时</h4><p><code>Cargo.toml</code>是一个清单文件(<code>manifest</code>)，包含<code>package</code>的描述元数据，可以说明对另一个<code>package</code>的依赖。</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"hello_world"</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token key property">regex</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token key property">git</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/rust-lang/regex.git"</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>只有一个依赖且该依赖的来源是<code>GitHub</code>上一个特定的仓库。由于没有<code>Cargo.lock</code>文件并且也没指定任何版本信息，<code>Cargo</code>会自动拉取该依赖库的最新版本(<code>master</code>或<code>main</code>分支上的最新<code>commit</code>)。</p><p>可使用了指定<code>rev</code>(<code>revision</code>)的方式来构建，那么不管何时再次构建，使用的依赖库都会是该<code>rev</code>版本，而不是最新的<code>commit</code>。</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">regex</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token key property">git</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/rust-lang/regex.git"</span><span class="token punctuation">,</span> <span class="token key property">rev</span> <span class="token punctuation">=</span> <span class="token string">"9f9f693"</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但，<code>rev</code>需要手动管理，每次更新包的时候都思考下<code>SHA-1</code>，这非常麻烦。</p><h4 id=当存在cargolock文件时><a class=anchor href=#当存在cargolock文件时>#</a> 当存在Cargo.lock文件时</h4><p>当有了<code>Cargo.lock</code>后，就无需手动追踪依赖库的<code>rev</code>了，<code>Cargo</code>会自动完成这些工作。</p><figure class="highlight rust"><figcaption data-lang=Rust></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span>package<span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre>name <span class="token operator">=</span> <span class="token string">"hello_world"</span></pre></td></tr><tr><td data-num=3></td><td><pre>version <span class="token operator">=</span> <span class="token string">"0.1.0"</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span></pre></td></tr><tr><td data-num=6></td><td><pre>regex <span class="token operator">=</span> <span class="token punctuation">&#123;</span> git <span class="token operator">=</span> <span class="token string">"https://github.com/rust-lang/regex.git"</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>第一次构建时，<code>Cargo</code>依然会拉取最新的<code>master commit</code>，然后将以下信息写到<code>Cargo.lock</code>文件中。</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"hello_world"</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span></pre></td></tr><tr><td data-num=4></td><td><pre><span class="token key property">dependencies</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num=5></td><td><pre> <span class="token string">"regex 1.5.0 (git+https://github.com/rust-lang/regex.git#9f9f693768c584971a4d53bc3c586c33ed3a6831)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=7></td><td><pre></pre></td></tr><tr><td data-num=8></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=9></td><td><pre><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"regex"</span></pre></td></tr><tr><td data-num=10></td><td><pre><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"1.5.0"</span></pre></td></tr><tr><td data-num=11></td><td><pre><span class="token key property">source</span> <span class="token punctuation">=</span> <span class="token string">"git+https://github.com/rust-lang/regex.git#9f9f693768c584971a4d53bc3c586c33ed3a6831"</span></pre></td></tr></table></figure><p>其中包含了依赖库的准确<code>rev</code>信息，当之后再次构建时，只要项目中还有该<code>Cargo.lock</code>文件，那构建依然会拉取同一个版本的依赖库，并且无需手动去管理<code>rev</code>的<code>SHA</code>信息。</p><h2 id=代码调试><a class=anchor href=#代码调试>#</a> 代码调试</h2><p>在Rust中，可以通过在Cargo.toml文件中的[profile]部分设置<code>debug</code>或<code>release</code>配置来控制调试信息的生成。</p><figure class="highlight toml"><figcaption data-lang=TOML></figcaption><table><tr><td data-num=1></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">profile.dev</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=2></td><td><pre><span class="token key property">opt-level</span> <span class="token punctuation">=</span> <span class="token number">0</span>  <span class="token comment"># 为了开启最大的调试信息，将opt-level设置为 0</span></pre></td></tr><tr><td data-num=3></td><td><pre><span class="token key property">debug</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>   <span class="token comment"># 启用调试信息</span></pre></td></tr><tr><td data-num=4></td><td><pre></pre></td></tr><tr><td data-num=5></td><td><pre><span class="token punctuation">[</span><span class="token table class-name">profile.release</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num=6></td><td><pre><span class="token key property">opt-level</span> <span class="token punctuation">=</span> <span class="token number">3</span>  <span class="token comment"># 使用优化级别 3（默认），生成优化的release二进制</span></pre></td></tr><tr><td data-num=7></td><td><pre><span class="token key property">debug</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>  <span class="token comment"># 禁用调试信息</span></pre></td></tr></table></figure><p>在构建项目时，使用 <code>--release</code>标志来构建release版本 - <code>cargo build --release</code></p><p>使用<code>--release</code>构建Rust项目会启用编译器的优化，编译器会进行更多的优化，包括删除不可达的代码和剔除调试信息。</p><p>在release模式下，<code>println!</code>语句通常会被编译器优化掉。</p><p>在debug模式下，<code>println!</code>语句会保留，以便在运行时打印调试信息。</p><h2 id=第三方crate><a class=anchor href=#第三方crate>#</a> 第三方crate</h2><p><strong>url - HTTP协议处理</strong></p><p><code>url = &quot;2.5.0&quot;</code></p><p><strong>reqwest - HTTP请求</strong></p><p><code>reqwest = &#123; version = &quot;0.11&quot;, features = [&quot;json&quot;] &#125;</code></p><p><strong>tokio &amp; tokio-tungstenite - 异步请求与websocket</strong></p><p><code>tokio = &#123; version = &quot;1&quot;, features = [&quot;full&quot;] &#125;</code></p><p><code>tokio-tungstenite = &quot;0.21&quot;</code></p><p><strong>serde &amp; serde_json - JSON数据处理</strong></p><p>serde = { version = &quot;1.0&quot;,features = [&quot;derive&quot;] }<br>serde_json = &quot;1.0&quot;</p><p><strong>chrono - 时间相关处理</strong></p><p>chrono = &quot;0.4&quot;</p><div class=tags><a href=/tags/programming-language/ rel=tag><i class="ic i-tag"></i> 编程语言</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span> <span class=text>更新于</span> <time title="修改时间：2024-02-10 22:03:40" itemprop=dateModified datetime=2024-02-10T22:03:40+08:00>2024-02-10</time></span><span class=item data-path=/computer-science/programming/rust/rust-basic/rustpart3/ title=阅读次数><span class=icon><i class="ic i-eye"></i></span> <span class=text>阅读次数</span><span class=waline-pageview-count></span> <span class=text>次</span></span></div><div id=copyright><ul><li class=author><strong>本文作者：</strong> ReverseSacle <i class="ic i-at"><em>@</em></i>逆转天平</li><li class=link><strong>本文链接：</strong> <a href=https://www.reversesacle.com/computer-science/programming/rust/rust-basic/rustpart3/ title=Rust语言-基础-第三部分>https://www.reversesacle.com/computer-science/programming/rust/rust-basic/rustpart3/</a></li><li class=license><strong>版权声明：</strong> 本站所有文章除特别声明外，均采用 <span class=exturl data-url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class=post-nav><div class="item left"><a href=/computer-science/programming/rust/rust-basic/rustpart2/ itemprop=url rel=prev data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg3.webp title=Rust语言-基础-第二部分><span class=type>上一篇</span><span class=category><i class="ic i-flag"></i> Rust基础</span><h3>Rust语言-基础-第二部分</h3></a></div><div class="item right"><a href=/computer-science/programming/rust/rust-example/socket/ itemprop=url rel=next data-background-image=https:&#x2F;&#x2F;resa-imgs.oss-accelerate.aliyuncs.com&#x2F;img&#x2F;acg11.webp title=rust版HTTP协议的socket通信><span class=type>下一篇</span><span class=category><i class="ic i-flag"></i> Rust案例</span><h3>rust版HTTP协议的socket通信</h3></a></div></div><div class=wrap id=comments><div id=waline-comment></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=文章目录><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F><span class=toc-number>1.</span> <span class=toc-text>生命周期</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%82%AC%E5%9E%82%E6%8C%87%E9%92%88%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F><span class=toc-number>1.1.</span> <span class=toc-text>悬垂指针与生命周期</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%80%9F%E7%94%A8%E6%A3%80%E6%9F%A5><span class=toc-number>1.2.</span> <span class=toc-text>借用检查</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%97%AE%E9%A2%98><span class=toc-number>1.3.</span> <span class=toc-text>函数中的生命周期问题</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8%E8%AF%AD%E6%B3%95><span class=toc-number>1.4.</span> <span class=toc-text>生命周期标注语法</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E6%B6%88%E9%99%A4><span class=toc-number>1.5.</span> <span class=toc-text>生命周期的消除</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F><span class=toc-number>1.6.</span> <span class=toc-text>结构体中的生命周期</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%B9%E6%B3%95%E4%B8%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F><span class=toc-number>1.7.</span> <span class=toc-text>方法中的生命周期</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%9D%99%E6%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F><span class=toc-number>1.8.</span> <span class=toc-text>静态生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C><span class=toc-number>2.</span> <span class=toc-text>文件操作</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%9B%E5%BB%BA><span class=toc-number>2.1.</span> <span class=toc-text>文件的创建</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E6%89%93%E5%BC%80><span class=toc-number>2.2.</span> <span class=toc-text>文件的打开</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%83%E4%BF%A1%E6%81%AF%E6%9F%A5%E7%9C%8B><span class=toc-number>2.3.</span> <span class=toc-text>文件的元信息查看</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AE%B9%E8%AF%BB%E5%8F%96><span class=toc-number>2.4.</span> <span class=toc-text>文件的内容读取</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5><span class=toc-number>2.5.</span> <span class=toc-text>文件的内容写入</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%A0%E9%99%A4><span class=toc-number>2.6.</span> <span class=toc-text>文件的删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E8%BF%AD%E4%BB%A3%E5%99%A8%E7%9A%84%E6%B6%88%E8%B4%B9><span class=toc-number>3.</span> <span class=toc-text>迭代器与迭代器的消费</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AD%97%E7%AC%A6%E4%B8%B2><span class=toc-number>3.1.</span> <span class=toc-text>字符串</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%95%B0%E7%BB%84><span class=toc-number>3.2.</span> <span class=toc-text>数组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93%E6%96%B9%E6%B3%95><span class=toc-number>4.</span> <span class=toc-text>常用标准库方法</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%A7%E5%B0%8F%E6%AF%94%E8%BE%83><span class=toc-number>4.1.</span> <span class=toc-text>大小比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#unsafe-rust><span class=toc-number>5.</span> <span class=toc-text>Unsafe Rust</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%A7%A3%E5%BC%95%E7%94%A8%E8%A3%B8%E6%8C%87%E9%92%88><span class=toc-number>5.1.</span> <span class=toc-text>解引用裸指针</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B0%83%E7%94%A8unsafe%E5%87%BD%E6%95%B0%E6%88%96%E6%96%B9%E6%B3%95><span class=toc-number>5.2.</span> <span class=toc-text>调用unsafe函数或方法</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%94%A8%E5%AE%89%E5%85%A8%E6%8A%BD%E8%B1%A1%E5%8C%85%E8%A3%B9unsafe%E4%BB%A3%E7%A0%81><span class=toc-number>5.3.</span> <span class=toc-text>用安全抽象包裹unsafe代码</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#ffiforeign-function-interface><span class=toc-number>5.4.</span> <span class=toc-text>FFI(Foreign Function Interface)</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%9E%E7%8E%B0unsafe%E7%89%B9%E5%BE%81><span class=toc-number>5.5.</span> <span class=toc-text>实现unsafe特征</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%AE%BF%E9%97%AEunion%E4%B8%AD%E7%9A%84%E5%AD%97%E6%AE%B5><span class=toc-number>5.6.</span> <span class=toc-text>访问union中的字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#linux%E4%B8%8B%E5%AE%89%E8%A3%85rust><span class=toc-number>6.</span> <span class=toc-text>Linux下安装Rust</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%A1%B9%E7%9B%AE%E5%8C%85%E6%A8%A1%E5%9D%97%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5><span class=toc-number>7.</span> <span class=toc-text>项目&#x2F;包&#x2F;模块相关概念</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8C%85%E4%B8%8E%E9%A1%B9%E7%9B%AE><span class=toc-number>8.</span> <span class=toc-text>包与项目</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%8C%85crate><span class=toc-number>8.1.</span> <span class=toc-text>包(Crate)</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%A1%B9%E7%9B%AEpackages><span class=toc-number>8.2.</span> <span class=toc-text>项目(Packages)</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%BA%8C%E8%BF%9B%E5%88%B6package><span class=toc-number>8.2.1.</span> <span class=toc-text>二进制Package</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%BA%93package><span class=toc-number>8.2.2.</span> <span class=toc-text>库Package</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%85%B8%E5%9E%8B%E7%9A%84package%E7%BB%93%E6%9E%84><span class=toc-number>8.2.3.</span> <span class=toc-text>典型的Package结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%A8%A1%E5%9D%97module><span class=toc-number>9.</span> <span class=toc-text>模块(Module)</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%B5%8C%E5%A5%97%E6%A8%A1%E5%9D%97%E7%9A%84%E5%88%9B%E5%BB%BA><span class=toc-number>9.1.</span> <span class=toc-text>嵌套模块的创建</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A8%A1%E5%9D%97%E6%A0%91><span class=toc-number>9.2.</span> <span class=toc-text>模块树</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E8%B7%AF%E5%BE%84%E5%BC%95%E7%94%A8%E6%A8%A1%E5%9D%97><span class=toc-number>9.3.</span> <span class=toc-text>使用路径引用模块</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8><span class=toc-number>9.3.1.</span> <span class=toc-text>基本使用</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%BD%BF%E7%94%A8super%E5%BC%95%E7%94%A8%E6%A8%A1%E5%9D%97><span class=toc-number>9.3.2.</span> <span class=toc-text>使用super引用模块</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%BD%BF%E7%94%A8self%E5%BC%95%E7%94%A8%E6%A8%A1%E5%9D%97><span class=toc-number>9.3.3.</span> <span class=toc-text>使用self引用模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#pub%E5%85%B3%E9%94%AE%E5%AD%97%E5%88%B6%E7%BA%A6%E4%BB%A3%E7%A0%81%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7><span class=toc-number>9.4.</span> <span class=toc-text>pub关键字制约代码的可见性</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%86%E7%A6%BB%E6%A8%A1%E5%9D%97%E4%B8%8E%E6%96%87%E4%BB%B6><span class=toc-number>9.5.</span> <span class=toc-text>分离模块与文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#use%E5%BC%95%E5%85%A5%E4%B8%8E%E5%85%B6%E5%8F%97%E9%99%90%E5%8F%AF%E8%A7%81%E6%80%A7><span class=toc-number>10.</span> <span class=toc-text>use引入与其受限可见性</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%9F%BA%E6%9C%AC%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F><span class=toc-number>10.1.</span> <span class=toc-text>基本引入方式</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%81%BF%E5%85%8D%E5%90%8C%E5%90%8D%E5%BC%95%E7%94%A8><span class=toc-number>10.2.</span> <span class=toc-text>避免同名引用</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%BC%95%E5%85%A5%E9%A1%B9%E5%86%8D%E5%AF%BC%E5%87%BA><span class=toc-number>10.3.</span> <span class=toc-text>引入项再导出</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E7%AE%80%E5%8C%96%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F><span class=toc-number>10.4.</span> <span class=toc-text>使用{}简化引入方式</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%E4%B8%8B%E7%9A%84%E6%89%80%E6%9C%89%E9%A1%B9><span class=toc-number>10.5.</span> <span class=toc-text>使用*引入模块下的所有项</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%8F%97%E9%99%90%E5%8F%AF%E8%A7%81%E6%80%A7><span class=toc-number>10.6.</span> <span class=toc-text>受限可见性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#cargo%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7><span class=toc-number>11.</span> <span class=toc-text>Cargo包管理工具</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-number>11.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9E%84%E5%BB%BApackage><span class=toc-number>11.2.</span> <span class=toc-text>下载并构建Package</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96><span class=toc-number>11.3.</span> <span class=toc-text>添加依赖</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A0%87%E5%87%86%E7%9A%84package%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84><span class=toc-number>11.4.</span> <span class=toc-text>标准的Package目录结构</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#cargotoml%E4%B8%8Ecargolock><span class=toc-number>11.5.</span> <span class=toc-text>Cargo.toml与Cargo.lock</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E4%B8%8A%E4%BC%A0%E6%9C%AC%E5%9C%B0%E7%9A%84cargolock><span class=toc-number>11.5.1.</span> <span class=toc-text>是否需要上传本地的Cargo.lock</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%BD%93%E6%B2%A1%E6%9C%89cargolock%E6%96%87%E4%BB%B6%E6%97%B6><span class=toc-number>11.5.2.</span> <span class=toc-text>当没有Cargo.lock文件时</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%BD%93%E5%AD%98%E5%9C%A8cargolock%E6%96%87%E4%BB%B6%E6%97%B6><span class=toc-number>11.5.3.</span> <span class=toc-text>当存在Cargo.lock文件时</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%BB%A3%E7%A0%81%E8%B0%83%E8%AF%95><span class=toc-number>12.</span> <span class=toc-text>代码调试</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%AC%AC%E4%B8%89%E6%96%B9crate><span class=toc-number>13.</span> <span class=toc-text>第三方crate</span></a></li></ol></div><div class="related panel pjax" data-title=系列文章><ul><li><a href=/computer-science/programming/rust/rust-basic/rustpart1/ rel=bookmark title=Rust语言-基础-第一部分>Rust语言-基础-第一部分</a></li><li><a href=/computer-science/programming/rust/rust-basic/rustpart2/ rel=bookmark title=Rust语言-基础-第二部分>Rust语言-基础-第二部分</a></li><li class=active><a href=/computer-science/programming/rust/rust-basic/rustpart3/ rel=bookmark title=Rust语言-基础-第三部分>Rust语言-基础-第三部分</a></li></ul></div><div class="overview panel" data-title=站点概览><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img class=image itemprop=image alt=ReverseSacle data-src=/images/avatar.webp><p class=name itemprop=name>ReverseSacle</p><div class=description itemprop=description>知识书库 & 学习点滴</div></div><nav class=state><div class="item posts"><a href=/archives/ ><span class=count>186</span> <span class=name>文章</span></a></div><div class="item categories"><a href=/categories/ ><span class=count>52</span> <span class=name>分类</span></a></div><div class="item tags"><a href=/tags/ ><span class=count>18</span> <span class=name>标签</span></a></div></nav><div class=social><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JldmVyc2VTYWNsZQ==" title=https:&#x2F;&#x2F;github.com&#x2F;ReverseSacle><i class="ic i-github"></i></span><span class="exturl item email" data-url="bWFpbHRvOnByaXZhdGVAcmV2ZXJzZXNhY2xlLmNvbQ==" title=mailto:private@reversesacle.com><i class="ic i-envelope"></i></span></div><ul class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i> 首页</a></li><li class="item dropdown"><a href=javascript:void(0);><i class="ic i-feather"></i> 文章</a><ul class=submenu><li class=item><a href=/archives/ rel=section><i class="ic i-list-alt"></i> 归档</a></li><li class=item><a href=/categories/ rel=section><i class="ic i-th"></i> 分类</a></li><li class=item><a href=/tags/ rel=section><i class="ic i-tags"></i> 标签</a></li></ul></li><li class=item><a href=/about/ rel=section><i class="ic i-user"></i> 关于</a></li><li class=item><a href=/friend-links/ rel=section><i class="ic i-heart"></i> 友链</a></li></ul></div></div></div><ul id=quick><li class="prev pjax"><a href=/computer-science/programming/rust/rust-basic/rustpart2/ rel=prev title=上一篇><i class="ic i-chevron-left"></i></a></li><li class=up><i class="ic i-arrow-up"></i></li><li class=down><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href=/computer-science/programming/rust/rust-example/socket/ rel=next title=下一篇><i class="ic i-chevron-right"></i></a></li><li class=percent></li></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>随机文章</h2><ul><li class=item><div class=breadcrumb><a href=/categories/general-science-and-technology/ title="分类于 通用科学技术">通用科学技术</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/ title="分类于 通用技术之PC端">通用技术之PC端</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/external-device/ title="分类于 外接设备">外接设备</a></div><span><a href=/general-science-and-technology/pc/external-device/external-screen-guidance/ title=外接显示屏DIY指南>外接显示屏DIY指南</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/rust/ title="分类于 Rust">Rust</a></div><span><a href=/computer-science/programming/rust/rust-data-structure/linear-structure/hash-table/ title=Rust-哈希表>Rust-哈希表</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/reverse-engineering/ title="分类于 逆向工程">逆向工程</a></div><span><a href=/computer-science/programming/reverse-engineering/cheatengine/ title=CheatEngine基础>CheatEngine基础</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/link-list/ title="分类于 链表">链表</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/link-list/traversal/ title=链表-遍历>链表-遍历</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/python/ title="分类于 Python">Python</a></div><span><a href=/computer-science/programming/python/flask-basic/ title=Python后端框架Flask基础>Python后端框架Flask基础</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/binary-tree/ title="分类于 二叉树">二叉树</a></div><span><a href=/computer-science/programming/c-language/c-algorithm/binary-tree/sort/ title=二叉树-序列重组>二叉树-序列重组</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/shoka-theme/ title="分类于 Shoka主题">Shoka主题</a></div><span><a href=/computer-science/shoka-theme/supplement-for-shoka-theme/ title=Hexo-Shoka主题功能介绍补充点>Hexo-Shoka主题功能介绍补充点</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/database/ title="分类于 数据库">数据库</a></div><span><a href=/computer-science/programming/database/theory/ title=数据库基础理论>数据库基础理论</a></span></li><li class=item><div class=breadcrumb><a href=/categories/general-science-and-technology/ title="分类于 通用科学技术">通用科学技术</a><i class="ic i-angle-right"></i> <a href=/categories/general-science-and-technology/pc/ title="分类于 通用技术之PC端">通用技术之PC端</a></div><span><a href=/general-science-and-technology/pc/win-question/ title=windows综合问题>windows综合问题</a></span></li><li class=item><div class=breadcrumb><a href=/categories/computer-science/ title="分类于 计算机科学">计算机科学</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/ title="分类于 编程">编程</a><i class="ic i-angle-right"></i> <a href=/categories/computer-science/programming/c-language/ title="分类于 C语言">C语言</a></div><span><a href=/computer-science/programming/c-language/c-data-structure/linear-structure/seqlist/ title=C语言-顺序表>C语言-顺序表</a></span></li></ul></div><div><h2>最新评论</h2><ul id=waline-recent></ul></div></div><div class=status><div class=copyright>&copy; 2021 – <span itemprop=copyrightYear>2025</span><span class=with-love><i class="ic i-sakura rotate"></i></span> <span class=author itemprop=copyrightHolder>ReverseSacle @ ReverseSacle-Blog</span></div><div class=count><i class="ic i-clock" aria-hidden=true></i> <span id=time align=center>载入时间中...<script defer>var now=new Date;function createtime(){var n=new Date("2021-11-16 22:30:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("time").innerHTML="已经过 "+dnum+" 天 "+hnum+" 小时 "+mnum+" 分 "+snum+" 秒 "}setInterval("createtime()",250)</script></span><span class=post-meta-item-icon>|&nbsp<i class="ic i-chart-area"></i></span> <span title=站点总字数>2.1m 字</span> <span class=post-meta-item-icon>|&nbsp<i class="ic i-coffee"></i></span> <span title=站点阅读时长>40:40</span></div></div></div></footer></div><script data-config>var LOCAL={path:"computer-science/programming/rust/rust-basic/rustpart3/",favicon:{show:"ReverseSacle-Blog",hide:"ReverseSacle-Blog"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},waline:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src=https://polyfill.alicdn.com/v3/polyfill.min.js></script><script src=https://jd.reversesacle.com/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1.16.0/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js></script><script src=/js/app.js></script></body></html>